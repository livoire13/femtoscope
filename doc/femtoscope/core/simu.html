<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.0.0"/>
    <title>femtoscope.core.simu API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script>
<style>
    mjx-container {
        overflow-x: auto;
    }
</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../core.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;femtoscope.core</a>

            <img src="file://D:/hlevy/Documents/microscope2/femtoscope/images/logo.png" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>

            <h2>Contents</h2>
            <ul>
  <li><a href="#052022-update-note">05/2022 update note</a></li>
</ul>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Solver">Solver</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Solver.__init__">Solver</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.forbidden_nl_arg">forbidden_nl_arg</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.verbose">verbose</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.print_kappa">print_kappa</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.eps_dic">eps_dic</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.ls">ls</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.nls">nls</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.wfs_dic">wfs_dic</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.weakforms">weakforms</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.nwf">nwf</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.is_bounded">is_bounded</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.oldsols">oldsols</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.buffersols">buffersols</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.sols">sols</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.bounds">bounds</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.islinear">islinear</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.initialized">initialized</a>
                        </li>
                        <li>
                                <a class="variable" href="#Solver.outfiles">outfiles</a>
                        </li>
                        <li>
                                <a class="function" href="#Solver.init_mtxvec_dic">init_mtxvec_dic</a>
                        </li>
                        <li>
                                <a class="function" href="#Solver.init_problems">init_problems</a>
                        </li>
                        <li>
                                <a class="function" href="#Solver.init_mtxvec">init_mtxvec</a>
                        </li>
                        <li>
                                <a class="function" href="#Solver.update_mtxvec">update_mtxvec</a>
                        </li>
                        <li>
                                <a class="function" href="#Solver.solve">solve</a>
                        </li>
                        <li>
                                <a class="function" href="#Solver.save">save</a>
                        </li>
                        <li>
                                <a class="function" href="#Solver.plot_residual">plot_residual</a>
                        </li>
                        <li>
                                <a class="function" href="#Solver.display">display</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#StopCriteria">StopCriteria</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#StopCriteria.__init__">StopCriteria</a>
                        </li>
                        <li>
                                <a class="variable" href="#StopCriteria.max_iter">max_iter</a>
                        </li>
                        <li>
                                <a class="variable" href="#StopCriteria.min_iter">min_iter</a>
                        </li>
                        <li>
                                <a class="variable" href="#StopCriteria.res_delta_tol">res_delta_tol</a>
                        </li>
                        <li>
                                <a class="variable" href="#StopCriteria.sol_delta_tol">sol_delta_tol</a>
                        </li>
                        <li>
                                <a class="variable" href="#StopCriteria.stop">stop</a>
                        </li>
                        <li>
                                <a class="variable" href="#StopCriteria.res_vec">res_vec</a>
                        </li>
                        <li>
                                <a class="variable" href="#StopCriteria.res_vec_parts">res_vec_parts</a>
                        </li>
                        <li>
                                <a class="variable" href="#StopCriteria.res">res</a>
                        </li>
                        <li>
                                <a class="variable" href="#StopCriteria.sol_delta">sol_delta</a>
                        </li>
                        <li>
                                <a class="variable" href="#StopCriteria.history">history</a>
                        </li>
                        <li>
                                <a class="variable" href="#StopCriteria.last_relax_update">last_relax_update</a>
                        </li>
                        <li>
                                <a class="variable" href="#StopCriteria.active_dic">active_dic</a>
                        </li>
                        <li>
                                <a class="variable" href="#StopCriteria.verbose">verbose</a>
                        </li>
                        <li>
                                <a class="function" href="#StopCriteria.evaluate">evaluate</a>
                        </li>
                        <li>
                                <a class="function" href="#StopCriteria.fill_history">fill_history</a>
                        </li>
                        <li>
                                <a class="function" href="#StopCriteria.adjust_relax">adjust_relax</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#lsolve">lsolve</a>
            </li>
            <li>
                    <a class="function" href="#nlsolve">nlsolve</a>
            </li>
            <li>
                    <a class="function" href="#hook_writer">hook_writer</a>
            </li>
            <li>
                    <a class="function" href="#line_search">line_search</a>
            </li>
            <li>
                    <a class="function" href="#set_mat_extra_arg">set_mat_extra_arg</a>
            </li>
            <li>
                    <a class="function" href="#evaluate_at_qps">evaluate_at_qps</a>
            </li>
            <li>
                    <a class="function" href="#update_neumann">update_neumann</a>
            </li>
            <li>
                    <a class="function" href="#update_material">update_material</a>
            </li>
            <li>
                    <a class="function" href="#update_material_all">update_material_all</a>
            </li>
            <li>
                    <a class="function" href="#reset_dirichlet">reset_dirichlet</a>
            </li>
            <li>
                    <a class="function" href="#strong_residual">strong_residual</a>
            </li>
            <li>
                    <a class="function" href="#vec_G">vec_G</a>
            </li>
            <li>
                    <a class="function" href="#delete_ebc_dofs">delete_ebc_dofs</a>
            </li>
            <li>
                    <a class="function" href="#get_ebc_dofs">get_ebc_dofs</a>
            </li>
            <li>
                    <a class="function" href="#assemble_mtxvec">assemble_mtxvec</a>
            </li>
            <li>
                    <a class="function" href="#update_global_mtxvec">update_global_mtxvec</a>
            </li>
            <li>
                    <a class="function" href="#reconstruct_full_sol">reconstruct_full_sol</a>
            </li>
    </ul>


            <footer>Hugo Lévy PhD Thesis</footer>

        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../femtoscope.html">femtoscope</a><wbr>.<a href="./../core.html">core</a><wbr>.simu    </h1>

                        <div class="docstring"><p>Created on Fri Jan 28 15:32:37 2022</p>

<p>Simulation engine (bounded or unbounded domains, linear or nonlinear PDEs...).
Reminder for getting matrix / rhs vector:
<a href="https://github.com/sfepy/sfepy/issues/565">https://github.com/sfepy/sfepy/issues/565</a></p>

<h2 id="052022-update-note">05/2022 update note</h2>

<p>In the past, femtoscope used to re-assemble all matrices and vectors at each
iteration of the Newton method (and even at each ping-pong iteration!), which
is computationally inefficient. This problem can be circumvented by re-
assembling only the iteration-dependent terms. An important portion of the
program was edited in order to make this performance enhancement.</p>

<p>@author: hlevy</p>
</div>

                        <input id="mod-simu-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-simu-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="c1"># -*- coding: utf-8 -*-</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="sd">Created on Fri Jan 28 15:32:37 2022</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="sd">Simulation engine (bounded or unbounded domains, linear or nonlinear PDEs...).</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="sd">Reminder for getting matrix / rhs vector:</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="sd">https://github.com/sfepy/sfepy/issues/565</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="sd">05/2022 update note</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="sd">-------------------</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="sd">In the past, femtoscope used to re-assemble all matrices and vectors at each</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="sd">iteration of the Newton method (and even at each ping-pong iteration!), which</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="sd">is computationally inefficient. This problem can be circumvented by re-</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="sd">assembling only the iteration-dependent terms. An important portion of the</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="sd">program was edited in order to make this performance enhancement.</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="sd">@author: hlevy</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="c1"># from sfepy.solvers.auto_fallback import AutoDirect</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="kn">from</span> <span class="nn">sfepy.solvers.ls</span> <span class="kn">import</span> <span class="n">ScipyDirect</span> <span class="c1">#, ScipyIterative</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="kn">from</span> <span class="nn">sfepy.solvers.nls</span> <span class="kn">import</span> <span class="n">Newton</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="kn">from</span> <span class="nn">sfepy.base.base</span> <span class="kn">import</span> <span class="n">IndexedStruct</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="kn">from</span> <span class="nn">sfepy.discrete</span> <span class="kn">import</span> <span class="n">Equations</span><span class="p">,</span> <span class="n">Problem</span><span class="p">,</span> <span class="n">Function</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="kn">from</span> <span class="nn">sfepy.discrete.conditions</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Conditions</span><span class="p">,</span> <span class="n">EssentialBC</span><span class="p">,</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>                                       <span class="n">LinearCombinationBC</span><span class="p">)</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="kn">from</span> <span class="nn">femtoscope.misc.util</span> <span class="kn">import</span> <span class="n">concatenate</span><span class="p">,</span> <span class="n">copy_list_of_arrays</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="kn">import</span> <span class="nn">sfepy.discrete.fem.periodic</span> <span class="k">as</span> <span class="nn">per</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="kn">from</span> <span class="nn">sfepy.discrete.common.mappings</span> <span class="kn">import</span> <span class="n">get_physical_qps</span> <span class="c1"># get_normals</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="kn">from</span> <span class="nn">sfepy.base.base</span> <span class="kn">import</span> <span class="n">output</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="n">output</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Toggle for Sfepy console&#39;s messages</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="k">class</span> <span class="nc">Solver</span><span class="p">:</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">    Class for performing FEM simulations.</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="sd">    Attributes</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">    ----------</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">    eps_dic : dict</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="sd">        Dictionary with keys &#39;eps_a&#39; and &#39;eps_r&#39; corresponding to the absolute</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="sd">        and relative tolerance settings respectively.</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="sd">        The default is {&#39;eps_a&#39; : 1e-10, &#39;eps_r&#39; : 1.0}</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">    ls : `sfepy.solvers.ls.ScipyDirect` by default.</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="sd">        Linear solver to be used. The default is ScipyDirect.</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="sd">    nls : `sfepy.solvers.nls.Newton`</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="sd">        Nonlinear solver to be used. The default is Newton.</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">    wfs_dic : dict</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">        Dictionary of all weakforms used in the simulation. Item with key</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">        &#39;weakforms&#39; represents the weakforms associated with the PDE to be</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">        solved (1 wf for bounded domains, 2 wfs for unbounded ones). Other</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd">        weakforms are for supplementary purposes (evaluation of the strong</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">        residual, line-search...).</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="sd">    nwf : int</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">        Number of weak forms provided to the solver.</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">    islinear : bool</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">        Whether or not the PDE to be solved is linear.</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="sd">    is_bounded : bool</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="sd">        Whether or not the domain is bounded.</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="sd">    iter : int, optional</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="sd">        Maximum number of newton/picard iterations (defined if islinear is</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a><span class="sd">        False).</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="sd">    initial_guess : list, optional</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="sd">        List of initial guesses (one per weak form) used to initialize</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="sd">        nonlinear solver (defined if islinear is False).The default is a scalar</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="sd">        field set to zero everywhere.</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="sd">    relax : float, optional</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a><span class="sd">        Relaxation parameter for newton/picard method (defined if islinear is</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">        False). The default is 0.9.</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a><span class="sd">    criteria : `Criteria` instance, optional</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a><span class="sd">        Criteria instance gathering the directives for when to stop nonlinear</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a><span class="sd">        iterations (defined if islinear is False). The default is to iterate</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a><span class="sd">        20 times.</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a><span class="sd">    has_converged : bool</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a><span class="sd">        False until the Criteria instance decrees convergence has been reached</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a><span class="sd">        (defined if islinear is False).</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a><span class="sd">    sols : list</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a><span class="sd">        List of the solution(s) (one per weak form).</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a><span class="sd">    cogammas : list</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a><span class="sd">        List of two `sfepy.discrete.common.region.Region` instances</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a><span class="sd">        corresponding to the interior and exterior domain common frontier</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a><span class="sd">        (defined if nwf = 2).</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a><span class="sd">    conn : str</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a><span class="sd">        Method for linking the interior domain with the exterior domain</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a><span class="sd">        [&#39;connected&#39; , &#39;ping-pong&#39;]. The default is &#39;connected&#39;.</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a><span class="sd">    max_iter_pp : int</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a><span class="sd">        Maximum number of iterations for the ping-pong method (defined if</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a><span class="sd">        conn = &#39;ping-pong&#39;). The default is 7.</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a><span class="sd">    relax_pp :  float</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="sd">        Relaxation parameter for ping-pong iterations (between 0 and 1).</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">        The default is 0.7.</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="sd">    bounds : list</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="sd">        List of the min &amp; max field values (can be crucial to prevent</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="sd">        divergence in the solution for nonlinear problems).</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a><span class="sd">    oldsols : list</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="sd">        List of the solution(s) at the previous iteration (one per weak form).</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="sd">    buffersols : list</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a><span class="sd">        Temporary storage of the solution(s).</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a><span class="sd">    outfiles : list</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a><span class="sd">        List of the exported .vtk files containing simulation results.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a><span class="sd">    save_all_newton : bool</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a><span class="sd">        Save all Newton&#39;s iterations (for nonlinear problems only).</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a><span class="sd">        The default is False.</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a><span class="sd">    verbose : bool</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="sd">        Display user&#39;s information. The default is False.</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>    <span class="n">forbidden_nl_arg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;update_nl&#39;</span><span class="p">,</span> <span class="s1">&#39;rho&#39;</span><span class="p">,</span> <span class="s1">&#39;rho_vac&#39;</span><span class="p">,</span> <span class="s1">&#39;Rcut&#39;</span><span class="p">,</span> <span class="s1">&#39;solver&#39;</span><span class="p">]</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class variable `forbidden_nl_arg` is a list of material extra-arguments</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a><span class="sd">    (strings) which are not to be interpreted as non-linear terms.</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a><span class="sd">    Consequently, material&#39;s data will not be updated when calling the function</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a><span class="sd">    `update_material` unless the material&#39;s function has at least one extra-</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a><span class="sd">    argument not contained in that list.&quot;&quot;&quot;</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wfs_dic</span><span class="p">,</span> <span class="n">islinear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a><span class="sd">        Construct a Solver instance.</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a><span class="sd">        Parameters</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a><span class="sd">        ----------</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a><span class="sd">        weakforms : list</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a><span class="sd">            List of one or two WeakForm instances.</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="sd">        islinear : bool, optional</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="sd">            Whether or not the PDE to be solved is linear. The default is True.</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a><span class="sd">        kwargs</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="sd">            *Cf class documentation*</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Display Sfepy console&#39;s messages</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">print_kappa</span> <span class="o">=</span>  <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;print_kappa&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>        <span class="c1"># Solver(s) &amp; precision</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eps_dic</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eps_dic&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;eps_a&#39;</span> <span class="p">:</span> <span class="mf">1e-15</span><span class="p">,</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>                                              <span class="s1">&#39;eps_r&#39;</span> <span class="p">:</span> <span class="mf">1e-15</span><span class="p">,</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>                                              <span class="s1">&#39;i_max&#39;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>        <span class="c1"># self.ls = kwargs.get(&#39;ls&#39;, AutoDirect({}))</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ls</span> <span class="o">=</span> <span class="n">ScipyDirect</span><span class="p">({})</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nls</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nls&#39;</span><span class="p">,</span> <span class="n">Newton</span><span class="p">({</span><span class="s1">&#39;is_linear&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>                                            <span class="n">lin_solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">,</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>                                            <span class="n">status</span><span class="o">=</span><span class="n">IndexedStruct</span><span class="p">()))</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>        <span class="c1"># Weak Forms</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span> <span class="o">=</span> <span class="n">wfs_dic</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>        <span class="n">weakforms</span> <span class="o">=</span> <span class="n">wfs_dic</span><span class="p">[</span><span class="s1">&#39;weakforms&#39;</span><span class="p">]</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span> <span class="o">=</span> <span class="n">weakforms</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weakforms</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> \
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>                                   <span class="k">else</span> <span class="p">[</span><span class="n">weakforms</span><span class="p">]</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">)</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_bounded</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_bounded&#39;</span><span class="p">)</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>        <span class="c1"># TODO: pre-allocate solutions&#39; arrays</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">oldsols</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buffersols</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sols</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bounds&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">1e15</span><span class="p">,</span> <span class="mf">1e15</span><span class="p">])</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>        <span class="c1"># Non-linear problems</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">islinear</span> <span class="o">=</span> <span class="n">islinear</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">islinear</span><span class="p">:</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>            <span class="n">wf_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_res&#39;</span><span class="p">)</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>            <span class="n">wf_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_G&#39;</span><span class="p">)</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>            <span class="n">initial_guess</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_guess&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_guess</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>                <span class="k">for</span> <span class="n">wf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">:</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>                    <span class="n">initial_guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">n_nod</span><span class="p">))</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwf</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">initial_guess</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>                <span class="n">initial_guess</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_guess</span><span class="p">]</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">initial_guess</span> <span class="o">=</span> <span class="n">initial_guess</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">oldsols</span> <span class="o">=</span> <span class="n">copy_list_of_arrays</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_guess</span><span class="p">)</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">relax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relax&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;criteria&#39;</span><span class="p">,</span> <span class="n">StopCriteria</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">has_converged</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save_all_newton</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_all_newton&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>            <span class="c1"># Set materials&#39; extra-arguements</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span><span class="n">oldsol</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">oldsols</span><span class="p">)):</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>                <span class="n">oldsol_qps</span> <span class="o">=</span> <span class="n">evaluate_at_qps</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">oldsol</span><span class="p">)</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>                <span class="n">oldsol_qps</span><span class="p">[</span><span class="n">oldsol_qps</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>                <span class="n">oldsol_qps</span><span class="p">[</span><span class="n">oldsol_qps</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>                <span class="n">set_mat_extra_arg</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">oldsol_qps</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>                <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">wf_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>                    <span class="n">set_mat_extra_arg</span><span class="p">(</span><span class="n">wf_res</span><span class="p">,</span> <span class="n">oldsol_qps</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>            <span class="c1"># line-search related weak form</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">line_search_bool</span> <span class="o">=</span> <span class="p">(</span><span class="n">wf_G</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> \
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>                <span class="ow">and</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;line_search_bool&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>        <span class="c1"># Unbounded domains</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sols</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cogammas</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cogammas&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conn&#39;</span><span class="p">,</span> <span class="s1">&#39;connected&#39;</span><span class="p">)</span> <span class="c1"># or &#39;ping-pong&#39;</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">max_iter_pp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_iter_pp&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">relax_pp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relax_pp&#39;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;connected&#39;</span><span class="p">:</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>                <span class="k">pass</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Connection keyword not recognized&quot;</span><span class="p">)</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>        <span class="c1"># Additional initializations</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_mtxvec_dic</span><span class="p">()</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">outfiles</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>    <span class="k">def</span> <span class="nf">init_mtxvec_dic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the dictionary of all matrices &amp; vectors. The keys</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a><span class="sd">        depend on the nature of the simulation (linear or nonlinear, connection</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a><span class="sd">        technique, etc.)&quot;&quot;&quot;</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>        <span class="n">mtxvec_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>        <span class="n">wf1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>        <span class="n">nwf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>        <span class="k">if</span> <span class="n">nwf</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">nwf</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;connected&#39;</span><span class="p">):</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>            <span class="k">if</span> <span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>        <span class="k">elif</span> <span class="n">nwf</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_mod_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>            <span class="k">if</span> <span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_mod_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>        <span class="n">wf_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_res&#39;</span><span class="p">)</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>        <span class="k">if</span> <span class="n">wf_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>            <span class="k">if</span> <span class="n">wf_res</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_mod_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mtxvec_dic</span> <span class="o">=</span> <span class="n">mtxvec_dic</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>    <span class="k">def</span> <span class="nf">init_problems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize problem instances. The keys of the `pbs_dic` depend on</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a><span class="sd">        the nature of the simulation (linear or nonlinear, connection</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a><span class="sd">        technique, etc.)&quot;&quot;&quot;</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>        <span class="n">wf1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>            <span class="n">ebcs</span> <span class="o">=</span> <span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">)</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>            <span class="n">epbcs</span> <span class="o">=</span> <span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">epbcs</span><span class="p">)</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>            <span class="n">eqs_cst</span> <span class="o">=</span> <span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">])</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>            <span class="n">pb_cst</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst&#39;</span><span class="p">,</span> <span class="n">equations</span><span class="o">=</span><span class="n">eqs_cst</span><span class="p">,</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>            <span class="n">pb_cst</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">ebcs</span><span class="p">,</span> <span class="n">epbcs</span><span class="o">=</span><span class="n">epbcs</span><span class="p">)</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>            <span class="n">pb_cst</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>            <span class="k">if</span> <span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>                <span class="n">eqs_mod</span> <span class="o">=</span> <span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">])</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>                <span class="n">pb_mod</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod&#39;</span><span class="p">,</span> <span class="n">equations</span><span class="o">=</span><span class="n">eqs_mod</span><span class="p">,</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>                <span class="n">pb_mod</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">ebcs</span><span class="p">,</span> <span class="n">epbcs</span><span class="o">=</span><span class="n">epbcs</span><span class="p">)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>                <span class="n">pb_mod</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>            <span class="n">wf2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;connected&#39;</span><span class="p">:</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>                <span class="k">def</span> <span class="nf">zero_shift</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">coors</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">coors</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>                <span class="n">match_coors</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="s1">&#39;match_coors&#39;</span><span class="p">,</span> <span class="n">per</span><span class="o">.</span><span class="n">match_coors</span><span class="p">)</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>                <span class="n">shift_fun</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="s1">&#39;shift_fun&#39;</span><span class="p">,</span> <span class="n">zero_shift</span><span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>                <span class="n">lcbcs</span> <span class="o">=</span> <span class="n">Conditions</span><span class="p">(</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>                    <span class="p">[</span><span class="n">LinearCombinationBC</span><span class="p">(</span><span class="s1">&#39;lc12&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cogammas</span><span class="p">,</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>                    <span class="p">{</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.all&#39;</span> <span class="o">%</span><span class="n">wf1</span><span class="o">.</span><span class="n">unknown_name</span> <span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.all&#39;</span> <span class="o">%</span><span class="n">wf2</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">},</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>                    <span class="n">match_coors</span><span class="p">,</span> <span class="s1">&#39;shifted_periodic&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">(</span><span class="n">shift_fun</span><span class="p">,))])</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>                <span class="n">ebcs</span> <span class="o">=</span> <span class="n">Conditions</span><span class="p">(</span><span class="n">concatenate</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">,</span> <span class="n">wf2</span><span class="o">.</span><span class="n">ebcs</span><span class="p">]))</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>                <span class="n">epbcs</span> <span class="o">=</span> <span class="n">Conditions</span><span class="p">(</span><span class="n">concatenate</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">epbcs</span><span class="p">,</span> <span class="n">wf2</span><span class="o">.</span><span class="n">epbcs</span><span class="p">]))</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>                <span class="n">eqs_cst</span> <span class="o">=</span> <span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">,</span> <span class="n">wf2</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">])</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>                <span class="n">pb_cst</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst&#39;</span><span class="p">,</span> <span class="n">equations</span><span class="o">=</span><span class="n">eqs_cst</span><span class="p">,</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>                <span class="n">pb_cst</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">ebcs</span><span class="p">,</span> <span class="n">epbcs</span><span class="o">=</span><span class="n">epbcs</span><span class="p">,</span> <span class="n">lcbcs</span><span class="o">=</span><span class="n">lcbcs</span><span class="p">)</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>                <span class="n">pb_cst</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>                <span class="k">if</span> <span class="n">wf2</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>                    <span class="n">eqs_mod</span> <span class="o">=</span> <span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">,</span> <span class="n">wf2</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">])</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>                    <span class="n">pb_mod</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod&#39;</span><span class="p">,</span> <span class="n">equations</span><span class="o">=</span><span class="n">eqs_mod</span><span class="p">,</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>                                     <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>                    <span class="n">pb_mod</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">ebcs</span><span class="p">,</span> <span class="n">epbcs</span><span class="o">=</span><span class="n">epbcs</span><span class="p">,</span> <span class="n">lcbcs</span><span class="o">=</span><span class="n">lcbcs</span><span class="p">)</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>                    <span class="n">pb_mod</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>                <span class="n">pb_cst_pp1</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst_pp1&#39;</span><span class="p">,</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>                                     <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">]),</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>                                     <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>                <span class="n">pb_cst_pp1</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>                                   <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>                <span class="n">pb_cst_pp1</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst_pp1</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>                <span class="n">pb_cst_pp2</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst_pp2&#39;</span><span class="p">,</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>                                     <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf2</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">]),</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>                                     <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>                <span class="n">pb_cst_pp2</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf2</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>                                   <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf2</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>                <span class="n">pb_cst_pp2</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst_pp2</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>                <span class="n">pb_mod_pp2</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod_pp2&#39;</span><span class="p">,</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>                                    <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf2</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">]),</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>                                    <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>                <span class="n">pb_mod_pp2</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf2</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>                                   <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf2</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>                <span class="n">pb_mod_pp2</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod_pp2</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>                <span class="k">if</span> <span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>                    <span class="n">pb_mod_pp1</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod_pp1&#39;</span><span class="p">,</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>                                        <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">]),</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>                                        <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>                    <span class="n">pb_mod_pp1</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>                                       <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>                    <span class="n">pb_mod_pp1</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod_pp1</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Connection keyword not recognized&quot;</span><span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>        <span class="n">wf_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_res&#39;</span><span class="p">)</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>        <span class="k">if</span> <span class="n">wf_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>            <span class="n">pb_cst_res</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst_res&#39;</span><span class="p">,</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>                                 <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf_res</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">]),</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>                                 <span class="n">active_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>            <span class="n">pb_cst_res</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_res</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>                               <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_res</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>            <span class="n">pb_cst_res</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst_res</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>            <span class="n">pb_mod_res</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod_res&#39;</span><span class="p">,</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>                                 <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf_res</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">]),</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>                                 <span class="n">active_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>            <span class="n">pb_mod_res</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_res</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>                               <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_res</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>            <span class="n">pb_mod_res</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod_res</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>        <span class="n">wf_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_G&#39;</span><span class="p">)</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>        <span class="k">if</span> <span class="n">wf_G</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>            <span class="n">pb_cst_G</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst_G&#39;</span><span class="p">,</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>                                <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf_G</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">]),</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>                                <span class="n">active_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>            <span class="n">pb_cst_G</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_G</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>                              <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_G</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>            <span class="n">pb_cst_G</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst_G</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>            <span class="n">pb_mod_G</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod_G&#39;</span><span class="p">,</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>                                <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf_G</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">]),</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>                                <span class="n">active_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>            <span class="n">pb_mod_G</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_G</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>                              <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_G</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>            <span class="n">pb_mod_G</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod_G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod_G</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>    <span class="k">def</span> <span class="nf">init_mtxvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Assemble all matrices and vectors. These objects are then accessible</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a><span class="sd">        through the `self.mtxvec_dic` dictionary.&quot;&quot;&quot;</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>        <span class="n">pb_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>        <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pb_list</span><span class="p">):</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>            <span class="k">if</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;pb_cst_G&#39;</span> <span class="ow">or</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;pb_mod_G&#39;</span><span class="p">:</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>                <span class="n">pb_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>        <span class="n">assemble_mtxvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pb_list</span><span class="p">)</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>    <span class="k">def</span> <span class="nf">update_mtxvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Re-assemble matrices and vectors associated with terms featured in</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a><span class="sd">        `eqn_mod` equations from all weak forms.&quot;&quot;&quot;</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>        <span class="n">pb_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>        <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>            <span class="n">pb_name</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>            <span class="k">if</span> <span class="n">pb_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;mod&#39;</span> <span class="ow">and</span> \
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>                <span class="p">(</span><span class="n">pb_name</span><span class="o">!=</span><span class="s1">&#39;pb_cst_G&#39;</span> <span class="ow">or</span> <span class="n">pb_name</span><span class="o">!=</span><span class="s1">&#39;pb_mod_G&#39;</span><span class="p">):</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>                <span class="n">pb_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>        <span class="n">assemble_mtxvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pb_list</span><span class="p">)</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Launch the FEM computation!&quot;&quot;&quot;</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">islinear</span><span class="p">:</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>            <span class="n">lsolve</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>            <span class="n">nlsolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="sd">        Save the results to vtk. This routine is a wrapper for</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="sd">        `femtoscope.inout.vtkfactory.createStructuredVTK`, which itself rely</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="sd">        on meshio.</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="sd">        Warning: the connectivity is reconstructed from scratch</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a><span class="sd">        Parameters</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a><span class="sd">        ----------</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a><span class="sd">        grad : bool, optional</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a><span class="sd">            Save the gradient of the scalar field. The default is False.</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a><span class="sd">        name : str, optional</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a><span class="sd">            Name of the output file (prefix).</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a><span class="sd">            </span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a><span class="sd">        Returns</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a><span class="sd">        -------</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a><span class="sd">        out : list</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a><span class="sd">            Result file names.</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>        <span class="kn">from</span> <span class="nn">femtoscope.inout.vtkfactory</span> <span class="kn">import</span> <span class="n">createStructuredVTK</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>        <span class="kn">from</span> <span class="nn">femtoscope.misc.util</span> <span class="kn">import</span> <span class="n">merge_dicts</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>        <span class="n">val_renorm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val_renorm&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>        <span class="n">grad_renorm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grad_renorm&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">((</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dimension</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>        <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">sol</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sols</span><span class="p">)):</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>            <span class="n">vars_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>            <span class="c1"># Retrieve coordinates and connectivity</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>            <span class="n">pos</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_coor</span><span class="p">()</span> <span class="c1"># also works with pos = field.coors</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>            <span class="n">X</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>            <span class="n">Y</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>            <span class="n">Z</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>            <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>                <span class="kn">from</span> <span class="nn">matplotlib.tri</span> <span class="kn">import</span> <span class="n">Triangulation</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>                <span class="n">cells</span> <span class="o">=</span> <span class="n">Triangulation</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">triangles</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>            <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>                <span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">Delaunay</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>                <span class="n">cells</span> <span class="o">=</span> <span class="n">Delaunay</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">.</span><span class="n">vertices</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>            <span class="n">vars_dic</span><span class="p">[</span><span class="n">wf</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_renorm</span> <span class="o">*</span> <span class="n">sol</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>            <span class="k">if</span> <span class="n">grad</span><span class="p">:</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>                <span class="n">gradsol</span> <span class="o">=</span> <span class="n">grad_renorm</span> <span class="o">*</span> <span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">evaluate_at</span><span class="p">(</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>                    <span class="n">pos</span><span class="p">,</span> <span class="n">sol</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;grad&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>                <span class="n">normgradsol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">gradsol</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>                <span class="n">vars_dic</span><span class="p">[</span><span class="s1">&#39;norm_grad_&#39;</span><span class="o">+</span><span class="n">wf</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">normgradsol</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>                <span class="n">vars_dic</span><span class="p">[</span><span class="s1">&#39;gradX_&#39;</span><span class="o">+</span><span class="n">wf</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gradsol</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>                <span class="n">vars_dic</span><span class="p">[</span><span class="s1">&#39;gradY_&#39;</span><span class="o">+</span><span class="n">wf</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gradsol</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>                <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>                    <span class="n">vars_dic</span><span class="p">[</span><span class="s1">&#39;gradZ_&#39;</span><span class="o">+</span><span class="n">wf</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gradsol</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">kk</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">islinear</span><span class="p">):</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>                <span class="n">vars_dic</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">res_vec</span><span class="o">.</span><span class="n">data</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>                <span class="n">merge_dicts</span><span class="p">(</span><span class="n">vars_dic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">res_vec_parts</span><span class="p">)</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">createStructuredVTK</span><span class="p">(</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>                <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">vars_dic</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">wf</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">outfiles</span> <span class="o">=</span> <span class="n">out</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>    
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>    <span class="k">def</span> <span class="nf">plot_residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a><span class="sd">        Plot the residual vector.</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a><span class="sd">        Since 22/05/23, it is no longer necessary to remove ebc-DOFs from the</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a><span class="sd">        coordinate array. The residual vector is not cropped anymore but</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a><span class="sd">        contains NaN values instead.</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a><span class="sd">        Parameters</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a><span class="sd">        ----------</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="sd">        log : bool, optional</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="sd">            If True, plot the log of the absolute value of the residual vector.</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="sd">            The default is False.</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a><span class="sd">        Returns</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a><span class="sd">        -------</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a><span class="sd">        ax : Axes</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a><span class="sd">            Figure axe.</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dimension</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>        <span class="n">res_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">res_vec</span><span class="p">)</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>        <span class="n">coors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">coors</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>            <span class="n">res_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">res_vec</span><span class="p">))</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>        
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">coors</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">res_vec</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Residual&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>        <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">coors</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coors</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">res_vec</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Residual&quot;</span><span class="p">)</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot plot residual for dimension </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">dim</span><span class="p">)</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>        <span class="k">return</span> <span class="n">ax</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a><span class="sd">        Display FEM results. The `solve` method must have been called on the</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a><span class="sd">        Solver instance beforehand.</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a><span class="sd">        Parameters</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a><span class="sd">        ----------</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a><span class="sd">        grad : bool, optional</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a><span class="sd">            Save the gradient of the scalar field. The default is False.</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a><span class="sd">        kwargs :</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a><span class="sd">            Potential extra arguments (to be added in the future).</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a><span class="sd">        Returns</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a><span class="sd">        -------</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a><span class="sd">        None.</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>        <span class="kn">from</span> <span class="nn">femtoscope.display.fea_plot</span> <span class="kn">import</span> <span class="n">plot_from_vtk</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outfiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">grad</span><span class="o">=</span><span class="n">grad</span><span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>            <span class="n">delete</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>        <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outfiles</span><span class="p">:</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>            <span class="n">plot_from_vtk</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>            <span class="k">if</span> <span class="n">delete</span><span class="p">:</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>        <span class="kn">from</span> <span class="nn">femtoscope.misc.util</span> <span class="kn">import</span> <span class="n">remove_empty_lines</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>        <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a><span class="s2">        Solver:</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a><span class="s2">            # weak-form(s): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nwf</span><span class="si">}</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a><span class="s2">        &quot;&quot;&quot;</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_bounded</span><span class="p">:</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>            <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a><span class="s2">            bounded domain</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a><span class="s2">            &quot;&quot;&quot;</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>            <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a><span class="s2">            unbounded domain</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a><span class="s2">            &quot;&quot;&quot;</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>            <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a><span class="s2">            ping-pong max iter: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter_pp</span><span class="si">}</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a><span class="s2">            &quot;&quot;&quot;</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">islinear</span><span class="p">:</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>            <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a><span class="s2">            is linear?: YES</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a><span class="s2">            &quot;&quot;&quot;</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>            <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a><span class="s2">            is linear?: NO</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a><span class="s2">            relax parameter: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="si">}</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a><span class="s2">            &quot;&quot;&quot;</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>            <span class="n">string</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>        <span class="k">return</span> <span class="n">remove_empty_lines</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a><span class="k">class</span> <span class="nc">StopCriteria</span><span class="p">:</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a><span class="sd">    Class defining stopping conditions for nonlinear problems.</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="sd">    Attributes</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a><span class="sd">    ----------</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a><span class="sd">    min_iter : int</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a><span class="sd">        Minimum number of Newton iterations. The default is 8.</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a><span class="sd">    max_iter : int</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a><span class="sd">        Maximum number of Newton iterations.</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a><span class="sd">    sol_delta_tol : float</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a><span class="sd">        Threshold on the minimum relative distance (in 2-norm) between two</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a><span class="sd">        successive iterations.</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a><span class="sd">    active_dic : dict</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a><span class="sd">        Dictionary for knowing which criteria are active and which are not.</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a><span class="sd">    verbose : bool</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a><span class="sd">        Display user&#39;s information. The default is False.</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a><span class="sd">    stop : bool</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a><span class="sd">        False until some stopping criterion is met.</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a><span class="sd">    res_vec : ndarray</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a><span class="sd">        Current strong residual vector.</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a><span class="sd">    res_vec_parts : dic</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a><span class="sd">        Dictionary with keys (&#39;mtx&#39;, &#39;rhs_cst&#39;, &#39;rhs_mod&#39;) and values each term</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a><span class="sd">        of the strong residual vector.</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a><span class="sd">    res : float</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a><span class="sd">        Current value of the strong residual (L2-norm).</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a><span class="sd">    sol_delta : float</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a><span class="sd">        Current value of the relative distance between two successive</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a><span class="sd">        iterations.</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a><span class="sd">    history : list of dicts</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a><span class="sd">        List of dictionaries containing all the above parameters for monitoring</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a><span class="sd">        convergence.</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a><span class="sd">    last_relax_update : List of int</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a><span class="sd">        Last iteration number for which the relaxation parameter of the Newton</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a><span class="sd">        method was decreased.</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">,</span> <span class="n">min_iter</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span> <span class="k">if</span> <span class="n">max_iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">50</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">min_iter</span> <span class="o">=</span> <span class="n">min_iter</span> <span class="k">if</span> <span class="n">min_iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">8</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res_delta_tol</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sol_delta_tol</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res_vec</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res_vec_parts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sol_delta</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>        <span class="c1"># Dictionary of active stopping criteria</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>        <span class="n">active_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>        <span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;res_delta_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;res_delta_tol&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>        <span class="k">if</span> <span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;res_delta_tol&#39;</span><span class="p">]:</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">res_delta_tol</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;res_delta_tol&#39;</span><span class="p">)</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>        <span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;sol_delta_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;sol_delta_tol&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>        <span class="k">if</span> <span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;sol_delta_tol&#39;</span><span class="p">]:</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sol_delta_tol</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sol_delta_tol&#39;</span><span class="p">)</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">active_dic</span> <span class="o">=</span> <span class="n">active_dic</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a><span class="s2">        Stop Criteria:</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a><span class="s2">            max iter: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="si">}</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a><span class="s2">            relative delta_sol tolerance: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sol_delta_tol</span><span class="si">}</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a><span class="s2">            relative delta_res tolerance: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">res_delta_tol</span><span class="si">}</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a><span class="s2">        &quot;&quot;&quot;</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a><span class="sd">        Evaluate all the criteria set active. Some additional indicators are</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a><span class="sd">        computed but are intended for information purposes only.</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a><span class="sd">        Parameters</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a><span class="sd">        ----------</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a><span class="sd">        solver : `Solver` instance</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a><span class="sd">            The solver instance.</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a><span class="sd">        Returns</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a><span class="sd">        -------</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a><span class="sd">        bool</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a><span class="sd">            True if one of the stopping criterion has been met, False otherwise.</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>        <span class="c1"># Set to None</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>        <span class="n">sol_delta</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>        <span class="n">res_delta</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>        <span class="n">res_L2</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>        <span class="n">res_mean</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>        <span class="n">res_inf</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>        <span class="c1"># strong residual evaluation</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>        <span class="n">res_vec</span><span class="p">,</span> <span class="n">res_vec_parts</span> <span class="o">=</span> <span class="n">strong_residual</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>        <span class="n">res_L2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">res_vec</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>        <span class="n">res_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">res_vec</span><span class="p">))</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>        <span class="n">res_inf</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">res_vec</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_vec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>            <span class="n">res_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">res_vec</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">res_vec</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>            <span class="n">res_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>        <span class="c1"># distance between two successive iterations</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>            <span class="n">delta</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>            <span class="n">denominator</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>            <span class="k">for</span> <span class="n">oldsol</span><span class="p">,</span> <span class="n">newsol</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">oldsols</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">):</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">oldsol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">newsol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>                    <span class="n">delta</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">newsol</span><span class="o">-</span><span class="n">oldsol</span><span class="p">)</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>                    <span class="n">denominator</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">oldsol</span><span class="p">)</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>            <span class="n">sol_delta</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">denominator</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>            <span class="n">sol_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sol_delta</span> <span class="o">=</span> <span class="n">sol_delta</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">res_L2</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res_vec</span> <span class="o">=</span> <span class="n">res_vec</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res_vec_parts</span> <span class="o">=</span> <span class="n">res_vec_parts</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0: &lt;17}</span><span class="s2"> </span><span class="si">{1:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Sol rel delta&quot;</span><span class="p">,</span> <span class="n">sol_delta</span><span class="p">))</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0: &lt;17}</span><span class="s2"> </span><span class="si">{1:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Residual L2&quot;</span><span class="p">,</span> <span class="n">res_L2</span><span class="p">))</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0: &lt;17}</span><span class="s2"> </span><span class="si">{1:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Residual mean&quot;</span><span class="p">,</span> <span class="n">res_mean</span><span class="p">))</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0: &lt;17}</span><span class="s2"> </span><span class="si">{1:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Residual inf&quot;</span><span class="p">,</span> <span class="n">res_inf</span><span class="p">))</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0: &lt;17}</span><span class="s2"> </span><span class="si">{1:.3E}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Residual rel delta&quot;</span><span class="p">,</span> <span class="n">res_delta</span><span class="p">))</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fill_history</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">iter</span><span class="p">,</span> <span class="n">sol_delta</span><span class="p">,</span> <span class="n">res_delta</span><span class="p">,</span> <span class="n">res_L2</span><span class="p">,</span> <span class="n">res_mean</span><span class="p">,</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>                          <span class="n">res_inf</span><span class="p">)</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>        <span class="c1"># Active criteria</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;sol_delta_tol&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_iter</span><span class="p">:</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>            <span class="k">if</span> <span class="n">sol_delta</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol_delta_tol</span><span class="p">:</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">has_converged</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STOP: Delta in successive iterations is small&quot;</span><span class="p">)</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;res_delta_tol&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_iter</span><span class="p">:</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>            <span class="k">if</span> <span class="n">res_delta</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_delta_tol</span><span class="p">:</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">has_converged</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STOP: Residual variation is small&quot;</span><span class="p">)</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">:</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STOP: Maximum number of iteration has been reached&quot;</span><span class="p">)</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>    <span class="k">def</span> <span class="nf">fill_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">niter</span><span class="p">,</span> <span class="n">sol_delta</span><span class="p">,</span> <span class="n">res_delta</span><span class="p">,</span> <span class="n">res_L2</span><span class="p">,</span> <span class="n">res_mean</span><span class="p">,</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>                     <span class="n">res_inf</span><span class="p">):</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>        <span class="n">iter_dic</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>            <span class="s1">&#39;iter&#39;</span><span class="p">:</span> <span class="n">niter</span><span class="p">,</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>            <span class="s1">&#39;sol delta&#39;</span> <span class="p">:</span> <span class="n">sol_delta</span><span class="p">,</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>            <span class="s1">&#39;res delta&#39;</span> <span class="p">:</span> <span class="n">res_delta</span><span class="p">,</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>            <span class="s1">&#39;res L2&#39;</span> <span class="p">:</span> <span class="n">res_L2</span><span class="p">,</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>            <span class="s1">&#39;res mean&#39;</span> <span class="p">:</span> <span class="n">res_mean</span><span class="p">,</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>            <span class="s1">&#39;res inf&#39;</span> <span class="p">:</span> <span class="n">res_inf</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>            <span class="p">}</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">==</span> <span class="p">[]:</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>            <span class="n">iter_dic</span><span class="p">[</span><span class="s1">&#39;res_k / res_0 (%)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>            <span class="n">iter_dic</span><span class="p">[</span><span class="s1">&#39;res_k / res_0 (%)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_L2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;res L2&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iter_dic</span><span class="p">)</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>    <span class="k">def</span> <span class="nf">adjust_relax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a><span class="sd">        Based on the analyis of the current convergence-history of the on-going</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a><span class="sd">        nonlinear equation solving, the relaxation parameter manually decreased</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a><span class="sd">        to achieve convergence of Newton&#39;s iterations. The two following</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="sd">        conditions must be satisfied simultaneously:</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="sd">            - the relative delta has stopped decreasing</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a><span class="sd">            - the residual in 2-norm has stopped decreasing</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="sd">        Parameters</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="sd">        ----------</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a><span class="sd">        solver : `Solver` instance</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a><span class="sd">            The solver instance.</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="sd">        history_size : int, optional</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">            Number of past iteration used to check the two stalling conditions.</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a><span class="sd">            The default is 3.</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a><span class="sd">        factor : float, optional</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a><span class="sd">            Factor by which the relaxation parameter is multiplied (should be</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a><span class="sd">            strictly smaller than 1). The default value is 0.8.</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>        
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>        <span class="k">assert</span> <span class="n">factor</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">factor</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;</span> <span class="n">history_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>            <span class="n">res_L2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;res L2&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">history_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>            <span class="n">sol_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;sol delta&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">history_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>            <span class="n">cond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">sol_delta</span><span class="p">)</span><span class="o">/</span><span class="n">sol_delta</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1e-2</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            <span class="n">cond2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">res_L2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">res_L2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1e-2</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>            <span class="k">if</span> <span class="n">cond1</span> <span class="ow">and</span> <span class="n">cond2</span><span class="p">:</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>                    <span class="n">factor</span> <span class="o">*=</span> <span class="mf">1e-2</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>                    <span class="n">factor</span> <span class="o">*=</span> <span class="mf">0.25</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>                    <span class="n">factor</span> <span class="o">*=</span> <span class="mf">0.5</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">relax</span> <span class="o">*=</span> <span class="n">factor</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>                <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;! Decreasing relax. param. to </span><span class="si">{:.3f}</span><span class="s2"> !</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>                        <span class="n">solver</span><span class="o">.</span><span class="n">relax</span><span class="p">))</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>        
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a><span class="k">def</span> <span class="nf">lsolve</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a><span class="sd">    Linear solve function.</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a><span class="sd">    Parameters</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a><span class="sd">    ----------</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a><span class="sd">    solver : `Solver` instance</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a><span class="sd">        The solver instance.</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a><span class="sd">    buffer : bool, optional</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a><span class="sd">        If True, the computed solution is kept in *solver.buffersols*. This is</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a><span class="sd">        only relevant to nonlinear problems. The way the buffer is unload into</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a><span class="sd">        *solver.sols* depends on the nonlinear method implementation.</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a><span class="sd">        The default is False.</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>    <span class="c1"># Retrieve tolerance settings</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>    <span class="n">eps_a</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">eps_dic</span><span class="p">[</span><span class="s1">&#39;eps_a&#39;</span><span class="p">]</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>    <span class="n">eps_r</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">eps_dic</span><span class="p">[</span><span class="s1">&#39;eps_r&#39;</span><span class="p">]</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>    <span class="n">i_max</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">eps_dic</span><span class="p">[</span><span class="s1">&#39;i_max&#39;</span><span class="p">]</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>    <span class="n">mtxvec_dic</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>    <span class="c1"># Setup problem instances &amp; assemble matrices / vectors</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">solver</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">init_problems</span><span class="p">()</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">init_mtxvec</span><span class="p">()</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>    <span class="n">nwf</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>    <span class="n">status</span> <span class="o">=</span> <span class="n">IndexedStruct</span><span class="p">()</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>    <span class="n">update_global_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>    <span class="n">ls</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">nls</span><span class="o">.</span><span class="n">lin_solver</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>    <span class="c1"># Single domain</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>    <span class="k">if</span> <span class="n">nwf</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>        <span class="n">pb</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst&#39;</span><span class="p">]</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>        <span class="n">mtx</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx&#39;</span><span class="p">]</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>        <span class="n">rhs</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs&#39;</span><span class="p">]</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>        <span class="n">vec_x</span> <span class="o">=</span> <span class="n">ls</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eps_a</span><span class="o">=</span><span class="n">eps_a</span><span class="p">,</span> <span class="n">eps_r</span><span class="o">=</span><span class="n">eps_r</span><span class="p">,</span> <span class="n">mtx</span><span class="o">=</span><span class="n">mtx</span><span class="p">,</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>                   <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>        <span class="n">sol</span> <span class="o">=</span> <span class="n">reconstruct_full_sol</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">vec_x</span><span class="p">)</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>    <span class="c1"># Double domain</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>    <span class="k">elif</span> <span class="n">nwf</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>        <span class="n">wf1</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>        <span class="n">wf2</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>        <span class="c1"># Virtual connection of DOFs at the boundary</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;connected&#39;</span><span class="p">:</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>            <span class="n">pb</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst&#39;</span><span class="p">]</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>            <span class="n">mtx</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx&#39;</span><span class="p">]</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>            <span class="n">rhs</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs&#39;</span><span class="p">]</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>            <span class="n">vec_x</span> <span class="o">=</span> <span class="n">ls</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eps_a</span><span class="o">=</span><span class="n">eps_a</span><span class="p">,</span> <span class="n">eps_r</span><span class="o">=</span><span class="n">eps_r</span><span class="p">,</span> <span class="n">mtx</span><span class="o">=</span><span class="n">mtx</span><span class="p">,</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>                       <span class="n">i_max</span><span class="o">=</span><span class="n">i_max</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>            <span class="n">sol</span> <span class="o">=</span> <span class="n">reconstruct_full_sol</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">vec_x</span><span class="p">)</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[:</span><span class="n">wf1</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">n_nod</span><span class="p">]</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="n">wf1</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">n_nod</span><span class="p">:]</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>        <span class="c1"># DtN / NtD iterations (&#39;ping-pong&#39;)</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>        <span class="k">elif</span> <span class="n">solver</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">relax_pp</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>            <span class="n">convergence_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>            <span class="n">old_pp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">n_nod</span><span class="p">)</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>            <span class="n">old_pp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">n_nod</span><span class="p">)</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>            <span class="n">pb_cst_pp1</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_pp1&#39;</span><span class="p">]</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>            <span class="n">pb_cst_pp2</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_pp2&#39;</span><span class="p">]</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>            
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">max_iter_pp</span><span class="p">):</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>                <span class="c1"># Dirichlet BC on interior domain</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>                <span class="n">mtx_pp1</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_pp1&#39;</span><span class="p">]</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>                <span class="n">rhs_pp1</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_pp1&#39;</span><span class="p">]</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>                <span class="n">vec_x_pp1</span> <span class="o">=</span> <span class="n">ls</span><span class="p">(</span><span class="n">rhs_pp1</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eps_a</span><span class="o">=</span><span class="n">eps_a</span><span class="p">,</span> <span class="n">eps_r</span><span class="o">=</span><span class="n">eps_r</span><span class="p">,</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>                               <span class="n">mtx</span><span class="o">=</span><span class="n">mtx_pp1</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>                <span class="n">sol_pp1</span> <span class="o">=</span> <span class="n">reconstruct_full_sol</span><span class="p">(</span><span class="n">pb_cst_pp1</span><span class="p">,</span> <span class="n">vec_x_pp1</span><span class="p">)</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_pp1</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>                <span class="c1"># Neumann BC on inversed exterior domain</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>                <span class="n">update_neumann</span><span class="p">(</span><span class="n">wf2</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">cogammas</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>                <span class="n">assemble_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod_pp2&#39;</span><span class="p">],</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>                                <span class="n">assemble_mtx</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># do not rebuild matrices!</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>                <span class="n">mtx_mod_pp2</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mtx_mod_pp2&#39;</span><span class="p">)</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>                <span class="k">if</span> <span class="n">mtx_mod_pp2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>                    <span class="n">mtx_pp2</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_pp2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">mtx_mod_pp2</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>                    <span class="n">mtx_pp2</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_pp2&#39;</span><span class="p">]</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>                <span class="n">rhs_mod_pp2</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rhs_mod_pp2&#39;</span><span class="p">)</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>                <span class="k">if</span> <span class="n">rhs_mod_pp2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>                    <span class="n">rhs_pp2</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_pp2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">rhs_mod_pp2</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>                    <span class="n">rhs_pp2</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_pp2&#39;</span><span class="p">]</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>                <span class="n">vec_x_pp2</span> <span class="o">=</span> <span class="n">ls</span><span class="p">(</span><span class="n">rhs_pp2</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eps_a</span><span class="o">=</span><span class="n">eps_a</span><span class="p">,</span> <span class="n">eps_r</span><span class="o">=</span><span class="n">eps_r</span><span class="p">,</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>                               <span class="n">mtx</span><span class="o">=</span><span class="n">mtx_pp2</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>                <span class="n">sol_pp2</span> <span class="o">=</span> <span class="n">reconstruct_full_sol</span><span class="p">(</span><span class="n">pb_cst_pp2</span><span class="p">,</span> <span class="n">vec_x_pp2</span><span class="p">)</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>                <span class="c1"># Reset Dirichlet BC on the interior domain using the solution</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>                <span class="c1"># on the inversed exterior domain that we just calculated...</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>                <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>                    <span class="n">sol_relax</span> <span class="o">=</span> <span class="n">theta</span><span class="o">*</span><span class="n">sol_pp2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">old_pp2</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>                    <span class="n">sol_relax</span> <span class="o">=</span> <span class="n">sol_pp2</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>                <span class="n">reset_dirichlet</span><span class="p">(</span><span class="n">sol_relax</span><span class="p">,</span> <span class="n">wf1</span><span class="p">,</span> <span class="n">wf2</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">cogammas</span><span class="p">)</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>                <span class="n">pb_cst_pp1</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>                                   <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>                <span class="n">pb_cst_pp1</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">apply_ebc</span><span class="p">()</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>                <span class="n">pb_mod_pp1</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">pbs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pb_mod_pp1&#39;</span><span class="p">)</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>                <span class="k">if</span> <span class="n">pb_mod_pp1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>                    <span class="n">pb_mod_pp1</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>                                       <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>                    <span class="n">pb_mod_pp1</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">apply_ebc</span><span class="p">()</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>                <span class="c1"># ... which involves re-assembling rhs vectors</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>                <span class="n">assemble_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">pb_cst_pp1</span><span class="p">,</span> <span class="n">assemble_mtx</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>                <span class="n">assemble_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">pb_mod_pp1</span><span class="p">)</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>                <span class="n">update_global_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>                
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>                <span class="c1"># check if convergence has been reached</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>                <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>                    <span class="n">norm_delta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">sol_pp1</span><span class="o">-</span><span class="n">old_pp1</span><span class="p">)</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>                    <span class="n">norm_delta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">sol_pp2</span><span class="o">-</span><span class="n">old_pp2</span><span class="p">)</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>                    <span class="n">norm_old1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">old_pp1</span><span class="p">)</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>                    <span class="n">norm_old2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">old_pp2</span><span class="p">)</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>                    <span class="n">rel_delta</span> <span class="o">=</span> <span class="n">norm_delta1</span><span class="o">/</span><span class="n">norm_old1</span> <span class="o">+</span> <span class="n">norm_delta2</span><span class="o">/</span><span class="n">norm_old2</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>                    <span class="n">convergence_flag</span> <span class="o">=</span> <span class="n">rel_delta</span> <span class="o">&lt;</span> <span class="mf">1e-8</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>                
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>                <span class="c1"># update auxiliary array</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>                <span class="n">old_pp1</span> <span class="o">=</span> <span class="n">sol_pp1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>                <span class="n">old_pp2</span> <span class="o">=</span> <span class="n">sol_pp2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>                
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>                <span class="k">if</span> <span class="n">convergence_flag</span><span class="p">:</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>                    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">verbose</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">islinear</span><span class="p">):</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ping-pong convergence in </span><span class="si">{}</span><span class="s2"> iter&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a>                    <span class="k">break</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_pp1</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_pp2</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not implemented&quot;</span> <span class="o">%</span><span class="n">solver</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;femtoscope cannot deal with more than 2 domains&quot;</span><span class="p">)</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">buffer</span><span class="p">:</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">sols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">]</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>        
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>    <span class="c1"># compute the condition number of the stifness matrix</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">print_kappa</span><span class="p">:</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>        <span class="kn">from</span> <span class="nn">scipy.sparse.linalg</span> <span class="kn">import</span> <span class="n">eigsh</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>            <span class="n">mtx</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_pp1&#39;</span><span class="p">]</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>        <span class="n">max_eig</span> <span class="o">=</span> <span class="n">eigsh</span><span class="p">(</span><span class="n">mtx</span><span class="p">,</span> <span class="n">return_eigenvectors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;LM&#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>        <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1e-8</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>        <span class="n">min_eig</span> <span class="o">=</span> <span class="n">eigsh</span><span class="p">(</span><span class="n">mtx</span><span class="p">,</span> <span class="n">return_eigenvectors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>        <span class="k">while</span> <span class="n">min_eig</span> <span class="o">&lt;</span> <span class="n">sigma</span> <span class="ow">and</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>            <span class="n">sigma</span> <span class="o">/=</span> <span class="mi">100</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>            <span class="n">min_eig</span> <span class="o">=</span> <span class="n">eigsh</span><span class="p">(</span><span class="n">mtx</span><span class="p">,</span> <span class="n">return_eigenvectors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>        <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>            <span class="kn">import</span> <span class="nn">warnings</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Could not compute the condition number!&quot;</span><span class="p">)</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>            <span class="n">kappa</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_eig</span><span class="o">/</span><span class="n">min_eig</span><span class="p">)</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matrix condition number = </span><span class="si">{:.2e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kappa</span><span class="p">))</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a><span class="k">def</span> <span class="nf">nlsolve</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a><span class="sd">    Nonlinear solve function based on Newton iterations. Each iteration is</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a><span class="sd">    associated with a linear problem that is solved by calling the `solve()`</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a><span class="sd">    function.</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a><span class="sd">    Parameters</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a><span class="sd">    ----------</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a><span class="sd">    solver : `Solver` instance</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a><span class="sd">        The solver instance.</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a><span class="sd">        </span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a><span class="sd">    Other Parameters</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a><span class="sd">    ----------------</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a><span class="sd">    save_all_newton : bool, optional</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a><span class="sd">        If true, save all Newton&#39;s iterations (solution, residual...).</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a><span class="sd">        The default is False.</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a><span class="sd">    Returns</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a><span class="sd">    -------</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a><span class="sd">    None.</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>    <span class="n">save_all_newton</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_all_newton&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>    <span class="n">solver</span><span class="o">.</span><span class="n">save_all_newton</span> <span class="o">=</span> <span class="n">save_all_newton</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>    <span class="k">if</span> <span class="n">save_all_newton</span><span class="p">:</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>        <span class="kn">from</span> <span class="nn">femtoscope</span> <span class="kn">import</span> <span class="n">RESULT_DIR</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>        <span class="kn">from</span> <span class="nn">femtoscope.misc.util</span> <span class="kn">import</span> <span class="n">mkdir_p</span><span class="p">,</span> <span class="n">date_string</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>        <span class="n">dirname</span> <span class="o">=</span> <span class="s2">&quot;newton-it_&quot;</span> <span class="o">+</span> <span class="n">date_string</span><span class="p">()</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>        <span class="n">dirpath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">RESULT_DIR</span><span class="o">/</span><span class="n">dirname</span><span class="p">))</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>    <span class="n">stop_criteria</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">criteria</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>    <span class="n">sol_min</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>    <span class="n">sol_max</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>    
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; Iteration no </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">))</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stop_criteria</span><span class="o">.</span><span class="n">max_iter</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>        <span class="n">lsolve</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>        
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>        <span class="c1"># fill history for 0-th iteration</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">)):</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">oldsols</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>            <span class="n">stop_criteria</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>            <span class="k">if</span> <span class="n">save_all_newton</span><span class="p">:</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">dirname</span><span class="o">+</span><span class="s1">&#39;/iter-</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">+=</span> <span class="mi">1</span>                
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; Iteration no </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">))</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>        <span class="c1"># Crop the (buffered) solution to fit interval requirement</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">sol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">):</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sol</span><span class="o">&lt;</span><span class="n">sol_min</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sol_min</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sol</span><span class="o">&gt;</span><span class="n">sol_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sol_max</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">relax</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">nwf</span><span class="p">):</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">solver</span><span class="o">.</span><span class="n">oldsols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>        <span class="c1"># Crop the (new iteration) solution to fit interval requirement</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">sol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">):</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sol</span><span class="o">&lt;</span><span class="n">sol_min</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sol_min</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sol</span><span class="o">&gt;</span><span class="n">sol_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sol_max</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>        <span class="c1"># Update material&#39;s data (linearized nonlinear terms)</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>        <span class="n">wf_res</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_res&#39;</span><span class="p">)</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">)):</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>            <span class="n">sol_qps</span> <span class="o">=</span> <span class="n">evaluate_at_qps</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>            <span class="n">sol_qps</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sol_qps</span><span class="o">&lt;</span><span class="n">sol_min</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sol_min</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>            <span class="n">sol_qps</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sol_qps</span><span class="o">&gt;</span><span class="n">sol_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sol_max</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>            <span class="n">set_mat_extra_arg</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">sol_qps</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>            <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">wf_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>                <span class="n">set_mat_extra_arg</span><span class="p">(</span><span class="n">wf_res</span><span class="p">,</span> <span class="n">sol_qps</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>        <span class="c1"># Re-assemble matrices &amp; vectors and update the dictionary</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">update_mtxvec</span><span class="p">()</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>        <span class="n">update_global_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>        
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>        <span class="c1"># if solver.weakforms[0].dimension == 2:</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>        <span class="c1">#     hook_writer(solver.weakforms[0].field.coors, solver.sols[0],</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>        <span class="c1">#                 solver.criteria.res_vec, solver.iter)</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>        <span class="c1"># Stop criteria: do we do one more iteration?</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>        <span class="k">if</span> <span class="n">stop_criteria</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">solver</span><span class="p">):</span> <span class="c1"># NO</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>            <span class="n">stop_criteria</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">stop_criteria</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>            <span class="k">break</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># YES</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">)):</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">oldsols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>                
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>        <span class="c1"># Stop criteria: res stagnation --&gt; decrease the relaxation parameter</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>        <span class="n">stop_criteria</span><span class="o">.</span><span class="n">adjust_relax</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>        <span class="c1"># Save current Newton iteration</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>        <span class="k">if</span> <span class="n">save_all_newton</span><span class="p">:</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">dirname</span><span class="o">+</span><span class="s1">&#39;/iter-</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">iter</span><span class="p">))</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>            
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>        <span class="c1"># to_pickle.append(stop_criteria.strong_res_vec)</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>    <span class="c1"># Save last Newton iteration</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>    <span class="k">if</span> <span class="n">save_all_newton</span><span class="p">:</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">dirname</span><span class="o">+</span><span class="s1">&#39;/iter-</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">iter</span><span class="p">))</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>        
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">has_converged</span><span class="p">:</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CONVERGENCE in </span><span class="si">{}</span><span class="s2"> iterations</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">iter</span><span class="p">))</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NO CONVERGENCE after </span><span class="si">{}</span><span class="s2"> iterations</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">iter</span><span class="p">))</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Recap of all Iterations &quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">88</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">))</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a><span class="k">def</span> <span class="nf">hook_writer</span><span class="p">(</span><span class="n">coors</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">no_iter</span><span class="p">):</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>    <span class="kn">import</span> <span class="nn">pickle</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>    <span class="n">data_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>    <span class="n">x1</span> <span class="o">=</span> <span class="mf">1.059</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>    <span class="n">x2</span> <span class="o">=</span> <span class="mf">1.111</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>    <span class="n">x3</span> <span class="o">=</span> <span class="mf">1.314</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>    <span class="n">x4</span> <span class="o">=</span> <span class="mf">4.645</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>    <span class="n">x5</span> <span class="o">=</span> <span class="mf">6.617</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>    <span class="n">XX</span> <span class="o">=</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">]</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>    <span class="n">XX_str</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">,</span> <span class="s1">&#39;x3&#39;</span><span class="p">,</span> <span class="s1">&#39;x4&#39;</span><span class="p">,</span> <span class="s1">&#39;x5&#39;</span><span class="p">]</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>    <span class="k">for</span> <span class="n">xx</span><span class="p">,</span> <span class="n">xx_str</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">XX</span><span class="p">,</span> <span class="n">XX_str</span><span class="p">):</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>        <span class="n">ind_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">coors</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">xx</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>        <span class="n">theta_x</span> <span class="o">=</span> <span class="n">coors</span><span class="p">[</span><span class="n">ind_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>        <span class="n">sol_x</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="n">ind_x</span><span class="p">]</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>        <span class="n">ind_sort</span> <span class="o">=</span> <span class="n">theta_x</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>        <span class="n">theta_x</span> <span class="o">=</span> <span class="n">theta_x</span><span class="p">[</span><span class="n">ind_sort</span><span class="p">]</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>        <span class="n">sol_x</span> <span class="o">=</span> <span class="n">sol_x</span><span class="p">[</span><span class="n">ind_sort</span><span class="p">]</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>        
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>        <span class="k">if</span> <span class="n">no_iter</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>            <span class="n">res_x</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">ind_x</span><span class="p">]</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>            <span class="n">res_x</span> <span class="o">=</span> <span class="n">res_x</span><span class="p">[</span><span class="n">ind_sort</span><span class="p">]</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>                <span class="p">(</span><span class="n">theta_x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">sol_x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>                 <span class="n">res_x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">theta_x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>                                   <span class="n">sol_x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>        <span class="n">data_dic</span><span class="p">[</span><span class="n">xx_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;iter\iter</span><span class="si">{}</span><span class="s1">.pkl&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">no_iter</span><span class="p">)</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data_dic</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>        
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a><span class="k">def</span> <span class="nf">line_search</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a><span class="sd">    WARNING -- EXPERIMENTAL!!</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a><span class="sd">    Find the real number w such that $u_{k+1} = w u^* + (1-w) u_{k}$ minimizes</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a><span class="sd">    the L² norm of the strong residual.</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a><span class="sd">    Parameters</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a><span class="sd">    ----------</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a><span class="sd">    solver : `Solver` instance</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a><span class="sd">        The solver instance.</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a><span class="sd">    delta : ndarray</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a><span class="sd">        Local direction of descent $\delta u = u^* - u_k$.</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a><span class="sd">    Returns</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a><span class="sd">    -------</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a><span class="sd">    float</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a><span class="sd">        The real number w resulting from the line-search algorithm.</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>    <span class="k">def</span> <span class="nf">fun</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>        <span class="n">sol_w</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">solver</span><span class="o">.</span><span class="n">oldsols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>        <span class="n">str_res</span> <span class="o">=</span> <span class="n">strong_residual</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">sol_w</span><span class="p">)</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">vec_G</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">sol_w</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">str_res</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>    <span class="n">fa</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>    <span class="n">fb</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>    <span class="k">if</span> <span class="n">fa</span><span class="o">*</span><span class="n">fb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">fb</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">fa</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fb</span> <span class="o">-</span> <span class="n">fa</span><span class="p">)</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">fb</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">fa</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fb</span> <span class="o">-</span> <span class="n">fa</span><span class="p">)</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1e-3</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1e-3</span><span class="p">:</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>                <span class="k">break</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>            <span class="n">fc</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>            <span class="k">if</span> <span class="n">fc</span><span class="o">*</span><span class="n">fa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>                <span class="n">fb</span> <span class="o">=</span> <span class="n">fc</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>                <span class="n">a</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>                <span class="n">fa</span> <span class="o">=</span> <span class="n">fc</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Line search result w = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>    <span class="k">return</span> <span class="n">c</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a><span class="k">def</span> <span class="nf">set_mat_extra_arg</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a><span class="sd">    Utilitary function for setting material extra arg.</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a><span class="sd">    Parameters</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a><span class="sd">    ----------</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a><span class="sd">    wf : `WeakForm` instance</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a><span class="sd">        Weak form containing the materials of interest.</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a><span class="sd">    arg : *any type*</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a><span class="sd">        Value of the argument to be set.</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a><span class="sd">    update : bool, optional</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a><span class="sd">        If True, the material data will be re-computed. Typically, it has to be</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a><span class="sd">        set to True when called after Sfepy&#39;s Problem instanciation.</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a><span class="sd">        The default is False.</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a><span class="sd">    Returns</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a><span class="sd">    -------</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a><span class="sd">    None.</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>        <span class="k">assert</span> <span class="n">keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>        <span class="n">args_dic</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>        <span class="n">arg</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>    <span class="k">for</span> <span class="n">mat</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">eqn</span><span class="o">.</span><span class="n">collect_materials</span><span class="p">(),</span> <span class="n">wf</span><span class="o">.</span><span class="n">terms</span><span class="p">):</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>        <span class="n">modified</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="s1">&#39;extra_args&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mat</span><span class="o">.</span><span class="n">extra_args</span> <span class="o">!=</span> <span class="p">{}:</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>            <span class="n">extra_args</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">extra_args</span> <span class="c1"># fetch material&#39;s extra-args dict</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">extra_args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Solver</span><span class="o">.</span><span class="n">forbidden_nl_arg</span><span class="p">:</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>                        <span class="n">extra_args</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>                        <span class="n">extra_args</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">args_dic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>                    <span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>            <span class="n">mat</span><span class="o">.</span><span class="n">set_extra_args</span><span class="p">(</span><span class="o">**</span><span class="n">extra_args</span><span class="p">)</span> <span class="c1"># reset material&#39;s extra-args</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>            <span class="c1"># recompute material&#39;s data with its new extra-arg</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>            <span class="k">if</span> <span class="n">update</span> <span class="ow">and</span> <span class="n">modified</span><span class="p">:</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>                <span class="n">update_material</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">integral</span><span class="p">)</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a><span class="k">def</span> <span class="nf">evaluate_at_qps</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">sol</span><span class="p">):</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a><span class="sd">    Compute an extrapolation of the solution at the domain&#39;s quadrature points.</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a><span class="sd">    Parameters</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a><span class="sd">    ----------</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a><span class="sd">    wf : `WeakForm` instance</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a><span class="sd">        Weak form associated with the solution field `sol`.</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a><span class="sd">    sol : ndarray</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a><span class="sd">        1D array containing the solution at DOFs.</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a><span class="sd">    Returns</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a><span class="sd">    -------</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a><span class="sd">    sol_qps : ndarray</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a><span class="sd">        1D array containing the values of the solution field at quadrature</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a><span class="sd">        points.</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>    <span class="n">qps</span> <span class="o">=</span> <span class="n">get_physical_qps</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">omega</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">integral</span><span class="p">)</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>    <span class="n">sol_qps</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">evaluate_at</span><span class="p">(</span><span class="n">qps</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">sol</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>    <span class="k">return</span> <span class="n">sol_qps</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a><span class="k">def</span> <span class="nf">update_neumann</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a><span class="sd">    Utility function for updating the Neumann boundary condition term on the</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a><span class="sd">    exterior domain. Note that the neumann material function should take the</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a><span class="sd">    solver instance as one of its extra-arguments in order to be able to</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a><span class="sd">    actually compute the flux of the solution across the interior domain</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a><span class="sd">    boundary. This function is only called when dealing with unbounded problems</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a><span class="sd">    with `conn` set to &#39;ping-pong&#39;.</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a><span class="sd">    Parameters</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a><span class="sd">    ----------</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a><span class="sd">    wf : `WeakForm` instance</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a><span class="sd">        Weak form whose Neumann boundary condition term is updated.</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a><span class="sd">    gamma : `Region` instance</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a><span class="sd">        Sub region of dimension D-1 on which the Neumann term is defined.</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a><span class="sd">    Returns</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a><span class="sd">    -------</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a><span class="sd">    None.</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>    <span class="n">term_idx</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">terms</span><span class="p">):</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>        <span class="c1"># check if term is the neumann term</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>        <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;dw_surface_integrate&#39;</span> <span class="ow">and</span> <span class="n">term</span><span class="o">.</span><span class="n">region</span><span class="o">==</span><span class="n">gamma</span><span class="p">:</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>            <span class="n">term_idx</span> <span class="o">=</span> <span class="n">k</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>            <span class="k">break</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>    <span class="c1"># get neumann term and update its material</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>    <span class="n">mat_neumann</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">eqn</span><span class="o">.</span><span class="n">collect_materials</span><span class="p">()[</span><span class="n">term_idx</span><span class="p">]</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>    <span class="n">update_material</span><span class="p">(</span><span class="n">mat_neumann</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">integral</span><span class="p">)</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a><span class="k">def</span> <span class="nf">update_material</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">integral</span><span class="p">):</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a><span class="sd">    Utility function for updating a material&#39;s data at the region quadrature</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a><span class="sd">    points.</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a><span class="sd">    Parameters</span>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a><span class="sd">    ----------</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a><span class="sd">    mat : `Material` instance</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a><span class="sd">        The material to be updated.</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a><span class="sd">    region : `Region` instance</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a><span class="sd">        Region over which the material is defined.</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a><span class="sd">    integral : `Integral` instance</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a><span class="sd">        Sfepy&#39;s Integral class instance (wrapper class around quadratures).</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a><span class="sd">    Returns</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a><span class="sd">    -------</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a><span class="sd">    None.</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>    <span class="kn">from</span> <span class="nn">sfepy.solvers.ts</span> <span class="kn">import</span> <span class="n">TimeStepper</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>    <span class="n">dummy_ts</span> <span class="o">=</span> <span class="n">TimeStepper</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="c1"># ficticious time-stepper</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>    <span class="n">qps</span> <span class="o">=</span> <span class="n">get_physical_qps</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">integral</span><span class="p">)</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>    <span class="n">coors</span> <span class="o">=</span> <span class="n">qps</span><span class="o">.</span><span class="n">values</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">dummy_ts</span><span class="p">,</span> <span class="n">coors</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;qp&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">mat</span><span class="o">.</span><span class="n">extra_args</span><span class="p">)</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">integral</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>    <span class="n">mat</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">qps</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a><span class="k">def</span> <span class="nf">update_material_all</span><span class="p">(</span><span class="n">wf</span><span class="p">):</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a><span class="sd">    Utility function for updating all materials&#39; data of a given weak form.</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a><span class="sd">    Parameters</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a><span class="sd">    ----------</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a><span class="sd">    wf : `WeakForm` instance</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a><span class="sd">        Weak form whose materials&#39; data are updated.</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a><span class="sd">    Returns</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a><span class="sd">    -------</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a><span class="sd">    None.</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>    <span class="k">for</span> <span class="n">mat</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">eqn</span><span class="o">.</span><span class="n">collect_materials</span><span class="p">(),</span> <span class="n">wf</span><span class="o">.</span><span class="n">terms</span><span class="p">):</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>        <span class="n">update_material</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">integral</span><span class="p">)</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a><span class="k">def</span> <span class="nf">reset_dirichlet</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">wf1</span><span class="p">,</span> <span class="n">wf2</span><span class="p">,</span> <span class="n">cogammas</span><span class="p">):</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a><span class="sd">    Utility function for setting new Dirichlet boundary condition on the outer</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a><span class="sd">    boundary of the interior domain. This function is only called when dealing</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a><span class="sd">    with unbounded problems with `conn` set to &#39;ping-pong&#39;.</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a><span class="sd">    Parameters</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a><span class="sd">    ----------</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a><span class="sd">    data : ndarray</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a><span class="sd">        1D numpy array containing the solution field at the exterior domain</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a><span class="sd">        DOFs.</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a><span class="sd">    wf1 : `WeakForm` instance</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a><span class="sd">        Weak form associated with the interior domain.</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a><span class="sd">    wf2 : `WeakForm` instance</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a><span class="sd">        Weak form associated with the exterior domain.</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a><span class="sd">    cogammas : list</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a><span class="sd">        List of two `sfepy.discrete.common.region.Region` instances</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a><span class="sd">        corresponding to the interior and exterior domain common frontier.</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>    <span class="k">def</span> <span class="nf">dbc</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">coor</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>        <span class="k">return</span> <span class="n">wf2</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">evaluate_at</span><span class="p">(</span><span class="n">coor</span><span class="p">,</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>    <span class="n">d_func</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="s1">&#39;d_func&#39;</span><span class="p">,</span> <span class="n">dbc</span><span class="p">)</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>    <span class="n">new_ebc</span> <span class="o">=</span> <span class="n">EssentialBC</span><span class="p">(</span><span class="s1">&#39;dbc_pp&#39;</span><span class="p">,</span> <span class="n">cogammas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>                          <span class="p">{</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.all&#39;</span> <span class="o">%</span><span class="n">wf1</span><span class="o">.</span><span class="n">unknown_name</span> <span class="p">:</span> <span class="n">d_func</span><span class="p">})</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ebc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">):</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>        <span class="k">if</span> <span class="n">ebc</span><span class="o">.</span><span class="n">region</span> <span class="o">==</span> <span class="n">cogammas</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>            <span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ebc</span>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>            <span class="k">break</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a><span class="k">def</span> <span class="nf">strong_residual</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">sol_w</span><span class="p">):</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a><span class="sd">    Compute the strong residual (for nonlinear problems only). Note that the</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a><span class="sd">    strong residual might be evaluated on both the interior and exterior</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a><span class="sd">    if two nonlinear WeakForms instances are provided at the creation of</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a><span class="sd">    `solver` (unbounded problems only).</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a><span class="sd">    Parameters</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a><span class="sd">    ----------</span>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a><span class="sd">    solver : `Solver` instance</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a><span class="sd">        The solver instance.</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a><span class="sd">    sol_w : array</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a><span class="sd">        Current solution (vector).</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a><span class="sd">    Returns</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a><span class="sd">    -------</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a><span class="sd">    res_vec : ndarray</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a><span class="sd">        Residual vector.</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>    <span class="c1"># Fetch solution vector and matrix &amp; rhs associated with the residual</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a>    <span class="n">wf_res</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">wfs_dic</span><span class="p">[</span><span class="s1">&#39;wf_res&#39;</span><span class="p">]</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>    <span class="n">cg</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">cogammas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;cogammas&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>    <span class="n">idx_bc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">get_ebc_dofs</span><span class="p">(</span><span class="n">wf_res</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">cg</span><span class="p">))</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>    <span class="n">mtx_res</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_res&#39;</span><span class="p">]</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>    <span class="n">rhs_res</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_res&#39;</span><span class="p">]</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>    
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>    <span class="c1"># Set coeff associated with EBC to zero</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>    <span class="c1"># mtx_res[idx_bc, :] = 0.0</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>    <span class="c1"># mtx_res[:, idx_bc] = 0.0</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>    <span class="c1"># rhs_res[idx_bc] = 0.0</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>    
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>    <span class="c1"># Evaluate the residual vector</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>    <span class="n">Ax</span> <span class="o">=</span> <span class="n">mtx_res</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sol_w</span><span class="p">)</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>    <span class="n">res_vec</span> <span class="o">=</span> <span class="n">Ax</span> <span class="o">-</span> <span class="n">rhs_res</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>    <span class="n">res_vec</span><span class="p">[</span><span class="n">idx_bc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>    <span class="n">res_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">res_vec</span><span class="p">)</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>    <span class="n">res_vec_parts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mtx&#39;</span> <span class="p">:</span> <span class="n">Ax</span><span class="p">,</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>                     <span class="s1">&#39;rhs_cst&#39;</span> <span class="p">:</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_res&#39;</span><span class="p">],</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>                     <span class="s1">&#39;rhs_mod&#39;</span> <span class="p">:</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_res&#39;</span><span class="p">]}</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>    <span class="k">return</span> <span class="n">res_vec</span><span class="p">,</span> <span class="n">res_vec_parts</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a><span class="k">def</span> <span class="nf">vec_G</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">sol_w</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Utility function for the line-search algorithm&quot;&quot;&quot;</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>    <span class="n">wf1</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>    <span class="n">wf_G</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">wfs_dic</span><span class="p">[</span><span class="s1">&#39;wf_G&#39;</span><span class="p">]</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>    <span class="n">sol_qps</span> <span class="o">=</span> <span class="n">evaluate_at_qps</span><span class="p">(</span><span class="n">wf1</span><span class="p">,</span> <span class="n">sol_w</span><span class="p">)</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>    <span class="n">dphi_qps</span> <span class="o">=</span> <span class="n">evaluate_at_qps</span><span class="p">(</span><span class="n">wf1</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>    <span class="n">set_mat_extra_arg</span><span class="p">(</span><span class="n">wf_G</span><span class="p">,</span> <span class="n">sol_qps</span><span class="p">,</span> <span class="n">dphi_qps</span><span class="p">,</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>                      <span class="n">keys</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="s1">&#39;dphi&#39;</span><span class="p">),</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>    <span class="n">is_not_assembled</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mtx_cst_G&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>    <span class="k">if</span> <span class="n">is_not_assembled</span><span class="p">:</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>        <span class="n">assemble_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_G&#39;</span><span class="p">],</span> <span class="n">assemble_rhs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>    <span class="n">assemble_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod_G&#39;</span><span class="p">],</span> <span class="n">assemble_mtx</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>    <span class="n">mtx</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_G&#39;</span><span class="p">]</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>    <span class="n">rhs</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_G&#39;</span><span class="p">]</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>    <span class="n">vec</span> <span class="o">=</span> <span class="n">mtx</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">-</span> <span class="n">rhs</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>    <span class="n">cg</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">cogammas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;cogammas&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>    <span class="n">idx_bc</span> <span class="o">=</span> <span class="n">get_ebc_dofs</span><span class="p">(</span><span class="n">wf_G</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">cg</span><span class="p">)</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>    <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">idx_bc</span><span class="p">)</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>    <span class="k">return</span> <span class="n">vec</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a><span class="k">def</span> <span class="nf">delete_ebc_dofs</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">wf</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a><span class="sd">    Remove vector elements that correspond to DOFs subject to essential</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a><span class="sd">    boundary conditions or DOFs that are part of a certain facet region</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a><span class="sd">    specified by the keyword argument `gamma`.</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a><span class="sd">    Parameters</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a><span class="sd">    ----------</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a><span class="sd">    vec : ndarray</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a><span class="sd">        1D numpy array defined over DOFs.</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a><span class="sd">    wf : `WeakForm` instance</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a><span class="sd">        Weak form instance containing the DOFs info as well as the facet(s)</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a><span class="sd">        subject to essential boundary conditions.</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a><span class="sd">    gamma : `Region` instance, optional</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a><span class="sd">        Extra boundary where `vec` elements should be deleted (a priori not</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a><span class="sd">        concerned by ebc). The default is None.</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a><span class="sd">    Returns</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a><span class="sd">    -------</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a><span class="sd">    idx : ndarray</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a><span class="sd">        Indices of the DOFs deleted.</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a><span class="sd">    ndarray</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a><span class="sd">        The amputed version of `vec`.</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>    <span class="n">vertices_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">ebcs</span><span class="p">)):</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>        <span class="n">vertices_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_dofs_in_region</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">ebcs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">region</span><span class="p">))</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>    <span class="k">if</span> <span class="n">gamma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>        <span class="n">vertices_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_dofs_in_region</span><span class="p">(</span><span class="n">gamma</span><span class="p">))</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">vertices_list</span><span class="p">))</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>    <span class="k">return</span> <span class="n">idx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a><span class="k">def</span> <span class="nf">get_ebc_dofs</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Same as `delete_ebc_dofs` but only returns the indices of the DOFs</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a><span class="sd">    associated with Dirichlet boundary conditions or belong to facet gamma.&quot;&quot;&quot;</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>    <span class="n">vertices_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">ebcs</span><span class="p">)):</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>        <span class="n">vertices_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_dofs_in_region</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">ebcs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">region</span><span class="p">))</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>    <span class="k">if</span> <span class="n">gamma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>        <span class="n">vertices_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_dofs_in_region</span><span class="p">(</span><span class="n">gamma</span><span class="p">))</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">vertices_list</span><span class="p">))</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>    <span class="k">return</span> <span class="n">idx</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a><span class="k">def</span> <span class="nf">assemble_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="o">*</span><span class="n">pbs</span><span class="p">,</span> <span class="n">assemble_mtx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">assemble_rhs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a><span class="sd">    Assemble the terms (matrices and vectors) of `Problem` instances (Cf sfepy</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a><span class="sd">    API) provided by the user. The assembled matrices and vectors are then</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a><span class="sd">    accessible through the solver&#39;s `mtxvec_dic` dictionary.</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a><span class="sd">    Parameters</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a><span class="sd">    ----------</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a><span class="sd">    solver : `Solver` instance</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a><span class="sd">        The solver instance.</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a><span class="sd">    *pbs : list or tupple</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a><span class="sd">        List of `Problem` instances.</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a><span class="sd">    assemble_mtx : bool, optional</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a><span class="sd">        Whether matrices are assembled or not. The default is True.</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a><span class="sd">    assemble_rhs : bool, optional</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a><span class="sd">        Whether vectors are assembled or not. The default is True.</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a><span class="sd">    Returns</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a><span class="sd">    -------</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a><span class="sd">    None.</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>    <span class="n">saved_assemble_mtx</span> <span class="o">=</span> <span class="n">assemble_mtx</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>    <span class="n">saved_assemble_rhs</span> <span class="o">=</span> <span class="n">assemble_rhs</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>    <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="n">pbs</span><span class="p">:</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>        <span class="k">if</span> <span class="n">pb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>            <span class="k">continue</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>        <span class="c1"># name handling</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>        <span class="n">pb_name</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>        <span class="n">sname</span> <span class="o">=</span> <span class="n">pb_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>        <span class="n">sname</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>        <span class="n">mtx_key</span> <span class="o">=</span> <span class="s1">&#39;mtx_&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sname</span><span class="p">)</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>        <span class="n">rhs_key</span> <span class="o">=</span> <span class="s1">&#39;rhs_&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sname</span><span class="p">)</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>        <span class="c1"># handling exceptions</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>        <span class="k">if</span> <span class="p">((</span><span class="n">solver</span><span class="o">.</span><span class="n">islinear</span> <span class="ow">and</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;pb_mod_pp2&#39;</span><span class="p">)</span> <span class="ow">or</span> 
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>            <span class="p">(</span><span class="ow">not</span> <span class="n">solver</span><span class="o">.</span><span class="n">islinear</span> <span class="ow">and</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;pb_mod_res&#39;</span><span class="p">)):</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>            <span class="n">assemble_mtx</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">solver</span><span class="o">.</span><span class="n">initialized</span> <span class="ow">and</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;pb_mod_pp2&#39;</span><span class="p">:</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>            <span class="n">assemble_rhs</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">assemble_mtx</span> <span class="ow">or</span> <span class="n">assemble_rhs</span><span class="p">):</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>            <span class="k">continue</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>        <span class="c1"># assembling matrix and rhs vector</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>        <span class="n">tss</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">get_solver</span><span class="p">()</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>        <span class="n">pb</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_unknown</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>        <span class="n">variables</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">get_initial_state</span><span class="p">(</span><span class="n">vec</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>        <span class="n">variables</span><span class="o">.</span><span class="n">adof_conns</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>        <span class="n">pb</span><span class="o">.</span><span class="n">time_update</span><span class="p">(</span><span class="n">tss</span><span class="o">.</span><span class="n">ts</span><span class="p">,</span> <span class="n">is_matrix</span><span class="o">=</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">mtx_a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>        <span class="n">variables</span><span class="o">.</span><span class="n">apply_ebc</span><span class="p">(</span><span class="n">force_values</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>        <span class="n">pb</span><span class="o">.</span><span class="n">update_materials</span><span class="p">()</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>        <span class="n">ev</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">get_evaluator</span><span class="p">()</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>        <span class="k">if</span> <span class="n">assemble_mtx</span><span class="p">:</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>            <span class="n">mtx</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">eval_tangent_matrix</span><span class="p">(</span><span class="n">variables</span><span class="p">(),</span> <span class="n">is_full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="p">[</span><span class="n">mtx_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtx</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>        <span class="k">if</span> <span class="n">assemble_rhs</span><span class="p">:</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>            <span class="n">rhs</span> <span class="o">=</span> <span class="o">-</span><span class="n">ev</span><span class="o">.</span><span class="n">eval_residual</span><span class="p">(</span><span class="n">variables</span><span class="p">(),</span> <span class="n">is_full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="p">[</span><span class="n">rhs_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>            <span class="c1"># alternative way / syntax</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>            <span class="c1"># rhs = pb.equations.create_reduced_vec()</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>            <span class="c1"># rhs = pb.equations.evaluate(mode=&#39;weak&#39;, dw_mode=&#39;vector&#39;,</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>            <span class="c1">#                             asm_obj=rhs)</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>            <span class="c1"># solver.mtxvec_dic[rhs_key] = -rhs</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>        <span class="c1"># reset assembling boolean options</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>        <span class="n">assemble_mtx</span> <span class="o">=</span> <span class="n">saved_assemble_mtx</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>        <span class="n">assemble_rhs</span> <span class="o">=</span> <span class="n">saved_assemble_rhs</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a><span class="k">def</span> <span class="nf">update_global_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">):</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the global stiffness matrix &amp; rhs vector (those subsequently</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a><span class="sd">    passed to the linear solver) which are only sums of pre-computed matrices</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a><span class="sd">    &amp; vectors.&quot;&quot;&quot;</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>    <span class="n">mtxvec_dic</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>    <span class="n">wf1</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">nwf</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">nwf</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">conn</span><span class="o">==</span><span class="s1">&#39;connected&#39;</span><span class="p">):</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>        <span class="k">if</span> <span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst&#39;</span><span class="p">]</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst&#39;</span><span class="p">]</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_mod&#39;</span><span class="p">]</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod&#39;</span><span class="p">]</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>    <span class="k">elif</span> <span class="n">solver</span><span class="o">.</span><span class="n">nwf</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">conn</span><span class="o">==</span><span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>        <span class="k">if</span> <span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_pp1&#39;</span><span class="p">]</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_pp1&#39;</span><span class="p">]</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_pp2&#39;</span><span class="p">]</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_pp2&#39;</span><span class="p">]</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_pp1&#39;</span><span class="p">]</span> \
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>                <span class="o">+</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_mod_pp1&#39;</span><span class="p">]</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_pp1&#39;</span><span class="p">]</span> \
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>                <span class="o">+</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_pp1&#39;</span><span class="p">]</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>    <span class="n">wf_res</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_res&#39;</span><span class="p">)</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>    <span class="k">if</span> <span class="n">wf_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>        <span class="k">if</span> <span class="n">wf_res</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_res&#39;</span><span class="p">]</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_res&#39;</span><span class="p">]</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_res&#39;</span><span class="p">]</span> <span class="c1">#+ mtxvec_dic[&#39;mtx_mod_res&#39;]</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_res&#39;</span><span class="p">]</span> \
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>                <span class="o">+</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_res&#39;</span><span class="p">]</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a><span class="k">def</span> <span class="nf">reconstruct_full_sol</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">sol_reduced</span><span class="p">):</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a><span class="sd">    Reconstruct the full solution vector from the reduced solution vector</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a><span class="sd">    (defined only at active DOFs i.e. DOFs that are not constrained by</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a><span class="sd">    essential boundary conditions).</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a><span class="sd">    Parameters</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a><span class="sd">    ----------</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a><span class="sd">    pb : `Problem` instance</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a><span class="sd">        Problem instance associated with the solution to reconstruct.</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a><span class="sd">    sol_reduced : ndarray</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a><span class="sd">        Reduced solution vector.</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a><span class="sd">    Returns</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a><span class="sd">    -------</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a><span class="sd">    sol_full : ndarray</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a><span class="sd">        Solution vector defined on all DOFs.</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>    <span class="n">pb</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">sol_reduced</span><span class="p">,</span> <span class="n">reduced</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>    <span class="n">sol_full</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">variables</span><span class="p">()</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>    <span class="k">return</span> <span class="n">sol_full</span>
</span></pre></div>


            </section>
                <section id="Solver">
                            <input id="Solver-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Solver</span>:

                <label class="view-source-button" for="Solver-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Solver"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Solver-39"><a href="#Solver-39"><span class="linenos"> 39</span></a><span class="k">class</span> <span class="nc">Solver</span><span class="p">:</span>
</span><span id="Solver-40"><a href="#Solver-40"><span class="linenos"> 40</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Solver-41"><a href="#Solver-41"><span class="linenos"> 41</span></a><span class="sd">    Class for performing FEM simulations.</span>
</span><span id="Solver-42"><a href="#Solver-42"><span class="linenos"> 42</span></a>
</span><span id="Solver-43"><a href="#Solver-43"><span class="linenos"> 43</span></a><span class="sd">    Attributes</span>
</span><span id="Solver-44"><a href="#Solver-44"><span class="linenos"> 44</span></a><span class="sd">    ----------</span>
</span><span id="Solver-45"><a href="#Solver-45"><span class="linenos"> 45</span></a><span class="sd">    eps_dic : dict</span>
</span><span id="Solver-46"><a href="#Solver-46"><span class="linenos"> 46</span></a><span class="sd">        Dictionary with keys &#39;eps_a&#39; and &#39;eps_r&#39; corresponding to the absolute</span>
</span><span id="Solver-47"><a href="#Solver-47"><span class="linenos"> 47</span></a><span class="sd">        and relative tolerance settings respectively.</span>
</span><span id="Solver-48"><a href="#Solver-48"><span class="linenos"> 48</span></a><span class="sd">        The default is {&#39;eps_a&#39; : 1e-10, &#39;eps_r&#39; : 1.0}</span>
</span><span id="Solver-49"><a href="#Solver-49"><span class="linenos"> 49</span></a><span class="sd">    ls : `sfepy.solvers.ls.ScipyDirect` by default.</span>
</span><span id="Solver-50"><a href="#Solver-50"><span class="linenos"> 50</span></a><span class="sd">        Linear solver to be used. The default is ScipyDirect.</span>
</span><span id="Solver-51"><a href="#Solver-51"><span class="linenos"> 51</span></a><span class="sd">    nls : `sfepy.solvers.nls.Newton`</span>
</span><span id="Solver-52"><a href="#Solver-52"><span class="linenos"> 52</span></a><span class="sd">        Nonlinear solver to be used. The default is Newton.</span>
</span><span id="Solver-53"><a href="#Solver-53"><span class="linenos"> 53</span></a><span class="sd">    wfs_dic : dict</span>
</span><span id="Solver-54"><a href="#Solver-54"><span class="linenos"> 54</span></a><span class="sd">        Dictionary of all weakforms used in the simulation. Item with key</span>
</span><span id="Solver-55"><a href="#Solver-55"><span class="linenos"> 55</span></a><span class="sd">        &#39;weakforms&#39; represents the weakforms associated with the PDE to be</span>
</span><span id="Solver-56"><a href="#Solver-56"><span class="linenos"> 56</span></a><span class="sd">        solved (1 wf for bounded domains, 2 wfs for unbounded ones). Other</span>
</span><span id="Solver-57"><a href="#Solver-57"><span class="linenos"> 57</span></a><span class="sd">        weakforms are for supplementary purposes (evaluation of the strong</span>
</span><span id="Solver-58"><a href="#Solver-58"><span class="linenos"> 58</span></a><span class="sd">        residual, line-search...).</span>
</span><span id="Solver-59"><a href="#Solver-59"><span class="linenos"> 59</span></a><span class="sd">    nwf : int</span>
</span><span id="Solver-60"><a href="#Solver-60"><span class="linenos"> 60</span></a><span class="sd">        Number of weak forms provided to the solver.</span>
</span><span id="Solver-61"><a href="#Solver-61"><span class="linenos"> 61</span></a><span class="sd">    islinear : bool</span>
</span><span id="Solver-62"><a href="#Solver-62"><span class="linenos"> 62</span></a><span class="sd">        Whether or not the PDE to be solved is linear.</span>
</span><span id="Solver-63"><a href="#Solver-63"><span class="linenos"> 63</span></a><span class="sd">    is_bounded : bool</span>
</span><span id="Solver-64"><a href="#Solver-64"><span class="linenos"> 64</span></a><span class="sd">        Whether or not the domain is bounded.</span>
</span><span id="Solver-65"><a href="#Solver-65"><span class="linenos"> 65</span></a><span class="sd">    iter : int, optional</span>
</span><span id="Solver-66"><a href="#Solver-66"><span class="linenos"> 66</span></a><span class="sd">        Maximum number of newton/picard iterations (defined if islinear is</span>
</span><span id="Solver-67"><a href="#Solver-67"><span class="linenos"> 67</span></a><span class="sd">        False).</span>
</span><span id="Solver-68"><a href="#Solver-68"><span class="linenos"> 68</span></a><span class="sd">    initial_guess : list, optional</span>
</span><span id="Solver-69"><a href="#Solver-69"><span class="linenos"> 69</span></a><span class="sd">        List of initial guesses (one per weak form) used to initialize</span>
</span><span id="Solver-70"><a href="#Solver-70"><span class="linenos"> 70</span></a><span class="sd">        nonlinear solver (defined if islinear is False).The default is a scalar</span>
</span><span id="Solver-71"><a href="#Solver-71"><span class="linenos"> 71</span></a><span class="sd">        field set to zero everywhere.</span>
</span><span id="Solver-72"><a href="#Solver-72"><span class="linenos"> 72</span></a><span class="sd">    relax : float, optional</span>
</span><span id="Solver-73"><a href="#Solver-73"><span class="linenos"> 73</span></a><span class="sd">        Relaxation parameter for newton/picard method (defined if islinear is</span>
</span><span id="Solver-74"><a href="#Solver-74"><span class="linenos"> 74</span></a><span class="sd">        False). The default is 0.9.</span>
</span><span id="Solver-75"><a href="#Solver-75"><span class="linenos"> 75</span></a><span class="sd">    criteria : `Criteria` instance, optional</span>
</span><span id="Solver-76"><a href="#Solver-76"><span class="linenos"> 76</span></a><span class="sd">        Criteria instance gathering the directives for when to stop nonlinear</span>
</span><span id="Solver-77"><a href="#Solver-77"><span class="linenos"> 77</span></a><span class="sd">        iterations (defined if islinear is False). The default is to iterate</span>
</span><span id="Solver-78"><a href="#Solver-78"><span class="linenos"> 78</span></a><span class="sd">        20 times.</span>
</span><span id="Solver-79"><a href="#Solver-79"><span class="linenos"> 79</span></a><span class="sd">    has_converged : bool</span>
</span><span id="Solver-80"><a href="#Solver-80"><span class="linenos"> 80</span></a><span class="sd">        False until the Criteria instance decrees convergence has been reached</span>
</span><span id="Solver-81"><a href="#Solver-81"><span class="linenos"> 81</span></a><span class="sd">        (defined if islinear is False).</span>
</span><span id="Solver-82"><a href="#Solver-82"><span class="linenos"> 82</span></a><span class="sd">    sols : list</span>
</span><span id="Solver-83"><a href="#Solver-83"><span class="linenos"> 83</span></a><span class="sd">        List of the solution(s) (one per weak form).</span>
</span><span id="Solver-84"><a href="#Solver-84"><span class="linenos"> 84</span></a><span class="sd">    cogammas : list</span>
</span><span id="Solver-85"><a href="#Solver-85"><span class="linenos"> 85</span></a><span class="sd">        List of two `sfepy.discrete.common.region.Region` instances</span>
</span><span id="Solver-86"><a href="#Solver-86"><span class="linenos"> 86</span></a><span class="sd">        corresponding to the interior and exterior domain common frontier</span>
</span><span id="Solver-87"><a href="#Solver-87"><span class="linenos"> 87</span></a><span class="sd">        (defined if nwf = 2).</span>
</span><span id="Solver-88"><a href="#Solver-88"><span class="linenos"> 88</span></a><span class="sd">    conn : str</span>
</span><span id="Solver-89"><a href="#Solver-89"><span class="linenos"> 89</span></a><span class="sd">        Method for linking the interior domain with the exterior domain</span>
</span><span id="Solver-90"><a href="#Solver-90"><span class="linenos"> 90</span></a><span class="sd">        [&#39;connected&#39; , &#39;ping-pong&#39;]. The default is &#39;connected&#39;.</span>
</span><span id="Solver-91"><a href="#Solver-91"><span class="linenos"> 91</span></a><span class="sd">    max_iter_pp : int</span>
</span><span id="Solver-92"><a href="#Solver-92"><span class="linenos"> 92</span></a><span class="sd">        Maximum number of iterations for the ping-pong method (defined if</span>
</span><span id="Solver-93"><a href="#Solver-93"><span class="linenos"> 93</span></a><span class="sd">        conn = &#39;ping-pong&#39;). The default is 7.</span>
</span><span id="Solver-94"><a href="#Solver-94"><span class="linenos"> 94</span></a><span class="sd">    relax_pp :  float</span>
</span><span id="Solver-95"><a href="#Solver-95"><span class="linenos"> 95</span></a><span class="sd">        Relaxation parameter for ping-pong iterations (between 0 and 1).</span>
</span><span id="Solver-96"><a href="#Solver-96"><span class="linenos"> 96</span></a><span class="sd">        The default is 0.7.</span>
</span><span id="Solver-97"><a href="#Solver-97"><span class="linenos"> 97</span></a><span class="sd">    bounds : list</span>
</span><span id="Solver-98"><a href="#Solver-98"><span class="linenos"> 98</span></a><span class="sd">        List of the min &amp; max field values (can be crucial to prevent</span>
</span><span id="Solver-99"><a href="#Solver-99"><span class="linenos"> 99</span></a><span class="sd">        divergence in the solution for nonlinear problems).</span>
</span><span id="Solver-100"><a href="#Solver-100"><span class="linenos">100</span></a><span class="sd">    oldsols : list</span>
</span><span id="Solver-101"><a href="#Solver-101"><span class="linenos">101</span></a><span class="sd">        List of the solution(s) at the previous iteration (one per weak form).</span>
</span><span id="Solver-102"><a href="#Solver-102"><span class="linenos">102</span></a><span class="sd">    buffersols : list</span>
</span><span id="Solver-103"><a href="#Solver-103"><span class="linenos">103</span></a><span class="sd">        Temporary storage of the solution(s).</span>
</span><span id="Solver-104"><a href="#Solver-104"><span class="linenos">104</span></a><span class="sd">    outfiles : list</span>
</span><span id="Solver-105"><a href="#Solver-105"><span class="linenos">105</span></a><span class="sd">        List of the exported .vtk files containing simulation results.</span>
</span><span id="Solver-106"><a href="#Solver-106"><span class="linenos">106</span></a><span class="sd">    save_all_newton : bool</span>
</span><span id="Solver-107"><a href="#Solver-107"><span class="linenos">107</span></a><span class="sd">        Save all Newton&#39;s iterations (for nonlinear problems only).</span>
</span><span id="Solver-108"><a href="#Solver-108"><span class="linenos">108</span></a><span class="sd">        The default is False.</span>
</span><span id="Solver-109"><a href="#Solver-109"><span class="linenos">109</span></a><span class="sd">    verbose : bool</span>
</span><span id="Solver-110"><a href="#Solver-110"><span class="linenos">110</span></a><span class="sd">        Display user&#39;s information. The default is False.</span>
</span><span id="Solver-111"><a href="#Solver-111"><span class="linenos">111</span></a>
</span><span id="Solver-112"><a href="#Solver-112"><span class="linenos">112</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Solver-113"><a href="#Solver-113"><span class="linenos">113</span></a>
</span><span id="Solver-114"><a href="#Solver-114"><span class="linenos">114</span></a>    <span class="n">forbidden_nl_arg</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;update_nl&#39;</span><span class="p">,</span> <span class="s1">&#39;rho&#39;</span><span class="p">,</span> <span class="s1">&#39;rho_vac&#39;</span><span class="p">,</span> <span class="s1">&#39;Rcut&#39;</span><span class="p">,</span> <span class="s1">&#39;solver&#39;</span><span class="p">]</span>
</span><span id="Solver-115"><a href="#Solver-115"><span class="linenos">115</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class variable `forbidden_nl_arg` is a list of material extra-arguments</span>
</span><span id="Solver-116"><a href="#Solver-116"><span class="linenos">116</span></a><span class="sd">    (strings) which are not to be interpreted as non-linear terms.</span>
</span><span id="Solver-117"><a href="#Solver-117"><span class="linenos">117</span></a><span class="sd">    Consequently, material&#39;s data will not be updated when calling the function</span>
</span><span id="Solver-118"><a href="#Solver-118"><span class="linenos">118</span></a><span class="sd">    `update_material` unless the material&#39;s function has at least one extra-</span>
</span><span id="Solver-119"><a href="#Solver-119"><span class="linenos">119</span></a><span class="sd">    argument not contained in that list.&quot;&quot;&quot;</span>
</span><span id="Solver-120"><a href="#Solver-120"><span class="linenos">120</span></a>
</span><span id="Solver-121"><a href="#Solver-121"><span class="linenos">121</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wfs_dic</span><span class="p">,</span> <span class="n">islinear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Solver-122"><a href="#Solver-122"><span class="linenos">122</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Solver-123"><a href="#Solver-123"><span class="linenos">123</span></a><span class="sd">        Construct a Solver instance.</span>
</span><span id="Solver-124"><a href="#Solver-124"><span class="linenos">124</span></a>
</span><span id="Solver-125"><a href="#Solver-125"><span class="linenos">125</span></a><span class="sd">        Parameters</span>
</span><span id="Solver-126"><a href="#Solver-126"><span class="linenos">126</span></a><span class="sd">        ----------</span>
</span><span id="Solver-127"><a href="#Solver-127"><span class="linenos">127</span></a><span class="sd">        weakforms : list</span>
</span><span id="Solver-128"><a href="#Solver-128"><span class="linenos">128</span></a><span class="sd">            List of one or two WeakForm instances.</span>
</span><span id="Solver-129"><a href="#Solver-129"><span class="linenos">129</span></a><span class="sd">        islinear : bool, optional</span>
</span><span id="Solver-130"><a href="#Solver-130"><span class="linenos">130</span></a><span class="sd">            Whether or not the PDE to be solved is linear. The default is True.</span>
</span><span id="Solver-131"><a href="#Solver-131"><span class="linenos">131</span></a><span class="sd">        kwargs</span>
</span><span id="Solver-132"><a href="#Solver-132"><span class="linenos">132</span></a><span class="sd">            *Cf class documentation*</span>
</span><span id="Solver-133"><a href="#Solver-133"><span class="linenos">133</span></a>
</span><span id="Solver-134"><a href="#Solver-134"><span class="linenos">134</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Solver-135"><a href="#Solver-135"><span class="linenos">135</span></a>
</span><span id="Solver-136"><a href="#Solver-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Solver-137"><a href="#Solver-137"><span class="linenos">137</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="Solver-138"><a href="#Solver-138"><span class="linenos">138</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Display Sfepy console&#39;s messages</span>
</span><span id="Solver-139"><a href="#Solver-139"><span class="linenos">139</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">print_kappa</span> <span class="o">=</span>  <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;print_kappa&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Solver-140"><a href="#Solver-140"><span class="linenos">140</span></a>
</span><span id="Solver-141"><a href="#Solver-141"><span class="linenos">141</span></a>        <span class="c1"># Solver(s) &amp; precision</span>
</span><span id="Solver-142"><a href="#Solver-142"><span class="linenos">142</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eps_dic</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eps_dic&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;eps_a&#39;</span> <span class="p">:</span> <span class="mf">1e-15</span><span class="p">,</span>
</span><span id="Solver-143"><a href="#Solver-143"><span class="linenos">143</span></a>                                              <span class="s1">&#39;eps_r&#39;</span> <span class="p">:</span> <span class="mf">1e-15</span><span class="p">,</span>
</span><span id="Solver-144"><a href="#Solver-144"><span class="linenos">144</span></a>                                              <span class="s1">&#39;i_max&#39;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
</span><span id="Solver-145"><a href="#Solver-145"><span class="linenos">145</span></a>        <span class="c1"># self.ls = kwargs.get(&#39;ls&#39;, AutoDirect({}))</span>
</span><span id="Solver-146"><a href="#Solver-146"><span class="linenos">146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ls</span> <span class="o">=</span> <span class="n">ScipyDirect</span><span class="p">({})</span>
</span><span id="Solver-147"><a href="#Solver-147"><span class="linenos">147</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nls</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nls&#39;</span><span class="p">,</span> <span class="n">Newton</span><span class="p">({</span><span class="s1">&#39;is_linear&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
</span><span id="Solver-148"><a href="#Solver-148"><span class="linenos">148</span></a>                                            <span class="n">lin_solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">,</span>
</span><span id="Solver-149"><a href="#Solver-149"><span class="linenos">149</span></a>                                            <span class="n">status</span><span class="o">=</span><span class="n">IndexedStruct</span><span class="p">()))</span>
</span><span id="Solver-150"><a href="#Solver-150"><span class="linenos">150</span></a>        <span class="c1"># Weak Forms</span>
</span><span id="Solver-151"><a href="#Solver-151"><span class="linenos">151</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span> <span class="o">=</span> <span class="n">wfs_dic</span>
</span><span id="Solver-152"><a href="#Solver-152"><span class="linenos">152</span></a>        <span class="n">weakforms</span> <span class="o">=</span> <span class="n">wfs_dic</span><span class="p">[</span><span class="s1">&#39;weakforms&#39;</span><span class="p">]</span>
</span><span id="Solver-153"><a href="#Solver-153"><span class="linenos">153</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span> <span class="o">=</span> <span class="n">weakforms</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weakforms</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> \
</span><span id="Solver-154"><a href="#Solver-154"><span class="linenos">154</span></a>                                   <span class="k">else</span> <span class="p">[</span><span class="n">weakforms</span><span class="p">]</span>
</span><span id="Solver-155"><a href="#Solver-155"><span class="linenos">155</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">)</span>
</span><span id="Solver-156"><a href="#Solver-156"><span class="linenos">156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_bounded</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_bounded&#39;</span><span class="p">)</span>
</span><span id="Solver-157"><a href="#Solver-157"><span class="linenos">157</span></a>
</span><span id="Solver-158"><a href="#Solver-158"><span class="linenos">158</span></a>        <span class="c1"># TODO: pre-allocate solutions&#39; arrays</span>
</span><span id="Solver-159"><a href="#Solver-159"><span class="linenos">159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">oldsols</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="Solver-160"><a href="#Solver-160"><span class="linenos">160</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buffersols</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="Solver-161"><a href="#Solver-161"><span class="linenos">161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sols</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="Solver-162"><a href="#Solver-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bounds&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">1e15</span><span class="p">,</span> <span class="mf">1e15</span><span class="p">])</span>
</span><span id="Solver-163"><a href="#Solver-163"><span class="linenos">163</span></a>
</span><span id="Solver-164"><a href="#Solver-164"><span class="linenos">164</span></a>        <span class="c1"># Non-linear problems</span>
</span><span id="Solver-165"><a href="#Solver-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">islinear</span> <span class="o">=</span> <span class="n">islinear</span>
</span><span id="Solver-166"><a href="#Solver-166"><span class="linenos">166</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">islinear</span><span class="p">:</span>
</span><span id="Solver-167"><a href="#Solver-167"><span class="linenos">167</span></a>            <span class="n">wf_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_res&#39;</span><span class="p">)</span>
</span><span id="Solver-168"><a href="#Solver-168"><span class="linenos">168</span></a>            <span class="n">wf_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_G&#39;</span><span class="p">)</span>
</span><span id="Solver-169"><a href="#Solver-169"><span class="linenos">169</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Solver-170"><a href="#Solver-170"><span class="linenos">170</span></a>            <span class="n">initial_guess</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_guess&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="Solver-171"><a href="#Solver-171"><span class="linenos">171</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_guess</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Solver-172"><a href="#Solver-172"><span class="linenos">172</span></a>                <span class="k">for</span> <span class="n">wf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">:</span>
</span><span id="Solver-173"><a href="#Solver-173"><span class="linenos">173</span></a>                    <span class="n">initial_guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">n_nod</span><span class="p">))</span>
</span><span id="Solver-174"><a href="#Solver-174"><span class="linenos">174</span></a>            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwf</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">initial_guess</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
</span><span id="Solver-175"><a href="#Solver-175"><span class="linenos">175</span></a>                <span class="n">initial_guess</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_guess</span><span class="p">]</span>
</span><span id="Solver-176"><a href="#Solver-176"><span class="linenos">176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">initial_guess</span> <span class="o">=</span> <span class="n">initial_guess</span>
</span><span id="Solver-177"><a href="#Solver-177"><span class="linenos">177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">oldsols</span> <span class="o">=</span> <span class="n">copy_list_of_arrays</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_guess</span><span class="p">)</span>
</span><span id="Solver-178"><a href="#Solver-178"><span class="linenos">178</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">relax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relax&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
</span><span id="Solver-179"><a href="#Solver-179"><span class="linenos">179</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;criteria&#39;</span><span class="p">,</span> <span class="n">StopCriteria</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
</span><span id="Solver-180"><a href="#Solver-180"><span class="linenos">180</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">has_converged</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Solver-181"><a href="#Solver-181"><span class="linenos">181</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save_all_newton</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_all_newton&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Solver-182"><a href="#Solver-182"><span class="linenos">182</span></a>
</span><span id="Solver-183"><a href="#Solver-183"><span class="linenos">183</span></a>            <span class="c1"># Set materials&#39; extra-arguements</span>
</span><span id="Solver-184"><a href="#Solver-184"><span class="linenos">184</span></a>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span><span class="n">oldsol</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">oldsols</span><span class="p">)):</span>
</span><span id="Solver-185"><a href="#Solver-185"><span class="linenos">185</span></a>                <span class="n">oldsol_qps</span> <span class="o">=</span> <span class="n">evaluate_at_qps</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">oldsol</span><span class="p">)</span>
</span><span id="Solver-186"><a href="#Solver-186"><span class="linenos">186</span></a>                <span class="n">oldsol_qps</span><span class="p">[</span><span class="n">oldsol_qps</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Solver-187"><a href="#Solver-187"><span class="linenos">187</span></a>                <span class="n">oldsol_qps</span><span class="p">[</span><span class="n">oldsol_qps</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Solver-188"><a href="#Solver-188"><span class="linenos">188</span></a>                <span class="n">set_mat_extra_arg</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">oldsol_qps</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Solver-189"><a href="#Solver-189"><span class="linenos">189</span></a>                <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">wf_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver-190"><a href="#Solver-190"><span class="linenos">190</span></a>                    <span class="n">set_mat_extra_arg</span><span class="p">(</span><span class="n">wf_res</span><span class="p">,</span> <span class="n">oldsol_qps</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Solver-191"><a href="#Solver-191"><span class="linenos">191</span></a>
</span><span id="Solver-192"><a href="#Solver-192"><span class="linenos">192</span></a>            <span class="c1"># line-search related weak form</span>
</span><span id="Solver-193"><a href="#Solver-193"><span class="linenos">193</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">line_search_bool</span> <span class="o">=</span> <span class="p">(</span><span class="n">wf_G</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> \
</span><span id="Solver-194"><a href="#Solver-194"><span class="linenos">194</span></a>                <span class="ow">and</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;line_search_bool&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Solver-195"><a href="#Solver-195"><span class="linenos">195</span></a>
</span><span id="Solver-196"><a href="#Solver-196"><span class="linenos">196</span></a>        <span class="c1"># Unbounded domains</span>
</span><span id="Solver-197"><a href="#Solver-197"><span class="linenos">197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sols</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="Solver-198"><a href="#Solver-198"><span class="linenos">198</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Solver-199"><a href="#Solver-199"><span class="linenos">199</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cogammas</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cogammas&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Solver-200"><a href="#Solver-200"><span class="linenos">200</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conn&#39;</span><span class="p">,</span> <span class="s1">&#39;connected&#39;</span><span class="p">)</span> <span class="c1"># or &#39;ping-pong&#39;</span>
</span><span id="Solver-201"><a href="#Solver-201"><span class="linenos">201</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="Solver-202"><a href="#Solver-202"><span class="linenos">202</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">max_iter_pp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_iter_pp&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
</span><span id="Solver-203"><a href="#Solver-203"><span class="linenos">203</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">relax_pp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relax_pp&#39;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
</span><span id="Solver-204"><a href="#Solver-204"><span class="linenos">204</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;connected&#39;</span><span class="p">:</span>
</span><span id="Solver-205"><a href="#Solver-205"><span class="linenos">205</span></a>                <span class="k">pass</span>
</span><span id="Solver-206"><a href="#Solver-206"><span class="linenos">206</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Solver-207"><a href="#Solver-207"><span class="linenos">207</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Connection keyword not recognized&quot;</span><span class="p">)</span>
</span><span id="Solver-208"><a href="#Solver-208"><span class="linenos">208</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Solver-209"><a href="#Solver-209"><span class="linenos">209</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-210"><a href="#Solver-210"><span class="linenos">210</span></a>
</span><span id="Solver-211"><a href="#Solver-211"><span class="linenos">211</span></a>        <span class="c1"># Additional initializations</span>
</span><span id="Solver-212"><a href="#Solver-212"><span class="linenos">212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_mtxvec_dic</span><span class="p">()</span>
</span><span id="Solver-213"><a href="#Solver-213"><span class="linenos">213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Solver-214"><a href="#Solver-214"><span class="linenos">214</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">outfiles</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-215"><a href="#Solver-215"><span class="linenos">215</span></a>
</span><span id="Solver-216"><a href="#Solver-216"><span class="linenos">216</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Solver-217"><a href="#Solver-217"><span class="linenos">217</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>
</span><span id="Solver-218"><a href="#Solver-218"><span class="linenos">218</span></a>
</span><span id="Solver-219"><a href="#Solver-219"><span class="linenos">219</span></a>    <span class="k">def</span> <span class="nf">init_mtxvec_dic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Solver-220"><a href="#Solver-220"><span class="linenos">220</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the dictionary of all matrices &amp; vectors. The keys</span>
</span><span id="Solver-221"><a href="#Solver-221"><span class="linenos">221</span></a><span class="sd">        depend on the nature of the simulation (linear or nonlinear, connection</span>
</span><span id="Solver-222"><a href="#Solver-222"><span class="linenos">222</span></a><span class="sd">        technique, etc.)&quot;&quot;&quot;</span>
</span><span id="Solver-223"><a href="#Solver-223"><span class="linenos">223</span></a>        <span class="n">mtxvec_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Solver-224"><a href="#Solver-224"><span class="linenos">224</span></a>        <span class="n">wf1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Solver-225"><a href="#Solver-225"><span class="linenos">225</span></a>        <span class="n">nwf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="Solver-226"><a href="#Solver-226"><span class="linenos">226</span></a>        <span class="k">if</span> <span class="n">nwf</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">nwf</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;connected&#39;</span><span class="p">):</span>
</span><span id="Solver-227"><a href="#Solver-227"><span class="linenos">227</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-228"><a href="#Solver-228"><span class="linenos">228</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-229"><a href="#Solver-229"><span class="linenos">229</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-230"><a href="#Solver-230"><span class="linenos">230</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-231"><a href="#Solver-231"><span class="linenos">231</span></a>            <span class="k">if</span> <span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver-232"><a href="#Solver-232"><span class="linenos">232</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-233"><a href="#Solver-233"><span class="linenos">233</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-234"><a href="#Solver-234"><span class="linenos">234</span></a>        <span class="k">elif</span> <span class="n">nwf</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="Solver-235"><a href="#Solver-235"><span class="linenos">235</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-236"><a href="#Solver-236"><span class="linenos">236</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-237"><a href="#Solver-237"><span class="linenos">237</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-238"><a href="#Solver-238"><span class="linenos">238</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-239"><a href="#Solver-239"><span class="linenos">239</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-240"><a href="#Solver-240"><span class="linenos">240</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-241"><a href="#Solver-241"><span class="linenos">241</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-242"><a href="#Solver-242"><span class="linenos">242</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-243"><a href="#Solver-243"><span class="linenos">243</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_mod_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-244"><a href="#Solver-244"><span class="linenos">244</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-245"><a href="#Solver-245"><span class="linenos">245</span></a>            <span class="k">if</span> <span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver-246"><a href="#Solver-246"><span class="linenos">246</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_mod_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-247"><a href="#Solver-247"><span class="linenos">247</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-248"><a href="#Solver-248"><span class="linenos">248</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Solver-249"><a href="#Solver-249"><span class="linenos">249</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>
</span><span id="Solver-250"><a href="#Solver-250"><span class="linenos">250</span></a>
</span><span id="Solver-251"><a href="#Solver-251"><span class="linenos">251</span></a>        <span class="n">wf_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_res&#39;</span><span class="p">)</span>
</span><span id="Solver-252"><a href="#Solver-252"><span class="linenos">252</span></a>        <span class="k">if</span> <span class="n">wf_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver-253"><a href="#Solver-253"><span class="linenos">253</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-254"><a href="#Solver-254"><span class="linenos">254</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-255"><a href="#Solver-255"><span class="linenos">255</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-256"><a href="#Solver-256"><span class="linenos">256</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-257"><a href="#Solver-257"><span class="linenos">257</span></a>            <span class="k">if</span> <span class="n">wf_res</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver-258"><a href="#Solver-258"><span class="linenos">258</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_mod_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-259"><a href="#Solver-259"><span class="linenos">259</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver-260"><a href="#Solver-260"><span class="linenos">260</span></a>
</span><span id="Solver-261"><a href="#Solver-261"><span class="linenos">261</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mtxvec_dic</span> <span class="o">=</span> <span class="n">mtxvec_dic</span>
</span><span id="Solver-262"><a href="#Solver-262"><span class="linenos">262</span></a>
</span><span id="Solver-263"><a href="#Solver-263"><span class="linenos">263</span></a>    <span class="k">def</span> <span class="nf">init_problems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Solver-264"><a href="#Solver-264"><span class="linenos">264</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize problem instances. The keys of the `pbs_dic` depend on</span>
</span><span id="Solver-265"><a href="#Solver-265"><span class="linenos">265</span></a><span class="sd">        the nature of the simulation (linear or nonlinear, connection</span>
</span><span id="Solver-266"><a href="#Solver-266"><span class="linenos">266</span></a><span class="sd">        technique, etc.)&quot;&quot;&quot;</span>
</span><span id="Solver-267"><a href="#Solver-267"><span class="linenos">267</span></a>
</span><span id="Solver-268"><a href="#Solver-268"><span class="linenos">268</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Solver-269"><a href="#Solver-269"><span class="linenos">269</span></a>        <span class="n">wf1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Solver-270"><a href="#Solver-270"><span class="linenos">270</span></a>
</span><span id="Solver-271"><a href="#Solver-271"><span class="linenos">271</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Solver-272"><a href="#Solver-272"><span class="linenos">272</span></a>            <span class="n">ebcs</span> <span class="o">=</span> <span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">)</span>
</span><span id="Solver-273"><a href="#Solver-273"><span class="linenos">273</span></a>            <span class="n">epbcs</span> <span class="o">=</span> <span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">epbcs</span><span class="p">)</span>
</span><span id="Solver-274"><a href="#Solver-274"><span class="linenos">274</span></a>            <span class="n">eqs_cst</span> <span class="o">=</span> <span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">])</span>
</span><span id="Solver-275"><a href="#Solver-275"><span class="linenos">275</span></a>            <span class="n">pb_cst</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst&#39;</span><span class="p">,</span> <span class="n">equations</span><span class="o">=</span><span class="n">eqs_cst</span><span class="p">,</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Solver-276"><a href="#Solver-276"><span class="linenos">276</span></a>            <span class="n">pb_cst</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">ebcs</span><span class="p">,</span> <span class="n">epbcs</span><span class="o">=</span><span class="n">epbcs</span><span class="p">)</span>
</span><span id="Solver-277"><a href="#Solver-277"><span class="linenos">277</span></a>            <span class="n">pb_cst</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver-278"><a href="#Solver-278"><span class="linenos">278</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst</span>
</span><span id="Solver-279"><a href="#Solver-279"><span class="linenos">279</span></a>            <span class="k">if</span> <span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver-280"><a href="#Solver-280"><span class="linenos">280</span></a>                <span class="n">eqs_mod</span> <span class="o">=</span> <span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">])</span>
</span><span id="Solver-281"><a href="#Solver-281"><span class="linenos">281</span></a>                <span class="n">pb_mod</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod&#39;</span><span class="p">,</span> <span class="n">equations</span><span class="o">=</span><span class="n">eqs_mod</span><span class="p">,</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Solver-282"><a href="#Solver-282"><span class="linenos">282</span></a>                <span class="n">pb_mod</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">ebcs</span><span class="p">,</span> <span class="n">epbcs</span><span class="o">=</span><span class="n">epbcs</span><span class="p">)</span>
</span><span id="Solver-283"><a href="#Solver-283"><span class="linenos">283</span></a>                <span class="n">pb_mod</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver-284"><a href="#Solver-284"><span class="linenos">284</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod</span>
</span><span id="Solver-285"><a href="#Solver-285"><span class="linenos">285</span></a>
</span><span id="Solver-286"><a href="#Solver-286"><span class="linenos">286</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Solver-287"><a href="#Solver-287"><span class="linenos">287</span></a>            <span class="n">wf2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Solver-288"><a href="#Solver-288"><span class="linenos">288</span></a>
</span><span id="Solver-289"><a href="#Solver-289"><span class="linenos">289</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;connected&#39;</span><span class="p">:</span>
</span><span id="Solver-290"><a href="#Solver-290"><span class="linenos">290</span></a>                <span class="k">def</span> <span class="nf">zero_shift</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">coors</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
</span><span id="Solver-291"><a href="#Solver-291"><span class="linenos">291</span></a>                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">coors</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="Solver-292"><a href="#Solver-292"><span class="linenos">292</span></a>                <span class="n">match_coors</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="s1">&#39;match_coors&#39;</span><span class="p">,</span> <span class="n">per</span><span class="o">.</span><span class="n">match_coors</span><span class="p">)</span>
</span><span id="Solver-293"><a href="#Solver-293"><span class="linenos">293</span></a>                <span class="n">shift_fun</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="s1">&#39;shift_fun&#39;</span><span class="p">,</span> <span class="n">zero_shift</span><span class="p">)</span>
</span><span id="Solver-294"><a href="#Solver-294"><span class="linenos">294</span></a>                <span class="n">lcbcs</span> <span class="o">=</span> <span class="n">Conditions</span><span class="p">(</span>
</span><span id="Solver-295"><a href="#Solver-295"><span class="linenos">295</span></a>                    <span class="p">[</span><span class="n">LinearCombinationBC</span><span class="p">(</span><span class="s1">&#39;lc12&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cogammas</span><span class="p">,</span>
</span><span id="Solver-296"><a href="#Solver-296"><span class="linenos">296</span></a>                    <span class="p">{</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.all&#39;</span> <span class="o">%</span><span class="n">wf1</span><span class="o">.</span><span class="n">unknown_name</span> <span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.all&#39;</span> <span class="o">%</span><span class="n">wf2</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">},</span>
</span><span id="Solver-297"><a href="#Solver-297"><span class="linenos">297</span></a>                    <span class="n">match_coors</span><span class="p">,</span> <span class="s1">&#39;shifted_periodic&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">(</span><span class="n">shift_fun</span><span class="p">,))])</span>
</span><span id="Solver-298"><a href="#Solver-298"><span class="linenos">298</span></a>                <span class="n">ebcs</span> <span class="o">=</span> <span class="n">Conditions</span><span class="p">(</span><span class="n">concatenate</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">,</span> <span class="n">wf2</span><span class="o">.</span><span class="n">ebcs</span><span class="p">]))</span>
</span><span id="Solver-299"><a href="#Solver-299"><span class="linenos">299</span></a>                <span class="n">epbcs</span> <span class="o">=</span> <span class="n">Conditions</span><span class="p">(</span><span class="n">concatenate</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">epbcs</span><span class="p">,</span> <span class="n">wf2</span><span class="o">.</span><span class="n">epbcs</span><span class="p">]))</span>
</span><span id="Solver-300"><a href="#Solver-300"><span class="linenos">300</span></a>                <span class="n">eqs_cst</span> <span class="o">=</span> <span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">,</span> <span class="n">wf2</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">])</span>
</span><span id="Solver-301"><a href="#Solver-301"><span class="linenos">301</span></a>                <span class="n">pb_cst</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst&#39;</span><span class="p">,</span> <span class="n">equations</span><span class="o">=</span><span class="n">eqs_cst</span><span class="p">,</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Solver-302"><a href="#Solver-302"><span class="linenos">302</span></a>                <span class="n">pb_cst</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">ebcs</span><span class="p">,</span> <span class="n">epbcs</span><span class="o">=</span><span class="n">epbcs</span><span class="p">,</span> <span class="n">lcbcs</span><span class="o">=</span><span class="n">lcbcs</span><span class="p">)</span>
</span><span id="Solver-303"><a href="#Solver-303"><span class="linenos">303</span></a>                <span class="n">pb_cst</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver-304"><a href="#Solver-304"><span class="linenos">304</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst</span>
</span><span id="Solver-305"><a href="#Solver-305"><span class="linenos">305</span></a>                <span class="k">if</span> <span class="n">wf2</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver-306"><a href="#Solver-306"><span class="linenos">306</span></a>                    <span class="n">eqs_mod</span> <span class="o">=</span> <span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">,</span> <span class="n">wf2</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">])</span>
</span><span id="Solver-307"><a href="#Solver-307"><span class="linenos">307</span></a>                    <span class="n">pb_mod</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod&#39;</span><span class="p">,</span> <span class="n">equations</span><span class="o">=</span><span class="n">eqs_mod</span><span class="p">,</span>
</span><span id="Solver-308"><a href="#Solver-308"><span class="linenos">308</span></a>                                     <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Solver-309"><a href="#Solver-309"><span class="linenos">309</span></a>                    <span class="n">pb_mod</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">ebcs</span><span class="p">,</span> <span class="n">epbcs</span><span class="o">=</span><span class="n">epbcs</span><span class="p">,</span> <span class="n">lcbcs</span><span class="o">=</span><span class="n">lcbcs</span><span class="p">)</span>
</span><span id="Solver-310"><a href="#Solver-310"><span class="linenos">310</span></a>                    <span class="n">pb_mod</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver-311"><a href="#Solver-311"><span class="linenos">311</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod</span>
</span><span id="Solver-312"><a href="#Solver-312"><span class="linenos">312</span></a>
</span><span id="Solver-313"><a href="#Solver-313"><span class="linenos">313</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="Solver-314"><a href="#Solver-314"><span class="linenos">314</span></a>                <span class="n">pb_cst_pp1</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst_pp1&#39;</span><span class="p">,</span>
</span><span id="Solver-315"><a href="#Solver-315"><span class="linenos">315</span></a>                                     <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">]),</span>
</span><span id="Solver-316"><a href="#Solver-316"><span class="linenos">316</span></a>                                     <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Solver-317"><a href="#Solver-317"><span class="linenos">317</span></a>                <span class="n">pb_cst_pp1</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="Solver-318"><a href="#Solver-318"><span class="linenos">318</span></a>                                   <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="Solver-319"><a href="#Solver-319"><span class="linenos">319</span></a>                <span class="n">pb_cst_pp1</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver-320"><a href="#Solver-320"><span class="linenos">320</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst_pp1</span>
</span><span id="Solver-321"><a href="#Solver-321"><span class="linenos">321</span></a>
</span><span id="Solver-322"><a href="#Solver-322"><span class="linenos">322</span></a>                <span class="n">pb_cst_pp2</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst_pp2&#39;</span><span class="p">,</span>
</span><span id="Solver-323"><a href="#Solver-323"><span class="linenos">323</span></a>                                     <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf2</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">]),</span>
</span><span id="Solver-324"><a href="#Solver-324"><span class="linenos">324</span></a>                                     <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Solver-325"><a href="#Solver-325"><span class="linenos">325</span></a>                <span class="n">pb_cst_pp2</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf2</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="Solver-326"><a href="#Solver-326"><span class="linenos">326</span></a>                                   <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf2</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="Solver-327"><a href="#Solver-327"><span class="linenos">327</span></a>                <span class="n">pb_cst_pp2</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver-328"><a href="#Solver-328"><span class="linenos">328</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst_pp2</span>
</span><span id="Solver-329"><a href="#Solver-329"><span class="linenos">329</span></a>
</span><span id="Solver-330"><a href="#Solver-330"><span class="linenos">330</span></a>                <span class="n">pb_mod_pp2</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod_pp2&#39;</span><span class="p">,</span>
</span><span id="Solver-331"><a href="#Solver-331"><span class="linenos">331</span></a>                                    <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf2</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">]),</span>
</span><span id="Solver-332"><a href="#Solver-332"><span class="linenos">332</span></a>                                    <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Solver-333"><a href="#Solver-333"><span class="linenos">333</span></a>                <span class="n">pb_mod_pp2</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf2</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="Solver-334"><a href="#Solver-334"><span class="linenos">334</span></a>                                   <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf2</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="Solver-335"><a href="#Solver-335"><span class="linenos">335</span></a>                <span class="n">pb_mod_pp2</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver-336"><a href="#Solver-336"><span class="linenos">336</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod_pp2</span>
</span><span id="Solver-337"><a href="#Solver-337"><span class="linenos">337</span></a>
</span><span id="Solver-338"><a href="#Solver-338"><span class="linenos">338</span></a>                <span class="k">if</span> <span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver-339"><a href="#Solver-339"><span class="linenos">339</span></a>                    <span class="n">pb_mod_pp1</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod_pp1&#39;</span><span class="p">,</span>
</span><span id="Solver-340"><a href="#Solver-340"><span class="linenos">340</span></a>                                        <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">]),</span>
</span><span id="Solver-341"><a href="#Solver-341"><span class="linenos">341</span></a>                                        <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Solver-342"><a href="#Solver-342"><span class="linenos">342</span></a>                    <span class="n">pb_mod_pp1</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="Solver-343"><a href="#Solver-343"><span class="linenos">343</span></a>                                       <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="Solver-344"><a href="#Solver-344"><span class="linenos">344</span></a>                    <span class="n">pb_mod_pp1</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver-345"><a href="#Solver-345"><span class="linenos">345</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod_pp1</span>
</span><span id="Solver-346"><a href="#Solver-346"><span class="linenos">346</span></a>
</span><span id="Solver-347"><a href="#Solver-347"><span class="linenos">347</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Solver-348"><a href="#Solver-348"><span class="linenos">348</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Connection keyword not recognized&quot;</span><span class="p">)</span>
</span><span id="Solver-349"><a href="#Solver-349"><span class="linenos">349</span></a>
</span><span id="Solver-350"><a href="#Solver-350"><span class="linenos">350</span></a>        <span class="n">wf_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_res&#39;</span><span class="p">)</span>
</span><span id="Solver-351"><a href="#Solver-351"><span class="linenos">351</span></a>        <span class="k">if</span> <span class="n">wf_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver-352"><a href="#Solver-352"><span class="linenos">352</span></a>            <span class="n">pb_cst_res</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst_res&#39;</span><span class="p">,</span>
</span><span id="Solver-353"><a href="#Solver-353"><span class="linenos">353</span></a>                                 <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf_res</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">]),</span>
</span><span id="Solver-354"><a href="#Solver-354"><span class="linenos">354</span></a>                                 <span class="n">active_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Solver-355"><a href="#Solver-355"><span class="linenos">355</span></a>            <span class="n">pb_cst_res</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_res</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="Solver-356"><a href="#Solver-356"><span class="linenos">356</span></a>                               <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_res</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="Solver-357"><a href="#Solver-357"><span class="linenos">357</span></a>            <span class="n">pb_cst_res</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver-358"><a href="#Solver-358"><span class="linenos">358</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst_res</span>
</span><span id="Solver-359"><a href="#Solver-359"><span class="linenos">359</span></a>
</span><span id="Solver-360"><a href="#Solver-360"><span class="linenos">360</span></a>            <span class="n">pb_mod_res</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod_res&#39;</span><span class="p">,</span>
</span><span id="Solver-361"><a href="#Solver-361"><span class="linenos">361</span></a>                                 <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf_res</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">]),</span>
</span><span id="Solver-362"><a href="#Solver-362"><span class="linenos">362</span></a>                                 <span class="n">active_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Solver-363"><a href="#Solver-363"><span class="linenos">363</span></a>            <span class="n">pb_mod_res</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_res</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="Solver-364"><a href="#Solver-364"><span class="linenos">364</span></a>                               <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_res</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="Solver-365"><a href="#Solver-365"><span class="linenos">365</span></a>            <span class="n">pb_mod_res</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver-366"><a href="#Solver-366"><span class="linenos">366</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod_res</span>
</span><span id="Solver-367"><a href="#Solver-367"><span class="linenos">367</span></a>
</span><span id="Solver-368"><a href="#Solver-368"><span class="linenos">368</span></a>        <span class="n">wf_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_G&#39;</span><span class="p">)</span>
</span><span id="Solver-369"><a href="#Solver-369"><span class="linenos">369</span></a>        <span class="k">if</span> <span class="n">wf_G</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver-370"><a href="#Solver-370"><span class="linenos">370</span></a>            <span class="n">pb_cst_G</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst_G&#39;</span><span class="p">,</span>
</span><span id="Solver-371"><a href="#Solver-371"><span class="linenos">371</span></a>                                <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf_G</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">]),</span>
</span><span id="Solver-372"><a href="#Solver-372"><span class="linenos">372</span></a>                                <span class="n">active_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Solver-373"><a href="#Solver-373"><span class="linenos">373</span></a>            <span class="n">pb_cst_G</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_G</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="Solver-374"><a href="#Solver-374"><span class="linenos">374</span></a>                              <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_G</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="Solver-375"><a href="#Solver-375"><span class="linenos">375</span></a>            <span class="n">pb_cst_G</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver-376"><a href="#Solver-376"><span class="linenos">376</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst_G</span>
</span><span id="Solver-377"><a href="#Solver-377"><span class="linenos">377</span></a>
</span><span id="Solver-378"><a href="#Solver-378"><span class="linenos">378</span></a>            <span class="n">pb_mod_G</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod_G&#39;</span><span class="p">,</span>
</span><span id="Solver-379"><a href="#Solver-379"><span class="linenos">379</span></a>                                <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf_G</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">]),</span>
</span><span id="Solver-380"><a href="#Solver-380"><span class="linenos">380</span></a>                                <span class="n">active_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Solver-381"><a href="#Solver-381"><span class="linenos">381</span></a>            <span class="n">pb_mod_G</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_G</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="Solver-382"><a href="#Solver-382"><span class="linenos">382</span></a>                              <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_G</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="Solver-383"><a href="#Solver-383"><span class="linenos">383</span></a>            <span class="n">pb_mod_G</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver-384"><a href="#Solver-384"><span class="linenos">384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod_G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod_G</span>
</span><span id="Solver-385"><a href="#Solver-385"><span class="linenos">385</span></a>
</span><span id="Solver-386"><a href="#Solver-386"><span class="linenos">386</span></a>    <span class="k">def</span> <span class="nf">init_mtxvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Solver-387"><a href="#Solver-387"><span class="linenos">387</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Assemble all matrices and vectors. These objects are then accessible</span>
</span><span id="Solver-388"><a href="#Solver-388"><span class="linenos">388</span></a><span class="sd">        through the `self.mtxvec_dic` dictionary.&quot;&quot;&quot;</span>
</span><span id="Solver-389"><a href="#Solver-389"><span class="linenos">389</span></a>        <span class="n">pb_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="Solver-390"><a href="#Solver-390"><span class="linenos">390</span></a>        <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pb_list</span><span class="p">):</span>
</span><span id="Solver-391"><a href="#Solver-391"><span class="linenos">391</span></a>            <span class="k">if</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;pb_cst_G&#39;</span> <span class="ow">or</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;pb_mod_G&#39;</span><span class="p">:</span>
</span><span id="Solver-392"><a href="#Solver-392"><span class="linenos">392</span></a>                <span class="n">pb_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
</span><span id="Solver-393"><a href="#Solver-393"><span class="linenos">393</span></a>        <span class="n">assemble_mtxvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pb_list</span><span class="p">)</span>
</span><span id="Solver-394"><a href="#Solver-394"><span class="linenos">394</span></a>
</span><span id="Solver-395"><a href="#Solver-395"><span class="linenos">395</span></a>    <span class="k">def</span> <span class="nf">update_mtxvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Solver-396"><a href="#Solver-396"><span class="linenos">396</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Re-assemble matrices and vectors associated with terms featured in</span>
</span><span id="Solver-397"><a href="#Solver-397"><span class="linenos">397</span></a><span class="sd">        `eqn_mod` equations from all weak forms.&quot;&quot;&quot;</span>
</span><span id="Solver-398"><a href="#Solver-398"><span class="linenos">398</span></a>        <span class="n">pb_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Solver-399"><a href="#Solver-399"><span class="linenos">399</span></a>        <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="Solver-400"><a href="#Solver-400"><span class="linenos">400</span></a>            <span class="n">pb_name</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span>
</span><span id="Solver-401"><a href="#Solver-401"><span class="linenos">401</span></a>            <span class="k">if</span> <span class="n">pb_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;mod&#39;</span> <span class="ow">and</span> \
</span><span id="Solver-402"><a href="#Solver-402"><span class="linenos">402</span></a>                <span class="p">(</span><span class="n">pb_name</span><span class="o">!=</span><span class="s1">&#39;pb_cst_G&#39;</span> <span class="ow">or</span> <span class="n">pb_name</span><span class="o">!=</span><span class="s1">&#39;pb_mod_G&#39;</span><span class="p">):</span>
</span><span id="Solver-403"><a href="#Solver-403"><span class="linenos">403</span></a>                <span class="n">pb_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
</span><span id="Solver-404"><a href="#Solver-404"><span class="linenos">404</span></a>        <span class="n">assemble_mtxvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pb_list</span><span class="p">)</span>
</span><span id="Solver-405"><a href="#Solver-405"><span class="linenos">405</span></a>
</span><span id="Solver-406"><a href="#Solver-406"><span class="linenos">406</span></a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Solver-407"><a href="#Solver-407"><span class="linenos">407</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Launch the FEM computation!&quot;&quot;&quot;</span>
</span><span id="Solver-408"><a href="#Solver-408"><span class="linenos">408</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">islinear</span><span class="p">:</span>
</span><span id="Solver-409"><a href="#Solver-409"><span class="linenos">409</span></a>            <span class="n">lsolve</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Solver-410"><a href="#Solver-410"><span class="linenos">410</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Solver-411"><a href="#Solver-411"><span class="linenos">411</span></a>            <span class="n">nlsolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Solver-412"><a href="#Solver-412"><span class="linenos">412</span></a>
</span><span id="Solver-413"><a href="#Solver-413"><span class="linenos">413</span></a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Solver-414"><a href="#Solver-414"><span class="linenos">414</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Solver-415"><a href="#Solver-415"><span class="linenos">415</span></a><span class="sd">        Save the results to vtk. This routine is a wrapper for</span>
</span><span id="Solver-416"><a href="#Solver-416"><span class="linenos">416</span></a><span class="sd">        `femtoscope.inout.vtkfactory.createStructuredVTK`, which itself rely</span>
</span><span id="Solver-417"><a href="#Solver-417"><span class="linenos">417</span></a><span class="sd">        on meshio.</span>
</span><span id="Solver-418"><a href="#Solver-418"><span class="linenos">418</span></a><span class="sd">        Warning: the connectivity is reconstructed from scratch</span>
</span><span id="Solver-419"><a href="#Solver-419"><span class="linenos">419</span></a>
</span><span id="Solver-420"><a href="#Solver-420"><span class="linenos">420</span></a><span class="sd">        Parameters</span>
</span><span id="Solver-421"><a href="#Solver-421"><span class="linenos">421</span></a><span class="sd">        ----------</span>
</span><span id="Solver-422"><a href="#Solver-422"><span class="linenos">422</span></a><span class="sd">        grad : bool, optional</span>
</span><span id="Solver-423"><a href="#Solver-423"><span class="linenos">423</span></a><span class="sd">            Save the gradient of the scalar field. The default is False.</span>
</span><span id="Solver-424"><a href="#Solver-424"><span class="linenos">424</span></a><span class="sd">        name : str, optional</span>
</span><span id="Solver-425"><a href="#Solver-425"><span class="linenos">425</span></a><span class="sd">            Name of the output file (prefix).</span>
</span><span id="Solver-426"><a href="#Solver-426"><span class="linenos">426</span></a><span class="sd">            </span>
</span><span id="Solver-427"><a href="#Solver-427"><span class="linenos">427</span></a><span class="sd">        Returns</span>
</span><span id="Solver-428"><a href="#Solver-428"><span class="linenos">428</span></a><span class="sd">        -------</span>
</span><span id="Solver-429"><a href="#Solver-429"><span class="linenos">429</span></a><span class="sd">        out : list</span>
</span><span id="Solver-430"><a href="#Solver-430"><span class="linenos">430</span></a><span class="sd">            Result file names.</span>
</span><span id="Solver-431"><a href="#Solver-431"><span class="linenos">431</span></a>
</span><span id="Solver-432"><a href="#Solver-432"><span class="linenos">432</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Solver-433"><a href="#Solver-433"><span class="linenos">433</span></a>
</span><span id="Solver-434"><a href="#Solver-434"><span class="linenos">434</span></a>        <span class="kn">from</span> <span class="nn">femtoscope.inout.vtkfactory</span> <span class="kn">import</span> <span class="n">createStructuredVTK</span>
</span><span id="Solver-435"><a href="#Solver-435"><span class="linenos">435</span></a>        <span class="kn">from</span> <span class="nn">femtoscope.misc.util</span> <span class="kn">import</span> <span class="n">merge_dicts</span>
</span><span id="Solver-436"><a href="#Solver-436"><span class="linenos">436</span></a>        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="Solver-437"><a href="#Solver-437"><span class="linenos">437</span></a>        <span class="n">val_renorm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val_renorm&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="Solver-438"><a href="#Solver-438"><span class="linenos">438</span></a>        <span class="n">grad_renorm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grad_renorm&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="Solver-439"><a href="#Solver-439"><span class="linenos">439</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">((</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
</span><span id="Solver-440"><a href="#Solver-440"><span class="linenos">440</span></a>        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="Solver-441"><a href="#Solver-441"><span class="linenos">441</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
</span><span id="Solver-442"><a href="#Solver-442"><span class="linenos">442</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Solver-443"><a href="#Solver-443"><span class="linenos">443</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="Solver-444"><a href="#Solver-444"><span class="linenos">444</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dimension</span>
</span><span id="Solver-445"><a href="#Solver-445"><span class="linenos">445</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Solver-446"><a href="#Solver-446"><span class="linenos">446</span></a>        <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">sol</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sols</span><span class="p">)):</span>
</span><span id="Solver-447"><a href="#Solver-447"><span class="linenos">447</span></a>            <span class="n">vars_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Solver-448"><a href="#Solver-448"><span class="linenos">448</span></a>            <span class="c1"># Retrieve coordinates and connectivity</span>
</span><span id="Solver-449"><a href="#Solver-449"><span class="linenos">449</span></a>            <span class="n">pos</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_coor</span><span class="p">()</span> <span class="c1"># also works with pos = field.coors</span>
</span><span id="Solver-450"><a href="#Solver-450"><span class="linenos">450</span></a>            <span class="n">X</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Solver-451"><a href="#Solver-451"><span class="linenos">451</span></a>            <span class="n">Y</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="Solver-452"><a href="#Solver-452"><span class="linenos">452</span></a>            <span class="n">Z</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Solver-453"><a href="#Solver-453"><span class="linenos">453</span></a>            <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Solver-454"><a href="#Solver-454"><span class="linenos">454</span></a>                <span class="kn">from</span> <span class="nn">matplotlib.tri</span> <span class="kn">import</span> <span class="n">Triangulation</span>
</span><span id="Solver-455"><a href="#Solver-455"><span class="linenos">455</span></a>                <span class="n">cells</span> <span class="o">=</span> <span class="n">Triangulation</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">triangles</span>
</span><span id="Solver-456"><a href="#Solver-456"><span class="linenos">456</span></a>            <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="Solver-457"><a href="#Solver-457"><span class="linenos">457</span></a>                <span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">Delaunay</span>
</span><span id="Solver-458"><a href="#Solver-458"><span class="linenos">458</span></a>                <span class="n">cells</span> <span class="o">=</span> <span class="n">Delaunay</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">.</span><span class="n">vertices</span>
</span><span id="Solver-459"><a href="#Solver-459"><span class="linenos">459</span></a>            <span class="n">vars_dic</span><span class="p">[</span><span class="n">wf</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_renorm</span> <span class="o">*</span> <span class="n">sol</span>
</span><span id="Solver-460"><a href="#Solver-460"><span class="linenos">460</span></a>            <span class="k">if</span> <span class="n">grad</span><span class="p">:</span>
</span><span id="Solver-461"><a href="#Solver-461"><span class="linenos">461</span></a>                <span class="n">gradsol</span> <span class="o">=</span> <span class="n">grad_renorm</span> <span class="o">*</span> <span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">evaluate_at</span><span class="p">(</span>
</span><span id="Solver-462"><a href="#Solver-462"><span class="linenos">462</span></a>                    <span class="n">pos</span><span class="p">,</span> <span class="n">sol</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;grad&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="Solver-463"><a href="#Solver-463"><span class="linenos">463</span></a>                <span class="n">normgradsol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">gradsol</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Solver-464"><a href="#Solver-464"><span class="linenos">464</span></a>                <span class="n">vars_dic</span><span class="p">[</span><span class="s1">&#39;norm_grad_&#39;</span><span class="o">+</span><span class="n">wf</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">normgradsol</span>
</span><span id="Solver-465"><a href="#Solver-465"><span class="linenos">465</span></a>                <span class="n">vars_dic</span><span class="p">[</span><span class="s1">&#39;gradX_&#39;</span><span class="o">+</span><span class="n">wf</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gradsol</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Solver-466"><a href="#Solver-466"><span class="linenos">466</span></a>                <span class="n">vars_dic</span><span class="p">[</span><span class="s1">&#39;gradY_&#39;</span><span class="o">+</span><span class="n">wf</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gradsol</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="Solver-467"><a href="#Solver-467"><span class="linenos">467</span></a>                <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="Solver-468"><a href="#Solver-468"><span class="linenos">468</span></a>                    <span class="n">vars_dic</span><span class="p">[</span><span class="s1">&#39;gradZ_&#39;</span><span class="o">+</span><span class="n">wf</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gradsol</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="Solver-469"><a href="#Solver-469"><span class="linenos">469</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">kk</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">islinear</span><span class="p">):</span>
</span><span id="Solver-470"><a href="#Solver-470"><span class="linenos">470</span></a>                <span class="n">vars_dic</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">res_vec</span><span class="o">.</span><span class="n">data</span>
</span><span id="Solver-471"><a href="#Solver-471"><span class="linenos">471</span></a>                <span class="n">merge_dicts</span><span class="p">(</span><span class="n">vars_dic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">res_vec_parts</span><span class="p">)</span>
</span><span id="Solver-472"><a href="#Solver-472"><span class="linenos">472</span></a>            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">createStructuredVTK</span><span class="p">(</span>
</span><span id="Solver-473"><a href="#Solver-473"><span class="linenos">473</span></a>                <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">vars_dic</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">wf</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span><span id="Solver-474"><a href="#Solver-474"><span class="linenos">474</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">outfiles</span> <span class="o">=</span> <span class="n">out</span>
</span><span id="Solver-475"><a href="#Solver-475"><span class="linenos">475</span></a>        <span class="k">return</span> <span class="n">out</span>
</span><span id="Solver-476"><a href="#Solver-476"><span class="linenos">476</span></a>    
</span><span id="Solver-477"><a href="#Solver-477"><span class="linenos">477</span></a>    <span class="k">def</span> <span class="nf">plot_residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Solver-478"><a href="#Solver-478"><span class="linenos">478</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Solver-479"><a href="#Solver-479"><span class="linenos">479</span></a><span class="sd">        Plot the residual vector.</span>
</span><span id="Solver-480"><a href="#Solver-480"><span class="linenos">480</span></a><span class="sd">        Since 22/05/23, it is no longer necessary to remove ebc-DOFs from the</span>
</span><span id="Solver-481"><a href="#Solver-481"><span class="linenos">481</span></a><span class="sd">        coordinate array. The residual vector is not cropped anymore but</span>
</span><span id="Solver-482"><a href="#Solver-482"><span class="linenos">482</span></a><span class="sd">        contains NaN values instead.</span>
</span><span id="Solver-483"><a href="#Solver-483"><span class="linenos">483</span></a>
</span><span id="Solver-484"><a href="#Solver-484"><span class="linenos">484</span></a><span class="sd">        Parameters</span>
</span><span id="Solver-485"><a href="#Solver-485"><span class="linenos">485</span></a><span class="sd">        ----------</span>
</span><span id="Solver-486"><a href="#Solver-486"><span class="linenos">486</span></a><span class="sd">        log : bool, optional</span>
</span><span id="Solver-487"><a href="#Solver-487"><span class="linenos">487</span></a><span class="sd">            If True, plot the log of the absolute value of the residual vector.</span>
</span><span id="Solver-488"><a href="#Solver-488"><span class="linenos">488</span></a><span class="sd">            The default is False.</span>
</span><span id="Solver-489"><a href="#Solver-489"><span class="linenos">489</span></a>
</span><span id="Solver-490"><a href="#Solver-490"><span class="linenos">490</span></a><span class="sd">        Returns</span>
</span><span id="Solver-491"><a href="#Solver-491"><span class="linenos">491</span></a><span class="sd">        -------</span>
</span><span id="Solver-492"><a href="#Solver-492"><span class="linenos">492</span></a><span class="sd">        ax : Axes</span>
</span><span id="Solver-493"><a href="#Solver-493"><span class="linenos">493</span></a><span class="sd">            Figure axe.</span>
</span><span id="Solver-494"><a href="#Solver-494"><span class="linenos">494</span></a>
</span><span id="Solver-495"><a href="#Solver-495"><span class="linenos">495</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Solver-496"><a href="#Solver-496"><span class="linenos">496</span></a>        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</span><span id="Solver-497"><a href="#Solver-497"><span class="linenos">497</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dimension</span>
</span><span id="Solver-498"><a href="#Solver-498"><span class="linenos">498</span></a>        <span class="n">res_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">res_vec</span><span class="p">)</span>
</span><span id="Solver-499"><a href="#Solver-499"><span class="linenos">499</span></a>        <span class="n">coors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">coors</span>
</span><span id="Solver-500"><a href="#Solver-500"><span class="linenos">500</span></a>        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
</span><span id="Solver-501"><a href="#Solver-501"><span class="linenos">501</span></a>            <span class="n">res_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">res_vec</span><span class="p">))</span>
</span><span id="Solver-502"><a href="#Solver-502"><span class="linenos">502</span></a>        
</span><span id="Solver-503"><a href="#Solver-503"><span class="linenos">503</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</span><span id="Solver-504"><a href="#Solver-504"><span class="linenos">504</span></a>        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Solver-505"><a href="#Solver-505"><span class="linenos">505</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">coors</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">res_vec</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Solver-506"><a href="#Solver-506"><span class="linenos">506</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="Solver-507"><a href="#Solver-507"><span class="linenos">507</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Residual&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="Solver-508"><a href="#Solver-508"><span class="linenos">508</span></a>        <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Solver-509"><a href="#Solver-509"><span class="linenos">509</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">coors</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coors</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">res_vec</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Solver-510"><a href="#Solver-510"><span class="linenos">510</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Residual&quot;</span><span class="p">)</span>
</span><span id="Solver-511"><a href="#Solver-511"><span class="linenos">511</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Solver-512"><a href="#Solver-512"><span class="linenos">512</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot plot residual for dimension </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">dim</span><span class="p">)</span>
</span><span id="Solver-513"><a href="#Solver-513"><span class="linenos">513</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
</span><span id="Solver-514"><a href="#Solver-514"><span class="linenos">514</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="Solver-515"><a href="#Solver-515"><span class="linenos">515</span></a>        <span class="k">return</span> <span class="n">ax</span>
</span><span id="Solver-516"><a href="#Solver-516"><span class="linenos">516</span></a>
</span><span id="Solver-517"><a href="#Solver-517"><span class="linenos">517</span></a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Solver-518"><a href="#Solver-518"><span class="linenos">518</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Solver-519"><a href="#Solver-519"><span class="linenos">519</span></a><span class="sd">        Display FEM results. The `solve` method must have been called on the</span>
</span><span id="Solver-520"><a href="#Solver-520"><span class="linenos">520</span></a><span class="sd">        Solver instance beforehand.</span>
</span><span id="Solver-521"><a href="#Solver-521"><span class="linenos">521</span></a>
</span><span id="Solver-522"><a href="#Solver-522"><span class="linenos">522</span></a><span class="sd">        Parameters</span>
</span><span id="Solver-523"><a href="#Solver-523"><span class="linenos">523</span></a><span class="sd">        ----------</span>
</span><span id="Solver-524"><a href="#Solver-524"><span class="linenos">524</span></a><span class="sd">        grad : bool, optional</span>
</span><span id="Solver-525"><a href="#Solver-525"><span class="linenos">525</span></a><span class="sd">            Save the gradient of the scalar field. The default is False.</span>
</span><span id="Solver-526"><a href="#Solver-526"><span class="linenos">526</span></a><span class="sd">        kwargs :</span>
</span><span id="Solver-527"><a href="#Solver-527"><span class="linenos">527</span></a><span class="sd">            Potential extra arguments (to be added in the future).</span>
</span><span id="Solver-528"><a href="#Solver-528"><span class="linenos">528</span></a>
</span><span id="Solver-529"><a href="#Solver-529"><span class="linenos">529</span></a><span class="sd">        Returns</span>
</span><span id="Solver-530"><a href="#Solver-530"><span class="linenos">530</span></a><span class="sd">        -------</span>
</span><span id="Solver-531"><a href="#Solver-531"><span class="linenos">531</span></a><span class="sd">        None.</span>
</span><span id="Solver-532"><a href="#Solver-532"><span class="linenos">532</span></a>
</span><span id="Solver-533"><a href="#Solver-533"><span class="linenos">533</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Solver-534"><a href="#Solver-534"><span class="linenos">534</span></a>        <span class="kn">from</span> <span class="nn">femtoscope.display.fea_plot</span> <span class="kn">import</span> <span class="n">plot_from_vtk</span>
</span><span id="Solver-535"><a href="#Solver-535"><span class="linenos">535</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outfiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver-536"><a href="#Solver-536"><span class="linenos">536</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">grad</span><span class="o">=</span><span class="n">grad</span><span class="p">)</span>
</span><span id="Solver-537"><a href="#Solver-537"><span class="linenos">537</span></a>            <span class="n">delete</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Solver-538"><a href="#Solver-538"><span class="linenos">538</span></a>        <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outfiles</span><span class="p">:</span>
</span><span id="Solver-539"><a href="#Solver-539"><span class="linenos">539</span></a>            <span class="n">plot_from_vtk</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Solver-540"><a href="#Solver-540"><span class="linenos">540</span></a>            <span class="k">if</span> <span class="n">delete</span><span class="p">:</span>
</span><span id="Solver-541"><a href="#Solver-541"><span class="linenos">541</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span><span id="Solver-542"><a href="#Solver-542"><span class="linenos">542</span></a>
</span><span id="Solver-543"><a href="#Solver-543"><span class="linenos">543</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Solver-544"><a href="#Solver-544"><span class="linenos">544</span></a>        <span class="kn">from</span> <span class="nn">femtoscope.misc.util</span> <span class="kn">import</span> <span class="n">remove_empty_lines</span>
</span><span id="Solver-545"><a href="#Solver-545"><span class="linenos">545</span></a>        <span class="n">string</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="Solver-546"><a href="#Solver-546"><span class="linenos">546</span></a><span class="s2">        Solver:</span>
</span><span id="Solver-547"><a href="#Solver-547"><span class="linenos">547</span></a><span class="s2">            # weak-form(s): </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nwf</span><span class="si">}</span>
</span><span id="Solver-548"><a href="#Solver-548"><span class="linenos">548</span></a><span class="s2">        &quot;&quot;&quot;</span>
</span><span id="Solver-549"><a href="#Solver-549"><span class="linenos">549</span></a>
</span><span id="Solver-550"><a href="#Solver-550"><span class="linenos">550</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_bounded</span><span class="p">:</span>
</span><span id="Solver-551"><a href="#Solver-551"><span class="linenos">551</span></a>            <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="Solver-552"><a href="#Solver-552"><span class="linenos">552</span></a><span class="s2">            bounded domain</span>
</span><span id="Solver-553"><a href="#Solver-553"><span class="linenos">553</span></a><span class="s2">            &quot;&quot;&quot;</span>
</span><span id="Solver-554"><a href="#Solver-554"><span class="linenos">554</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Solver-555"><a href="#Solver-555"><span class="linenos">555</span></a>            <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="Solver-556"><a href="#Solver-556"><span class="linenos">556</span></a><span class="s2">            unbounded domain</span>
</span><span id="Solver-557"><a href="#Solver-557"><span class="linenos">557</span></a><span class="s2">            &quot;&quot;&quot;</span>
</span><span id="Solver-558"><a href="#Solver-558"><span class="linenos">558</span></a>
</span><span id="Solver-559"><a href="#Solver-559"><span class="linenos">559</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="Solver-560"><a href="#Solver-560"><span class="linenos">560</span></a>            <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="Solver-561"><a href="#Solver-561"><span class="linenos">561</span></a><span class="s2">            ping-pong max iter: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter_pp</span><span class="si">}</span>
</span><span id="Solver-562"><a href="#Solver-562"><span class="linenos">562</span></a><span class="s2">            &quot;&quot;&quot;</span>
</span><span id="Solver-563"><a href="#Solver-563"><span class="linenos">563</span></a>
</span><span id="Solver-564"><a href="#Solver-564"><span class="linenos">564</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">islinear</span><span class="p">:</span>
</span><span id="Solver-565"><a href="#Solver-565"><span class="linenos">565</span></a>            <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="Solver-566"><a href="#Solver-566"><span class="linenos">566</span></a><span class="s2">            is linear?: YES</span>
</span><span id="Solver-567"><a href="#Solver-567"><span class="linenos">567</span></a><span class="s2">            &quot;&quot;&quot;</span>
</span><span id="Solver-568"><a href="#Solver-568"><span class="linenos">568</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Solver-569"><a href="#Solver-569"><span class="linenos">569</span></a>            <span class="n">string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="Solver-570"><a href="#Solver-570"><span class="linenos">570</span></a><span class="s2">            is linear?: NO</span>
</span><span id="Solver-571"><a href="#Solver-571"><span class="linenos">571</span></a><span class="s2">            relax parameter: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">relax</span><span class="si">}</span>
</span><span id="Solver-572"><a href="#Solver-572"><span class="linenos">572</span></a><span class="s2">            &quot;&quot;&quot;</span>
</span><span id="Solver-573"><a href="#Solver-573"><span class="linenos">573</span></a>            <span class="n">string</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>
</span><span id="Solver-574"><a href="#Solver-574"><span class="linenos">574</span></a>
</span><span id="Solver-575"><a href="#Solver-575"><span class="linenos">575</span></a>        <span class="k">return</span> <span class="n">remove_empty_lines</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Class for performing FEM simulations.</p>

<h6 id="attributes">Attributes</h6>

<ul>
<li><strong>eps_dic</strong> (dict):
Dictionary with keys 'eps_a' and 'eps_r' corresponding to the absolute
and relative tolerance settings respectively.
The default is {'eps_a' : 1e-10, 'eps_r' : 1.0}</li>
<li><strong>ls</strong> (<code>sfepy.solvers.ls.ScipyDirect</code> by default.):
Linear solver to be used. The default is ScipyDirect.</li>
<li><strong>nls</strong> (<code>sfepy.solvers.nls.Newton</code>):
Nonlinear solver to be used. The default is Newton.</li>
<li><strong>wfs_dic</strong> (dict):
Dictionary of all weakforms used in the simulation. Item with key
'weakforms' represents the weakforms associated with the PDE to be
solved (1 wf for bounded domains, 2 wfs for unbounded ones). Other
weakforms are for supplementary purposes (evaluation of the strong
residual, line-search...).</li>
<li><strong>nwf</strong> (int):
Number of weak forms provided to the solver.</li>
<li><strong>islinear</strong> (bool):
Whether or not the PDE to be solved is linear.</li>
<li><strong>is_bounded</strong> (bool):
Whether or not the domain is bounded.</li>
<li><strong>iter</strong> (int, optional):
Maximum number of newton/picard iterations (defined if islinear is
False).</li>
<li><strong>initial_guess</strong> (list, optional):
List of initial guesses (one per weak form) used to initialize
nonlinear solver (defined if islinear is False).The default is a scalar
field set to zero everywhere.</li>
<li><strong>relax</strong> (float, optional):
Relaxation parameter for newton/picard method (defined if islinear is
False). The default is 0.9.</li>
<li><strong>criteria</strong> (<code>Criteria</code> instance, optional):
Criteria instance gathering the directives for when to stop nonlinear
iterations (defined if islinear is False). The default is to iterate
20 times.</li>
<li><strong>has_converged</strong> (bool):
False until the Criteria instance decrees convergence has been reached
(defined if islinear is False).</li>
<li><strong>sols</strong> (list):
List of the solution(s) (one per weak form).</li>
<li><strong>cogammas</strong> (list):
List of two <code>sfepy.discrete.common.region.Region</code> instances
corresponding to the interior and exterior domain common frontier
(defined if nwf = 2).</li>
<li><strong>conn</strong> (str):
Method for linking the interior domain with the exterior domain
['connected' , 'ping-pong']. The default is 'connected'.</li>
<li><strong>max_iter_pp</strong> (int):
Maximum number of iterations for the ping-pong method (defined if
conn = 'ping-pong'). The default is 7.</li>
<li><strong>relax_pp</strong> (float):
Relaxation parameter for ping-pong iterations (between 0 and 1).
The default is 0.7.</li>
<li><strong>bounds</strong> (list):
List of the min &amp; max field values (can be crucial to prevent
divergence in the solution for nonlinear problems).</li>
<li><strong>oldsols</strong> (list):
List of the solution(s) at the previous iteration (one per weak form).</li>
<li><strong>buffersols</strong> (list):
Temporary storage of the solution(s).</li>
<li><strong>outfiles</strong> (list):
List of the exported .vtk files containing simulation results.</li>
<li><strong>save_all_newton</strong> (bool):
Save all Newton's iterations (for nonlinear problems only).
The default is False.</li>
<li><strong>verbose</strong> (bool):
Display user's information. The default is False.</li>
</ul>
</div>


                            <div id="Solver.__init__" class="classattr">
                                        <input id="Solver.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Solver</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">wfs_dic</span>, </span><span class="param"><span class="n">islinear</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="Solver.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Solver.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Solver.__init__-121"><a href="#Solver.__init__-121"><span class="linenos">121</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wfs_dic</span><span class="p">,</span> <span class="n">islinear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Solver.__init__-122"><a href="#Solver.__init__-122"><span class="linenos">122</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Solver.__init__-123"><a href="#Solver.__init__-123"><span class="linenos">123</span></a><span class="sd">        Construct a Solver instance.</span>
</span><span id="Solver.__init__-124"><a href="#Solver.__init__-124"><span class="linenos">124</span></a>
</span><span id="Solver.__init__-125"><a href="#Solver.__init__-125"><span class="linenos">125</span></a><span class="sd">        Parameters</span>
</span><span id="Solver.__init__-126"><a href="#Solver.__init__-126"><span class="linenos">126</span></a><span class="sd">        ----------</span>
</span><span id="Solver.__init__-127"><a href="#Solver.__init__-127"><span class="linenos">127</span></a><span class="sd">        weakforms : list</span>
</span><span id="Solver.__init__-128"><a href="#Solver.__init__-128"><span class="linenos">128</span></a><span class="sd">            List of one or two WeakForm instances.</span>
</span><span id="Solver.__init__-129"><a href="#Solver.__init__-129"><span class="linenos">129</span></a><span class="sd">        islinear : bool, optional</span>
</span><span id="Solver.__init__-130"><a href="#Solver.__init__-130"><span class="linenos">130</span></a><span class="sd">            Whether or not the PDE to be solved is linear. The default is True.</span>
</span><span id="Solver.__init__-131"><a href="#Solver.__init__-131"><span class="linenos">131</span></a><span class="sd">        kwargs</span>
</span><span id="Solver.__init__-132"><a href="#Solver.__init__-132"><span class="linenos">132</span></a><span class="sd">            *Cf class documentation*</span>
</span><span id="Solver.__init__-133"><a href="#Solver.__init__-133"><span class="linenos">133</span></a>
</span><span id="Solver.__init__-134"><a href="#Solver.__init__-134"><span class="linenos">134</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Solver.__init__-135"><a href="#Solver.__init__-135"><span class="linenos">135</span></a>
</span><span id="Solver.__init__-136"><a href="#Solver.__init__-136"><span class="linenos">136</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Solver.__init__-137"><a href="#Solver.__init__-137"><span class="linenos">137</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="Solver.__init__-138"><a href="#Solver.__init__-138"><span class="linenos">138</span></a>            <span class="n">output</span><span class="o">.</span><span class="n">set_output</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Display Sfepy console&#39;s messages</span>
</span><span id="Solver.__init__-139"><a href="#Solver.__init__-139"><span class="linenos">139</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">print_kappa</span> <span class="o">=</span>  <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;print_kappa&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Solver.__init__-140"><a href="#Solver.__init__-140"><span class="linenos">140</span></a>
</span><span id="Solver.__init__-141"><a href="#Solver.__init__-141"><span class="linenos">141</span></a>        <span class="c1"># Solver(s) &amp; precision</span>
</span><span id="Solver.__init__-142"><a href="#Solver.__init__-142"><span class="linenos">142</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">eps_dic</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eps_dic&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;eps_a&#39;</span> <span class="p">:</span> <span class="mf">1e-15</span><span class="p">,</span>
</span><span id="Solver.__init__-143"><a href="#Solver.__init__-143"><span class="linenos">143</span></a>                                              <span class="s1">&#39;eps_r&#39;</span> <span class="p">:</span> <span class="mf">1e-15</span><span class="p">,</span>
</span><span id="Solver.__init__-144"><a href="#Solver.__init__-144"><span class="linenos">144</span></a>                                              <span class="s1">&#39;i_max&#39;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
</span><span id="Solver.__init__-145"><a href="#Solver.__init__-145"><span class="linenos">145</span></a>        <span class="c1"># self.ls = kwargs.get(&#39;ls&#39;, AutoDirect({}))</span>
</span><span id="Solver.__init__-146"><a href="#Solver.__init__-146"><span class="linenos">146</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ls</span> <span class="o">=</span> <span class="n">ScipyDirect</span><span class="p">({})</span>
</span><span id="Solver.__init__-147"><a href="#Solver.__init__-147"><span class="linenos">147</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nls</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nls&#39;</span><span class="p">,</span> <span class="n">Newton</span><span class="p">({</span><span class="s1">&#39;is_linear&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
</span><span id="Solver.__init__-148"><a href="#Solver.__init__-148"><span class="linenos">148</span></a>                                            <span class="n">lin_solver</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ls</span><span class="p">,</span>
</span><span id="Solver.__init__-149"><a href="#Solver.__init__-149"><span class="linenos">149</span></a>                                            <span class="n">status</span><span class="o">=</span><span class="n">IndexedStruct</span><span class="p">()))</span>
</span><span id="Solver.__init__-150"><a href="#Solver.__init__-150"><span class="linenos">150</span></a>        <span class="c1"># Weak Forms</span>
</span><span id="Solver.__init__-151"><a href="#Solver.__init__-151"><span class="linenos">151</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span> <span class="o">=</span> <span class="n">wfs_dic</span>
</span><span id="Solver.__init__-152"><a href="#Solver.__init__-152"><span class="linenos">152</span></a>        <span class="n">weakforms</span> <span class="o">=</span> <span class="n">wfs_dic</span><span class="p">[</span><span class="s1">&#39;weakforms&#39;</span><span class="p">]</span>
</span><span id="Solver.__init__-153"><a href="#Solver.__init__-153"><span class="linenos">153</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span> <span class="o">=</span> <span class="n">weakforms</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">weakforms</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> \
</span><span id="Solver.__init__-154"><a href="#Solver.__init__-154"><span class="linenos">154</span></a>                                   <span class="k">else</span> <span class="p">[</span><span class="n">weakforms</span><span class="p">]</span>
</span><span id="Solver.__init__-155"><a href="#Solver.__init__-155"><span class="linenos">155</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">)</span>
</span><span id="Solver.__init__-156"><a href="#Solver.__init__-156"><span class="linenos">156</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_bounded</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_bounded&#39;</span><span class="p">)</span>
</span><span id="Solver.__init__-157"><a href="#Solver.__init__-157"><span class="linenos">157</span></a>
</span><span id="Solver.__init__-158"><a href="#Solver.__init__-158"><span class="linenos">158</span></a>        <span class="c1"># TODO: pre-allocate solutions&#39; arrays</span>
</span><span id="Solver.__init__-159"><a href="#Solver.__init__-159"><span class="linenos">159</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">oldsols</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="Solver.__init__-160"><a href="#Solver.__init__-160"><span class="linenos">160</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buffersols</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="Solver.__init__-161"><a href="#Solver.__init__-161"><span class="linenos">161</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sols</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="Solver.__init__-162"><a href="#Solver.__init__-162"><span class="linenos">162</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bounds&#39;</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mf">1e15</span><span class="p">,</span> <span class="mf">1e15</span><span class="p">])</span>
</span><span id="Solver.__init__-163"><a href="#Solver.__init__-163"><span class="linenos">163</span></a>
</span><span id="Solver.__init__-164"><a href="#Solver.__init__-164"><span class="linenos">164</span></a>        <span class="c1"># Non-linear problems</span>
</span><span id="Solver.__init__-165"><a href="#Solver.__init__-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">islinear</span> <span class="o">=</span> <span class="n">islinear</span>
</span><span id="Solver.__init__-166"><a href="#Solver.__init__-166"><span class="linenos">166</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">islinear</span><span class="p">:</span>
</span><span id="Solver.__init__-167"><a href="#Solver.__init__-167"><span class="linenos">167</span></a>            <span class="n">wf_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_res&#39;</span><span class="p">)</span>
</span><span id="Solver.__init__-168"><a href="#Solver.__init__-168"><span class="linenos">168</span></a>            <span class="n">wf_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_G&#39;</span><span class="p">)</span>
</span><span id="Solver.__init__-169"><a href="#Solver.__init__-169"><span class="linenos">169</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">iter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Solver.__init__-170"><a href="#Solver.__init__-170"><span class="linenos">170</span></a>            <span class="n">initial_guess</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_guess&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="Solver.__init__-171"><a href="#Solver.__init__-171"><span class="linenos">171</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_guess</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Solver.__init__-172"><a href="#Solver.__init__-172"><span class="linenos">172</span></a>                <span class="k">for</span> <span class="n">wf</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">:</span>
</span><span id="Solver.__init__-173"><a href="#Solver.__init__-173"><span class="linenos">173</span></a>                    <span class="n">initial_guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">n_nod</span><span class="p">))</span>
</span><span id="Solver.__init__-174"><a href="#Solver.__init__-174"><span class="linenos">174</span></a>            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwf</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">initial_guess</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
</span><span id="Solver.__init__-175"><a href="#Solver.__init__-175"><span class="linenos">175</span></a>                <span class="n">initial_guess</span> <span class="o">=</span> <span class="p">[</span><span class="n">initial_guess</span><span class="p">]</span>
</span><span id="Solver.__init__-176"><a href="#Solver.__init__-176"><span class="linenos">176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">initial_guess</span> <span class="o">=</span> <span class="n">initial_guess</span>
</span><span id="Solver.__init__-177"><a href="#Solver.__init__-177"><span class="linenos">177</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">oldsols</span> <span class="o">=</span> <span class="n">copy_list_of_arrays</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initial_guess</span><span class="p">)</span>
</span><span id="Solver.__init__-178"><a href="#Solver.__init__-178"><span class="linenos">178</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">relax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relax&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
</span><span id="Solver.__init__-179"><a href="#Solver.__init__-179"><span class="linenos">179</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;criteria&#39;</span><span class="p">,</span> <span class="n">StopCriteria</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
</span><span id="Solver.__init__-180"><a href="#Solver.__init__-180"><span class="linenos">180</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">has_converged</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Solver.__init__-181"><a href="#Solver.__init__-181"><span class="linenos">181</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save_all_newton</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_all_newton&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Solver.__init__-182"><a href="#Solver.__init__-182"><span class="linenos">182</span></a>
</span><span id="Solver.__init__-183"><a href="#Solver.__init__-183"><span class="linenos">183</span></a>            <span class="c1"># Set materials&#39; extra-arguements</span>
</span><span id="Solver.__init__-184"><a href="#Solver.__init__-184"><span class="linenos">184</span></a>            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span><span class="n">oldsol</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">oldsols</span><span class="p">)):</span>
</span><span id="Solver.__init__-185"><a href="#Solver.__init__-185"><span class="linenos">185</span></a>                <span class="n">oldsol_qps</span> <span class="o">=</span> <span class="n">evaluate_at_qps</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">oldsol</span><span class="p">)</span>
</span><span id="Solver.__init__-186"><a href="#Solver.__init__-186"><span class="linenos">186</span></a>                <span class="n">oldsol_qps</span><span class="p">[</span><span class="n">oldsol_qps</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Solver.__init__-187"><a href="#Solver.__init__-187"><span class="linenos">187</span></a>                <span class="n">oldsol_qps</span><span class="p">[</span><span class="n">oldsol_qps</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Solver.__init__-188"><a href="#Solver.__init__-188"><span class="linenos">188</span></a>                <span class="n">set_mat_extra_arg</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">oldsol_qps</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Solver.__init__-189"><a href="#Solver.__init__-189"><span class="linenos">189</span></a>                <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">wf_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver.__init__-190"><a href="#Solver.__init__-190"><span class="linenos">190</span></a>                    <span class="n">set_mat_extra_arg</span><span class="p">(</span><span class="n">wf_res</span><span class="p">,</span> <span class="n">oldsol_qps</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Solver.__init__-191"><a href="#Solver.__init__-191"><span class="linenos">191</span></a>
</span><span id="Solver.__init__-192"><a href="#Solver.__init__-192"><span class="linenos">192</span></a>            <span class="c1"># line-search related weak form</span>
</span><span id="Solver.__init__-193"><a href="#Solver.__init__-193"><span class="linenos">193</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">line_search_bool</span> <span class="o">=</span> <span class="p">(</span><span class="n">wf_G</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> \
</span><span id="Solver.__init__-194"><a href="#Solver.__init__-194"><span class="linenos">194</span></a>                <span class="ow">and</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;line_search_bool&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Solver.__init__-195"><a href="#Solver.__init__-195"><span class="linenos">195</span></a>
</span><span id="Solver.__init__-196"><a href="#Solver.__init__-196"><span class="linenos">196</span></a>        <span class="c1"># Unbounded domains</span>
</span><span id="Solver.__init__-197"><a href="#Solver.__init__-197"><span class="linenos">197</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sols</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="Solver.__init__-198"><a href="#Solver.__init__-198"><span class="linenos">198</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Solver.__init__-199"><a href="#Solver.__init__-199"><span class="linenos">199</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cogammas</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cogammas&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Solver.__init__-200"><a href="#Solver.__init__-200"><span class="linenos">200</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conn&#39;</span><span class="p">,</span> <span class="s1">&#39;connected&#39;</span><span class="p">)</span> <span class="c1"># or &#39;ping-pong&#39;</span>
</span><span id="Solver.__init__-201"><a href="#Solver.__init__-201"><span class="linenos">201</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="Solver.__init__-202"><a href="#Solver.__init__-202"><span class="linenos">202</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">max_iter_pp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_iter_pp&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
</span><span id="Solver.__init__-203"><a href="#Solver.__init__-203"><span class="linenos">203</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">relax_pp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relax_pp&#39;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
</span><span id="Solver.__init__-204"><a href="#Solver.__init__-204"><span class="linenos">204</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;connected&#39;</span><span class="p">:</span>
</span><span id="Solver.__init__-205"><a href="#Solver.__init__-205"><span class="linenos">205</span></a>                <span class="k">pass</span>
</span><span id="Solver.__init__-206"><a href="#Solver.__init__-206"><span class="linenos">206</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Solver.__init__-207"><a href="#Solver.__init__-207"><span class="linenos">207</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Connection keyword not recognized&quot;</span><span class="p">)</span>
</span><span id="Solver.__init__-208"><a href="#Solver.__init__-208"><span class="linenos">208</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Solver.__init__-209"><a href="#Solver.__init__-209"><span class="linenos">209</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.__init__-210"><a href="#Solver.__init__-210"><span class="linenos">210</span></a>
</span><span id="Solver.__init__-211"><a href="#Solver.__init__-211"><span class="linenos">211</span></a>        <span class="c1"># Additional initializations</span>
</span><span id="Solver.__init__-212"><a href="#Solver.__init__-212"><span class="linenos">212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_mtxvec_dic</span><span class="p">()</span>
</span><span id="Solver.__init__-213"><a href="#Solver.__init__-213"><span class="linenos">213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Solver.__init__-214"><a href="#Solver.__init__-214"><span class="linenos">214</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">outfiles</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.__init__-215"><a href="#Solver.__init__-215"><span class="linenos">215</span></a>
</span><span id="Solver.__init__-216"><a href="#Solver.__init__-216"><span class="linenos">216</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="Solver.__init__-217"><a href="#Solver.__init__-217"><span class="linenos">217</span></a>            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span>
</span></pre></div>


            <div class="docstring"><p>Construct a Solver instance.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>weakforms</strong> (list):
List of one or two WeakForm instances.</li>
<li><strong>islinear</strong> (bool, optional):
Whether or not the PDE to be solved is linear. The default is True.</li>
<li><strong>kwargs</strong>: <em>Cf class documentation</em></li>
</ul>
</div>


                            </div>
                            <div id="Solver.forbidden_nl_arg" class="classattr">
                                <div class="attr variable">
            <span class="name">forbidden_nl_arg</span>        =
<span class="default_value">[&#39;update_nl&#39;, &#39;rho&#39;, &#39;rho_vac&#39;, &#39;Rcut&#39;, &#39;solver&#39;]</span>

        
    </div>
    <a class="headerlink" href="#Solver.forbidden_nl_arg"></a>
    
            <div class="docstring"><p>Class variable <code><a href="#Solver.forbidden_nl_arg">forbidden_nl_arg</a></code> is a list of material extra-arguments
(strings) which are not to be interpreted as non-linear terms.
Consequently, material's data will not be updated when calling the function
<code><a href="#update_material">update_material</a></code> unless the material's function has at least one extra-
argument not contained in that list.</p>
</div>


                            </div>
                            <div id="Solver.verbose" class="classattr">
                                <div class="attr variable">
            <span class="name">verbose</span>

        
    </div>
    <a class="headerlink" href="#Solver.verbose"></a>
    
    

                            </div>
                            <div id="Solver.print_kappa" class="classattr">
                                <div class="attr variable">
            <span class="name">print_kappa</span>

        
    </div>
    <a class="headerlink" href="#Solver.print_kappa"></a>
    
    

                            </div>
                            <div id="Solver.eps_dic" class="classattr">
                                <div class="attr variable">
            <span class="name">eps_dic</span>

        
    </div>
    <a class="headerlink" href="#Solver.eps_dic"></a>
    
    

                            </div>
                            <div id="Solver.ls" class="classattr">
                                <div class="attr variable">
            <span class="name">ls</span>

        
    </div>
    <a class="headerlink" href="#Solver.ls"></a>
    
    

                            </div>
                            <div id="Solver.nls" class="classattr">
                                <div class="attr variable">
            <span class="name">nls</span>

        
    </div>
    <a class="headerlink" href="#Solver.nls"></a>
    
    

                            </div>
                            <div id="Solver.wfs_dic" class="classattr">
                                <div class="attr variable">
            <span class="name">wfs_dic</span>

        
    </div>
    <a class="headerlink" href="#Solver.wfs_dic"></a>
    
    

                            </div>
                            <div id="Solver.weakforms" class="classattr">
                                <div class="attr variable">
            <span class="name">weakforms</span>

        
    </div>
    <a class="headerlink" href="#Solver.weakforms"></a>
    
    

                            </div>
                            <div id="Solver.nwf" class="classattr">
                                <div class="attr variable">
            <span class="name">nwf</span>

        
    </div>
    <a class="headerlink" href="#Solver.nwf"></a>
    
    

                            </div>
                            <div id="Solver.is_bounded" class="classattr">
                                <div class="attr variable">
            <span class="name">is_bounded</span>

        
    </div>
    <a class="headerlink" href="#Solver.is_bounded"></a>
    
    

                            </div>
                            <div id="Solver.oldsols" class="classattr">
                                <div class="attr variable">
            <span class="name">oldsols</span>

        
    </div>
    <a class="headerlink" href="#Solver.oldsols"></a>
    
    

                            </div>
                            <div id="Solver.buffersols" class="classattr">
                                <div class="attr variable">
            <span class="name">buffersols</span>

        
    </div>
    <a class="headerlink" href="#Solver.buffersols"></a>
    
    

                            </div>
                            <div id="Solver.sols" class="classattr">
                                <div class="attr variable">
            <span class="name">sols</span>

        
    </div>
    <a class="headerlink" href="#Solver.sols"></a>
    
    

                            </div>
                            <div id="Solver.bounds" class="classattr">
                                <div class="attr variable">
            <span class="name">bounds</span>

        
    </div>
    <a class="headerlink" href="#Solver.bounds"></a>
    
    

                            </div>
                            <div id="Solver.islinear" class="classattr">
                                <div class="attr variable">
            <span class="name">islinear</span>

        
    </div>
    <a class="headerlink" href="#Solver.islinear"></a>
    
    

                            </div>
                            <div id="Solver.initialized" class="classattr">
                                <div class="attr variable">
            <span class="name">initialized</span>

        
    </div>
    <a class="headerlink" href="#Solver.initialized"></a>
    
    

                            </div>
                            <div id="Solver.outfiles" class="classattr">
                                <div class="attr variable">
            <span class="name">outfiles</span>

        
    </div>
    <a class="headerlink" href="#Solver.outfiles"></a>
    
    

                            </div>
                            <div id="Solver.init_mtxvec_dic" class="classattr">
                                        <input id="Solver.init_mtxvec_dic-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">init_mtxvec_dic</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Solver.init_mtxvec_dic-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Solver.init_mtxvec_dic"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Solver.init_mtxvec_dic-219"><a href="#Solver.init_mtxvec_dic-219"><span class="linenos">219</span></a>    <span class="k">def</span> <span class="nf">init_mtxvec_dic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Solver.init_mtxvec_dic-220"><a href="#Solver.init_mtxvec_dic-220"><span class="linenos">220</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the dictionary of all matrices &amp; vectors. The keys</span>
</span><span id="Solver.init_mtxvec_dic-221"><a href="#Solver.init_mtxvec_dic-221"><span class="linenos">221</span></a><span class="sd">        depend on the nature of the simulation (linear or nonlinear, connection</span>
</span><span id="Solver.init_mtxvec_dic-222"><a href="#Solver.init_mtxvec_dic-222"><span class="linenos">222</span></a><span class="sd">        technique, etc.)&quot;&quot;&quot;</span>
</span><span id="Solver.init_mtxvec_dic-223"><a href="#Solver.init_mtxvec_dic-223"><span class="linenos">223</span></a>        <span class="n">mtxvec_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Solver.init_mtxvec_dic-224"><a href="#Solver.init_mtxvec_dic-224"><span class="linenos">224</span></a>        <span class="n">wf1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Solver.init_mtxvec_dic-225"><a href="#Solver.init_mtxvec_dic-225"><span class="linenos">225</span></a>        <span class="n">nwf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="Solver.init_mtxvec_dic-226"><a href="#Solver.init_mtxvec_dic-226"><span class="linenos">226</span></a>        <span class="k">if</span> <span class="n">nwf</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">nwf</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;connected&#39;</span><span class="p">):</span>
</span><span id="Solver.init_mtxvec_dic-227"><a href="#Solver.init_mtxvec_dic-227"><span class="linenos">227</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-228"><a href="#Solver.init_mtxvec_dic-228"><span class="linenos">228</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-229"><a href="#Solver.init_mtxvec_dic-229"><span class="linenos">229</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-230"><a href="#Solver.init_mtxvec_dic-230"><span class="linenos">230</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-231"><a href="#Solver.init_mtxvec_dic-231"><span class="linenos">231</span></a>            <span class="k">if</span> <span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver.init_mtxvec_dic-232"><a href="#Solver.init_mtxvec_dic-232"><span class="linenos">232</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-233"><a href="#Solver.init_mtxvec_dic-233"><span class="linenos">233</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-234"><a href="#Solver.init_mtxvec_dic-234"><span class="linenos">234</span></a>        <span class="k">elif</span> <span class="n">nwf</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="Solver.init_mtxvec_dic-235"><a href="#Solver.init_mtxvec_dic-235"><span class="linenos">235</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-236"><a href="#Solver.init_mtxvec_dic-236"><span class="linenos">236</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-237"><a href="#Solver.init_mtxvec_dic-237"><span class="linenos">237</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-238"><a href="#Solver.init_mtxvec_dic-238"><span class="linenos">238</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-239"><a href="#Solver.init_mtxvec_dic-239"><span class="linenos">239</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-240"><a href="#Solver.init_mtxvec_dic-240"><span class="linenos">240</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-241"><a href="#Solver.init_mtxvec_dic-241"><span class="linenos">241</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-242"><a href="#Solver.init_mtxvec_dic-242"><span class="linenos">242</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-243"><a href="#Solver.init_mtxvec_dic-243"><span class="linenos">243</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_mod_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-244"><a href="#Solver.init_mtxvec_dic-244"><span class="linenos">244</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-245"><a href="#Solver.init_mtxvec_dic-245"><span class="linenos">245</span></a>            <span class="k">if</span> <span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver.init_mtxvec_dic-246"><a href="#Solver.init_mtxvec_dic-246"><span class="linenos">246</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_mod_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-247"><a href="#Solver.init_mtxvec_dic-247"><span class="linenos">247</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-248"><a href="#Solver.init_mtxvec_dic-248"><span class="linenos">248</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Solver.init_mtxvec_dic-249"><a href="#Solver.init_mtxvec_dic-249"><span class="linenos">249</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>
</span><span id="Solver.init_mtxvec_dic-250"><a href="#Solver.init_mtxvec_dic-250"><span class="linenos">250</span></a>
</span><span id="Solver.init_mtxvec_dic-251"><a href="#Solver.init_mtxvec_dic-251"><span class="linenos">251</span></a>        <span class="n">wf_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_res&#39;</span><span class="p">)</span>
</span><span id="Solver.init_mtxvec_dic-252"><a href="#Solver.init_mtxvec_dic-252"><span class="linenos">252</span></a>        <span class="k">if</span> <span class="n">wf_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver.init_mtxvec_dic-253"><a href="#Solver.init_mtxvec_dic-253"><span class="linenos">253</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-254"><a href="#Solver.init_mtxvec_dic-254"><span class="linenos">254</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-255"><a href="#Solver.init_mtxvec_dic-255"><span class="linenos">255</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-256"><a href="#Solver.init_mtxvec_dic-256"><span class="linenos">256</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-257"><a href="#Solver.init_mtxvec_dic-257"><span class="linenos">257</span></a>            <span class="k">if</span> <span class="n">wf_res</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver.init_mtxvec_dic-258"><a href="#Solver.init_mtxvec_dic-258"><span class="linenos">258</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_mod_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-259"><a href="#Solver.init_mtxvec_dic-259"><span class="linenos">259</span></a>                <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Solver.init_mtxvec_dic-260"><a href="#Solver.init_mtxvec_dic-260"><span class="linenos">260</span></a>
</span><span id="Solver.init_mtxvec_dic-261"><a href="#Solver.init_mtxvec_dic-261"><span class="linenos">261</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mtxvec_dic</span> <span class="o">=</span> <span class="n">mtxvec_dic</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the dictionary of all matrices &amp; vectors. The keys
depend on the nature of the simulation (linear or nonlinear, connection
technique, etc.)</p>
</div>


                            </div>
                            <div id="Solver.init_problems" class="classattr">
                                        <input id="Solver.init_problems-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">init_problems</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Solver.init_problems-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Solver.init_problems"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Solver.init_problems-263"><a href="#Solver.init_problems-263"><span class="linenos">263</span></a>    <span class="k">def</span> <span class="nf">init_problems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Solver.init_problems-264"><a href="#Solver.init_problems-264"><span class="linenos">264</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize problem instances. The keys of the `pbs_dic` depend on</span>
</span><span id="Solver.init_problems-265"><a href="#Solver.init_problems-265"><span class="linenos">265</span></a><span class="sd">        the nature of the simulation (linear or nonlinear, connection</span>
</span><span id="Solver.init_problems-266"><a href="#Solver.init_problems-266"><span class="linenos">266</span></a><span class="sd">        technique, etc.)&quot;&quot;&quot;</span>
</span><span id="Solver.init_problems-267"><a href="#Solver.init_problems-267"><span class="linenos">267</span></a>
</span><span id="Solver.init_problems-268"><a href="#Solver.init_problems-268"><span class="linenos">268</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Solver.init_problems-269"><a href="#Solver.init_problems-269"><span class="linenos">269</span></a>        <span class="n">wf1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Solver.init_problems-270"><a href="#Solver.init_problems-270"><span class="linenos">270</span></a>
</span><span id="Solver.init_problems-271"><a href="#Solver.init_problems-271"><span class="linenos">271</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Solver.init_problems-272"><a href="#Solver.init_problems-272"><span class="linenos">272</span></a>            <span class="n">ebcs</span> <span class="o">=</span> <span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">)</span>
</span><span id="Solver.init_problems-273"><a href="#Solver.init_problems-273"><span class="linenos">273</span></a>            <span class="n">epbcs</span> <span class="o">=</span> <span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">epbcs</span><span class="p">)</span>
</span><span id="Solver.init_problems-274"><a href="#Solver.init_problems-274"><span class="linenos">274</span></a>            <span class="n">eqs_cst</span> <span class="o">=</span> <span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">])</span>
</span><span id="Solver.init_problems-275"><a href="#Solver.init_problems-275"><span class="linenos">275</span></a>            <span class="n">pb_cst</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst&#39;</span><span class="p">,</span> <span class="n">equations</span><span class="o">=</span><span class="n">eqs_cst</span><span class="p">,</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Solver.init_problems-276"><a href="#Solver.init_problems-276"><span class="linenos">276</span></a>            <span class="n">pb_cst</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">ebcs</span><span class="p">,</span> <span class="n">epbcs</span><span class="o">=</span><span class="n">epbcs</span><span class="p">)</span>
</span><span id="Solver.init_problems-277"><a href="#Solver.init_problems-277"><span class="linenos">277</span></a>            <span class="n">pb_cst</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver.init_problems-278"><a href="#Solver.init_problems-278"><span class="linenos">278</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst</span>
</span><span id="Solver.init_problems-279"><a href="#Solver.init_problems-279"><span class="linenos">279</span></a>            <span class="k">if</span> <span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver.init_problems-280"><a href="#Solver.init_problems-280"><span class="linenos">280</span></a>                <span class="n">eqs_mod</span> <span class="o">=</span> <span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">])</span>
</span><span id="Solver.init_problems-281"><a href="#Solver.init_problems-281"><span class="linenos">281</span></a>                <span class="n">pb_mod</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod&#39;</span><span class="p">,</span> <span class="n">equations</span><span class="o">=</span><span class="n">eqs_mod</span><span class="p">,</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Solver.init_problems-282"><a href="#Solver.init_problems-282"><span class="linenos">282</span></a>                <span class="n">pb_mod</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">ebcs</span><span class="p">,</span> <span class="n">epbcs</span><span class="o">=</span><span class="n">epbcs</span><span class="p">)</span>
</span><span id="Solver.init_problems-283"><a href="#Solver.init_problems-283"><span class="linenos">283</span></a>                <span class="n">pb_mod</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver.init_problems-284"><a href="#Solver.init_problems-284"><span class="linenos">284</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod</span>
</span><span id="Solver.init_problems-285"><a href="#Solver.init_problems-285"><span class="linenos">285</span></a>
</span><span id="Solver.init_problems-286"><a href="#Solver.init_problems-286"><span class="linenos">286</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwf</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Solver.init_problems-287"><a href="#Solver.init_problems-287"><span class="linenos">287</span></a>            <span class="n">wf2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="Solver.init_problems-288"><a href="#Solver.init_problems-288"><span class="linenos">288</span></a>
</span><span id="Solver.init_problems-289"><a href="#Solver.init_problems-289"><span class="linenos">289</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;connected&#39;</span><span class="p">:</span>
</span><span id="Solver.init_problems-290"><a href="#Solver.init_problems-290"><span class="linenos">290</span></a>                <span class="k">def</span> <span class="nf">zero_shift</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">coors</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
</span><span id="Solver.init_problems-291"><a href="#Solver.init_problems-291"><span class="linenos">291</span></a>                    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">coors</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="Solver.init_problems-292"><a href="#Solver.init_problems-292"><span class="linenos">292</span></a>                <span class="n">match_coors</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="s1">&#39;match_coors&#39;</span><span class="p">,</span> <span class="n">per</span><span class="o">.</span><span class="n">match_coors</span><span class="p">)</span>
</span><span id="Solver.init_problems-293"><a href="#Solver.init_problems-293"><span class="linenos">293</span></a>                <span class="n">shift_fun</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="s1">&#39;shift_fun&#39;</span><span class="p">,</span> <span class="n">zero_shift</span><span class="p">)</span>
</span><span id="Solver.init_problems-294"><a href="#Solver.init_problems-294"><span class="linenos">294</span></a>                <span class="n">lcbcs</span> <span class="o">=</span> <span class="n">Conditions</span><span class="p">(</span>
</span><span id="Solver.init_problems-295"><a href="#Solver.init_problems-295"><span class="linenos">295</span></a>                    <span class="p">[</span><span class="n">LinearCombinationBC</span><span class="p">(</span><span class="s1">&#39;lc12&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cogammas</span><span class="p">,</span>
</span><span id="Solver.init_problems-296"><a href="#Solver.init_problems-296"><span class="linenos">296</span></a>                    <span class="p">{</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.all&#39;</span> <span class="o">%</span><span class="n">wf1</span><span class="o">.</span><span class="n">unknown_name</span> <span class="p">:</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.all&#39;</span> <span class="o">%</span><span class="n">wf2</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">},</span>
</span><span id="Solver.init_problems-297"><a href="#Solver.init_problems-297"><span class="linenos">297</span></a>                    <span class="n">match_coors</span><span class="p">,</span> <span class="s1">&#39;shifted_periodic&#39;</span><span class="p">,</span> <span class="n">arguments</span><span class="o">=</span><span class="p">(</span><span class="n">shift_fun</span><span class="p">,))])</span>
</span><span id="Solver.init_problems-298"><a href="#Solver.init_problems-298"><span class="linenos">298</span></a>                <span class="n">ebcs</span> <span class="o">=</span> <span class="n">Conditions</span><span class="p">(</span><span class="n">concatenate</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">,</span> <span class="n">wf2</span><span class="o">.</span><span class="n">ebcs</span><span class="p">]))</span>
</span><span id="Solver.init_problems-299"><a href="#Solver.init_problems-299"><span class="linenos">299</span></a>                <span class="n">epbcs</span> <span class="o">=</span> <span class="n">Conditions</span><span class="p">(</span><span class="n">concatenate</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">epbcs</span><span class="p">,</span> <span class="n">wf2</span><span class="o">.</span><span class="n">epbcs</span><span class="p">]))</span>
</span><span id="Solver.init_problems-300"><a href="#Solver.init_problems-300"><span class="linenos">300</span></a>                <span class="n">eqs_cst</span> <span class="o">=</span> <span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">,</span> <span class="n">wf2</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">])</span>
</span><span id="Solver.init_problems-301"><a href="#Solver.init_problems-301"><span class="linenos">301</span></a>                <span class="n">pb_cst</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst&#39;</span><span class="p">,</span> <span class="n">equations</span><span class="o">=</span><span class="n">eqs_cst</span><span class="p">,</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Solver.init_problems-302"><a href="#Solver.init_problems-302"><span class="linenos">302</span></a>                <span class="n">pb_cst</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">ebcs</span><span class="p">,</span> <span class="n">epbcs</span><span class="o">=</span><span class="n">epbcs</span><span class="p">,</span> <span class="n">lcbcs</span><span class="o">=</span><span class="n">lcbcs</span><span class="p">)</span>
</span><span id="Solver.init_problems-303"><a href="#Solver.init_problems-303"><span class="linenos">303</span></a>                <span class="n">pb_cst</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver.init_problems-304"><a href="#Solver.init_problems-304"><span class="linenos">304</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst</span>
</span><span id="Solver.init_problems-305"><a href="#Solver.init_problems-305"><span class="linenos">305</span></a>                <span class="k">if</span> <span class="n">wf2</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver.init_problems-306"><a href="#Solver.init_problems-306"><span class="linenos">306</span></a>                    <span class="n">eqs_mod</span> <span class="o">=</span> <span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">,</span> <span class="n">wf2</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">])</span>
</span><span id="Solver.init_problems-307"><a href="#Solver.init_problems-307"><span class="linenos">307</span></a>                    <span class="n">pb_mod</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod&#39;</span><span class="p">,</span> <span class="n">equations</span><span class="o">=</span><span class="n">eqs_mod</span><span class="p">,</span>
</span><span id="Solver.init_problems-308"><a href="#Solver.init_problems-308"><span class="linenos">308</span></a>                                     <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Solver.init_problems-309"><a href="#Solver.init_problems-309"><span class="linenos">309</span></a>                    <span class="n">pb_mod</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">ebcs</span><span class="p">,</span> <span class="n">epbcs</span><span class="o">=</span><span class="n">epbcs</span><span class="p">,</span> <span class="n">lcbcs</span><span class="o">=</span><span class="n">lcbcs</span><span class="p">)</span>
</span><span id="Solver.init_problems-310"><a href="#Solver.init_problems-310"><span class="linenos">310</span></a>                    <span class="n">pb_mod</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver.init_problems-311"><a href="#Solver.init_problems-311"><span class="linenos">311</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod</span>
</span><span id="Solver.init_problems-312"><a href="#Solver.init_problems-312"><span class="linenos">312</span></a>
</span><span id="Solver.init_problems-313"><a href="#Solver.init_problems-313"><span class="linenos">313</span></a>            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="Solver.init_problems-314"><a href="#Solver.init_problems-314"><span class="linenos">314</span></a>                <span class="n">pb_cst_pp1</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst_pp1&#39;</span><span class="p">,</span>
</span><span id="Solver.init_problems-315"><a href="#Solver.init_problems-315"><span class="linenos">315</span></a>                                     <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">]),</span>
</span><span id="Solver.init_problems-316"><a href="#Solver.init_problems-316"><span class="linenos">316</span></a>                                     <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Solver.init_problems-317"><a href="#Solver.init_problems-317"><span class="linenos">317</span></a>                <span class="n">pb_cst_pp1</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="Solver.init_problems-318"><a href="#Solver.init_problems-318"><span class="linenos">318</span></a>                                   <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="Solver.init_problems-319"><a href="#Solver.init_problems-319"><span class="linenos">319</span></a>                <span class="n">pb_cst_pp1</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver.init_problems-320"><a href="#Solver.init_problems-320"><span class="linenos">320</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst_pp1</span>
</span><span id="Solver.init_problems-321"><a href="#Solver.init_problems-321"><span class="linenos">321</span></a>
</span><span id="Solver.init_problems-322"><a href="#Solver.init_problems-322"><span class="linenos">322</span></a>                <span class="n">pb_cst_pp2</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst_pp2&#39;</span><span class="p">,</span>
</span><span id="Solver.init_problems-323"><a href="#Solver.init_problems-323"><span class="linenos">323</span></a>                                     <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf2</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">]),</span>
</span><span id="Solver.init_problems-324"><a href="#Solver.init_problems-324"><span class="linenos">324</span></a>                                     <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Solver.init_problems-325"><a href="#Solver.init_problems-325"><span class="linenos">325</span></a>                <span class="n">pb_cst_pp2</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf2</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="Solver.init_problems-326"><a href="#Solver.init_problems-326"><span class="linenos">326</span></a>                                   <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf2</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="Solver.init_problems-327"><a href="#Solver.init_problems-327"><span class="linenos">327</span></a>                <span class="n">pb_cst_pp2</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver.init_problems-328"><a href="#Solver.init_problems-328"><span class="linenos">328</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst_pp2</span>
</span><span id="Solver.init_problems-329"><a href="#Solver.init_problems-329"><span class="linenos">329</span></a>
</span><span id="Solver.init_problems-330"><a href="#Solver.init_problems-330"><span class="linenos">330</span></a>                <span class="n">pb_mod_pp2</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod_pp2&#39;</span><span class="p">,</span>
</span><span id="Solver.init_problems-331"><a href="#Solver.init_problems-331"><span class="linenos">331</span></a>                                    <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf2</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">]),</span>
</span><span id="Solver.init_problems-332"><a href="#Solver.init_problems-332"><span class="linenos">332</span></a>                                    <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Solver.init_problems-333"><a href="#Solver.init_problems-333"><span class="linenos">333</span></a>                <span class="n">pb_mod_pp2</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf2</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="Solver.init_problems-334"><a href="#Solver.init_problems-334"><span class="linenos">334</span></a>                                   <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf2</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="Solver.init_problems-335"><a href="#Solver.init_problems-335"><span class="linenos">335</span></a>                <span class="n">pb_mod_pp2</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver.init_problems-336"><a href="#Solver.init_problems-336"><span class="linenos">336</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod_pp2</span>
</span><span id="Solver.init_problems-337"><a href="#Solver.init_problems-337"><span class="linenos">337</span></a>
</span><span id="Solver.init_problems-338"><a href="#Solver.init_problems-338"><span class="linenos">338</span></a>                <span class="k">if</span> <span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver.init_problems-339"><a href="#Solver.init_problems-339"><span class="linenos">339</span></a>                    <span class="n">pb_mod_pp1</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod_pp1&#39;</span><span class="p">,</span>
</span><span id="Solver.init_problems-340"><a href="#Solver.init_problems-340"><span class="linenos">340</span></a>                                        <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">]),</span>
</span><span id="Solver.init_problems-341"><a href="#Solver.init_problems-341"><span class="linenos">341</span></a>                                        <span class="n">active_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Solver.init_problems-342"><a href="#Solver.init_problems-342"><span class="linenos">342</span></a>                    <span class="n">pb_mod_pp1</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="Solver.init_problems-343"><a href="#Solver.init_problems-343"><span class="linenos">343</span></a>                                       <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="Solver.init_problems-344"><a href="#Solver.init_problems-344"><span class="linenos">344</span></a>                    <span class="n">pb_mod_pp1</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver.init_problems-345"><a href="#Solver.init_problems-345"><span class="linenos">345</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod_pp1</span>
</span><span id="Solver.init_problems-346"><a href="#Solver.init_problems-346"><span class="linenos">346</span></a>
</span><span id="Solver.init_problems-347"><a href="#Solver.init_problems-347"><span class="linenos">347</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Solver.init_problems-348"><a href="#Solver.init_problems-348"><span class="linenos">348</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Connection keyword not recognized&quot;</span><span class="p">)</span>
</span><span id="Solver.init_problems-349"><a href="#Solver.init_problems-349"><span class="linenos">349</span></a>
</span><span id="Solver.init_problems-350"><a href="#Solver.init_problems-350"><span class="linenos">350</span></a>        <span class="n">wf_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_res&#39;</span><span class="p">)</span>
</span><span id="Solver.init_problems-351"><a href="#Solver.init_problems-351"><span class="linenos">351</span></a>        <span class="k">if</span> <span class="n">wf_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver.init_problems-352"><a href="#Solver.init_problems-352"><span class="linenos">352</span></a>            <span class="n">pb_cst_res</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst_res&#39;</span><span class="p">,</span>
</span><span id="Solver.init_problems-353"><a href="#Solver.init_problems-353"><span class="linenos">353</span></a>                                 <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf_res</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">]),</span>
</span><span id="Solver.init_problems-354"><a href="#Solver.init_problems-354"><span class="linenos">354</span></a>                                 <span class="n">active_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Solver.init_problems-355"><a href="#Solver.init_problems-355"><span class="linenos">355</span></a>            <span class="n">pb_cst_res</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_res</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="Solver.init_problems-356"><a href="#Solver.init_problems-356"><span class="linenos">356</span></a>                               <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_res</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="Solver.init_problems-357"><a href="#Solver.init_problems-357"><span class="linenos">357</span></a>            <span class="n">pb_cst_res</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver.init_problems-358"><a href="#Solver.init_problems-358"><span class="linenos">358</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst_res</span>
</span><span id="Solver.init_problems-359"><a href="#Solver.init_problems-359"><span class="linenos">359</span></a>
</span><span id="Solver.init_problems-360"><a href="#Solver.init_problems-360"><span class="linenos">360</span></a>            <span class="n">pb_mod_res</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod_res&#39;</span><span class="p">,</span>
</span><span id="Solver.init_problems-361"><a href="#Solver.init_problems-361"><span class="linenos">361</span></a>                                 <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf_res</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">]),</span>
</span><span id="Solver.init_problems-362"><a href="#Solver.init_problems-362"><span class="linenos">362</span></a>                                 <span class="n">active_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Solver.init_problems-363"><a href="#Solver.init_problems-363"><span class="linenos">363</span></a>            <span class="n">pb_mod_res</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_res</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="Solver.init_problems-364"><a href="#Solver.init_problems-364"><span class="linenos">364</span></a>                               <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_res</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="Solver.init_problems-365"><a href="#Solver.init_problems-365"><span class="linenos">365</span></a>            <span class="n">pb_mod_res</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver.init_problems-366"><a href="#Solver.init_problems-366"><span class="linenos">366</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod_res</span>
</span><span id="Solver.init_problems-367"><a href="#Solver.init_problems-367"><span class="linenos">367</span></a>
</span><span id="Solver.init_problems-368"><a href="#Solver.init_problems-368"><span class="linenos">368</span></a>        <span class="n">wf_G</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_G&#39;</span><span class="p">)</span>
</span><span id="Solver.init_problems-369"><a href="#Solver.init_problems-369"><span class="linenos">369</span></a>        <span class="k">if</span> <span class="n">wf_G</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver.init_problems-370"><a href="#Solver.init_problems-370"><span class="linenos">370</span></a>            <span class="n">pb_cst_G</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_cst_G&#39;</span><span class="p">,</span>
</span><span id="Solver.init_problems-371"><a href="#Solver.init_problems-371"><span class="linenos">371</span></a>                                <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf_G</span><span class="o">.</span><span class="n">eqn_cst</span><span class="p">]),</span>
</span><span id="Solver.init_problems-372"><a href="#Solver.init_problems-372"><span class="linenos">372</span></a>                                <span class="n">active_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Solver.init_problems-373"><a href="#Solver.init_problems-373"><span class="linenos">373</span></a>            <span class="n">pb_cst_G</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_G</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="Solver.init_problems-374"><a href="#Solver.init_problems-374"><span class="linenos">374</span></a>                              <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_G</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="Solver.init_problems-375"><a href="#Solver.init_problems-375"><span class="linenos">375</span></a>            <span class="n">pb_cst_G</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver.init_problems-376"><a href="#Solver.init_problems-376"><span class="linenos">376</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_cst_G</span>
</span><span id="Solver.init_problems-377"><a href="#Solver.init_problems-377"><span class="linenos">377</span></a>
</span><span id="Solver.init_problems-378"><a href="#Solver.init_problems-378"><span class="linenos">378</span></a>            <span class="n">pb_mod_G</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="s1">&#39;pb_mod_G&#39;</span><span class="p">,</span>
</span><span id="Solver.init_problems-379"><a href="#Solver.init_problems-379"><span class="linenos">379</span></a>                                <span class="n">equations</span><span class="o">=</span><span class="n">Equations</span><span class="p">([</span><span class="n">wf_G</span><span class="o">.</span><span class="n">eqn_mod</span><span class="p">]),</span>
</span><span id="Solver.init_problems-380"><a href="#Solver.init_problems-380"><span class="linenos">380</span></a>                                <span class="n">active_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="Solver.init_problems-381"><a href="#Solver.init_problems-381"><span class="linenos">381</span></a>            <span class="n">pb_mod_G</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_G</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="Solver.init_problems-382"><a href="#Solver.init_problems-382"><span class="linenos">382</span></a>                              <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf_G</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="Solver.init_problems-383"><a href="#Solver.init_problems-383"><span class="linenos">383</span></a>            <span class="n">pb_mod_G</span><span class="o">.</span><span class="n">set_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nls</span><span class="p">)</span>
</span><span id="Solver.init_problems-384"><a href="#Solver.init_problems-384"><span class="linenos">384</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod_G&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pb_mod_G</span>
</span></pre></div>


            <div class="docstring"><p>Initialize problem instances. The keys of the <code>pbs_dic</code> depend on
the nature of the simulation (linear or nonlinear, connection
technique, etc.)</p>
</div>


                            </div>
                            <div id="Solver.init_mtxvec" class="classattr">
                                        <input id="Solver.init_mtxvec-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">init_mtxvec</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Solver.init_mtxvec-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Solver.init_mtxvec"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Solver.init_mtxvec-386"><a href="#Solver.init_mtxvec-386"><span class="linenos">386</span></a>    <span class="k">def</span> <span class="nf">init_mtxvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Solver.init_mtxvec-387"><a href="#Solver.init_mtxvec-387"><span class="linenos">387</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Assemble all matrices and vectors. These objects are then accessible</span>
</span><span id="Solver.init_mtxvec-388"><a href="#Solver.init_mtxvec-388"><span class="linenos">388</span></a><span class="sd">        through the `self.mtxvec_dic` dictionary.&quot;&quot;&quot;</span>
</span><span id="Solver.init_mtxvec-389"><a href="#Solver.init_mtxvec-389"><span class="linenos">389</span></a>        <span class="n">pb_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="Solver.init_mtxvec-390"><a href="#Solver.init_mtxvec-390"><span class="linenos">390</span></a>        <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pb_list</span><span class="p">):</span>
</span><span id="Solver.init_mtxvec-391"><a href="#Solver.init_mtxvec-391"><span class="linenos">391</span></a>            <span class="k">if</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;pb_cst_G&#39;</span> <span class="ow">or</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;pb_mod_G&#39;</span><span class="p">:</span>
</span><span id="Solver.init_mtxvec-392"><a href="#Solver.init_mtxvec-392"><span class="linenos">392</span></a>                <span class="n">pb_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
</span><span id="Solver.init_mtxvec-393"><a href="#Solver.init_mtxvec-393"><span class="linenos">393</span></a>        <span class="n">assemble_mtxvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pb_list</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Assemble all matrices and vectors. These objects are then accessible
through the <code>self.mtxvec_dic</code> dictionary.</p>
</div>


                            </div>
                            <div id="Solver.update_mtxvec" class="classattr">
                                        <input id="Solver.update_mtxvec-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_mtxvec</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Solver.update_mtxvec-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Solver.update_mtxvec"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Solver.update_mtxvec-395"><a href="#Solver.update_mtxvec-395"><span class="linenos">395</span></a>    <span class="k">def</span> <span class="nf">update_mtxvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Solver.update_mtxvec-396"><a href="#Solver.update_mtxvec-396"><span class="linenos">396</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Re-assemble matrices and vectors associated with terms featured in</span>
</span><span id="Solver.update_mtxvec-397"><a href="#Solver.update_mtxvec-397"><span class="linenos">397</span></a><span class="sd">        `eqn_mod` equations from all weak forms.&quot;&quot;&quot;</span>
</span><span id="Solver.update_mtxvec-398"><a href="#Solver.update_mtxvec-398"><span class="linenos">398</span></a>        <span class="n">pb_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Solver.update_mtxvec-399"><a href="#Solver.update_mtxvec-399"><span class="linenos">399</span></a>        <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pbs_dic</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
</span><span id="Solver.update_mtxvec-400"><a href="#Solver.update_mtxvec-400"><span class="linenos">400</span></a>            <span class="n">pb_name</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span>
</span><span id="Solver.update_mtxvec-401"><a href="#Solver.update_mtxvec-401"><span class="linenos">401</span></a>            <span class="k">if</span> <span class="n">pb_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;mod&#39;</span> <span class="ow">and</span> \
</span><span id="Solver.update_mtxvec-402"><a href="#Solver.update_mtxvec-402"><span class="linenos">402</span></a>                <span class="p">(</span><span class="n">pb_name</span><span class="o">!=</span><span class="s1">&#39;pb_cst_G&#39;</span> <span class="ow">or</span> <span class="n">pb_name</span><span class="o">!=</span><span class="s1">&#39;pb_mod_G&#39;</span><span class="p">):</span>
</span><span id="Solver.update_mtxvec-403"><a href="#Solver.update_mtxvec-403"><span class="linenos">403</span></a>                <span class="n">pb_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
</span><span id="Solver.update_mtxvec-404"><a href="#Solver.update_mtxvec-404"><span class="linenos">404</span></a>        <span class="n">assemble_mtxvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pb_list</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Re-assemble matrices and vectors associated with terms featured in
<code>eqn_mod</code> equations from all weak forms.</p>
</div>


                            </div>
                            <div id="Solver.solve" class="classattr">
                                        <input id="Solver.solve-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">solve</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Solver.solve-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Solver.solve"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Solver.solve-406"><a href="#Solver.solve-406"><span class="linenos">406</span></a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Solver.solve-407"><a href="#Solver.solve-407"><span class="linenos">407</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Launch the FEM computation!&quot;&quot;&quot;</span>
</span><span id="Solver.solve-408"><a href="#Solver.solve-408"><span class="linenos">408</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">islinear</span><span class="p">:</span>
</span><span id="Solver.solve-409"><a href="#Solver.solve-409"><span class="linenos">409</span></a>            <span class="n">lsolve</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Solver.solve-410"><a href="#Solver.solve-410"><span class="linenos">410</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Solver.solve-411"><a href="#Solver.solve-411"><span class="linenos">411</span></a>            <span class="n">nlsolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Launch the FEM computation!</p>
</div>


                            </div>
                            <div id="Solver.save" class="classattr">
                                        <input id="Solver.save-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">grad</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Solver.save-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Solver.save"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Solver.save-413"><a href="#Solver.save-413"><span class="linenos">413</span></a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Solver.save-414"><a href="#Solver.save-414"><span class="linenos">414</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Solver.save-415"><a href="#Solver.save-415"><span class="linenos">415</span></a><span class="sd">        Save the results to vtk. This routine is a wrapper for</span>
</span><span id="Solver.save-416"><a href="#Solver.save-416"><span class="linenos">416</span></a><span class="sd">        `femtoscope.inout.vtkfactory.createStructuredVTK`, which itself rely</span>
</span><span id="Solver.save-417"><a href="#Solver.save-417"><span class="linenos">417</span></a><span class="sd">        on meshio.</span>
</span><span id="Solver.save-418"><a href="#Solver.save-418"><span class="linenos">418</span></a><span class="sd">        Warning: the connectivity is reconstructed from scratch</span>
</span><span id="Solver.save-419"><a href="#Solver.save-419"><span class="linenos">419</span></a>
</span><span id="Solver.save-420"><a href="#Solver.save-420"><span class="linenos">420</span></a><span class="sd">        Parameters</span>
</span><span id="Solver.save-421"><a href="#Solver.save-421"><span class="linenos">421</span></a><span class="sd">        ----------</span>
</span><span id="Solver.save-422"><a href="#Solver.save-422"><span class="linenos">422</span></a><span class="sd">        grad : bool, optional</span>
</span><span id="Solver.save-423"><a href="#Solver.save-423"><span class="linenos">423</span></a><span class="sd">            Save the gradient of the scalar field. The default is False.</span>
</span><span id="Solver.save-424"><a href="#Solver.save-424"><span class="linenos">424</span></a><span class="sd">        name : str, optional</span>
</span><span id="Solver.save-425"><a href="#Solver.save-425"><span class="linenos">425</span></a><span class="sd">            Name of the output file (prefix).</span>
</span><span id="Solver.save-426"><a href="#Solver.save-426"><span class="linenos">426</span></a><span class="sd">            </span>
</span><span id="Solver.save-427"><a href="#Solver.save-427"><span class="linenos">427</span></a><span class="sd">        Returns</span>
</span><span id="Solver.save-428"><a href="#Solver.save-428"><span class="linenos">428</span></a><span class="sd">        -------</span>
</span><span id="Solver.save-429"><a href="#Solver.save-429"><span class="linenos">429</span></a><span class="sd">        out : list</span>
</span><span id="Solver.save-430"><a href="#Solver.save-430"><span class="linenos">430</span></a><span class="sd">            Result file names.</span>
</span><span id="Solver.save-431"><a href="#Solver.save-431"><span class="linenos">431</span></a>
</span><span id="Solver.save-432"><a href="#Solver.save-432"><span class="linenos">432</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Solver.save-433"><a href="#Solver.save-433"><span class="linenos">433</span></a>
</span><span id="Solver.save-434"><a href="#Solver.save-434"><span class="linenos">434</span></a>        <span class="kn">from</span> <span class="nn">femtoscope.inout.vtkfactory</span> <span class="kn">import</span> <span class="n">createStructuredVTK</span>
</span><span id="Solver.save-435"><a href="#Solver.save-435"><span class="linenos">435</span></a>        <span class="kn">from</span> <span class="nn">femtoscope.misc.util</span> <span class="kn">import</span> <span class="n">merge_dicts</span>
</span><span id="Solver.save-436"><a href="#Solver.save-436"><span class="linenos">436</span></a>        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="Solver.save-437"><a href="#Solver.save-437"><span class="linenos">437</span></a>        <span class="n">val_renorm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;val_renorm&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="Solver.save-438"><a href="#Solver.save-438"><span class="linenos">438</span></a>        <span class="n">grad_renorm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grad_renorm&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</span><span id="Solver.save-439"><a href="#Solver.save-439"><span class="linenos">439</span></a>        <span class="n">name</span> <span class="o">=</span> <span class="n">Path</span><span class="p">((</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)))</span>
</span><span id="Solver.save-440"><a href="#Solver.save-440"><span class="linenos">440</span></a>        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="Solver.save-441"><a href="#Solver.save-441"><span class="linenos">441</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">))</span>
</span><span id="Solver.save-442"><a href="#Solver.save-442"><span class="linenos">442</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Solver.save-443"><a href="#Solver.save-443"><span class="linenos">443</span></a>            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="Solver.save-444"><a href="#Solver.save-444"><span class="linenos">444</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dimension</span>
</span><span id="Solver.save-445"><a href="#Solver.save-445"><span class="linenos">445</span></a>        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Solver.save-446"><a href="#Solver.save-446"><span class="linenos">446</span></a>        <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">sol</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sols</span><span class="p">)):</span>
</span><span id="Solver.save-447"><a href="#Solver.save-447"><span class="linenos">447</span></a>            <span class="n">vars_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Solver.save-448"><a href="#Solver.save-448"><span class="linenos">448</span></a>            <span class="c1"># Retrieve coordinates and connectivity</span>
</span><span id="Solver.save-449"><a href="#Solver.save-449"><span class="linenos">449</span></a>            <span class="n">pos</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_coor</span><span class="p">()</span> <span class="c1"># also works with pos = field.coors</span>
</span><span id="Solver.save-450"><a href="#Solver.save-450"><span class="linenos">450</span></a>            <span class="n">X</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Solver.save-451"><a href="#Solver.save-451"><span class="linenos">451</span></a>            <span class="n">Y</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="Solver.save-452"><a href="#Solver.save-452"><span class="linenos">452</span></a>            <span class="n">Z</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">3</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="Solver.save-453"><a href="#Solver.save-453"><span class="linenos">453</span></a>            <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Solver.save-454"><a href="#Solver.save-454"><span class="linenos">454</span></a>                <span class="kn">from</span> <span class="nn">matplotlib.tri</span> <span class="kn">import</span> <span class="n">Triangulation</span>
</span><span id="Solver.save-455"><a href="#Solver.save-455"><span class="linenos">455</span></a>                <span class="n">cells</span> <span class="o">=</span> <span class="n">Triangulation</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span><span class="o">.</span><span class="n">triangles</span>
</span><span id="Solver.save-456"><a href="#Solver.save-456"><span class="linenos">456</span></a>            <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="Solver.save-457"><a href="#Solver.save-457"><span class="linenos">457</span></a>                <span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">Delaunay</span>
</span><span id="Solver.save-458"><a href="#Solver.save-458"><span class="linenos">458</span></a>                <span class="n">cells</span> <span class="o">=</span> <span class="n">Delaunay</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span><span class="o">.</span><span class="n">vertices</span>
</span><span id="Solver.save-459"><a href="#Solver.save-459"><span class="linenos">459</span></a>            <span class="n">vars_dic</span><span class="p">[</span><span class="n">wf</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_renorm</span> <span class="o">*</span> <span class="n">sol</span>
</span><span id="Solver.save-460"><a href="#Solver.save-460"><span class="linenos">460</span></a>            <span class="k">if</span> <span class="n">grad</span><span class="p">:</span>
</span><span id="Solver.save-461"><a href="#Solver.save-461"><span class="linenos">461</span></a>                <span class="n">gradsol</span> <span class="o">=</span> <span class="n">grad_renorm</span> <span class="o">*</span> <span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">evaluate_at</span><span class="p">(</span>
</span><span id="Solver.save-462"><a href="#Solver.save-462"><span class="linenos">462</span></a>                    <span class="n">pos</span><span class="p">,</span> <span class="n">sol</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;grad&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="Solver.save-463"><a href="#Solver.save-463"><span class="linenos">463</span></a>                <span class="n">normgradsol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">gradsol</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Solver.save-464"><a href="#Solver.save-464"><span class="linenos">464</span></a>                <span class="n">vars_dic</span><span class="p">[</span><span class="s1">&#39;norm_grad_&#39;</span><span class="o">+</span><span class="n">wf</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">normgradsol</span>
</span><span id="Solver.save-465"><a href="#Solver.save-465"><span class="linenos">465</span></a>                <span class="n">vars_dic</span><span class="p">[</span><span class="s1">&#39;gradX_&#39;</span><span class="o">+</span><span class="n">wf</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gradsol</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Solver.save-466"><a href="#Solver.save-466"><span class="linenos">466</span></a>                <span class="n">vars_dic</span><span class="p">[</span><span class="s1">&#39;gradY_&#39;</span><span class="o">+</span><span class="n">wf</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gradsol</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="Solver.save-467"><a href="#Solver.save-467"><span class="linenos">467</span></a>                <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="Solver.save-468"><a href="#Solver.save-468"><span class="linenos">468</span></a>                    <span class="n">vars_dic</span><span class="p">[</span><span class="s1">&#39;gradZ_&#39;</span><span class="o">+</span><span class="n">wf</span><span class="o">.</span><span class="n">unknown_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">gradsol</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="Solver.save-469"><a href="#Solver.save-469"><span class="linenos">469</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">kk</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">islinear</span><span class="p">):</span>
</span><span id="Solver.save-470"><a href="#Solver.save-470"><span class="linenos">470</span></a>                <span class="n">vars_dic</span><span class="p">[</span><span class="s1">&#39;residual&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">res_vec</span><span class="o">.</span><span class="n">data</span>
</span><span id="Solver.save-471"><a href="#Solver.save-471"><span class="linenos">471</span></a>                <span class="n">merge_dicts</span><span class="p">(</span><span class="n">vars_dic</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">res_vec_parts</span><span class="p">)</span>
</span><span id="Solver.save-472"><a href="#Solver.save-472"><span class="linenos">472</span></a>            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">createStructuredVTK</span><span class="p">(</span>
</span><span id="Solver.save-473"><a href="#Solver.save-473"><span class="linenos">473</span></a>                <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">vars_dic</span><span class="p">,</span> <span class="n">cells</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">wf</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span><span id="Solver.save-474"><a href="#Solver.save-474"><span class="linenos">474</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">outfiles</span> <span class="o">=</span> <span class="n">out</span>
</span><span id="Solver.save-475"><a href="#Solver.save-475"><span class="linenos">475</span></a>        <span class="k">return</span> <span class="n">out</span>
</span></pre></div>


            <div class="docstring"><p>Save the results to vtk. This routine is a wrapper for
<code><a href="../inout/vtkfactory.html#createStructuredVTK">femtoscope.inout.vtkfactory.createStructuredVTK</a></code>, which itself rely
on meshio.
Warning: the connectivity is reconstructed from scratch</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>grad</strong> (bool, optional):
Save the gradient of the scalar field. The default is False.</li>
<li><strong>name</strong> (str, optional):
Name of the output file (prefix).</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>out</strong> (list):
Result file names.</li>
</ul>
</div>


                            </div>
                            <div id="Solver.plot_residual" class="classattr">
                                        <input id="Solver.plot_residual-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">plot_residual</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">log</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Solver.plot_residual-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Solver.plot_residual"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Solver.plot_residual-477"><a href="#Solver.plot_residual-477"><span class="linenos">477</span></a>    <span class="k">def</span> <span class="nf">plot_residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Solver.plot_residual-478"><a href="#Solver.plot_residual-478"><span class="linenos">478</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Solver.plot_residual-479"><a href="#Solver.plot_residual-479"><span class="linenos">479</span></a><span class="sd">        Plot the residual vector.</span>
</span><span id="Solver.plot_residual-480"><a href="#Solver.plot_residual-480"><span class="linenos">480</span></a><span class="sd">        Since 22/05/23, it is no longer necessary to remove ebc-DOFs from the</span>
</span><span id="Solver.plot_residual-481"><a href="#Solver.plot_residual-481"><span class="linenos">481</span></a><span class="sd">        coordinate array. The residual vector is not cropped anymore but</span>
</span><span id="Solver.plot_residual-482"><a href="#Solver.plot_residual-482"><span class="linenos">482</span></a><span class="sd">        contains NaN values instead.</span>
</span><span id="Solver.plot_residual-483"><a href="#Solver.plot_residual-483"><span class="linenos">483</span></a>
</span><span id="Solver.plot_residual-484"><a href="#Solver.plot_residual-484"><span class="linenos">484</span></a><span class="sd">        Parameters</span>
</span><span id="Solver.plot_residual-485"><a href="#Solver.plot_residual-485"><span class="linenos">485</span></a><span class="sd">        ----------</span>
</span><span id="Solver.plot_residual-486"><a href="#Solver.plot_residual-486"><span class="linenos">486</span></a><span class="sd">        log : bool, optional</span>
</span><span id="Solver.plot_residual-487"><a href="#Solver.plot_residual-487"><span class="linenos">487</span></a><span class="sd">            If True, plot the log of the absolute value of the residual vector.</span>
</span><span id="Solver.plot_residual-488"><a href="#Solver.plot_residual-488"><span class="linenos">488</span></a><span class="sd">            The default is False.</span>
</span><span id="Solver.plot_residual-489"><a href="#Solver.plot_residual-489"><span class="linenos">489</span></a>
</span><span id="Solver.plot_residual-490"><a href="#Solver.plot_residual-490"><span class="linenos">490</span></a><span class="sd">        Returns</span>
</span><span id="Solver.plot_residual-491"><a href="#Solver.plot_residual-491"><span class="linenos">491</span></a><span class="sd">        -------</span>
</span><span id="Solver.plot_residual-492"><a href="#Solver.plot_residual-492"><span class="linenos">492</span></a><span class="sd">        ax : Axes</span>
</span><span id="Solver.plot_residual-493"><a href="#Solver.plot_residual-493"><span class="linenos">493</span></a><span class="sd">            Figure axe.</span>
</span><span id="Solver.plot_residual-494"><a href="#Solver.plot_residual-494"><span class="linenos">494</span></a>
</span><span id="Solver.plot_residual-495"><a href="#Solver.plot_residual-495"><span class="linenos">495</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Solver.plot_residual-496"><a href="#Solver.plot_residual-496"><span class="linenos">496</span></a>        <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</span><span id="Solver.plot_residual-497"><a href="#Solver.plot_residual-497"><span class="linenos">497</span></a>        <span class="n">dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dimension</span>
</span><span id="Solver.plot_residual-498"><a href="#Solver.plot_residual-498"><span class="linenos">498</span></a>        <span class="n">res_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">res_vec</span><span class="p">)</span>
</span><span id="Solver.plot_residual-499"><a href="#Solver.plot_residual-499"><span class="linenos">499</span></a>        <span class="n">coors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">coors</span>
</span><span id="Solver.plot_residual-500"><a href="#Solver.plot_residual-500"><span class="linenos">500</span></a>        <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
</span><span id="Solver.plot_residual-501"><a href="#Solver.plot_residual-501"><span class="linenos">501</span></a>            <span class="n">res_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">res_vec</span><span class="p">))</span>
</span><span id="Solver.plot_residual-502"><a href="#Solver.plot_residual-502"><span class="linenos">502</span></a>        
</span><span id="Solver.plot_residual-503"><a href="#Solver.plot_residual-503"><span class="linenos">503</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</span><span id="Solver.plot_residual-504"><a href="#Solver.plot_residual-504"><span class="linenos">504</span></a>        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Solver.plot_residual-505"><a href="#Solver.plot_residual-505"><span class="linenos">505</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">coors</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">res_vec</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Solver.plot_residual-506"><a href="#Solver.plot_residual-506"><span class="linenos">506</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$r$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="Solver.plot_residual-507"><a href="#Solver.plot_residual-507"><span class="linenos">507</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Residual&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="Solver.plot_residual-508"><a href="#Solver.plot_residual-508"><span class="linenos">508</span></a>        <span class="k">elif</span> <span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="Solver.plot_residual-509"><a href="#Solver.plot_residual-509"><span class="linenos">509</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">coors</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">coors</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">res_vec</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="Solver.plot_residual-510"><a href="#Solver.plot_residual-510"><span class="linenos">510</span></a>            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Residual&quot;</span><span class="p">)</span>
</span><span id="Solver.plot_residual-511"><a href="#Solver.plot_residual-511"><span class="linenos">511</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Solver.plot_residual-512"><a href="#Solver.plot_residual-512"><span class="linenos">512</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot plot residual for dimension </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">dim</span><span class="p">)</span>
</span><span id="Solver.plot_residual-513"><a href="#Solver.plot_residual-513"><span class="linenos">513</span></a>        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
</span><span id="Solver.plot_residual-514"><a href="#Solver.plot_residual-514"><span class="linenos">514</span></a>        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span><span id="Solver.plot_residual-515"><a href="#Solver.plot_residual-515"><span class="linenos">515</span></a>        <span class="k">return</span> <span class="n">ax</span>
</span></pre></div>


            <div class="docstring"><p>Plot the residual vector.
Since 22/05/23, it is no longer necessary to remove ebc-DOFs from the
coordinate array. The residual vector is not cropped anymore but
contains NaN values instead.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>log</strong> (bool, optional):
If True, plot the log of the absolute value of the residual vector.
The default is False.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>ax</strong> (Axes):
Figure axe.</li>
</ul>
</div>


                            </div>
                            <div id="Solver.display" class="classattr">
                                        <input id="Solver.display-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">display</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">grad</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Solver.display-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Solver.display"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Solver.display-517"><a href="#Solver.display-517"><span class="linenos">517</span></a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Solver.display-518"><a href="#Solver.display-518"><span class="linenos">518</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Solver.display-519"><a href="#Solver.display-519"><span class="linenos">519</span></a><span class="sd">        Display FEM results. The `solve` method must have been called on the</span>
</span><span id="Solver.display-520"><a href="#Solver.display-520"><span class="linenos">520</span></a><span class="sd">        Solver instance beforehand.</span>
</span><span id="Solver.display-521"><a href="#Solver.display-521"><span class="linenos">521</span></a>
</span><span id="Solver.display-522"><a href="#Solver.display-522"><span class="linenos">522</span></a><span class="sd">        Parameters</span>
</span><span id="Solver.display-523"><a href="#Solver.display-523"><span class="linenos">523</span></a><span class="sd">        ----------</span>
</span><span id="Solver.display-524"><a href="#Solver.display-524"><span class="linenos">524</span></a><span class="sd">        grad : bool, optional</span>
</span><span id="Solver.display-525"><a href="#Solver.display-525"><span class="linenos">525</span></a><span class="sd">            Save the gradient of the scalar field. The default is False.</span>
</span><span id="Solver.display-526"><a href="#Solver.display-526"><span class="linenos">526</span></a><span class="sd">        kwargs :</span>
</span><span id="Solver.display-527"><a href="#Solver.display-527"><span class="linenos">527</span></a><span class="sd">            Potential extra arguments (to be added in the future).</span>
</span><span id="Solver.display-528"><a href="#Solver.display-528"><span class="linenos">528</span></a>
</span><span id="Solver.display-529"><a href="#Solver.display-529"><span class="linenos">529</span></a><span class="sd">        Returns</span>
</span><span id="Solver.display-530"><a href="#Solver.display-530"><span class="linenos">530</span></a><span class="sd">        -------</span>
</span><span id="Solver.display-531"><a href="#Solver.display-531"><span class="linenos">531</span></a><span class="sd">        None.</span>
</span><span id="Solver.display-532"><a href="#Solver.display-532"><span class="linenos">532</span></a>
</span><span id="Solver.display-533"><a href="#Solver.display-533"><span class="linenos">533</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Solver.display-534"><a href="#Solver.display-534"><span class="linenos">534</span></a>        <span class="kn">from</span> <span class="nn">femtoscope.display.fea_plot</span> <span class="kn">import</span> <span class="n">plot_from_vtk</span>
</span><span id="Solver.display-535"><a href="#Solver.display-535"><span class="linenos">535</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outfiles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Solver.display-536"><a href="#Solver.display-536"><span class="linenos">536</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">grad</span><span class="o">=</span><span class="n">grad</span><span class="p">)</span>
</span><span id="Solver.display-537"><a href="#Solver.display-537"><span class="linenos">537</span></a>            <span class="n">delete</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Solver.display-538"><a href="#Solver.display-538"><span class="linenos">538</span></a>        <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outfiles</span><span class="p">:</span>
</span><span id="Solver.display-539"><a href="#Solver.display-539"><span class="linenos">539</span></a>            <span class="n">plot_from_vtk</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Solver.display-540"><a href="#Solver.display-540"><span class="linenos">540</span></a>            <span class="k">if</span> <span class="n">delete</span><span class="p">:</span>
</span><span id="Solver.display-541"><a href="#Solver.display-541"><span class="linenos">541</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Display FEM results. The <code><a href="#Solver.solve">solve</a></code> method must have been called on the
Solver instance beforehand.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>grad</strong> (bool, optional):
Save the gradient of the scalar field. The default is False.</li>
<li><strong>kwargs :</strong>: Potential extra arguments (to be added in the future).</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None.</strong></li>
</ul>
</div>


                            </div>
                </section>
                <section id="StopCriteria">
                            <input id="StopCriteria-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">StopCriteria</span>:

                <label class="view-source-button" for="StopCriteria-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StopCriteria"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StopCriteria-578"><a href="#StopCriteria-578"><span class="linenos">578</span></a><span class="k">class</span> <span class="nc">StopCriteria</span><span class="p">:</span>
</span><span id="StopCriteria-579"><a href="#StopCriteria-579"><span class="linenos">579</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StopCriteria-580"><a href="#StopCriteria-580"><span class="linenos">580</span></a><span class="sd">    Class defining stopping conditions for nonlinear problems.</span>
</span><span id="StopCriteria-581"><a href="#StopCriteria-581"><span class="linenos">581</span></a>
</span><span id="StopCriteria-582"><a href="#StopCriteria-582"><span class="linenos">582</span></a><span class="sd">    Attributes</span>
</span><span id="StopCriteria-583"><a href="#StopCriteria-583"><span class="linenos">583</span></a><span class="sd">    ----------</span>
</span><span id="StopCriteria-584"><a href="#StopCriteria-584"><span class="linenos">584</span></a><span class="sd">    min_iter : int</span>
</span><span id="StopCriteria-585"><a href="#StopCriteria-585"><span class="linenos">585</span></a><span class="sd">        Minimum number of Newton iterations. The default is 8.</span>
</span><span id="StopCriteria-586"><a href="#StopCriteria-586"><span class="linenos">586</span></a><span class="sd">    max_iter : int</span>
</span><span id="StopCriteria-587"><a href="#StopCriteria-587"><span class="linenos">587</span></a><span class="sd">        Maximum number of Newton iterations.</span>
</span><span id="StopCriteria-588"><a href="#StopCriteria-588"><span class="linenos">588</span></a><span class="sd">    sol_delta_tol : float</span>
</span><span id="StopCriteria-589"><a href="#StopCriteria-589"><span class="linenos">589</span></a><span class="sd">        Threshold on the minimum relative distance (in 2-norm) between two</span>
</span><span id="StopCriteria-590"><a href="#StopCriteria-590"><span class="linenos">590</span></a><span class="sd">        successive iterations.</span>
</span><span id="StopCriteria-591"><a href="#StopCriteria-591"><span class="linenos">591</span></a><span class="sd">    active_dic : dict</span>
</span><span id="StopCriteria-592"><a href="#StopCriteria-592"><span class="linenos">592</span></a><span class="sd">        Dictionary for knowing which criteria are active and which are not.</span>
</span><span id="StopCriteria-593"><a href="#StopCriteria-593"><span class="linenos">593</span></a><span class="sd">    verbose : bool</span>
</span><span id="StopCriteria-594"><a href="#StopCriteria-594"><span class="linenos">594</span></a><span class="sd">        Display user&#39;s information. The default is False.</span>
</span><span id="StopCriteria-595"><a href="#StopCriteria-595"><span class="linenos">595</span></a><span class="sd">    stop : bool</span>
</span><span id="StopCriteria-596"><a href="#StopCriteria-596"><span class="linenos">596</span></a><span class="sd">        False until some stopping criterion is met.</span>
</span><span id="StopCriteria-597"><a href="#StopCriteria-597"><span class="linenos">597</span></a><span class="sd">    res_vec : ndarray</span>
</span><span id="StopCriteria-598"><a href="#StopCriteria-598"><span class="linenos">598</span></a><span class="sd">        Current strong residual vector.</span>
</span><span id="StopCriteria-599"><a href="#StopCriteria-599"><span class="linenos">599</span></a><span class="sd">    res_vec_parts : dic</span>
</span><span id="StopCriteria-600"><a href="#StopCriteria-600"><span class="linenos">600</span></a><span class="sd">        Dictionary with keys (&#39;mtx&#39;, &#39;rhs_cst&#39;, &#39;rhs_mod&#39;) and values each term</span>
</span><span id="StopCriteria-601"><a href="#StopCriteria-601"><span class="linenos">601</span></a><span class="sd">        of the strong residual vector.</span>
</span><span id="StopCriteria-602"><a href="#StopCriteria-602"><span class="linenos">602</span></a><span class="sd">    res : float</span>
</span><span id="StopCriteria-603"><a href="#StopCriteria-603"><span class="linenos">603</span></a><span class="sd">        Current value of the strong residual (L2-norm).</span>
</span><span id="StopCriteria-604"><a href="#StopCriteria-604"><span class="linenos">604</span></a><span class="sd">    sol_delta : float</span>
</span><span id="StopCriteria-605"><a href="#StopCriteria-605"><span class="linenos">605</span></a><span class="sd">        Current value of the relative distance between two successive</span>
</span><span id="StopCriteria-606"><a href="#StopCriteria-606"><span class="linenos">606</span></a><span class="sd">        iterations.</span>
</span><span id="StopCriteria-607"><a href="#StopCriteria-607"><span class="linenos">607</span></a><span class="sd">    history : list of dicts</span>
</span><span id="StopCriteria-608"><a href="#StopCriteria-608"><span class="linenos">608</span></a><span class="sd">        List of dictionaries containing all the above parameters for monitoring</span>
</span><span id="StopCriteria-609"><a href="#StopCriteria-609"><span class="linenos">609</span></a><span class="sd">        convergence.</span>
</span><span id="StopCriteria-610"><a href="#StopCriteria-610"><span class="linenos">610</span></a><span class="sd">    last_relax_update : List of int</span>
</span><span id="StopCriteria-611"><a href="#StopCriteria-611"><span class="linenos">611</span></a><span class="sd">        Last iteration number for which the relaxation parameter of the Newton</span>
</span><span id="StopCriteria-612"><a href="#StopCriteria-612"><span class="linenos">612</span></a><span class="sd">        method was decreased.</span>
</span><span id="StopCriteria-613"><a href="#StopCriteria-613"><span class="linenos">613</span></a>
</span><span id="StopCriteria-614"><a href="#StopCriteria-614"><span class="linenos">614</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="StopCriteria-615"><a href="#StopCriteria-615"><span class="linenos">615</span></a>
</span><span id="StopCriteria-616"><a href="#StopCriteria-616"><span class="linenos">616</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">,</span> <span class="n">min_iter</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="StopCriteria-617"><a href="#StopCriteria-617"><span class="linenos">617</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span> <span class="k">if</span> <span class="n">max_iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">50</span>
</span><span id="StopCriteria-618"><a href="#StopCriteria-618"><span class="linenos">618</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">min_iter</span> <span class="o">=</span> <span class="n">min_iter</span> <span class="k">if</span> <span class="n">min_iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">8</span>
</span><span id="StopCriteria-619"><a href="#StopCriteria-619"><span class="linenos">619</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res_delta_tol</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria-620"><a href="#StopCriteria-620"><span class="linenos">620</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sol_delta_tol</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria-621"><a href="#StopCriteria-621"><span class="linenos">621</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="StopCriteria-622"><a href="#StopCriteria-622"><span class="linenos">622</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res_vec</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria-623"><a href="#StopCriteria-623"><span class="linenos">623</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res_vec_parts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria-624"><a href="#StopCriteria-624"><span class="linenos">624</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria-625"><a href="#StopCriteria-625"><span class="linenos">625</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sol_delta</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria-626"><a href="#StopCriteria-626"><span class="linenos">626</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="StopCriteria-627"><a href="#StopCriteria-627"><span class="linenos">627</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="StopCriteria-628"><a href="#StopCriteria-628"><span class="linenos">628</span></a>
</span><span id="StopCriteria-629"><a href="#StopCriteria-629"><span class="linenos">629</span></a>        <span class="c1"># Dictionary of active stopping criteria</span>
</span><span id="StopCriteria-630"><a href="#StopCriteria-630"><span class="linenos">630</span></a>        <span class="n">active_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="StopCriteria-631"><a href="#StopCriteria-631"><span class="linenos">631</span></a>        <span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;res_delta_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;res_delta_tol&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span>
</span><span id="StopCriteria-632"><a href="#StopCriteria-632"><span class="linenos">632</span></a>        <span class="k">if</span> <span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;res_delta_tol&#39;</span><span class="p">]:</span>
</span><span id="StopCriteria-633"><a href="#StopCriteria-633"><span class="linenos">633</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">res_delta_tol</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;res_delta_tol&#39;</span><span class="p">)</span>
</span><span id="StopCriteria-634"><a href="#StopCriteria-634"><span class="linenos">634</span></a>        <span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;sol_delta_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;sol_delta_tol&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span>
</span><span id="StopCriteria-635"><a href="#StopCriteria-635"><span class="linenos">635</span></a>        <span class="k">if</span> <span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;sol_delta_tol&#39;</span><span class="p">]:</span>
</span><span id="StopCriteria-636"><a href="#StopCriteria-636"><span class="linenos">636</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sol_delta_tol</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sol_delta_tol&#39;</span><span class="p">)</span>
</span><span id="StopCriteria-637"><a href="#StopCriteria-637"><span class="linenos">637</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">active_dic</span> <span class="o">=</span> <span class="n">active_dic</span>
</span><span id="StopCriteria-638"><a href="#StopCriteria-638"><span class="linenos">638</span></a>
</span><span id="StopCriteria-639"><a href="#StopCriteria-639"><span class="linenos">639</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="StopCriteria-640"><a href="#StopCriteria-640"><span class="linenos">640</span></a>
</span><span id="StopCriteria-641"><a href="#StopCriteria-641"><span class="linenos">641</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="StopCriteria-642"><a href="#StopCriteria-642"><span class="linenos">642</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
</span><span id="StopCriteria-643"><a href="#StopCriteria-643"><span class="linenos">643</span></a><span class="s2">        Stop Criteria:</span>
</span><span id="StopCriteria-644"><a href="#StopCriteria-644"><span class="linenos">644</span></a><span class="s2">            max iter: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="si">}</span>
</span><span id="StopCriteria-645"><a href="#StopCriteria-645"><span class="linenos">645</span></a><span class="s2">            relative delta_sol tolerance: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sol_delta_tol</span><span class="si">}</span>
</span><span id="StopCriteria-646"><a href="#StopCriteria-646"><span class="linenos">646</span></a><span class="s2">            relative delta_res tolerance: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">res_delta_tol</span><span class="si">}</span>
</span><span id="StopCriteria-647"><a href="#StopCriteria-647"><span class="linenos">647</span></a><span class="s2">        &quot;&quot;&quot;</span>
</span><span id="StopCriteria-648"><a href="#StopCriteria-648"><span class="linenos">648</span></a>
</span><span id="StopCriteria-649"><a href="#StopCriteria-649"><span class="linenos">649</span></a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
</span><span id="StopCriteria-650"><a href="#StopCriteria-650"><span class="linenos">650</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StopCriteria-651"><a href="#StopCriteria-651"><span class="linenos">651</span></a><span class="sd">        Evaluate all the criteria set active. Some additional indicators are</span>
</span><span id="StopCriteria-652"><a href="#StopCriteria-652"><span class="linenos">652</span></a><span class="sd">        computed but are intended for information purposes only.</span>
</span><span id="StopCriteria-653"><a href="#StopCriteria-653"><span class="linenos">653</span></a>
</span><span id="StopCriteria-654"><a href="#StopCriteria-654"><span class="linenos">654</span></a><span class="sd">        Parameters</span>
</span><span id="StopCriteria-655"><a href="#StopCriteria-655"><span class="linenos">655</span></a><span class="sd">        ----------</span>
</span><span id="StopCriteria-656"><a href="#StopCriteria-656"><span class="linenos">656</span></a><span class="sd">        solver : `Solver` instance</span>
</span><span id="StopCriteria-657"><a href="#StopCriteria-657"><span class="linenos">657</span></a><span class="sd">            The solver instance.</span>
</span><span id="StopCriteria-658"><a href="#StopCriteria-658"><span class="linenos">658</span></a>
</span><span id="StopCriteria-659"><a href="#StopCriteria-659"><span class="linenos">659</span></a><span class="sd">        Returns</span>
</span><span id="StopCriteria-660"><a href="#StopCriteria-660"><span class="linenos">660</span></a><span class="sd">        -------</span>
</span><span id="StopCriteria-661"><a href="#StopCriteria-661"><span class="linenos">661</span></a><span class="sd">        bool</span>
</span><span id="StopCriteria-662"><a href="#StopCriteria-662"><span class="linenos">662</span></a><span class="sd">            True if one of the stopping criterion has been met, False otherwise.</span>
</span><span id="StopCriteria-663"><a href="#StopCriteria-663"><span class="linenos">663</span></a>
</span><span id="StopCriteria-664"><a href="#StopCriteria-664"><span class="linenos">664</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StopCriteria-665"><a href="#StopCriteria-665"><span class="linenos">665</span></a>
</span><span id="StopCriteria-666"><a href="#StopCriteria-666"><span class="linenos">666</span></a>        <span class="c1"># Set to None</span>
</span><span id="StopCriteria-667"><a href="#StopCriteria-667"><span class="linenos">667</span></a>        <span class="n">sol_delta</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria-668"><a href="#StopCriteria-668"><span class="linenos">668</span></a>        <span class="n">res_delta</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria-669"><a href="#StopCriteria-669"><span class="linenos">669</span></a>        <span class="n">res_L2</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria-670"><a href="#StopCriteria-670"><span class="linenos">670</span></a>        <span class="n">res_mean</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria-671"><a href="#StopCriteria-671"><span class="linenos">671</span></a>        <span class="n">res_inf</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria-672"><a href="#StopCriteria-672"><span class="linenos">672</span></a>
</span><span id="StopCriteria-673"><a href="#StopCriteria-673"><span class="linenos">673</span></a>        <span class="c1"># strong residual evaluation</span>
</span><span id="StopCriteria-674"><a href="#StopCriteria-674"><span class="linenos">674</span></a>        <span class="n">res_vec</span><span class="p">,</span> <span class="n">res_vec_parts</span> <span class="o">=</span> <span class="n">strong_residual</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="StopCriteria-675"><a href="#StopCriteria-675"><span class="linenos">675</span></a>        <span class="n">res_L2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">res_vec</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</span><span id="StopCriteria-676"><a href="#StopCriteria-676"><span class="linenos">676</span></a>        <span class="n">res_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">res_vec</span><span class="p">))</span>
</span><span id="StopCriteria-677"><a href="#StopCriteria-677"><span class="linenos">677</span></a>        <span class="n">res_inf</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">res_vec</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="StopCriteria-678"><a href="#StopCriteria-678"><span class="linenos">678</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_vec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StopCriteria-679"><a href="#StopCriteria-679"><span class="linenos">679</span></a>            <span class="n">res_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">res_vec</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">res_vec</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span>
</span><span id="StopCriteria-680"><a href="#StopCriteria-680"><span class="linenos">680</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StopCriteria-681"><a href="#StopCriteria-681"><span class="linenos">681</span></a>            <span class="n">res_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="StopCriteria-682"><a href="#StopCriteria-682"><span class="linenos">682</span></a>
</span><span id="StopCriteria-683"><a href="#StopCriteria-683"><span class="linenos">683</span></a>        <span class="c1"># distance between two successive iterations</span>
</span><span id="StopCriteria-684"><a href="#StopCriteria-684"><span class="linenos">684</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="StopCriteria-685"><a href="#StopCriteria-685"><span class="linenos">685</span></a>            <span class="n">delta</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="StopCriteria-686"><a href="#StopCriteria-686"><span class="linenos">686</span></a>            <span class="n">denominator</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="StopCriteria-687"><a href="#StopCriteria-687"><span class="linenos">687</span></a>            <span class="k">for</span> <span class="n">oldsol</span><span class="p">,</span> <span class="n">newsol</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">oldsols</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">):</span>
</span><span id="StopCriteria-688"><a href="#StopCriteria-688"><span class="linenos">688</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">oldsol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">newsol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="StopCriteria-689"><a href="#StopCriteria-689"><span class="linenos">689</span></a>                    <span class="n">delta</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">newsol</span><span class="o">-</span><span class="n">oldsol</span><span class="p">)</span>
</span><span id="StopCriteria-690"><a href="#StopCriteria-690"><span class="linenos">690</span></a>                    <span class="n">denominator</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">oldsol</span><span class="p">)</span>
</span><span id="StopCriteria-691"><a href="#StopCriteria-691"><span class="linenos">691</span></a>            <span class="n">sol_delta</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">denominator</span>
</span><span id="StopCriteria-692"><a href="#StopCriteria-692"><span class="linenos">692</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StopCriteria-693"><a href="#StopCriteria-693"><span class="linenos">693</span></a>            <span class="n">sol_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="StopCriteria-694"><a href="#StopCriteria-694"><span class="linenos">694</span></a>
</span><span id="StopCriteria-695"><a href="#StopCriteria-695"><span class="linenos">695</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sol_delta</span> <span class="o">=</span> <span class="n">sol_delta</span>
</span><span id="StopCriteria-696"><a href="#StopCriteria-696"><span class="linenos">696</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">res_L2</span>
</span><span id="StopCriteria-697"><a href="#StopCriteria-697"><span class="linenos">697</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res_vec</span> <span class="o">=</span> <span class="n">res_vec</span>
</span><span id="StopCriteria-698"><a href="#StopCriteria-698"><span class="linenos">698</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res_vec_parts</span> <span class="o">=</span> <span class="n">res_vec_parts</span>
</span><span id="StopCriteria-699"><a href="#StopCriteria-699"><span class="linenos">699</span></a>
</span><span id="StopCriteria-700"><a href="#StopCriteria-700"><span class="linenos">700</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="StopCriteria-701"><a href="#StopCriteria-701"><span class="linenos">701</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0: &lt;17}</span><span class="s2"> </span><span class="si">{1:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Sol rel delta&quot;</span><span class="p">,</span> <span class="n">sol_delta</span><span class="p">))</span>
</span><span id="StopCriteria-702"><a href="#StopCriteria-702"><span class="linenos">702</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0: &lt;17}</span><span class="s2"> </span><span class="si">{1:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Residual L2&quot;</span><span class="p">,</span> <span class="n">res_L2</span><span class="p">))</span>
</span><span id="StopCriteria-703"><a href="#StopCriteria-703"><span class="linenos">703</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0: &lt;17}</span><span class="s2"> </span><span class="si">{1:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Residual mean&quot;</span><span class="p">,</span> <span class="n">res_mean</span><span class="p">))</span>
</span><span id="StopCriteria-704"><a href="#StopCriteria-704"><span class="linenos">704</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0: &lt;17}</span><span class="s2"> </span><span class="si">{1:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Residual inf&quot;</span><span class="p">,</span> <span class="n">res_inf</span><span class="p">))</span>
</span><span id="StopCriteria-705"><a href="#StopCriteria-705"><span class="linenos">705</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0: &lt;17}</span><span class="s2"> </span><span class="si">{1:.3E}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Residual rel delta&quot;</span><span class="p">,</span> <span class="n">res_delta</span><span class="p">))</span>
</span><span id="StopCriteria-706"><a href="#StopCriteria-706"><span class="linenos">706</span></a>
</span><span id="StopCriteria-707"><a href="#StopCriteria-707"><span class="linenos">707</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fill_history</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">iter</span><span class="p">,</span> <span class="n">sol_delta</span><span class="p">,</span> <span class="n">res_delta</span><span class="p">,</span> <span class="n">res_L2</span><span class="p">,</span> <span class="n">res_mean</span><span class="p">,</span>
</span><span id="StopCriteria-708"><a href="#StopCriteria-708"><span class="linenos">708</span></a>                          <span class="n">res_inf</span><span class="p">)</span>
</span><span id="StopCriteria-709"><a href="#StopCriteria-709"><span class="linenos">709</span></a>
</span><span id="StopCriteria-710"><a href="#StopCriteria-710"><span class="linenos">710</span></a>        <span class="c1"># Active criteria</span>
</span><span id="StopCriteria-711"><a href="#StopCriteria-711"><span class="linenos">711</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;sol_delta_tol&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_iter</span><span class="p">:</span>
</span><span id="StopCriteria-712"><a href="#StopCriteria-712"><span class="linenos">712</span></a>            <span class="k">if</span> <span class="n">sol_delta</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol_delta_tol</span><span class="p">:</span>
</span><span id="StopCriteria-713"><a href="#StopCriteria-713"><span class="linenos">713</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="StopCriteria-714"><a href="#StopCriteria-714"><span class="linenos">714</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">has_converged</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="StopCriteria-715"><a href="#StopCriteria-715"><span class="linenos">715</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="StopCriteria-716"><a href="#StopCriteria-716"><span class="linenos">716</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STOP: Delta in successive iterations is small&quot;</span><span class="p">)</span>
</span><span id="StopCriteria-717"><a href="#StopCriteria-717"><span class="linenos">717</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="StopCriteria-718"><a href="#StopCriteria-718"><span class="linenos">718</span></a>
</span><span id="StopCriteria-719"><a href="#StopCriteria-719"><span class="linenos">719</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;res_delta_tol&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_iter</span><span class="p">:</span>
</span><span id="StopCriteria-720"><a href="#StopCriteria-720"><span class="linenos">720</span></a>            <span class="k">if</span> <span class="n">res_delta</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_delta_tol</span><span class="p">:</span>
</span><span id="StopCriteria-721"><a href="#StopCriteria-721"><span class="linenos">721</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="StopCriteria-722"><a href="#StopCriteria-722"><span class="linenos">722</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">has_converged</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="StopCriteria-723"><a href="#StopCriteria-723"><span class="linenos">723</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="StopCriteria-724"><a href="#StopCriteria-724"><span class="linenos">724</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STOP: Residual variation is small&quot;</span><span class="p">)</span>
</span><span id="StopCriteria-725"><a href="#StopCriteria-725"><span class="linenos">725</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="StopCriteria-726"><a href="#StopCriteria-726"><span class="linenos">726</span></a>
</span><span id="StopCriteria-727"><a href="#StopCriteria-727"><span class="linenos">727</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">:</span>
</span><span id="StopCriteria-728"><a href="#StopCriteria-728"><span class="linenos">728</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="StopCriteria-729"><a href="#StopCriteria-729"><span class="linenos">729</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="StopCriteria-730"><a href="#StopCriteria-730"><span class="linenos">730</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STOP: Maximum number of iteration has been reached&quot;</span><span class="p">)</span>
</span><span id="StopCriteria-731"><a href="#StopCriteria-731"><span class="linenos">731</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="StopCriteria-732"><a href="#StopCriteria-732"><span class="linenos">732</span></a>
</span><span id="StopCriteria-733"><a href="#StopCriteria-733"><span class="linenos">733</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="StopCriteria-734"><a href="#StopCriteria-734"><span class="linenos">734</span></a>
</span><span id="StopCriteria-735"><a href="#StopCriteria-735"><span class="linenos">735</span></a>    <span class="k">def</span> <span class="nf">fill_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">niter</span><span class="p">,</span> <span class="n">sol_delta</span><span class="p">,</span> <span class="n">res_delta</span><span class="p">,</span> <span class="n">res_L2</span><span class="p">,</span> <span class="n">res_mean</span><span class="p">,</span>
</span><span id="StopCriteria-736"><a href="#StopCriteria-736"><span class="linenos">736</span></a>                     <span class="n">res_inf</span><span class="p">):</span>
</span><span id="StopCriteria-737"><a href="#StopCriteria-737"><span class="linenos">737</span></a>        <span class="n">iter_dic</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="StopCriteria-738"><a href="#StopCriteria-738"><span class="linenos">738</span></a>            <span class="s1">&#39;iter&#39;</span><span class="p">:</span> <span class="n">niter</span><span class="p">,</span>
</span><span id="StopCriteria-739"><a href="#StopCriteria-739"><span class="linenos">739</span></a>            <span class="s1">&#39;sol delta&#39;</span> <span class="p">:</span> <span class="n">sol_delta</span><span class="p">,</span>
</span><span id="StopCriteria-740"><a href="#StopCriteria-740"><span class="linenos">740</span></a>            <span class="s1">&#39;res delta&#39;</span> <span class="p">:</span> <span class="n">res_delta</span><span class="p">,</span>
</span><span id="StopCriteria-741"><a href="#StopCriteria-741"><span class="linenos">741</span></a>            <span class="s1">&#39;res L2&#39;</span> <span class="p">:</span> <span class="n">res_L2</span><span class="p">,</span>
</span><span id="StopCriteria-742"><a href="#StopCriteria-742"><span class="linenos">742</span></a>            <span class="s1">&#39;res mean&#39;</span> <span class="p">:</span> <span class="n">res_mean</span><span class="p">,</span>
</span><span id="StopCriteria-743"><a href="#StopCriteria-743"><span class="linenos">743</span></a>            <span class="s1">&#39;res inf&#39;</span> <span class="p">:</span> <span class="n">res_inf</span>
</span><span id="StopCriteria-744"><a href="#StopCriteria-744"><span class="linenos">744</span></a>            <span class="p">}</span>
</span><span id="StopCriteria-745"><a href="#StopCriteria-745"><span class="linenos">745</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">==</span> <span class="p">[]:</span>
</span><span id="StopCriteria-746"><a href="#StopCriteria-746"><span class="linenos">746</span></a>            <span class="n">iter_dic</span><span class="p">[</span><span class="s1">&#39;res_k / res_0 (%)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="StopCriteria-747"><a href="#StopCriteria-747"><span class="linenos">747</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StopCriteria-748"><a href="#StopCriteria-748"><span class="linenos">748</span></a>            <span class="n">iter_dic</span><span class="p">[</span><span class="s1">&#39;res_k / res_0 (%)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_L2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;res L2&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span>
</span><span id="StopCriteria-749"><a href="#StopCriteria-749"><span class="linenos">749</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iter_dic</span><span class="p">)</span>
</span><span id="StopCriteria-750"><a href="#StopCriteria-750"><span class="linenos">750</span></a>
</span><span id="StopCriteria-751"><a href="#StopCriteria-751"><span class="linenos">751</span></a>    <span class="k">def</span> <span class="nf">adjust_relax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
</span><span id="StopCriteria-752"><a href="#StopCriteria-752"><span class="linenos">752</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StopCriteria-753"><a href="#StopCriteria-753"><span class="linenos">753</span></a><span class="sd">        Based on the analyis of the current convergence-history of the on-going</span>
</span><span id="StopCriteria-754"><a href="#StopCriteria-754"><span class="linenos">754</span></a><span class="sd">        nonlinear equation solving, the relaxation parameter manually decreased</span>
</span><span id="StopCriteria-755"><a href="#StopCriteria-755"><span class="linenos">755</span></a><span class="sd">        to achieve convergence of Newton&#39;s iterations. The two following</span>
</span><span id="StopCriteria-756"><a href="#StopCriteria-756"><span class="linenos">756</span></a><span class="sd">        conditions must be satisfied simultaneously:</span>
</span><span id="StopCriteria-757"><a href="#StopCriteria-757"><span class="linenos">757</span></a><span class="sd">            - the relative delta has stopped decreasing</span>
</span><span id="StopCriteria-758"><a href="#StopCriteria-758"><span class="linenos">758</span></a><span class="sd">            - the residual in 2-norm has stopped decreasing</span>
</span><span id="StopCriteria-759"><a href="#StopCriteria-759"><span class="linenos">759</span></a>
</span><span id="StopCriteria-760"><a href="#StopCriteria-760"><span class="linenos">760</span></a><span class="sd">        Parameters</span>
</span><span id="StopCriteria-761"><a href="#StopCriteria-761"><span class="linenos">761</span></a><span class="sd">        ----------</span>
</span><span id="StopCriteria-762"><a href="#StopCriteria-762"><span class="linenos">762</span></a><span class="sd">        solver : `Solver` instance</span>
</span><span id="StopCriteria-763"><a href="#StopCriteria-763"><span class="linenos">763</span></a><span class="sd">            The solver instance.</span>
</span><span id="StopCriteria-764"><a href="#StopCriteria-764"><span class="linenos">764</span></a><span class="sd">        history_size : int, optional</span>
</span><span id="StopCriteria-765"><a href="#StopCriteria-765"><span class="linenos">765</span></a><span class="sd">            Number of past iteration used to check the two stalling conditions.</span>
</span><span id="StopCriteria-766"><a href="#StopCriteria-766"><span class="linenos">766</span></a><span class="sd">            The default is 3.</span>
</span><span id="StopCriteria-767"><a href="#StopCriteria-767"><span class="linenos">767</span></a><span class="sd">        factor : float, optional</span>
</span><span id="StopCriteria-768"><a href="#StopCriteria-768"><span class="linenos">768</span></a><span class="sd">            Factor by which the relaxation parameter is multiplied (should be</span>
</span><span id="StopCriteria-769"><a href="#StopCriteria-769"><span class="linenos">769</span></a><span class="sd">            strictly smaller than 1). The default value is 0.8.</span>
</span><span id="StopCriteria-770"><a href="#StopCriteria-770"><span class="linenos">770</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StopCriteria-771"><a href="#StopCriteria-771"><span class="linenos">771</span></a>        
</span><span id="StopCriteria-772"><a href="#StopCriteria-772"><span class="linenos">772</span></a>        <span class="k">assert</span> <span class="n">factor</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">factor</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="StopCriteria-773"><a href="#StopCriteria-773"><span class="linenos">773</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;</span> <span class="n">history_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="StopCriteria-774"><a href="#StopCriteria-774"><span class="linenos">774</span></a>            <span class="n">res_L2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;res L2&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">history_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
</span><span id="StopCriteria-775"><a href="#StopCriteria-775"><span class="linenos">775</span></a>            <span class="n">sol_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;sol delta&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">history_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
</span><span id="StopCriteria-776"><a href="#StopCriteria-776"><span class="linenos">776</span></a>            <span class="n">cond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">sol_delta</span><span class="p">)</span><span class="o">/</span><span class="n">sol_delta</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1e-2</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
</span><span id="StopCriteria-777"><a href="#StopCriteria-777"><span class="linenos">777</span></a>            <span class="n">cond2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">res_L2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">res_L2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1e-2</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
</span><span id="StopCriteria-778"><a href="#StopCriteria-778"><span class="linenos">778</span></a>            <span class="k">if</span> <span class="n">cond1</span> <span class="ow">and</span> <span class="n">cond2</span><span class="p">:</span>
</span><span id="StopCriteria-779"><a href="#StopCriteria-779"><span class="linenos">779</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="StopCriteria-780"><a href="#StopCriteria-780"><span class="linenos">780</span></a>                    <span class="n">factor</span> <span class="o">*=</span> <span class="mf">1e-2</span>
</span><span id="StopCriteria-781"><a href="#StopCriteria-781"><span class="linenos">781</span></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
</span><span id="StopCriteria-782"><a href="#StopCriteria-782"><span class="linenos">782</span></a>                    <span class="n">factor</span> <span class="o">*=</span> <span class="mf">0.25</span>
</span><span id="StopCriteria-783"><a href="#StopCriteria-783"><span class="linenos">783</span></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="StopCriteria-784"><a href="#StopCriteria-784"><span class="linenos">784</span></a>                    <span class="n">factor</span> <span class="o">*=</span> <span class="mf">0.5</span>
</span><span id="StopCriteria-785"><a href="#StopCriteria-785"><span class="linenos">785</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">relax</span> <span class="o">*=</span> <span class="n">factor</span>
</span><span id="StopCriteria-786"><a href="#StopCriteria-786"><span class="linenos">786</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span>
</span><span id="StopCriteria-787"><a href="#StopCriteria-787"><span class="linenos">787</span></a>                <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="StopCriteria-788"><a href="#StopCriteria-788"><span class="linenos">788</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;! Decreasing relax. param. to </span><span class="si">{:.3f}</span><span class="s2"> !</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="StopCriteria-789"><a href="#StopCriteria-789"><span class="linenos">789</span></a>                        <span class="n">solver</span><span class="o">.</span><span class="n">relax</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Class defining stopping conditions for nonlinear problems.</p>

<h6 id="attributes">Attributes</h6>

<ul>
<li><strong>min_iter</strong> (int):
Minimum number of Newton iterations. The default is 8.</li>
<li><strong>max_iter</strong> (int):
Maximum number of Newton iterations.</li>
<li><strong>sol_delta_tol</strong> (float):
Threshold on the minimum relative distance (in 2-norm) between two
successive iterations.</li>
<li><strong>active_dic</strong> (dict):
Dictionary for knowing which criteria are active and which are not.</li>
<li><strong>verbose</strong> (bool):
Display user's information. The default is False.</li>
<li><strong>stop</strong> (bool):
False until some stopping criterion is met.</li>
<li><strong>res_vec</strong> (ndarray):
Current strong residual vector.</li>
<li><strong>res_vec_parts</strong> (dic):
Dictionary with keys ('mtx', 'rhs_cst', 'rhs_mod') and values each term
of the strong residual vector.</li>
<li><strong>res</strong> (float):
Current value of the strong residual (L2-norm).</li>
<li><strong>sol_delta</strong> (float):
Current value of the relative distance between two successive
iterations.</li>
<li><strong>history</strong> (list of dicts):
List of dictionaries containing all the above parameters for monitoring
convergence.</li>
<li><strong>last_relax_update</strong> (List of int):
Last iteration number for which the relaxation parameter of the Newton
method was decreased.</li>
</ul>
</div>


                            <div id="StopCriteria.__init__" class="classattr">
                                        <input id="StopCriteria.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">StopCriteria</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">max_iter</span>, </span><span class="param"><span class="n">min_iter</span><span class="o">=</span><span class="mi">8</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="StopCriteria.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StopCriteria.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StopCriteria.__init__-616"><a href="#StopCriteria.__init__-616"><span class="linenos">616</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_iter</span><span class="p">,</span> <span class="n">min_iter</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="StopCriteria.__init__-617"><a href="#StopCriteria.__init__-617"><span class="linenos">617</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span> <span class="o">=</span> <span class="n">max_iter</span> <span class="k">if</span> <span class="n">max_iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">50</span>
</span><span id="StopCriteria.__init__-618"><a href="#StopCriteria.__init__-618"><span class="linenos">618</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">min_iter</span> <span class="o">=</span> <span class="n">min_iter</span> <span class="k">if</span> <span class="n">min_iter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">8</span>
</span><span id="StopCriteria.__init__-619"><a href="#StopCriteria.__init__-619"><span class="linenos">619</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res_delta_tol</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria.__init__-620"><a href="#StopCriteria.__init__-620"><span class="linenos">620</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sol_delta_tol</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria.__init__-621"><a href="#StopCriteria.__init__-621"><span class="linenos">621</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="StopCriteria.__init__-622"><a href="#StopCriteria.__init__-622"><span class="linenos">622</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res_vec</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria.__init__-623"><a href="#StopCriteria.__init__-623"><span class="linenos">623</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res_vec_parts</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria.__init__-624"><a href="#StopCriteria.__init__-624"><span class="linenos">624</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria.__init__-625"><a href="#StopCriteria.__init__-625"><span class="linenos">625</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sol_delta</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria.__init__-626"><a href="#StopCriteria.__init__-626"><span class="linenos">626</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="StopCriteria.__init__-627"><a href="#StopCriteria.__init__-627"><span class="linenos">627</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="StopCriteria.__init__-628"><a href="#StopCriteria.__init__-628"><span class="linenos">628</span></a>
</span><span id="StopCriteria.__init__-629"><a href="#StopCriteria.__init__-629"><span class="linenos">629</span></a>        <span class="c1"># Dictionary of active stopping criteria</span>
</span><span id="StopCriteria.__init__-630"><a href="#StopCriteria.__init__-630"><span class="linenos">630</span></a>        <span class="n">active_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="StopCriteria.__init__-631"><a href="#StopCriteria.__init__-631"><span class="linenos">631</span></a>        <span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;res_delta_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;res_delta_tol&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span>
</span><span id="StopCriteria.__init__-632"><a href="#StopCriteria.__init__-632"><span class="linenos">632</span></a>        <span class="k">if</span> <span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;res_delta_tol&#39;</span><span class="p">]:</span>
</span><span id="StopCriteria.__init__-633"><a href="#StopCriteria.__init__-633"><span class="linenos">633</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">res_delta_tol</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;res_delta_tol&#39;</span><span class="p">)</span>
</span><span id="StopCriteria.__init__-634"><a href="#StopCriteria.__init__-634"><span class="linenos">634</span></a>        <span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;sol_delta_tol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;sol_delta_tol&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span>
</span><span id="StopCriteria.__init__-635"><a href="#StopCriteria.__init__-635"><span class="linenos">635</span></a>        <span class="k">if</span> <span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;sol_delta_tol&#39;</span><span class="p">]:</span>
</span><span id="StopCriteria.__init__-636"><a href="#StopCriteria.__init__-636"><span class="linenos">636</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sol_delta_tol</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sol_delta_tol&#39;</span><span class="p">)</span>
</span><span id="StopCriteria.__init__-637"><a href="#StopCriteria.__init__-637"><span class="linenos">637</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">active_dic</span> <span class="o">=</span> <span class="n">active_dic</span>
</span><span id="StopCriteria.__init__-638"><a href="#StopCriteria.__init__-638"><span class="linenos">638</span></a>
</span><span id="StopCriteria.__init__-639"><a href="#StopCriteria.__init__-639"><span class="linenos">639</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="StopCriteria.max_iter" class="classattr">
                                <div class="attr variable">
            <span class="name">max_iter</span>

        
    </div>
    <a class="headerlink" href="#StopCriteria.max_iter"></a>
    
    

                            </div>
                            <div id="StopCriteria.min_iter" class="classattr">
                                <div class="attr variable">
            <span class="name">min_iter</span>

        
    </div>
    <a class="headerlink" href="#StopCriteria.min_iter"></a>
    
    

                            </div>
                            <div id="StopCriteria.res_delta_tol" class="classattr">
                                <div class="attr variable">
            <span class="name">res_delta_tol</span>

        
    </div>
    <a class="headerlink" href="#StopCriteria.res_delta_tol"></a>
    
    

                            </div>
                            <div id="StopCriteria.sol_delta_tol" class="classattr">
                                <div class="attr variable">
            <span class="name">sol_delta_tol</span>

        
    </div>
    <a class="headerlink" href="#StopCriteria.sol_delta_tol"></a>
    
    

                            </div>
                            <div id="StopCriteria.stop" class="classattr">
                                <div class="attr variable">
            <span class="name">stop</span>

        
    </div>
    <a class="headerlink" href="#StopCriteria.stop"></a>
    
    

                            </div>
                            <div id="StopCriteria.res_vec" class="classattr">
                                <div class="attr variable">
            <span class="name">res_vec</span>

        
    </div>
    <a class="headerlink" href="#StopCriteria.res_vec"></a>
    
    

                            </div>
                            <div id="StopCriteria.res_vec_parts" class="classattr">
                                <div class="attr variable">
            <span class="name">res_vec_parts</span>

        
    </div>
    <a class="headerlink" href="#StopCriteria.res_vec_parts"></a>
    
    

                            </div>
                            <div id="StopCriteria.res" class="classattr">
                                <div class="attr variable">
            <span class="name">res</span>

        
    </div>
    <a class="headerlink" href="#StopCriteria.res"></a>
    
    

                            </div>
                            <div id="StopCriteria.sol_delta" class="classattr">
                                <div class="attr variable">
            <span class="name">sol_delta</span>

        
    </div>
    <a class="headerlink" href="#StopCriteria.sol_delta"></a>
    
    

                            </div>
                            <div id="StopCriteria.history" class="classattr">
                                <div class="attr variable">
            <span class="name">history</span>

        
    </div>
    <a class="headerlink" href="#StopCriteria.history"></a>
    
    

                            </div>
                            <div id="StopCriteria.last_relax_update" class="classattr">
                                <div class="attr variable">
            <span class="name">last_relax_update</span>

        
    </div>
    <a class="headerlink" href="#StopCriteria.last_relax_update"></a>
    
    

                            </div>
                            <div id="StopCriteria.active_dic" class="classattr">
                                <div class="attr variable">
            <span class="name">active_dic</span>

        
    </div>
    <a class="headerlink" href="#StopCriteria.active_dic"></a>
    
    

                            </div>
                            <div id="StopCriteria.verbose" class="classattr">
                                <div class="attr variable">
            <span class="name">verbose</span>

        
    </div>
    <a class="headerlink" href="#StopCriteria.verbose"></a>
    
    

                            </div>
                            <div id="StopCriteria.evaluate" class="classattr">
                                        <input id="StopCriteria.evaluate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">evaluate</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">solver</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="StopCriteria.evaluate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StopCriteria.evaluate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StopCriteria.evaluate-649"><a href="#StopCriteria.evaluate-649"><span class="linenos">649</span></a>    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">):</span>
</span><span id="StopCriteria.evaluate-650"><a href="#StopCriteria.evaluate-650"><span class="linenos">650</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StopCriteria.evaluate-651"><a href="#StopCriteria.evaluate-651"><span class="linenos">651</span></a><span class="sd">        Evaluate all the criteria set active. Some additional indicators are</span>
</span><span id="StopCriteria.evaluate-652"><a href="#StopCriteria.evaluate-652"><span class="linenos">652</span></a><span class="sd">        computed but are intended for information purposes only.</span>
</span><span id="StopCriteria.evaluate-653"><a href="#StopCriteria.evaluate-653"><span class="linenos">653</span></a>
</span><span id="StopCriteria.evaluate-654"><a href="#StopCriteria.evaluate-654"><span class="linenos">654</span></a><span class="sd">        Parameters</span>
</span><span id="StopCriteria.evaluate-655"><a href="#StopCriteria.evaluate-655"><span class="linenos">655</span></a><span class="sd">        ----------</span>
</span><span id="StopCriteria.evaluate-656"><a href="#StopCriteria.evaluate-656"><span class="linenos">656</span></a><span class="sd">        solver : `Solver` instance</span>
</span><span id="StopCriteria.evaluate-657"><a href="#StopCriteria.evaluate-657"><span class="linenos">657</span></a><span class="sd">            The solver instance.</span>
</span><span id="StopCriteria.evaluate-658"><a href="#StopCriteria.evaluate-658"><span class="linenos">658</span></a>
</span><span id="StopCriteria.evaluate-659"><a href="#StopCriteria.evaluate-659"><span class="linenos">659</span></a><span class="sd">        Returns</span>
</span><span id="StopCriteria.evaluate-660"><a href="#StopCriteria.evaluate-660"><span class="linenos">660</span></a><span class="sd">        -------</span>
</span><span id="StopCriteria.evaluate-661"><a href="#StopCriteria.evaluate-661"><span class="linenos">661</span></a><span class="sd">        bool</span>
</span><span id="StopCriteria.evaluate-662"><a href="#StopCriteria.evaluate-662"><span class="linenos">662</span></a><span class="sd">            True if one of the stopping criterion has been met, False otherwise.</span>
</span><span id="StopCriteria.evaluate-663"><a href="#StopCriteria.evaluate-663"><span class="linenos">663</span></a>
</span><span id="StopCriteria.evaluate-664"><a href="#StopCriteria.evaluate-664"><span class="linenos">664</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StopCriteria.evaluate-665"><a href="#StopCriteria.evaluate-665"><span class="linenos">665</span></a>
</span><span id="StopCriteria.evaluate-666"><a href="#StopCriteria.evaluate-666"><span class="linenos">666</span></a>        <span class="c1"># Set to None</span>
</span><span id="StopCriteria.evaluate-667"><a href="#StopCriteria.evaluate-667"><span class="linenos">667</span></a>        <span class="n">sol_delta</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria.evaluate-668"><a href="#StopCriteria.evaluate-668"><span class="linenos">668</span></a>        <span class="n">res_delta</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria.evaluate-669"><a href="#StopCriteria.evaluate-669"><span class="linenos">669</span></a>        <span class="n">res_L2</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria.evaluate-670"><a href="#StopCriteria.evaluate-670"><span class="linenos">670</span></a>        <span class="n">res_mean</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria.evaluate-671"><a href="#StopCriteria.evaluate-671"><span class="linenos">671</span></a>        <span class="n">res_inf</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="StopCriteria.evaluate-672"><a href="#StopCriteria.evaluate-672"><span class="linenos">672</span></a>
</span><span id="StopCriteria.evaluate-673"><a href="#StopCriteria.evaluate-673"><span class="linenos">673</span></a>        <span class="c1"># strong residual evaluation</span>
</span><span id="StopCriteria.evaluate-674"><a href="#StopCriteria.evaluate-674"><span class="linenos">674</span></a>        <span class="n">res_vec</span><span class="p">,</span> <span class="n">res_vec_parts</span> <span class="o">=</span> <span class="n">strong_residual</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="StopCriteria.evaluate-675"><a href="#StopCriteria.evaluate-675"><span class="linenos">675</span></a>        <span class="n">res_L2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">res_vec</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</span><span id="StopCriteria.evaluate-676"><a href="#StopCriteria.evaluate-676"><span class="linenos">676</span></a>        <span class="n">res_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">res_vec</span><span class="p">))</span>
</span><span id="StopCriteria.evaluate-677"><a href="#StopCriteria.evaluate-677"><span class="linenos">677</span></a>        <span class="n">res_inf</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">res_vec</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="StopCriteria.evaluate-678"><a href="#StopCriteria.evaluate-678"><span class="linenos">678</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_vec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="StopCriteria.evaluate-679"><a href="#StopCriteria.evaluate-679"><span class="linenos">679</span></a>            <span class="n">res_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">res_vec</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">res_vec</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span>
</span><span id="StopCriteria.evaluate-680"><a href="#StopCriteria.evaluate-680"><span class="linenos">680</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StopCriteria.evaluate-681"><a href="#StopCriteria.evaluate-681"><span class="linenos">681</span></a>            <span class="n">res_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="StopCriteria.evaluate-682"><a href="#StopCriteria.evaluate-682"><span class="linenos">682</span></a>
</span><span id="StopCriteria.evaluate-683"><a href="#StopCriteria.evaluate-683"><span class="linenos">683</span></a>        <span class="c1"># distance between two successive iterations</span>
</span><span id="StopCriteria.evaluate-684"><a href="#StopCriteria.evaluate-684"><span class="linenos">684</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="StopCriteria.evaluate-685"><a href="#StopCriteria.evaluate-685"><span class="linenos">685</span></a>            <span class="n">delta</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="StopCriteria.evaluate-686"><a href="#StopCriteria.evaluate-686"><span class="linenos">686</span></a>            <span class="n">denominator</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="StopCriteria.evaluate-687"><a href="#StopCriteria.evaluate-687"><span class="linenos">687</span></a>            <span class="k">for</span> <span class="n">oldsol</span><span class="p">,</span> <span class="n">newsol</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">oldsols</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">):</span>
</span><span id="StopCriteria.evaluate-688"><a href="#StopCriteria.evaluate-688"><span class="linenos">688</span></a>                <span class="k">if</span> <span class="p">(</span><span class="n">oldsol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">newsol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="StopCriteria.evaluate-689"><a href="#StopCriteria.evaluate-689"><span class="linenos">689</span></a>                    <span class="n">delta</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">newsol</span><span class="o">-</span><span class="n">oldsol</span><span class="p">)</span>
</span><span id="StopCriteria.evaluate-690"><a href="#StopCriteria.evaluate-690"><span class="linenos">690</span></a>                    <span class="n">denominator</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">oldsol</span><span class="p">)</span>
</span><span id="StopCriteria.evaluate-691"><a href="#StopCriteria.evaluate-691"><span class="linenos">691</span></a>            <span class="n">sol_delta</span> <span class="o">=</span> <span class="n">delta</span> <span class="o">/</span> <span class="n">denominator</span>
</span><span id="StopCriteria.evaluate-692"><a href="#StopCriteria.evaluate-692"><span class="linenos">692</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StopCriteria.evaluate-693"><a href="#StopCriteria.evaluate-693"><span class="linenos">693</span></a>            <span class="n">sol_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</span><span id="StopCriteria.evaluate-694"><a href="#StopCriteria.evaluate-694"><span class="linenos">694</span></a>
</span><span id="StopCriteria.evaluate-695"><a href="#StopCriteria.evaluate-695"><span class="linenos">695</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">sol_delta</span> <span class="o">=</span> <span class="n">sol_delta</span>
</span><span id="StopCriteria.evaluate-696"><a href="#StopCriteria.evaluate-696"><span class="linenos">696</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">res_L2</span>
</span><span id="StopCriteria.evaluate-697"><a href="#StopCriteria.evaluate-697"><span class="linenos">697</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res_vec</span> <span class="o">=</span> <span class="n">res_vec</span>
</span><span id="StopCriteria.evaluate-698"><a href="#StopCriteria.evaluate-698"><span class="linenos">698</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">res_vec_parts</span> <span class="o">=</span> <span class="n">res_vec_parts</span>
</span><span id="StopCriteria.evaluate-699"><a href="#StopCriteria.evaluate-699"><span class="linenos">699</span></a>
</span><span id="StopCriteria.evaluate-700"><a href="#StopCriteria.evaluate-700"><span class="linenos">700</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="StopCriteria.evaluate-701"><a href="#StopCriteria.evaluate-701"><span class="linenos">701</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0: &lt;17}</span><span class="s2"> </span><span class="si">{1:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Sol rel delta&quot;</span><span class="p">,</span> <span class="n">sol_delta</span><span class="p">))</span>
</span><span id="StopCriteria.evaluate-702"><a href="#StopCriteria.evaluate-702"><span class="linenos">702</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0: &lt;17}</span><span class="s2"> </span><span class="si">{1:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Residual L2&quot;</span><span class="p">,</span> <span class="n">res_L2</span><span class="p">))</span>
</span><span id="StopCriteria.evaluate-703"><a href="#StopCriteria.evaluate-703"><span class="linenos">703</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0: &lt;17}</span><span class="s2"> </span><span class="si">{1:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Residual mean&quot;</span><span class="p">,</span> <span class="n">res_mean</span><span class="p">))</span>
</span><span id="StopCriteria.evaluate-704"><a href="#StopCriteria.evaluate-704"><span class="linenos">704</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0: &lt;17}</span><span class="s2"> </span><span class="si">{1:.3E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Residual inf&quot;</span><span class="p">,</span> <span class="n">res_inf</span><span class="p">))</span>
</span><span id="StopCriteria.evaluate-705"><a href="#StopCriteria.evaluate-705"><span class="linenos">705</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0: &lt;17}</span><span class="s2"> </span><span class="si">{1:.3E}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Residual rel delta&quot;</span><span class="p">,</span> <span class="n">res_delta</span><span class="p">))</span>
</span><span id="StopCriteria.evaluate-706"><a href="#StopCriteria.evaluate-706"><span class="linenos">706</span></a>
</span><span id="StopCriteria.evaluate-707"><a href="#StopCriteria.evaluate-707"><span class="linenos">707</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fill_history</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">iter</span><span class="p">,</span> <span class="n">sol_delta</span><span class="p">,</span> <span class="n">res_delta</span><span class="p">,</span> <span class="n">res_L2</span><span class="p">,</span> <span class="n">res_mean</span><span class="p">,</span>
</span><span id="StopCriteria.evaluate-708"><a href="#StopCriteria.evaluate-708"><span class="linenos">708</span></a>                          <span class="n">res_inf</span><span class="p">)</span>
</span><span id="StopCriteria.evaluate-709"><a href="#StopCriteria.evaluate-709"><span class="linenos">709</span></a>
</span><span id="StopCriteria.evaluate-710"><a href="#StopCriteria.evaluate-710"><span class="linenos">710</span></a>        <span class="c1"># Active criteria</span>
</span><span id="StopCriteria.evaluate-711"><a href="#StopCriteria.evaluate-711"><span class="linenos">711</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;sol_delta_tol&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_iter</span><span class="p">:</span>
</span><span id="StopCriteria.evaluate-712"><a href="#StopCriteria.evaluate-712"><span class="linenos">712</span></a>            <span class="k">if</span> <span class="n">sol_delta</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol_delta_tol</span><span class="p">:</span>
</span><span id="StopCriteria.evaluate-713"><a href="#StopCriteria.evaluate-713"><span class="linenos">713</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="StopCriteria.evaluate-714"><a href="#StopCriteria.evaluate-714"><span class="linenos">714</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">has_converged</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="StopCriteria.evaluate-715"><a href="#StopCriteria.evaluate-715"><span class="linenos">715</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="StopCriteria.evaluate-716"><a href="#StopCriteria.evaluate-716"><span class="linenos">716</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STOP: Delta in successive iterations is small&quot;</span><span class="p">)</span>
</span><span id="StopCriteria.evaluate-717"><a href="#StopCriteria.evaluate-717"><span class="linenos">717</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="StopCriteria.evaluate-718"><a href="#StopCriteria.evaluate-718"><span class="linenos">718</span></a>
</span><span id="StopCriteria.evaluate-719"><a href="#StopCriteria.evaluate-719"><span class="linenos">719</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_dic</span><span class="p">[</span><span class="s1">&#39;res_delta_tol&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_iter</span><span class="p">:</span>
</span><span id="StopCriteria.evaluate-720"><a href="#StopCriteria.evaluate-720"><span class="linenos">720</span></a>            <span class="k">if</span> <span class="n">res_delta</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">res_delta_tol</span><span class="p">:</span>
</span><span id="StopCriteria.evaluate-721"><a href="#StopCriteria.evaluate-721"><span class="linenos">721</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="StopCriteria.evaluate-722"><a href="#StopCriteria.evaluate-722"><span class="linenos">722</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">has_converged</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="StopCriteria.evaluate-723"><a href="#StopCriteria.evaluate-723"><span class="linenos">723</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="StopCriteria.evaluate-724"><a href="#StopCriteria.evaluate-724"><span class="linenos">724</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STOP: Residual variation is small&quot;</span><span class="p">)</span>
</span><span id="StopCriteria.evaluate-725"><a href="#StopCriteria.evaluate-725"><span class="linenos">725</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="StopCriteria.evaluate-726"><a href="#StopCriteria.evaluate-726"><span class="linenos">726</span></a>
</span><span id="StopCriteria.evaluate-727"><a href="#StopCriteria.evaluate-727"><span class="linenos">727</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_iter</span><span class="p">:</span>
</span><span id="StopCriteria.evaluate-728"><a href="#StopCriteria.evaluate-728"><span class="linenos">728</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="StopCriteria.evaluate-729"><a href="#StopCriteria.evaluate-729"><span class="linenos">729</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="StopCriteria.evaluate-730"><a href="#StopCriteria.evaluate-730"><span class="linenos">730</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STOP: Maximum number of iteration has been reached&quot;</span><span class="p">)</span>
</span><span id="StopCriteria.evaluate-731"><a href="#StopCriteria.evaluate-731"><span class="linenos">731</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="StopCriteria.evaluate-732"><a href="#StopCriteria.evaluate-732"><span class="linenos">732</span></a>
</span><span id="StopCriteria.evaluate-733"><a href="#StopCriteria.evaluate-733"><span class="linenos">733</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Evaluate all the criteria set active. Some additional indicators are
computed but are intended for information purposes only.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>solver</strong> (<code><a href="#Solver">Solver</a></code> instance):
The solver instance.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>bool</strong>: True if one of the stopping criterion has been met, False otherwise.</li>
</ul>
</div>


                            </div>
                            <div id="StopCriteria.fill_history" class="classattr">
                                        <input id="StopCriteria.fill_history-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fill_history</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">niter</span>, </span><span class="param"><span class="n">sol_delta</span>, </span><span class="param"><span class="n">res_delta</span>, </span><span class="param"><span class="n">res_L2</span>, </span><span class="param"><span class="n">res_mean</span>, </span><span class="param"><span class="n">res_inf</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="StopCriteria.fill_history-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StopCriteria.fill_history"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StopCriteria.fill_history-735"><a href="#StopCriteria.fill_history-735"><span class="linenos">735</span></a>    <span class="k">def</span> <span class="nf">fill_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">niter</span><span class="p">,</span> <span class="n">sol_delta</span><span class="p">,</span> <span class="n">res_delta</span><span class="p">,</span> <span class="n">res_L2</span><span class="p">,</span> <span class="n">res_mean</span><span class="p">,</span>
</span><span id="StopCriteria.fill_history-736"><a href="#StopCriteria.fill_history-736"><span class="linenos">736</span></a>                     <span class="n">res_inf</span><span class="p">):</span>
</span><span id="StopCriteria.fill_history-737"><a href="#StopCriteria.fill_history-737"><span class="linenos">737</span></a>        <span class="n">iter_dic</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="StopCriteria.fill_history-738"><a href="#StopCriteria.fill_history-738"><span class="linenos">738</span></a>            <span class="s1">&#39;iter&#39;</span><span class="p">:</span> <span class="n">niter</span><span class="p">,</span>
</span><span id="StopCriteria.fill_history-739"><a href="#StopCriteria.fill_history-739"><span class="linenos">739</span></a>            <span class="s1">&#39;sol delta&#39;</span> <span class="p">:</span> <span class="n">sol_delta</span><span class="p">,</span>
</span><span id="StopCriteria.fill_history-740"><a href="#StopCriteria.fill_history-740"><span class="linenos">740</span></a>            <span class="s1">&#39;res delta&#39;</span> <span class="p">:</span> <span class="n">res_delta</span><span class="p">,</span>
</span><span id="StopCriteria.fill_history-741"><a href="#StopCriteria.fill_history-741"><span class="linenos">741</span></a>            <span class="s1">&#39;res L2&#39;</span> <span class="p">:</span> <span class="n">res_L2</span><span class="p">,</span>
</span><span id="StopCriteria.fill_history-742"><a href="#StopCriteria.fill_history-742"><span class="linenos">742</span></a>            <span class="s1">&#39;res mean&#39;</span> <span class="p">:</span> <span class="n">res_mean</span><span class="p">,</span>
</span><span id="StopCriteria.fill_history-743"><a href="#StopCriteria.fill_history-743"><span class="linenos">743</span></a>            <span class="s1">&#39;res inf&#39;</span> <span class="p">:</span> <span class="n">res_inf</span>
</span><span id="StopCriteria.fill_history-744"><a href="#StopCriteria.fill_history-744"><span class="linenos">744</span></a>            <span class="p">}</span>
</span><span id="StopCriteria.fill_history-745"><a href="#StopCriteria.fill_history-745"><span class="linenos">745</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">==</span> <span class="p">[]:</span>
</span><span id="StopCriteria.fill_history-746"><a href="#StopCriteria.fill_history-746"><span class="linenos">746</span></a>            <span class="n">iter_dic</span><span class="p">[</span><span class="s1">&#39;res_k / res_0 (%)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="StopCriteria.fill_history-747"><a href="#StopCriteria.fill_history-747"><span class="linenos">747</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="StopCriteria.fill_history-748"><a href="#StopCriteria.fill_history-748"><span class="linenos">748</span></a>            <span class="n">iter_dic</span><span class="p">[</span><span class="s1">&#39;res_k / res_0 (%)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_L2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;res L2&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span>
</span><span id="StopCriteria.fill_history-749"><a href="#StopCriteria.fill_history-749"><span class="linenos">749</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iter_dic</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="StopCriteria.adjust_relax" class="classattr">
                                        <input id="StopCriteria.adjust_relax-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">adjust_relax</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">solver</span>, </span><span class="param"><span class="n">history_size</span><span class="o">=</span><span class="mi">2</span>, </span><span class="param"><span class="n">factor</span><span class="o">=</span><span class="mf">0.8</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="StopCriteria.adjust_relax-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#StopCriteria.adjust_relax"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="StopCriteria.adjust_relax-751"><a href="#StopCriteria.adjust_relax-751"><span class="linenos">751</span></a>    <span class="k">def</span> <span class="nf">adjust_relax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">history_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
</span><span id="StopCriteria.adjust_relax-752"><a href="#StopCriteria.adjust_relax-752"><span class="linenos">752</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="StopCriteria.adjust_relax-753"><a href="#StopCriteria.adjust_relax-753"><span class="linenos">753</span></a><span class="sd">        Based on the analyis of the current convergence-history of the on-going</span>
</span><span id="StopCriteria.adjust_relax-754"><a href="#StopCriteria.adjust_relax-754"><span class="linenos">754</span></a><span class="sd">        nonlinear equation solving, the relaxation parameter manually decreased</span>
</span><span id="StopCriteria.adjust_relax-755"><a href="#StopCriteria.adjust_relax-755"><span class="linenos">755</span></a><span class="sd">        to achieve convergence of Newton&#39;s iterations. The two following</span>
</span><span id="StopCriteria.adjust_relax-756"><a href="#StopCriteria.adjust_relax-756"><span class="linenos">756</span></a><span class="sd">        conditions must be satisfied simultaneously:</span>
</span><span id="StopCriteria.adjust_relax-757"><a href="#StopCriteria.adjust_relax-757"><span class="linenos">757</span></a><span class="sd">            - the relative delta has stopped decreasing</span>
</span><span id="StopCriteria.adjust_relax-758"><a href="#StopCriteria.adjust_relax-758"><span class="linenos">758</span></a><span class="sd">            - the residual in 2-norm has stopped decreasing</span>
</span><span id="StopCriteria.adjust_relax-759"><a href="#StopCriteria.adjust_relax-759"><span class="linenos">759</span></a>
</span><span id="StopCriteria.adjust_relax-760"><a href="#StopCriteria.adjust_relax-760"><span class="linenos">760</span></a><span class="sd">        Parameters</span>
</span><span id="StopCriteria.adjust_relax-761"><a href="#StopCriteria.adjust_relax-761"><span class="linenos">761</span></a><span class="sd">        ----------</span>
</span><span id="StopCriteria.adjust_relax-762"><a href="#StopCriteria.adjust_relax-762"><span class="linenos">762</span></a><span class="sd">        solver : `Solver` instance</span>
</span><span id="StopCriteria.adjust_relax-763"><a href="#StopCriteria.adjust_relax-763"><span class="linenos">763</span></a><span class="sd">            The solver instance.</span>
</span><span id="StopCriteria.adjust_relax-764"><a href="#StopCriteria.adjust_relax-764"><span class="linenos">764</span></a><span class="sd">        history_size : int, optional</span>
</span><span id="StopCriteria.adjust_relax-765"><a href="#StopCriteria.adjust_relax-765"><span class="linenos">765</span></a><span class="sd">            Number of past iteration used to check the two stalling conditions.</span>
</span><span id="StopCriteria.adjust_relax-766"><a href="#StopCriteria.adjust_relax-766"><span class="linenos">766</span></a><span class="sd">            The default is 3.</span>
</span><span id="StopCriteria.adjust_relax-767"><a href="#StopCriteria.adjust_relax-767"><span class="linenos">767</span></a><span class="sd">        factor : float, optional</span>
</span><span id="StopCriteria.adjust_relax-768"><a href="#StopCriteria.adjust_relax-768"><span class="linenos">768</span></a><span class="sd">            Factor by which the relaxation parameter is multiplied (should be</span>
</span><span id="StopCriteria.adjust_relax-769"><a href="#StopCriteria.adjust_relax-769"><span class="linenos">769</span></a><span class="sd">            strictly smaller than 1). The default value is 0.8.</span>
</span><span id="StopCriteria.adjust_relax-770"><a href="#StopCriteria.adjust_relax-770"><span class="linenos">770</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="StopCriteria.adjust_relax-771"><a href="#StopCriteria.adjust_relax-771"><span class="linenos">771</span></a>        
</span><span id="StopCriteria.adjust_relax-772"><a href="#StopCriteria.adjust_relax-772"><span class="linenos">772</span></a>        <span class="k">assert</span> <span class="n">factor</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">factor</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span id="StopCriteria.adjust_relax-773"><a href="#StopCriteria.adjust_relax-773"><span class="linenos">773</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">&gt;</span> <span class="n">history_size</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="StopCriteria.adjust_relax-774"><a href="#StopCriteria.adjust_relax-774"><span class="linenos">774</span></a>            <span class="n">res_L2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;res L2&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">history_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
</span><span id="StopCriteria.adjust_relax-775"><a href="#StopCriteria.adjust_relax-775"><span class="linenos">775</span></a>            <span class="n">sol_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="o">-</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;sol delta&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">history_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
</span><span id="StopCriteria.adjust_relax-776"><a href="#StopCriteria.adjust_relax-776"><span class="linenos">776</span></a>            <span class="n">cond1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">sol_delta</span><span class="p">)</span><span class="o">/</span><span class="n">sol_delta</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1e-2</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
</span><span id="StopCriteria.adjust_relax-777"><a href="#StopCriteria.adjust_relax-777"><span class="linenos">777</span></a>            <span class="n">cond2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">res_L2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">res_L2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1e-2</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
</span><span id="StopCriteria.adjust_relax-778"><a href="#StopCriteria.adjust_relax-778"><span class="linenos">778</span></a>            <span class="k">if</span> <span class="n">cond1</span> <span class="ow">and</span> <span class="n">cond2</span><span class="p">:</span>
</span><span id="StopCriteria.adjust_relax-779"><a href="#StopCriteria.adjust_relax-779"><span class="linenos">779</span></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="StopCriteria.adjust_relax-780"><a href="#StopCriteria.adjust_relax-780"><span class="linenos">780</span></a>                    <span class="n">factor</span> <span class="o">*=</span> <span class="mf">1e-2</span>
</span><span id="StopCriteria.adjust_relax-781"><a href="#StopCriteria.adjust_relax-781"><span class="linenos">781</span></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">:</span>
</span><span id="StopCriteria.adjust_relax-782"><a href="#StopCriteria.adjust_relax-782"><span class="linenos">782</span></a>                    <span class="n">factor</span> <span class="o">*=</span> <span class="mf">0.25</span>
</span><span id="StopCriteria.adjust_relax-783"><a href="#StopCriteria.adjust_relax-783"><span class="linenos">783</span></a>                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="StopCriteria.adjust_relax-784"><a href="#StopCriteria.adjust_relax-784"><span class="linenos">784</span></a>                    <span class="n">factor</span> <span class="o">*=</span> <span class="mf">0.5</span>
</span><span id="StopCriteria.adjust_relax-785"><a href="#StopCriteria.adjust_relax-785"><span class="linenos">785</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">relax</span> <span class="o">*=</span> <span class="n">factor</span>
</span><span id="StopCriteria.adjust_relax-786"><a href="#StopCriteria.adjust_relax-786"><span class="linenos">786</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">last_relax_update</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span>
</span><span id="StopCriteria.adjust_relax-787"><a href="#StopCriteria.adjust_relax-787"><span class="linenos">787</span></a>                <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="StopCriteria.adjust_relax-788"><a href="#StopCriteria.adjust_relax-788"><span class="linenos">788</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;! Decreasing relax. param. to </span><span class="si">{:.3f}</span><span class="s2"> !</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="StopCriteria.adjust_relax-789"><a href="#StopCriteria.adjust_relax-789"><span class="linenos">789</span></a>                        <span class="n">solver</span><span class="o">.</span><span class="n">relax</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Based on the analyis of the current convergence-history of the on-going
nonlinear equation solving, the relaxation parameter manually decreased
to achieve convergence of Newton's iterations. The two following
conditions must be satisfied simultaneously:
    - the relative delta has stopped decreasing
    - the residual in 2-norm has stopped decreasing</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>solver</strong> (<code><a href="#Solver">Solver</a></code> instance):
The solver instance.</li>
<li><strong>history_size</strong> (int, optional):
Number of past iteration used to check the two stalling conditions.
The default is 3.</li>
<li><strong>factor</strong> (float, optional):
Factor by which the relaxation parameter is multiplied (should be
strictly smaller than 1). The default value is 0.8.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="lsolve">
                            <input id="lsolve-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">lsolve</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">solver</span>, </span><span class="param"><span class="n">buffer</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="lsolve-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#lsolve"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="lsolve-792"><a href="#lsolve-792"><span class="linenos">792</span></a><span class="k">def</span> <span class="nf">lsolve</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="lsolve-793"><a href="#lsolve-793"><span class="linenos">793</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="lsolve-794"><a href="#lsolve-794"><span class="linenos">794</span></a><span class="sd">    Linear solve function.</span>
</span><span id="lsolve-795"><a href="#lsolve-795"><span class="linenos">795</span></a>
</span><span id="lsolve-796"><a href="#lsolve-796"><span class="linenos">796</span></a><span class="sd">    Parameters</span>
</span><span id="lsolve-797"><a href="#lsolve-797"><span class="linenos">797</span></a><span class="sd">    ----------</span>
</span><span id="lsolve-798"><a href="#lsolve-798"><span class="linenos">798</span></a><span class="sd">    solver : `Solver` instance</span>
</span><span id="lsolve-799"><a href="#lsolve-799"><span class="linenos">799</span></a><span class="sd">        The solver instance.</span>
</span><span id="lsolve-800"><a href="#lsolve-800"><span class="linenos">800</span></a><span class="sd">    buffer : bool, optional</span>
</span><span id="lsolve-801"><a href="#lsolve-801"><span class="linenos">801</span></a><span class="sd">        If True, the computed solution is kept in *solver.buffersols*. This is</span>
</span><span id="lsolve-802"><a href="#lsolve-802"><span class="linenos">802</span></a><span class="sd">        only relevant to nonlinear problems. The way the buffer is unload into</span>
</span><span id="lsolve-803"><a href="#lsolve-803"><span class="linenos">803</span></a><span class="sd">        *solver.sols* depends on the nonlinear method implementation.</span>
</span><span id="lsolve-804"><a href="#lsolve-804"><span class="linenos">804</span></a><span class="sd">        The default is False.</span>
</span><span id="lsolve-805"><a href="#lsolve-805"><span class="linenos">805</span></a>
</span><span id="lsolve-806"><a href="#lsolve-806"><span class="linenos">806</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="lsolve-807"><a href="#lsolve-807"><span class="linenos">807</span></a>
</span><span id="lsolve-808"><a href="#lsolve-808"><span class="linenos">808</span></a>    <span class="c1"># Retrieve tolerance settings</span>
</span><span id="lsolve-809"><a href="#lsolve-809"><span class="linenos">809</span></a>    <span class="n">eps_a</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">eps_dic</span><span class="p">[</span><span class="s1">&#39;eps_a&#39;</span><span class="p">]</span>
</span><span id="lsolve-810"><a href="#lsolve-810"><span class="linenos">810</span></a>    <span class="n">eps_r</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">eps_dic</span><span class="p">[</span><span class="s1">&#39;eps_r&#39;</span><span class="p">]</span>
</span><span id="lsolve-811"><a href="#lsolve-811"><span class="linenos">811</span></a>    <span class="n">i_max</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">eps_dic</span><span class="p">[</span><span class="s1">&#39;i_max&#39;</span><span class="p">]</span>
</span><span id="lsolve-812"><a href="#lsolve-812"><span class="linenos">812</span></a>    <span class="n">mtxvec_dic</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span>
</span><span id="lsolve-813"><a href="#lsolve-813"><span class="linenos">813</span></a>
</span><span id="lsolve-814"><a href="#lsolve-814"><span class="linenos">814</span></a>    <span class="c1"># Setup problem instances &amp; assemble matrices / vectors</span>
</span><span id="lsolve-815"><a href="#lsolve-815"><span class="linenos">815</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">solver</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
</span><span id="lsolve-816"><a href="#lsolve-816"><span class="linenos">816</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">init_problems</span><span class="p">()</span>
</span><span id="lsolve-817"><a href="#lsolve-817"><span class="linenos">817</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">init_mtxvec</span><span class="p">()</span>
</span><span id="lsolve-818"><a href="#lsolve-818"><span class="linenos">818</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="lsolve-819"><a href="#lsolve-819"><span class="linenos">819</span></a>
</span><span id="lsolve-820"><a href="#lsolve-820"><span class="linenos">820</span></a>    <span class="n">nwf</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">nwf</span>
</span><span id="lsolve-821"><a href="#lsolve-821"><span class="linenos">821</span></a>    <span class="n">status</span> <span class="o">=</span> <span class="n">IndexedStruct</span><span class="p">()</span>
</span><span id="lsolve-822"><a href="#lsolve-822"><span class="linenos">822</span></a>    <span class="n">update_global_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
</span><span id="lsolve-823"><a href="#lsolve-823"><span class="linenos">823</span></a>    <span class="n">ls</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">nls</span><span class="o">.</span><span class="n">lin_solver</span>
</span><span id="lsolve-824"><a href="#lsolve-824"><span class="linenos">824</span></a>
</span><span id="lsolve-825"><a href="#lsolve-825"><span class="linenos">825</span></a>    <span class="c1"># Single domain</span>
</span><span id="lsolve-826"><a href="#lsolve-826"><span class="linenos">826</span></a>    <span class="k">if</span> <span class="n">nwf</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="lsolve-827"><a href="#lsolve-827"><span class="linenos">827</span></a>        <span class="n">pb</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst&#39;</span><span class="p">]</span>
</span><span id="lsolve-828"><a href="#lsolve-828"><span class="linenos">828</span></a>        <span class="n">mtx</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx&#39;</span><span class="p">]</span>
</span><span id="lsolve-829"><a href="#lsolve-829"><span class="linenos">829</span></a>        <span class="n">rhs</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs&#39;</span><span class="p">]</span>
</span><span id="lsolve-830"><a href="#lsolve-830"><span class="linenos">830</span></a>        <span class="n">vec_x</span> <span class="o">=</span> <span class="n">ls</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eps_a</span><span class="o">=</span><span class="n">eps_a</span><span class="p">,</span> <span class="n">eps_r</span><span class="o">=</span><span class="n">eps_r</span><span class="p">,</span> <span class="n">mtx</span><span class="o">=</span><span class="n">mtx</span><span class="p">,</span>
</span><span id="lsolve-831"><a href="#lsolve-831"><span class="linenos">831</span></a>                   <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
</span><span id="lsolve-832"><a href="#lsolve-832"><span class="linenos">832</span></a>        <span class="n">sol</span> <span class="o">=</span> <span class="n">reconstruct_full_sol</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">vec_x</span><span class="p">)</span>
</span><span id="lsolve-833"><a href="#lsolve-833"><span class="linenos">833</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span>
</span><span id="lsolve-834"><a href="#lsolve-834"><span class="linenos">834</span></a>
</span><span id="lsolve-835"><a href="#lsolve-835"><span class="linenos">835</span></a>    <span class="c1"># Double domain</span>
</span><span id="lsolve-836"><a href="#lsolve-836"><span class="linenos">836</span></a>    <span class="k">elif</span> <span class="n">nwf</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="lsolve-837"><a href="#lsolve-837"><span class="linenos">837</span></a>        <span class="n">wf1</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="lsolve-838"><a href="#lsolve-838"><span class="linenos">838</span></a>        <span class="n">wf2</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="lsolve-839"><a href="#lsolve-839"><span class="linenos">839</span></a>
</span><span id="lsolve-840"><a href="#lsolve-840"><span class="linenos">840</span></a>        <span class="c1"># Virtual connection of DOFs at the boundary</span>
</span><span id="lsolve-841"><a href="#lsolve-841"><span class="linenos">841</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;connected&#39;</span><span class="p">:</span>
</span><span id="lsolve-842"><a href="#lsolve-842"><span class="linenos">842</span></a>            <span class="n">pb</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst&#39;</span><span class="p">]</span>
</span><span id="lsolve-843"><a href="#lsolve-843"><span class="linenos">843</span></a>            <span class="n">mtx</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx&#39;</span><span class="p">]</span>
</span><span id="lsolve-844"><a href="#lsolve-844"><span class="linenos">844</span></a>            <span class="n">rhs</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs&#39;</span><span class="p">]</span>
</span><span id="lsolve-845"><a href="#lsolve-845"><span class="linenos">845</span></a>            <span class="n">vec_x</span> <span class="o">=</span> <span class="n">ls</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eps_a</span><span class="o">=</span><span class="n">eps_a</span><span class="p">,</span> <span class="n">eps_r</span><span class="o">=</span><span class="n">eps_r</span><span class="p">,</span> <span class="n">mtx</span><span class="o">=</span><span class="n">mtx</span><span class="p">,</span>
</span><span id="lsolve-846"><a href="#lsolve-846"><span class="linenos">846</span></a>                       <span class="n">i_max</span><span class="o">=</span><span class="n">i_max</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
</span><span id="lsolve-847"><a href="#lsolve-847"><span class="linenos">847</span></a>            <span class="n">sol</span> <span class="o">=</span> <span class="n">reconstruct_full_sol</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">vec_x</span><span class="p">)</span>
</span><span id="lsolve-848"><a href="#lsolve-848"><span class="linenos">848</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[:</span><span class="n">wf1</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">n_nod</span><span class="p">]</span>
</span><span id="lsolve-849"><a href="#lsolve-849"><span class="linenos">849</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="n">wf1</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">n_nod</span><span class="p">:]</span>
</span><span id="lsolve-850"><a href="#lsolve-850"><span class="linenos">850</span></a>
</span><span id="lsolve-851"><a href="#lsolve-851"><span class="linenos">851</span></a>        <span class="c1"># DtN / NtD iterations (&#39;ping-pong&#39;)</span>
</span><span id="lsolve-852"><a href="#lsolve-852"><span class="linenos">852</span></a>        <span class="k">elif</span> <span class="n">solver</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="lsolve-853"><a href="#lsolve-853"><span class="linenos">853</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">relax_pp</span>
</span><span id="lsolve-854"><a href="#lsolve-854"><span class="linenos">854</span></a>            <span class="n">convergence_flag</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="lsolve-855"><a href="#lsolve-855"><span class="linenos">855</span></a>            <span class="n">old_pp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">n_nod</span><span class="p">)</span>
</span><span id="lsolve-856"><a href="#lsolve-856"><span class="linenos">856</span></a>            <span class="n">old_pp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">n_nod</span><span class="p">)</span>
</span><span id="lsolve-857"><a href="#lsolve-857"><span class="linenos">857</span></a>            <span class="n">pb_cst_pp1</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_pp1&#39;</span><span class="p">]</span>
</span><span id="lsolve-858"><a href="#lsolve-858"><span class="linenos">858</span></a>            <span class="n">pb_cst_pp2</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_pp2&#39;</span><span class="p">]</span>
</span><span id="lsolve-859"><a href="#lsolve-859"><span class="linenos">859</span></a>            
</span><span id="lsolve-860"><a href="#lsolve-860"><span class="linenos">860</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">max_iter_pp</span><span class="p">):</span>
</span><span id="lsolve-861"><a href="#lsolve-861"><span class="linenos">861</span></a>
</span><span id="lsolve-862"><a href="#lsolve-862"><span class="linenos">862</span></a>                <span class="c1"># Dirichlet BC on interior domain</span>
</span><span id="lsolve-863"><a href="#lsolve-863"><span class="linenos">863</span></a>                <span class="n">mtx_pp1</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_pp1&#39;</span><span class="p">]</span>
</span><span id="lsolve-864"><a href="#lsolve-864"><span class="linenos">864</span></a>                <span class="n">rhs_pp1</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_pp1&#39;</span><span class="p">]</span>
</span><span id="lsolve-865"><a href="#lsolve-865"><span class="linenos">865</span></a>                <span class="n">vec_x_pp1</span> <span class="o">=</span> <span class="n">ls</span><span class="p">(</span><span class="n">rhs_pp1</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eps_a</span><span class="o">=</span><span class="n">eps_a</span><span class="p">,</span> <span class="n">eps_r</span><span class="o">=</span><span class="n">eps_r</span><span class="p">,</span>
</span><span id="lsolve-866"><a href="#lsolve-866"><span class="linenos">866</span></a>                               <span class="n">mtx</span><span class="o">=</span><span class="n">mtx_pp1</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
</span><span id="lsolve-867"><a href="#lsolve-867"><span class="linenos">867</span></a>                <span class="n">sol_pp1</span> <span class="o">=</span> <span class="n">reconstruct_full_sol</span><span class="p">(</span><span class="n">pb_cst_pp1</span><span class="p">,</span> <span class="n">vec_x_pp1</span><span class="p">)</span>
</span><span id="lsolve-868"><a href="#lsolve-868"><span class="linenos">868</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_pp1</span>
</span><span id="lsolve-869"><a href="#lsolve-869"><span class="linenos">869</span></a>
</span><span id="lsolve-870"><a href="#lsolve-870"><span class="linenos">870</span></a>                <span class="c1"># Neumann BC on inversed exterior domain</span>
</span><span id="lsolve-871"><a href="#lsolve-871"><span class="linenos">871</span></a>                <span class="n">update_neumann</span><span class="p">(</span><span class="n">wf2</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">cogammas</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="lsolve-872"><a href="#lsolve-872"><span class="linenos">872</span></a>                <span class="n">assemble_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod_pp2&#39;</span><span class="p">],</span>
</span><span id="lsolve-873"><a href="#lsolve-873"><span class="linenos">873</span></a>                                <span class="n">assemble_mtx</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># do not rebuild matrices!</span>
</span><span id="lsolve-874"><a href="#lsolve-874"><span class="linenos">874</span></a>
</span><span id="lsolve-875"><a href="#lsolve-875"><span class="linenos">875</span></a>                <span class="n">mtx_mod_pp2</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mtx_mod_pp2&#39;</span><span class="p">)</span>
</span><span id="lsolve-876"><a href="#lsolve-876"><span class="linenos">876</span></a>                <span class="k">if</span> <span class="n">mtx_mod_pp2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="lsolve-877"><a href="#lsolve-877"><span class="linenos">877</span></a>                    <span class="n">mtx_pp2</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_pp2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">mtx_mod_pp2</span>
</span><span id="lsolve-878"><a href="#lsolve-878"><span class="linenos">878</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="lsolve-879"><a href="#lsolve-879"><span class="linenos">879</span></a>                    <span class="n">mtx_pp2</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_pp2&#39;</span><span class="p">]</span>
</span><span id="lsolve-880"><a href="#lsolve-880"><span class="linenos">880</span></a>
</span><span id="lsolve-881"><a href="#lsolve-881"><span class="linenos">881</span></a>                <span class="n">rhs_mod_pp2</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rhs_mod_pp2&#39;</span><span class="p">)</span>
</span><span id="lsolve-882"><a href="#lsolve-882"><span class="linenos">882</span></a>                <span class="k">if</span> <span class="n">rhs_mod_pp2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="lsolve-883"><a href="#lsolve-883"><span class="linenos">883</span></a>                    <span class="n">rhs_pp2</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_pp2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">rhs_mod_pp2</span>
</span><span id="lsolve-884"><a href="#lsolve-884"><span class="linenos">884</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="lsolve-885"><a href="#lsolve-885"><span class="linenos">885</span></a>                    <span class="n">rhs_pp2</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_pp2&#39;</span><span class="p">]</span>
</span><span id="lsolve-886"><a href="#lsolve-886"><span class="linenos">886</span></a>
</span><span id="lsolve-887"><a href="#lsolve-887"><span class="linenos">887</span></a>                <span class="n">vec_x_pp2</span> <span class="o">=</span> <span class="n">ls</span><span class="p">(</span><span class="n">rhs_pp2</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eps_a</span><span class="o">=</span><span class="n">eps_a</span><span class="p">,</span> <span class="n">eps_r</span><span class="o">=</span><span class="n">eps_r</span><span class="p">,</span>
</span><span id="lsolve-888"><a href="#lsolve-888"><span class="linenos">888</span></a>                               <span class="n">mtx</span><span class="o">=</span><span class="n">mtx_pp2</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
</span><span id="lsolve-889"><a href="#lsolve-889"><span class="linenos">889</span></a>                <span class="n">sol_pp2</span> <span class="o">=</span> <span class="n">reconstruct_full_sol</span><span class="p">(</span><span class="n">pb_cst_pp2</span><span class="p">,</span> <span class="n">vec_x_pp2</span><span class="p">)</span>
</span><span id="lsolve-890"><a href="#lsolve-890"><span class="linenos">890</span></a>
</span><span id="lsolve-891"><a href="#lsolve-891"><span class="linenos">891</span></a>                <span class="c1"># Reset Dirichlet BC on the interior domain using the solution</span>
</span><span id="lsolve-892"><a href="#lsolve-892"><span class="linenos">892</span></a>                <span class="c1"># on the inversed exterior domain that we just calculated...</span>
</span><span id="lsolve-893"><a href="#lsolve-893"><span class="linenos">893</span></a>                <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="lsolve-894"><a href="#lsolve-894"><span class="linenos">894</span></a>                    <span class="n">sol_relax</span> <span class="o">=</span> <span class="n">theta</span><span class="o">*</span><span class="n">sol_pp2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="n">old_pp2</span>
</span><span id="lsolve-895"><a href="#lsolve-895"><span class="linenos">895</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="lsolve-896"><a href="#lsolve-896"><span class="linenos">896</span></a>                    <span class="n">sol_relax</span> <span class="o">=</span> <span class="n">sol_pp2</span>
</span><span id="lsolve-897"><a href="#lsolve-897"><span class="linenos">897</span></a>                <span class="n">reset_dirichlet</span><span class="p">(</span><span class="n">sol_relax</span><span class="p">,</span> <span class="n">wf1</span><span class="p">,</span> <span class="n">wf2</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">cogammas</span><span class="p">)</span>
</span><span id="lsolve-898"><a href="#lsolve-898"><span class="linenos">898</span></a>                <span class="n">pb_cst_pp1</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="lsolve-899"><a href="#lsolve-899"><span class="linenos">899</span></a>                                   <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="lsolve-900"><a href="#lsolve-900"><span class="linenos">900</span></a>                <span class="n">pb_cst_pp1</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">apply_ebc</span><span class="p">()</span>
</span><span id="lsolve-901"><a href="#lsolve-901"><span class="linenos">901</span></a>                <span class="n">pb_mod_pp1</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">pbs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pb_mod_pp1&#39;</span><span class="p">)</span>
</span><span id="lsolve-902"><a href="#lsolve-902"><span class="linenos">902</span></a>                <span class="k">if</span> <span class="n">pb_mod_pp1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="lsolve-903"><a href="#lsolve-903"><span class="linenos">903</span></a>                    <span class="n">pb_mod_pp1</span><span class="o">.</span><span class="n">set_bcs</span><span class="p">(</span><span class="n">ebcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">),</span>
</span><span id="lsolve-904"><a href="#lsolve-904"><span class="linenos">904</span></a>                                       <span class="n">epbcs</span><span class="o">=</span><span class="n">Conditions</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">epbcs</span><span class="p">))</span>
</span><span id="lsolve-905"><a href="#lsolve-905"><span class="linenos">905</span></a>                    <span class="n">pb_mod_pp1</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">apply_ebc</span><span class="p">()</span>
</span><span id="lsolve-906"><a href="#lsolve-906"><span class="linenos">906</span></a>
</span><span id="lsolve-907"><a href="#lsolve-907"><span class="linenos">907</span></a>                <span class="c1"># ... which involves re-assembling rhs vectors</span>
</span><span id="lsolve-908"><a href="#lsolve-908"><span class="linenos">908</span></a>                <span class="n">assemble_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">pb_cst_pp1</span><span class="p">,</span> <span class="n">assemble_mtx</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="lsolve-909"><a href="#lsolve-909"><span class="linenos">909</span></a>                <span class="n">assemble_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">pb_mod_pp1</span><span class="p">)</span>
</span><span id="lsolve-910"><a href="#lsolve-910"><span class="linenos">910</span></a>                <span class="n">update_global_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
</span><span id="lsolve-911"><a href="#lsolve-911"><span class="linenos">911</span></a>                
</span><span id="lsolve-912"><a href="#lsolve-912"><span class="linenos">912</span></a>                <span class="c1"># check if convergence has been reached</span>
</span><span id="lsolve-913"><a href="#lsolve-913"><span class="linenos">913</span></a>                <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="lsolve-914"><a href="#lsolve-914"><span class="linenos">914</span></a>                    <span class="n">norm_delta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">sol_pp1</span><span class="o">-</span><span class="n">old_pp1</span><span class="p">)</span>
</span><span id="lsolve-915"><a href="#lsolve-915"><span class="linenos">915</span></a>                    <span class="n">norm_delta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">sol_pp2</span><span class="o">-</span><span class="n">old_pp2</span><span class="p">)</span>
</span><span id="lsolve-916"><a href="#lsolve-916"><span class="linenos">916</span></a>                    <span class="n">norm_old1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">old_pp1</span><span class="p">)</span>
</span><span id="lsolve-917"><a href="#lsolve-917"><span class="linenos">917</span></a>                    <span class="n">norm_old2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">old_pp2</span><span class="p">)</span>
</span><span id="lsolve-918"><a href="#lsolve-918"><span class="linenos">918</span></a>                    <span class="n">rel_delta</span> <span class="o">=</span> <span class="n">norm_delta1</span><span class="o">/</span><span class="n">norm_old1</span> <span class="o">+</span> <span class="n">norm_delta2</span><span class="o">/</span><span class="n">norm_old2</span>
</span><span id="lsolve-919"><a href="#lsolve-919"><span class="linenos">919</span></a>                    <span class="n">convergence_flag</span> <span class="o">=</span> <span class="n">rel_delta</span> <span class="o">&lt;</span> <span class="mf">1e-8</span>
</span><span id="lsolve-920"><a href="#lsolve-920"><span class="linenos">920</span></a>                
</span><span id="lsolve-921"><a href="#lsolve-921"><span class="linenos">921</span></a>                <span class="c1"># update auxiliary array</span>
</span><span id="lsolve-922"><a href="#lsolve-922"><span class="linenos">922</span></a>                <span class="n">old_pp1</span> <span class="o">=</span> <span class="n">sol_pp1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="lsolve-923"><a href="#lsolve-923"><span class="linenos">923</span></a>                <span class="n">old_pp2</span> <span class="o">=</span> <span class="n">sol_pp2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="lsolve-924"><a href="#lsolve-924"><span class="linenos">924</span></a>                
</span><span id="lsolve-925"><a href="#lsolve-925"><span class="linenos">925</span></a>                <span class="k">if</span> <span class="n">convergence_flag</span><span class="p">:</span>
</span><span id="lsolve-926"><a href="#lsolve-926"><span class="linenos">926</span></a>                    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">verbose</span><span class="o">&gt;</span><span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">islinear</span><span class="p">):</span>
</span><span id="lsolve-927"><a href="#lsolve-927"><span class="linenos">927</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ping-pong convergence in </span><span class="si">{}</span><span class="s2"> iter&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</span><span id="lsolve-928"><a href="#lsolve-928"><span class="linenos">928</span></a>                    <span class="k">break</span>
</span><span id="lsolve-929"><a href="#lsolve-929"><span class="linenos">929</span></a>
</span><span id="lsolve-930"><a href="#lsolve-930"><span class="linenos">930</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_pp1</span>
</span><span id="lsolve-931"><a href="#lsolve-931"><span class="linenos">931</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_pp2</span>
</span><span id="lsolve-932"><a href="#lsolve-932"><span class="linenos">932</span></a>
</span><span id="lsolve-933"><a href="#lsolve-933"><span class="linenos">933</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="lsolve-934"><a href="#lsolve-934"><span class="linenos">934</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not implemented&quot;</span> <span class="o">%</span><span class="n">solver</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>
</span><span id="lsolve-935"><a href="#lsolve-935"><span class="linenos">935</span></a>
</span><span id="lsolve-936"><a href="#lsolve-936"><span class="linenos">936</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="lsolve-937"><a href="#lsolve-937"><span class="linenos">937</span></a>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;femtoscope cannot deal with more than 2 domains&quot;</span><span class="p">)</span>
</span><span id="lsolve-938"><a href="#lsolve-938"><span class="linenos">938</span></a>
</span><span id="lsolve-939"><a href="#lsolve-939"><span class="linenos">939</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">buffer</span><span class="p">:</span>
</span><span id="lsolve-940"><a href="#lsolve-940"><span class="linenos">940</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">sols</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">]</span>
</span><span id="lsolve-941"><a href="#lsolve-941"><span class="linenos">941</span></a>        
</span><span id="lsolve-942"><a href="#lsolve-942"><span class="linenos">942</span></a>    <span class="c1"># compute the condition number of the stifness matrix</span>
</span><span id="lsolve-943"><a href="#lsolve-943"><span class="linenos">943</span></a>    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">print_kappa</span><span class="p">:</span>
</span><span id="lsolve-944"><a href="#lsolve-944"><span class="linenos">944</span></a>        <span class="kn">from</span> <span class="nn">scipy.sparse.linalg</span> <span class="kn">import</span> <span class="n">eigsh</span>
</span><span id="lsolve-945"><a href="#lsolve-945"><span class="linenos">945</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">conn</span> <span class="o">==</span> <span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="lsolve-946"><a href="#lsolve-946"><span class="linenos">946</span></a>            <span class="n">mtx</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_pp1&#39;</span><span class="p">]</span>
</span><span id="lsolve-947"><a href="#lsolve-947"><span class="linenos">947</span></a>        <span class="n">max_eig</span> <span class="o">=</span> <span class="n">eigsh</span><span class="p">(</span><span class="n">mtx</span><span class="p">,</span> <span class="n">return_eigenvectors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;LM&#39;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="lsolve-948"><a href="#lsolve-948"><span class="linenos">948</span></a>        <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1e-8</span>
</span><span id="lsolve-949"><a href="#lsolve-949"><span class="linenos">949</span></a>        <span class="n">min_eig</span> <span class="o">=</span> <span class="n">eigsh</span><span class="p">(</span><span class="n">mtx</span><span class="p">,</span> <span class="n">return_eigenvectors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="lsolve-950"><a href="#lsolve-950"><span class="linenos">950</span></a>        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="lsolve-951"><a href="#lsolve-951"><span class="linenos">951</span></a>        <span class="k">while</span> <span class="n">min_eig</span> <span class="o">&lt;</span> <span class="n">sigma</span> <span class="ow">and</span> <span class="n">counter</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="lsolve-952"><a href="#lsolve-952"><span class="linenos">952</span></a>            <span class="n">sigma</span> <span class="o">/=</span> <span class="mi">100</span>
</span><span id="lsolve-953"><a href="#lsolve-953"><span class="linenos">953</span></a>            <span class="n">min_eig</span> <span class="o">=</span> <span class="n">eigsh</span><span class="p">(</span><span class="n">mtx</span><span class="p">,</span> <span class="n">return_eigenvectors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
</span><span id="lsolve-954"><a href="#lsolve-954"><span class="linenos">954</span></a>            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="lsolve-955"><a href="#lsolve-955"><span class="linenos">955</span></a>        <span class="k">if</span> <span class="n">counter</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
</span><span id="lsolve-956"><a href="#lsolve-956"><span class="linenos">956</span></a>            <span class="kn">import</span> <span class="nn">warnings</span>
</span><span id="lsolve-957"><a href="#lsolve-957"><span class="linenos">957</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Could not compute the condition number!&quot;</span><span class="p">)</span>
</span><span id="lsolve-958"><a href="#lsolve-958"><span class="linenos">958</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="lsolve-959"><a href="#lsolve-959"><span class="linenos">959</span></a>            <span class="n">kappa</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">max_eig</span><span class="o">/</span><span class="n">min_eig</span><span class="p">)</span>
</span><span id="lsolve-960"><a href="#lsolve-960"><span class="linenos">960</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Matrix condition number = </span><span class="si">{:.2e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kappa</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Linear solve function.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>solver</strong> (<code><a href="#Solver">Solver</a></code> instance):
The solver instance.</li>
<li><strong>buffer</strong> (bool, optional):
If True, the computed solution is kept in <em>solver.buffersols</em>. This is
only relevant to nonlinear problems. The way the buffer is unload into
<em>solver.sols</em> depends on the nonlinear method implementation.
The default is False.</li>
</ul>
</div>


                </section>
                <section id="nlsolve">
                            <input id="nlsolve-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">nlsolve</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">solver</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="nlsolve-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#nlsolve"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="nlsolve-963"><a href="#nlsolve-963"><span class="linenos"> 963</span></a><span class="k">def</span> <span class="nf">nlsolve</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="nlsolve-964"><a href="#nlsolve-964"><span class="linenos"> 964</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="nlsolve-965"><a href="#nlsolve-965"><span class="linenos"> 965</span></a><span class="sd">    Nonlinear solve function based on Newton iterations. Each iteration is</span>
</span><span id="nlsolve-966"><a href="#nlsolve-966"><span class="linenos"> 966</span></a><span class="sd">    associated with a linear problem that is solved by calling the `solve()`</span>
</span><span id="nlsolve-967"><a href="#nlsolve-967"><span class="linenos"> 967</span></a><span class="sd">    function.</span>
</span><span id="nlsolve-968"><a href="#nlsolve-968"><span class="linenos"> 968</span></a>
</span><span id="nlsolve-969"><a href="#nlsolve-969"><span class="linenos"> 969</span></a><span class="sd">    Parameters</span>
</span><span id="nlsolve-970"><a href="#nlsolve-970"><span class="linenos"> 970</span></a><span class="sd">    ----------</span>
</span><span id="nlsolve-971"><a href="#nlsolve-971"><span class="linenos"> 971</span></a><span class="sd">    solver : `Solver` instance</span>
</span><span id="nlsolve-972"><a href="#nlsolve-972"><span class="linenos"> 972</span></a><span class="sd">        The solver instance.</span>
</span><span id="nlsolve-973"><a href="#nlsolve-973"><span class="linenos"> 973</span></a><span class="sd">        </span>
</span><span id="nlsolve-974"><a href="#nlsolve-974"><span class="linenos"> 974</span></a><span class="sd">    Other Parameters</span>
</span><span id="nlsolve-975"><a href="#nlsolve-975"><span class="linenos"> 975</span></a><span class="sd">    ----------------</span>
</span><span id="nlsolve-976"><a href="#nlsolve-976"><span class="linenos"> 976</span></a><span class="sd">    save_all_newton : bool, optional</span>
</span><span id="nlsolve-977"><a href="#nlsolve-977"><span class="linenos"> 977</span></a><span class="sd">        If true, save all Newton&#39;s iterations (solution, residual...).</span>
</span><span id="nlsolve-978"><a href="#nlsolve-978"><span class="linenos"> 978</span></a><span class="sd">        The default is False.</span>
</span><span id="nlsolve-979"><a href="#nlsolve-979"><span class="linenos"> 979</span></a>
</span><span id="nlsolve-980"><a href="#nlsolve-980"><span class="linenos"> 980</span></a><span class="sd">    Returns</span>
</span><span id="nlsolve-981"><a href="#nlsolve-981"><span class="linenos"> 981</span></a><span class="sd">    -------</span>
</span><span id="nlsolve-982"><a href="#nlsolve-982"><span class="linenos"> 982</span></a><span class="sd">    None.</span>
</span><span id="nlsolve-983"><a href="#nlsolve-983"><span class="linenos"> 983</span></a>
</span><span id="nlsolve-984"><a href="#nlsolve-984"><span class="linenos"> 984</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="nlsolve-985"><a href="#nlsolve-985"><span class="linenos"> 985</span></a>
</span><span id="nlsolve-986"><a href="#nlsolve-986"><span class="linenos"> 986</span></a>    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="nlsolve-987"><a href="#nlsolve-987"><span class="linenos"> 987</span></a>    <span class="n">save_all_newton</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;save_all_newton&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="nlsolve-988"><a href="#nlsolve-988"><span class="linenos"> 988</span></a>    <span class="n">solver</span><span class="o">.</span><span class="n">save_all_newton</span> <span class="o">=</span> <span class="n">save_all_newton</span>
</span><span id="nlsolve-989"><a href="#nlsolve-989"><span class="linenos"> 989</span></a>    <span class="k">if</span> <span class="n">save_all_newton</span><span class="p">:</span>
</span><span id="nlsolve-990"><a href="#nlsolve-990"><span class="linenos"> 990</span></a>        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="nlsolve-991"><a href="#nlsolve-991"><span class="linenos"> 991</span></a>        <span class="kn">from</span> <span class="nn">femtoscope</span> <span class="kn">import</span> <span class="n">RESULT_DIR</span>
</span><span id="nlsolve-992"><a href="#nlsolve-992"><span class="linenos"> 992</span></a>        <span class="kn">from</span> <span class="nn">femtoscope.misc.util</span> <span class="kn">import</span> <span class="n">mkdir_p</span><span class="p">,</span> <span class="n">date_string</span>
</span><span id="nlsolve-993"><a href="#nlsolve-993"><span class="linenos"> 993</span></a>        <span class="n">dirname</span> <span class="o">=</span> <span class="s2">&quot;newton-it_&quot;</span> <span class="o">+</span> <span class="n">date_string</span><span class="p">()</span>
</span><span id="nlsolve-994"><a href="#nlsolve-994"><span class="linenos"> 994</span></a>        <span class="n">dirpath</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">RESULT_DIR</span><span class="o">/</span><span class="n">dirname</span><span class="p">))</span>
</span><span id="nlsolve-995"><a href="#nlsolve-995"><span class="linenos"> 995</span></a>        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
</span><span id="nlsolve-996"><a href="#nlsolve-996"><span class="linenos"> 996</span></a>    <span class="n">stop_criteria</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">criteria</span>
</span><span id="nlsolve-997"><a href="#nlsolve-997"><span class="linenos"> 997</span></a>    <span class="n">sol_min</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="nlsolve-998"><a href="#nlsolve-998"><span class="linenos"> 998</span></a>    <span class="n">sol_max</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="nlsolve-999"><a href="#nlsolve-999"><span class="linenos"> 999</span></a>    
</span><span id="nlsolve-1000"><a href="#nlsolve-1000"><span class="linenos">1000</span></a>    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="nlsolve-1001"><a href="#nlsolve-1001"><span class="linenos">1001</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; Iteration no </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">))</span>
</span><span id="nlsolve-1002"><a href="#nlsolve-1002"><span class="linenos">1002</span></a>
</span><span id="nlsolve-1003"><a href="#nlsolve-1003"><span class="linenos">1003</span></a>    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stop_criteria</span><span class="o">.</span><span class="n">max_iter</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span><span id="nlsolve-1004"><a href="#nlsolve-1004"><span class="linenos">1004</span></a>        <span class="n">lsolve</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="nlsolve-1005"><a href="#nlsolve-1005"><span class="linenos">1005</span></a>        
</span><span id="nlsolve-1006"><a href="#nlsolve-1006"><span class="linenos">1006</span></a>        <span class="c1"># fill history for 0-th iteration</span>
</span><span id="nlsolve-1007"><a href="#nlsolve-1007"><span class="linenos">1007</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="nlsolve-1008"><a href="#nlsolve-1008"><span class="linenos">1008</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">)):</span>
</span><span id="nlsolve-1009"><a href="#nlsolve-1009"><span class="linenos">1009</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">oldsols</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
</span><span id="nlsolve-1010"><a href="#nlsolve-1010"><span class="linenos">1010</span></a>            <span class="n">stop_criteria</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
</span><span id="nlsolve-1011"><a href="#nlsolve-1011"><span class="linenos">1011</span></a>            <span class="k">if</span> <span class="n">save_all_newton</span><span class="p">:</span>
</span><span id="nlsolve-1012"><a href="#nlsolve-1012"><span class="linenos">1012</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">dirname</span><span class="o">+</span><span class="s1">&#39;/iter-</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</span><span id="nlsolve-1013"><a href="#nlsolve-1013"><span class="linenos">1013</span></a>
</span><span id="nlsolve-1014"><a href="#nlsolve-1014"><span class="linenos">1014</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">iter</span> <span class="o">+=</span> <span class="mi">1</span>                
</span><span id="nlsolve-1015"><a href="#nlsolve-1015"><span class="linenos">1015</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="nlsolve-1016"><a href="#nlsolve-1016"><span class="linenos">1016</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; Iteration no </span><span class="si">{}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">iter</span><span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">))</span>
</span><span id="nlsolve-1017"><a href="#nlsolve-1017"><span class="linenos">1017</span></a>
</span><span id="nlsolve-1018"><a href="#nlsolve-1018"><span class="linenos">1018</span></a>        <span class="c1"># Crop the (buffered) solution to fit interval requirement</span>
</span><span id="nlsolve-1019"><a href="#nlsolve-1019"><span class="linenos">1019</span></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">sol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">):</span>
</span><span id="nlsolve-1020"><a href="#nlsolve-1020"><span class="linenos">1020</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sol</span><span class="o">&lt;</span><span class="n">sol_min</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sol_min</span>
</span><span id="nlsolve-1021"><a href="#nlsolve-1021"><span class="linenos">1021</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sol</span><span class="o">&gt;</span><span class="n">sol_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sol_max</span>
</span><span id="nlsolve-1022"><a href="#nlsolve-1022"><span class="linenos">1022</span></a>
</span><span id="nlsolve-1023"><a href="#nlsolve-1023"><span class="linenos">1023</span></a>        <span class="n">w</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">relax</span>
</span><span id="nlsolve-1024"><a href="#nlsolve-1024"><span class="linenos">1024</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">nwf</span><span class="p">):</span>
</span><span id="nlsolve-1025"><a href="#nlsolve-1025"><span class="linenos">1025</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">solver</span><span class="o">.</span><span class="n">oldsols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="nlsolve-1026"><a href="#nlsolve-1026"><span class="linenos">1026</span></a>
</span><span id="nlsolve-1027"><a href="#nlsolve-1027"><span class="linenos">1027</span></a>        <span class="c1"># Crop the (new iteration) solution to fit interval requirement</span>
</span><span id="nlsolve-1028"><a href="#nlsolve-1028"><span class="linenos">1028</span></a>        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">sol</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">):</span>
</span><span id="nlsolve-1029"><a href="#nlsolve-1029"><span class="linenos">1029</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sol</span><span class="o">&lt;</span><span class="n">sol_min</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sol_min</span>
</span><span id="nlsolve-1030"><a href="#nlsolve-1030"><span class="linenos">1030</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sol</span><span class="o">&gt;</span><span class="n">sol_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sol_max</span>
</span><span id="nlsolve-1031"><a href="#nlsolve-1031"><span class="linenos">1031</span></a>
</span><span id="nlsolve-1032"><a href="#nlsolve-1032"><span class="linenos">1032</span></a>        <span class="c1"># Update material&#39;s data (linearized nonlinear terms)</span>
</span><span id="nlsolve-1033"><a href="#nlsolve-1033"><span class="linenos">1033</span></a>        <span class="n">wf_res</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_res&#39;</span><span class="p">)</span>
</span><span id="nlsolve-1034"><a href="#nlsolve-1034"><span class="linenos">1034</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">)):</span>
</span><span id="nlsolve-1035"><a href="#nlsolve-1035"><span class="linenos">1035</span></a>            <span class="n">sol_qps</span> <span class="o">=</span> <span class="n">evaluate_at_qps</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
</span><span id="nlsolve-1036"><a href="#nlsolve-1036"><span class="linenos">1036</span></a>            <span class="n">sol_qps</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sol_qps</span><span class="o">&lt;</span><span class="n">sol_min</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sol_min</span>
</span><span id="nlsolve-1037"><a href="#nlsolve-1037"><span class="linenos">1037</span></a>            <span class="n">sol_qps</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sol_qps</span><span class="o">&gt;</span><span class="n">sol_max</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sol_max</span>
</span><span id="nlsolve-1038"><a href="#nlsolve-1038"><span class="linenos">1038</span></a>            <span class="n">set_mat_extra_arg</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">sol_qps</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="nlsolve-1039"><a href="#nlsolve-1039"><span class="linenos">1039</span></a>            <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">wf_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="nlsolve-1040"><a href="#nlsolve-1040"><span class="linenos">1040</span></a>                <span class="n">set_mat_extra_arg</span><span class="p">(</span><span class="n">wf_res</span><span class="p">,</span> <span class="n">sol_qps</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="nlsolve-1041"><a href="#nlsolve-1041"><span class="linenos">1041</span></a>
</span><span id="nlsolve-1042"><a href="#nlsolve-1042"><span class="linenos">1042</span></a>        <span class="c1"># Re-assemble matrices &amp; vectors and update the dictionary</span>
</span><span id="nlsolve-1043"><a href="#nlsolve-1043"><span class="linenos">1043</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">update_mtxvec</span><span class="p">()</span>
</span><span id="nlsolve-1044"><a href="#nlsolve-1044"><span class="linenos">1044</span></a>        <span class="n">update_global_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
</span><span id="nlsolve-1045"><a href="#nlsolve-1045"><span class="linenos">1045</span></a>        
</span><span id="nlsolve-1046"><a href="#nlsolve-1046"><span class="linenos">1046</span></a>        <span class="c1"># if solver.weakforms[0].dimension == 2:</span>
</span><span id="nlsolve-1047"><a href="#nlsolve-1047"><span class="linenos">1047</span></a>        <span class="c1">#     hook_writer(solver.weakforms[0].field.coors, solver.sols[0],</span>
</span><span id="nlsolve-1048"><a href="#nlsolve-1048"><span class="linenos">1048</span></a>        <span class="c1">#                 solver.criteria.res_vec, solver.iter)</span>
</span><span id="nlsolve-1049"><a href="#nlsolve-1049"><span class="linenos">1049</span></a>
</span><span id="nlsolve-1050"><a href="#nlsolve-1050"><span class="linenos">1050</span></a>        <span class="c1"># Stop criteria: do we do one more iteration?</span>
</span><span id="nlsolve-1051"><a href="#nlsolve-1051"><span class="linenos">1051</span></a>        <span class="k">if</span> <span class="n">stop_criteria</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">solver</span><span class="p">):</span> <span class="c1"># NO</span>
</span><span id="nlsolve-1052"><a href="#nlsolve-1052"><span class="linenos">1052</span></a>            <span class="n">stop_criteria</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">stop_criteria</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
</span><span id="nlsolve-1053"><a href="#nlsolve-1053"><span class="linenos">1053</span></a>            <span class="k">break</span>
</span><span id="nlsolve-1054"><a href="#nlsolve-1054"><span class="linenos">1054</span></a>        <span class="k">else</span><span class="p">:</span> <span class="c1"># YES</span>
</span><span id="nlsolve-1055"><a href="#nlsolve-1055"><span class="linenos">1055</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">)):</span>
</span><span id="nlsolve-1056"><a href="#nlsolve-1056"><span class="linenos">1056</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">oldsols</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">sols</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
</span><span id="nlsolve-1057"><a href="#nlsolve-1057"><span class="linenos">1057</span></a>                
</span><span id="nlsolve-1058"><a href="#nlsolve-1058"><span class="linenos">1058</span></a>        <span class="c1"># Stop criteria: res stagnation --&gt; decrease the relaxation parameter</span>
</span><span id="nlsolve-1059"><a href="#nlsolve-1059"><span class="linenos">1059</span></a>        <span class="n">stop_criteria</span><span class="o">.</span><span class="n">adjust_relax</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span>
</span><span id="nlsolve-1060"><a href="#nlsolve-1060"><span class="linenos">1060</span></a>
</span><span id="nlsolve-1061"><a href="#nlsolve-1061"><span class="linenos">1061</span></a>        <span class="c1"># Save current Newton iteration</span>
</span><span id="nlsolve-1062"><a href="#nlsolve-1062"><span class="linenos">1062</span></a>        <span class="k">if</span> <span class="n">save_all_newton</span><span class="p">:</span>
</span><span id="nlsolve-1063"><a href="#nlsolve-1063"><span class="linenos">1063</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">dirname</span><span class="o">+</span><span class="s1">&#39;/iter-</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">iter</span><span class="p">))</span>
</span><span id="nlsolve-1064"><a href="#nlsolve-1064"><span class="linenos">1064</span></a>            
</span><span id="nlsolve-1065"><a href="#nlsolve-1065"><span class="linenos">1065</span></a>        <span class="c1"># to_pickle.append(stop_criteria.strong_res_vec)</span>
</span><span id="nlsolve-1066"><a href="#nlsolve-1066"><span class="linenos">1066</span></a>
</span><span id="nlsolve-1067"><a href="#nlsolve-1067"><span class="linenos">1067</span></a>    <span class="c1"># Save last Newton iteration</span>
</span><span id="nlsolve-1068"><a href="#nlsolve-1068"><span class="linenos">1068</span></a>    <span class="k">if</span> <span class="n">save_all_newton</span><span class="p">:</span>
</span><span id="nlsolve-1069"><a href="#nlsolve-1069"><span class="linenos">1069</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">dirname</span><span class="o">+</span><span class="s1">&#39;/iter-</span><span class="si">{:03d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">iter</span><span class="p">))</span>
</span><span id="nlsolve-1070"><a href="#nlsolve-1070"><span class="linenos">1070</span></a>        
</span><span id="nlsolve-1071"><a href="#nlsolve-1071"><span class="linenos">1071</span></a>    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="nlsolve-1072"><a href="#nlsolve-1072"><span class="linenos">1072</span></a>        <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">has_converged</span><span class="p">:</span>
</span><span id="nlsolve-1073"><a href="#nlsolve-1073"><span class="linenos">1073</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CONVERGENCE in </span><span class="si">{}</span><span class="s2"> iterations</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">iter</span><span class="p">))</span>
</span><span id="nlsolve-1074"><a href="#nlsolve-1074"><span class="linenos">1074</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="nlsolve-1075"><a href="#nlsolve-1075"><span class="linenos">1075</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NO CONVERGENCE after </span><span class="si">{}</span><span class="s2"> iterations</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">iter</span><span class="p">))</span>
</span><span id="nlsolve-1076"><a href="#nlsolve-1076"><span class="linenos">1076</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Recap of all Iterations &quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">88</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">))</span>
</span><span id="nlsolve-1077"><a href="#nlsolve-1077"><span class="linenos">1077</span></a>        <span class="nb">print</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">criteria</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Nonlinear solve function based on Newton iterations. Each iteration is
associated with a linear problem that is solved by calling the <code>solve()</code>
function.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>solver</strong> (<code><a href="#Solver">Solver</a></code> instance):
The solver instance.</li>
</ul>

<h6 id="other-parameters">Other Parameters</h6>

<ul>
<li><strong>save_all_newton</strong> (bool, optional):
If true, save all Newton's iterations (solution, residual...).
The default is False.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None.</strong></li>
</ul>
</div>


                </section>
                <section id="hook_writer">
                            <input id="hook_writer-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">hook_writer</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">coors</span>, </span><span class="param"><span class="n">sol</span>, </span><span class="param"><span class="n">res</span>, </span><span class="param"><span class="n">no_iter</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="hook_writer-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#hook_writer"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="hook_writer-1079"><a href="#hook_writer-1079"><span class="linenos">1079</span></a><span class="k">def</span> <span class="nf">hook_writer</span><span class="p">(</span><span class="n">coors</span><span class="p">,</span> <span class="n">sol</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">no_iter</span><span class="p">):</span>
</span><span id="hook_writer-1080"><a href="#hook_writer-1080"><span class="linenos">1080</span></a>    <span class="kn">import</span> <span class="nn">pickle</span>
</span><span id="hook_writer-1081"><a href="#hook_writer-1081"><span class="linenos">1081</span></a>    <span class="n">data_dic</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="hook_writer-1082"><a href="#hook_writer-1082"><span class="linenos">1082</span></a>    <span class="n">x1</span> <span class="o">=</span> <span class="mf">1.059</span>
</span><span id="hook_writer-1083"><a href="#hook_writer-1083"><span class="linenos">1083</span></a>    <span class="n">x2</span> <span class="o">=</span> <span class="mf">1.111</span>
</span><span id="hook_writer-1084"><a href="#hook_writer-1084"><span class="linenos">1084</span></a>    <span class="n">x3</span> <span class="o">=</span> <span class="mf">1.314</span>
</span><span id="hook_writer-1085"><a href="#hook_writer-1085"><span class="linenos">1085</span></a>    <span class="n">x4</span> <span class="o">=</span> <span class="mf">4.645</span>
</span><span id="hook_writer-1086"><a href="#hook_writer-1086"><span class="linenos">1086</span></a>    <span class="n">x5</span> <span class="o">=</span> <span class="mf">6.617</span>
</span><span id="hook_writer-1087"><a href="#hook_writer-1087"><span class="linenos">1087</span></a>    <span class="n">XX</span> <span class="o">=</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x3</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x5</span><span class="p">]</span>
</span><span id="hook_writer-1088"><a href="#hook_writer-1088"><span class="linenos">1088</span></a>    <span class="n">XX_str</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x1&#39;</span><span class="p">,</span> <span class="s1">&#39;x2&#39;</span><span class="p">,</span> <span class="s1">&#39;x3&#39;</span><span class="p">,</span> <span class="s1">&#39;x4&#39;</span><span class="p">,</span> <span class="s1">&#39;x5&#39;</span><span class="p">]</span>
</span><span id="hook_writer-1089"><a href="#hook_writer-1089"><span class="linenos">1089</span></a>    <span class="k">for</span> <span class="n">xx</span><span class="p">,</span> <span class="n">xx_str</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">XX</span><span class="p">,</span> <span class="n">XX_str</span><span class="p">):</span>
</span><span id="hook_writer-1090"><a href="#hook_writer-1090"><span class="linenos">1090</span></a>        <span class="n">ind_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">coors</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">xx</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="hook_writer-1091"><a href="#hook_writer-1091"><span class="linenos">1091</span></a>        <span class="n">theta_x</span> <span class="o">=</span> <span class="n">coors</span><span class="p">[</span><span class="n">ind_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="hook_writer-1092"><a href="#hook_writer-1092"><span class="linenos">1092</span></a>        <span class="n">sol_x</span> <span class="o">=</span> <span class="n">sol</span><span class="p">[</span><span class="n">ind_x</span><span class="p">]</span>
</span><span id="hook_writer-1093"><a href="#hook_writer-1093"><span class="linenos">1093</span></a>        <span class="n">ind_sort</span> <span class="o">=</span> <span class="n">theta_x</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
</span><span id="hook_writer-1094"><a href="#hook_writer-1094"><span class="linenos">1094</span></a>        <span class="n">theta_x</span> <span class="o">=</span> <span class="n">theta_x</span><span class="p">[</span><span class="n">ind_sort</span><span class="p">]</span>
</span><span id="hook_writer-1095"><a href="#hook_writer-1095"><span class="linenos">1095</span></a>        <span class="n">sol_x</span> <span class="o">=</span> <span class="n">sol_x</span><span class="p">[</span><span class="n">ind_sort</span><span class="p">]</span>
</span><span id="hook_writer-1096"><a href="#hook_writer-1096"><span class="linenos">1096</span></a>        
</span><span id="hook_writer-1097"><a href="#hook_writer-1097"><span class="linenos">1097</span></a>        <span class="k">if</span> <span class="n">no_iter</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="hook_writer-1098"><a href="#hook_writer-1098"><span class="linenos">1098</span></a>            <span class="n">res_x</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">ind_x</span><span class="p">]</span>
</span><span id="hook_writer-1099"><a href="#hook_writer-1099"><span class="linenos">1099</span></a>            <span class="n">res_x</span> <span class="o">=</span> <span class="n">res_x</span><span class="p">[</span><span class="n">ind_sort</span><span class="p">]</span>
</span><span id="hook_writer-1100"><a href="#hook_writer-1100"><span class="linenos">1100</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
</span><span id="hook_writer-1101"><a href="#hook_writer-1101"><span class="linenos">1101</span></a>                <span class="p">(</span><span class="n">theta_x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">sol_x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
</span><span id="hook_writer-1102"><a href="#hook_writer-1102"><span class="linenos">1102</span></a>                 <span class="n">res_x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="hook_writer-1103"><a href="#hook_writer-1103"><span class="linenos">1103</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="hook_writer-1104"><a href="#hook_writer-1104"><span class="linenos">1104</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">theta_x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
</span><span id="hook_writer-1105"><a href="#hook_writer-1105"><span class="linenos">1105</span></a>                                   <span class="n">sol_x</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="hook_writer-1106"><a href="#hook_writer-1106"><span class="linenos">1106</span></a>        <span class="n">data_dic</span><span class="p">[</span><span class="n">xx_str</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="hook_writer-1107"><a href="#hook_writer-1107"><span class="linenos">1107</span></a>    <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;iter\iter</span><span class="si">{}</span><span class="s1">.pkl&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">no_iter</span><span class="p">)</span>
</span><span id="hook_writer-1108"><a href="#hook_writer-1108"><span class="linenos">1108</span></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
</span><span id="hook_writer-1109"><a href="#hook_writer-1109"><span class="linenos">1109</span></a>        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data_dic</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="line_search">
                            <input id="line_search-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">line_search</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">solver</span>, </span><span class="param"><span class="n">delta</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="line_search-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#line_search"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="line_search-1113"><a href="#line_search-1113"><span class="linenos">1113</span></a><span class="k">def</span> <span class="nf">line_search</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
</span><span id="line_search-1114"><a href="#line_search-1114"><span class="linenos">1114</span></a><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="line_search-1115"><a href="#line_search-1115"><span class="linenos">1115</span></a><span class="sd">    WARNING -- EXPERIMENTAL!!</span>
</span><span id="line_search-1116"><a href="#line_search-1116"><span class="linenos">1116</span></a><span class="sd">    Find the real number w such that $u_{k+1} = w u^* + (1-w) u_{k}$ minimizes</span>
</span><span id="line_search-1117"><a href="#line_search-1117"><span class="linenos">1117</span></a><span class="sd">    the L² norm of the strong residual.</span>
</span><span id="line_search-1118"><a href="#line_search-1118"><span class="linenos">1118</span></a>
</span><span id="line_search-1119"><a href="#line_search-1119"><span class="linenos">1119</span></a><span class="sd">    Parameters</span>
</span><span id="line_search-1120"><a href="#line_search-1120"><span class="linenos">1120</span></a><span class="sd">    ----------</span>
</span><span id="line_search-1121"><a href="#line_search-1121"><span class="linenos">1121</span></a><span class="sd">    solver : `Solver` instance</span>
</span><span id="line_search-1122"><a href="#line_search-1122"><span class="linenos">1122</span></a><span class="sd">        The solver instance.</span>
</span><span id="line_search-1123"><a href="#line_search-1123"><span class="linenos">1123</span></a><span class="sd">    delta : ndarray</span>
</span><span id="line_search-1124"><a href="#line_search-1124"><span class="linenos">1124</span></a><span class="sd">        Local direction of descent $\delta u = u^* - u_k$.</span>
</span><span id="line_search-1125"><a href="#line_search-1125"><span class="linenos">1125</span></a>
</span><span id="line_search-1126"><a href="#line_search-1126"><span class="linenos">1126</span></a><span class="sd">    Returns</span>
</span><span id="line_search-1127"><a href="#line_search-1127"><span class="linenos">1127</span></a><span class="sd">    -------</span>
</span><span id="line_search-1128"><a href="#line_search-1128"><span class="linenos">1128</span></a><span class="sd">    float</span>
</span><span id="line_search-1129"><a href="#line_search-1129"><span class="linenos">1129</span></a><span class="sd">        The real number w resulting from the line-search algorithm.</span>
</span><span id="line_search-1130"><a href="#line_search-1130"><span class="linenos">1130</span></a>
</span><span id="line_search-1131"><a href="#line_search-1131"><span class="linenos">1131</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="line_search-1132"><a href="#line_search-1132"><span class="linenos">1132</span></a>
</span><span id="line_search-1133"><a href="#line_search-1133"><span class="linenos">1133</span></a>    <span class="k">def</span> <span class="nf">fun</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
</span><span id="line_search-1134"><a href="#line_search-1134"><span class="linenos">1134</span></a>        <span class="n">sol_w</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">solver</span><span class="o">.</span><span class="n">buffersols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="n">solver</span><span class="o">.</span><span class="n">oldsols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line_search-1135"><a href="#line_search-1135"><span class="linenos">1135</span></a>        <span class="n">str_res</span> <span class="o">=</span> <span class="n">strong_residual</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">sol_w</span><span class="p">)</span>
</span><span id="line_search-1136"><a href="#line_search-1136"><span class="linenos">1136</span></a>        <span class="n">G</span> <span class="o">=</span> <span class="n">vec_G</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">sol_w</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>
</span><span id="line_search-1137"><a href="#line_search-1137"><span class="linenos">1137</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">str_res</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span>
</span><span id="line_search-1138"><a href="#line_search-1138"><span class="linenos">1138</span></a>
</span><span id="line_search-1139"><a href="#line_search-1139"><span class="linenos">1139</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line_search-1140"><a href="#line_search-1140"><span class="linenos">1140</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="line_search-1141"><a href="#line_search-1141"><span class="linenos">1141</span></a>    <span class="n">fa</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</span><span id="line_search-1142"><a href="#line_search-1142"><span class="linenos">1142</span></a>    <span class="n">fb</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span id="line_search-1143"><a href="#line_search-1143"><span class="linenos">1143</span></a>    <span class="k">if</span> <span class="n">fa</span><span class="o">*</span><span class="n">fb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line_search-1144"><a href="#line_search-1144"><span class="linenos">1144</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">fb</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">fa</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fb</span> <span class="o">-</span> <span class="n">fa</span><span class="p">)</span>
</span><span id="line_search-1145"><a href="#line_search-1145"><span class="linenos">1145</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="line_search-1146"><a href="#line_search-1146"><span class="linenos">1146</span></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
</span><span id="line_search-1147"><a href="#line_search-1147"><span class="linenos">1147</span></a>            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">fb</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">fa</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fb</span> <span class="o">-</span> <span class="n">fa</span><span class="p">)</span>
</span><span id="line_search-1148"><a href="#line_search-1148"><span class="linenos">1148</span></a>            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1e-3</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">1e-3</span><span class="p">:</span>
</span><span id="line_search-1149"><a href="#line_search-1149"><span class="linenos">1149</span></a>                <span class="k">break</span>
</span><span id="line_search-1150"><a href="#line_search-1150"><span class="linenos">1150</span></a>            <span class="n">fc</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span id="line_search-1151"><a href="#line_search-1151"><span class="linenos">1151</span></a>            <span class="k">if</span> <span class="n">fc</span><span class="o">*</span><span class="n">fa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line_search-1152"><a href="#line_search-1152"><span class="linenos">1152</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="line_search-1153"><a href="#line_search-1153"><span class="linenos">1153</span></a>                <span class="n">fb</span> <span class="o">=</span> <span class="n">fc</span>
</span><span id="line_search-1154"><a href="#line_search-1154"><span class="linenos">1154</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="line_search-1155"><a href="#line_search-1155"><span class="linenos">1155</span></a>                <span class="n">a</span> <span class="o">=</span> <span class="n">c</span>
</span><span id="line_search-1156"><a href="#line_search-1156"><span class="linenos">1156</span></a>                <span class="n">fa</span> <span class="o">=</span> <span class="n">fc</span>
</span><span id="line_search-1157"><a href="#line_search-1157"><span class="linenos">1157</span></a>    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
</span><span id="line_search-1158"><a href="#line_search-1158"><span class="linenos">1158</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Line search result w = </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
</span><span id="line_search-1159"><a href="#line_search-1159"><span class="linenos">1159</span></a>    <span class="k">return</span> <span class="n">c</span>
</span></pre></div>


            <div class="docstring"><p>WARNING -- EXPERIMENTAL!!
Find the real number w such that $u_{k+1} = w u^* + (1-w) u_{k}$ minimizes
the L² norm of the strong residual.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>solver</strong> (<code><a href="#Solver">Solver</a></code> instance):
The solver instance.</li>
<li><strong>delta</strong> (ndarray):
Local direction of descent $\delta u = u^* - u_k$.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>float</strong>: The real number w resulting from the line-search algorithm.</li>
</ul>
</div>


                </section>
                <section id="set_mat_extra_arg">
                            <input id="set_mat_extra_arg-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_mat_extra_arg</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">wf</span>, </span><span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="n">keys</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">update</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="set_mat_extra_arg-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#set_mat_extra_arg"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="set_mat_extra_arg-1161"><a href="#set_mat_extra_arg-1161"><span class="linenos">1161</span></a><span class="k">def</span> <span class="nf">set_mat_extra_arg</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="set_mat_extra_arg-1162"><a href="#set_mat_extra_arg-1162"><span class="linenos">1162</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="set_mat_extra_arg-1163"><a href="#set_mat_extra_arg-1163"><span class="linenos">1163</span></a><span class="sd">    Utilitary function for setting material extra arg.</span>
</span><span id="set_mat_extra_arg-1164"><a href="#set_mat_extra_arg-1164"><span class="linenos">1164</span></a>
</span><span id="set_mat_extra_arg-1165"><a href="#set_mat_extra_arg-1165"><span class="linenos">1165</span></a><span class="sd">    Parameters</span>
</span><span id="set_mat_extra_arg-1166"><a href="#set_mat_extra_arg-1166"><span class="linenos">1166</span></a><span class="sd">    ----------</span>
</span><span id="set_mat_extra_arg-1167"><a href="#set_mat_extra_arg-1167"><span class="linenos">1167</span></a><span class="sd">    wf : `WeakForm` instance</span>
</span><span id="set_mat_extra_arg-1168"><a href="#set_mat_extra_arg-1168"><span class="linenos">1168</span></a><span class="sd">        Weak form containing the materials of interest.</span>
</span><span id="set_mat_extra_arg-1169"><a href="#set_mat_extra_arg-1169"><span class="linenos">1169</span></a><span class="sd">    arg : *any type*</span>
</span><span id="set_mat_extra_arg-1170"><a href="#set_mat_extra_arg-1170"><span class="linenos">1170</span></a><span class="sd">        Value of the argument to be set.</span>
</span><span id="set_mat_extra_arg-1171"><a href="#set_mat_extra_arg-1171"><span class="linenos">1171</span></a><span class="sd">    update : bool, optional</span>
</span><span id="set_mat_extra_arg-1172"><a href="#set_mat_extra_arg-1172"><span class="linenos">1172</span></a><span class="sd">        If True, the material data will be re-computed. Typically, it has to be</span>
</span><span id="set_mat_extra_arg-1173"><a href="#set_mat_extra_arg-1173"><span class="linenos">1173</span></a><span class="sd">        set to True when called after Sfepy&#39;s Problem instanciation.</span>
</span><span id="set_mat_extra_arg-1174"><a href="#set_mat_extra_arg-1174"><span class="linenos">1174</span></a><span class="sd">        The default is False.</span>
</span><span id="set_mat_extra_arg-1175"><a href="#set_mat_extra_arg-1175"><span class="linenos">1175</span></a>
</span><span id="set_mat_extra_arg-1176"><a href="#set_mat_extra_arg-1176"><span class="linenos">1176</span></a><span class="sd">    Returns</span>
</span><span id="set_mat_extra_arg-1177"><a href="#set_mat_extra_arg-1177"><span class="linenos">1177</span></a><span class="sd">    -------</span>
</span><span id="set_mat_extra_arg-1178"><a href="#set_mat_extra_arg-1178"><span class="linenos">1178</span></a><span class="sd">    None.</span>
</span><span id="set_mat_extra_arg-1179"><a href="#set_mat_extra_arg-1179"><span class="linenos">1179</span></a>
</span><span id="set_mat_extra_arg-1180"><a href="#set_mat_extra_arg-1180"><span class="linenos">1180</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="set_mat_extra_arg-1181"><a href="#set_mat_extra_arg-1181"><span class="linenos">1181</span></a>
</span><span id="set_mat_extra_arg-1182"><a href="#set_mat_extra_arg-1182"><span class="linenos">1182</span></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="set_mat_extra_arg-1183"><a href="#set_mat_extra_arg-1183"><span class="linenos">1183</span></a>        <span class="k">assert</span> <span class="n">keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span><span id="set_mat_extra_arg-1184"><a href="#set_mat_extra_arg-1184"><span class="linenos">1184</span></a>        <span class="n">args_dic</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
</span><span id="set_mat_extra_arg-1185"><a href="#set_mat_extra_arg-1185"><span class="linenos">1185</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="set_mat_extra_arg-1186"><a href="#set_mat_extra_arg-1186"><span class="linenos">1186</span></a>        <span class="n">arg</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="set_mat_extra_arg-1187"><a href="#set_mat_extra_arg-1187"><span class="linenos">1187</span></a>
</span><span id="set_mat_extra_arg-1188"><a href="#set_mat_extra_arg-1188"><span class="linenos">1188</span></a>    <span class="k">for</span> <span class="n">mat</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">eqn</span><span class="o">.</span><span class="n">collect_materials</span><span class="p">(),</span> <span class="n">wf</span><span class="o">.</span><span class="n">terms</span><span class="p">):</span>
</span><span id="set_mat_extra_arg-1189"><a href="#set_mat_extra_arg-1189"><span class="linenos">1189</span></a>        <span class="n">modified</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="set_mat_extra_arg-1190"><a href="#set_mat_extra_arg-1190"><span class="linenos">1190</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="s1">&#39;extra_args&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mat</span><span class="o">.</span><span class="n">extra_args</span> <span class="o">!=</span> <span class="p">{}:</span>
</span><span id="set_mat_extra_arg-1191"><a href="#set_mat_extra_arg-1191"><span class="linenos">1191</span></a>            <span class="n">extra_args</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">extra_args</span> <span class="c1"># fetch material&#39;s extra-args dict</span>
</span><span id="set_mat_extra_arg-1192"><a href="#set_mat_extra_arg-1192"><span class="linenos">1192</span></a>            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">extra_args</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
</span><span id="set_mat_extra_arg-1193"><a href="#set_mat_extra_arg-1193"><span class="linenos">1193</span></a>                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Solver</span><span class="o">.</span><span class="n">forbidden_nl_arg</span><span class="p">:</span>
</span><span id="set_mat_extra_arg-1194"><a href="#set_mat_extra_arg-1194"><span class="linenos">1194</span></a>                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
</span><span id="set_mat_extra_arg-1195"><a href="#set_mat_extra_arg-1195"><span class="linenos">1195</span></a>                        <span class="n">extra_args</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">arg</span>
</span><span id="set_mat_extra_arg-1196"><a href="#set_mat_extra_arg-1196"><span class="linenos">1196</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="set_mat_extra_arg-1197"><a href="#set_mat_extra_arg-1197"><span class="linenos">1197</span></a>                        <span class="n">extra_args</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">args_dic</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="set_mat_extra_arg-1198"><a href="#set_mat_extra_arg-1198"><span class="linenos">1198</span></a>                    <span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="set_mat_extra_arg-1199"><a href="#set_mat_extra_arg-1199"><span class="linenos">1199</span></a>            <span class="n">mat</span><span class="o">.</span><span class="n">set_extra_args</span><span class="p">(</span><span class="o">**</span><span class="n">extra_args</span><span class="p">)</span> <span class="c1"># reset material&#39;s extra-args</span>
</span><span id="set_mat_extra_arg-1200"><a href="#set_mat_extra_arg-1200"><span class="linenos">1200</span></a>
</span><span id="set_mat_extra_arg-1201"><a href="#set_mat_extra_arg-1201"><span class="linenos">1201</span></a>            <span class="c1"># recompute material&#39;s data with its new extra-arg</span>
</span><span id="set_mat_extra_arg-1202"><a href="#set_mat_extra_arg-1202"><span class="linenos">1202</span></a>            <span class="k">if</span> <span class="n">update</span> <span class="ow">and</span> <span class="n">modified</span><span class="p">:</span>
</span><span id="set_mat_extra_arg-1203"><a href="#set_mat_extra_arg-1203"><span class="linenos">1203</span></a>                <span class="n">update_material</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">integral</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Utilitary function for setting material extra arg.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>wf</strong> (<code>WeakForm</code> instance):
Weak form containing the materials of interest.</li>
<li><strong>arg</strong> (<em>any type</em>):
Value of the argument to be set.</li>
<li><strong>update</strong> (bool, optional):
If True, the material data will be re-computed. Typically, it has to be
set to True when called after Sfepy's Problem instanciation.
The default is False.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None.</strong></li>
</ul>
</div>


                </section>
                <section id="evaluate_at_qps">
                            <input id="evaluate_at_qps-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">evaluate_at_qps</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">wf</span>, </span><span class="param"><span class="n">sol</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="evaluate_at_qps-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#evaluate_at_qps"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="evaluate_at_qps-1206"><a href="#evaluate_at_qps-1206"><span class="linenos">1206</span></a><span class="k">def</span> <span class="nf">evaluate_at_qps</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">sol</span><span class="p">):</span>
</span><span id="evaluate_at_qps-1207"><a href="#evaluate_at_qps-1207"><span class="linenos">1207</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="evaluate_at_qps-1208"><a href="#evaluate_at_qps-1208"><span class="linenos">1208</span></a><span class="sd">    Compute an extrapolation of the solution at the domain&#39;s quadrature points.</span>
</span><span id="evaluate_at_qps-1209"><a href="#evaluate_at_qps-1209"><span class="linenos">1209</span></a>
</span><span id="evaluate_at_qps-1210"><a href="#evaluate_at_qps-1210"><span class="linenos">1210</span></a><span class="sd">    Parameters</span>
</span><span id="evaluate_at_qps-1211"><a href="#evaluate_at_qps-1211"><span class="linenos">1211</span></a><span class="sd">    ----------</span>
</span><span id="evaluate_at_qps-1212"><a href="#evaluate_at_qps-1212"><span class="linenos">1212</span></a><span class="sd">    wf : `WeakForm` instance</span>
</span><span id="evaluate_at_qps-1213"><a href="#evaluate_at_qps-1213"><span class="linenos">1213</span></a><span class="sd">        Weak form associated with the solution field `sol`.</span>
</span><span id="evaluate_at_qps-1214"><a href="#evaluate_at_qps-1214"><span class="linenos">1214</span></a><span class="sd">    sol : ndarray</span>
</span><span id="evaluate_at_qps-1215"><a href="#evaluate_at_qps-1215"><span class="linenos">1215</span></a><span class="sd">        1D array containing the solution at DOFs.</span>
</span><span id="evaluate_at_qps-1216"><a href="#evaluate_at_qps-1216"><span class="linenos">1216</span></a>
</span><span id="evaluate_at_qps-1217"><a href="#evaluate_at_qps-1217"><span class="linenos">1217</span></a><span class="sd">    Returns</span>
</span><span id="evaluate_at_qps-1218"><a href="#evaluate_at_qps-1218"><span class="linenos">1218</span></a><span class="sd">    -------</span>
</span><span id="evaluate_at_qps-1219"><a href="#evaluate_at_qps-1219"><span class="linenos">1219</span></a><span class="sd">    sol_qps : ndarray</span>
</span><span id="evaluate_at_qps-1220"><a href="#evaluate_at_qps-1220"><span class="linenos">1220</span></a><span class="sd">        1D array containing the values of the solution field at quadrature</span>
</span><span id="evaluate_at_qps-1221"><a href="#evaluate_at_qps-1221"><span class="linenos">1221</span></a><span class="sd">        points.</span>
</span><span id="evaluate_at_qps-1222"><a href="#evaluate_at_qps-1222"><span class="linenos">1222</span></a>
</span><span id="evaluate_at_qps-1223"><a href="#evaluate_at_qps-1223"><span class="linenos">1223</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="evaluate_at_qps-1224"><a href="#evaluate_at_qps-1224"><span class="linenos">1224</span></a>    <span class="n">qps</span> <span class="o">=</span> <span class="n">get_physical_qps</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">omega</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">integral</span><span class="p">)</span>
</span><span id="evaluate_at_qps-1225"><a href="#evaluate_at_qps-1225"><span class="linenos">1225</span></a>    <span class="n">sol_qps</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">evaluate_at</span><span class="p">(</span><span class="n">qps</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">sol</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="evaluate_at_qps-1226"><a href="#evaluate_at_qps-1226"><span class="linenos">1226</span></a>    <span class="k">return</span> <span class="n">sol_qps</span>
</span></pre></div>


            <div class="docstring"><p>Compute an extrapolation of the solution at the domain's quadrature points.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>wf</strong> (<code>WeakForm</code> instance):
Weak form associated with the solution field <code>sol</code>.</li>
<li><strong>sol</strong> (ndarray):
1D array containing the solution at DOFs.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>sol_qps</strong> (ndarray):
1D array containing the values of the solution field at quadrature
points.</li>
</ul>
</div>


                </section>
                <section id="update_neumann">
                            <input id="update_neumann-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_neumann</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">wf</span>, </span><span class="param"><span class="n">gamma</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="update_neumann-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#update_neumann"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="update_neumann-1228"><a href="#update_neumann-1228"><span class="linenos">1228</span></a><span class="k">def</span> <span class="nf">update_neumann</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
</span><span id="update_neumann-1229"><a href="#update_neumann-1229"><span class="linenos">1229</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="update_neumann-1230"><a href="#update_neumann-1230"><span class="linenos">1230</span></a><span class="sd">    Utility function for updating the Neumann boundary condition term on the</span>
</span><span id="update_neumann-1231"><a href="#update_neumann-1231"><span class="linenos">1231</span></a><span class="sd">    exterior domain. Note that the neumann material function should take the</span>
</span><span id="update_neumann-1232"><a href="#update_neumann-1232"><span class="linenos">1232</span></a><span class="sd">    solver instance as one of its extra-arguments in order to be able to</span>
</span><span id="update_neumann-1233"><a href="#update_neumann-1233"><span class="linenos">1233</span></a><span class="sd">    actually compute the flux of the solution across the interior domain</span>
</span><span id="update_neumann-1234"><a href="#update_neumann-1234"><span class="linenos">1234</span></a><span class="sd">    boundary. This function is only called when dealing with unbounded problems</span>
</span><span id="update_neumann-1235"><a href="#update_neumann-1235"><span class="linenos">1235</span></a><span class="sd">    with `conn` set to &#39;ping-pong&#39;.</span>
</span><span id="update_neumann-1236"><a href="#update_neumann-1236"><span class="linenos">1236</span></a>
</span><span id="update_neumann-1237"><a href="#update_neumann-1237"><span class="linenos">1237</span></a><span class="sd">    Parameters</span>
</span><span id="update_neumann-1238"><a href="#update_neumann-1238"><span class="linenos">1238</span></a><span class="sd">    ----------</span>
</span><span id="update_neumann-1239"><a href="#update_neumann-1239"><span class="linenos">1239</span></a><span class="sd">    wf : `WeakForm` instance</span>
</span><span id="update_neumann-1240"><a href="#update_neumann-1240"><span class="linenos">1240</span></a><span class="sd">        Weak form whose Neumann boundary condition term is updated.</span>
</span><span id="update_neumann-1241"><a href="#update_neumann-1241"><span class="linenos">1241</span></a><span class="sd">    gamma : `Region` instance</span>
</span><span id="update_neumann-1242"><a href="#update_neumann-1242"><span class="linenos">1242</span></a><span class="sd">        Sub region of dimension D-1 on which the Neumann term is defined.</span>
</span><span id="update_neumann-1243"><a href="#update_neumann-1243"><span class="linenos">1243</span></a>
</span><span id="update_neumann-1244"><a href="#update_neumann-1244"><span class="linenos">1244</span></a><span class="sd">    Returns</span>
</span><span id="update_neumann-1245"><a href="#update_neumann-1245"><span class="linenos">1245</span></a><span class="sd">    -------</span>
</span><span id="update_neumann-1246"><a href="#update_neumann-1246"><span class="linenos">1246</span></a><span class="sd">    None.</span>
</span><span id="update_neumann-1247"><a href="#update_neumann-1247"><span class="linenos">1247</span></a>
</span><span id="update_neumann-1248"><a href="#update_neumann-1248"><span class="linenos">1248</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="update_neumann-1249"><a href="#update_neumann-1249"><span class="linenos">1249</span></a>    <span class="n">term_idx</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="update_neumann-1250"><a href="#update_neumann-1250"><span class="linenos">1250</span></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">terms</span><span class="p">):</span>
</span><span id="update_neumann-1251"><a href="#update_neumann-1251"><span class="linenos">1251</span></a>        <span class="c1"># check if term is the neumann term</span>
</span><span id="update_neumann-1252"><a href="#update_neumann-1252"><span class="linenos">1252</span></a>        <span class="k">if</span> <span class="n">term</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;dw_surface_integrate&#39;</span> <span class="ow">and</span> <span class="n">term</span><span class="o">.</span><span class="n">region</span><span class="o">==</span><span class="n">gamma</span><span class="p">:</span>
</span><span id="update_neumann-1253"><a href="#update_neumann-1253"><span class="linenos">1253</span></a>            <span class="n">term_idx</span> <span class="o">=</span> <span class="n">k</span>
</span><span id="update_neumann-1254"><a href="#update_neumann-1254"><span class="linenos">1254</span></a>            <span class="k">break</span>
</span><span id="update_neumann-1255"><a href="#update_neumann-1255"><span class="linenos">1255</span></a>    <span class="c1"># get neumann term and update its material</span>
</span><span id="update_neumann-1256"><a href="#update_neumann-1256"><span class="linenos">1256</span></a>    <span class="n">mat_neumann</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">eqn</span><span class="o">.</span><span class="n">collect_materials</span><span class="p">()[</span><span class="n">term_idx</span><span class="p">]</span>
</span><span id="update_neumann-1257"><a href="#update_neumann-1257"><span class="linenos">1257</span></a>    <span class="n">update_material</span><span class="p">(</span><span class="n">mat_neumann</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">wf</span><span class="o">.</span><span class="n">integral</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Utility function for updating the Neumann boundary condition term on the
exterior domain. Note that the neumann material function should take the
solver instance as one of its extra-arguments in order to be able to
actually compute the flux of the solution across the interior domain
boundary. This function is only called when dealing with unbounded problems
with <code>conn</code> set to 'ping-pong'.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>wf</strong> (<code>WeakForm</code> instance):
Weak form whose Neumann boundary condition term is updated.</li>
<li><strong>gamma</strong> (<code>Region</code> instance):
Sub region of dimension D-1 on which the Neumann term is defined.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None.</strong></li>
</ul>
</div>


                </section>
                <section id="update_material">
                            <input id="update_material-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_material</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">mat</span>, </span><span class="param"><span class="n">region</span>, </span><span class="param"><span class="n">integral</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="update_material-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#update_material"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="update_material-1260"><a href="#update_material-1260"><span class="linenos">1260</span></a><span class="k">def</span> <span class="nf">update_material</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">region</span><span class="p">,</span> <span class="n">integral</span><span class="p">):</span>
</span><span id="update_material-1261"><a href="#update_material-1261"><span class="linenos">1261</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="update_material-1262"><a href="#update_material-1262"><span class="linenos">1262</span></a><span class="sd">    Utility function for updating a material&#39;s data at the region quadrature</span>
</span><span id="update_material-1263"><a href="#update_material-1263"><span class="linenos">1263</span></a><span class="sd">    points.</span>
</span><span id="update_material-1264"><a href="#update_material-1264"><span class="linenos">1264</span></a>
</span><span id="update_material-1265"><a href="#update_material-1265"><span class="linenos">1265</span></a><span class="sd">    Parameters</span>
</span><span id="update_material-1266"><a href="#update_material-1266"><span class="linenos">1266</span></a><span class="sd">    ----------</span>
</span><span id="update_material-1267"><a href="#update_material-1267"><span class="linenos">1267</span></a><span class="sd">    mat : `Material` instance</span>
</span><span id="update_material-1268"><a href="#update_material-1268"><span class="linenos">1268</span></a><span class="sd">        The material to be updated.</span>
</span><span id="update_material-1269"><a href="#update_material-1269"><span class="linenos">1269</span></a><span class="sd">    region : `Region` instance</span>
</span><span id="update_material-1270"><a href="#update_material-1270"><span class="linenos">1270</span></a><span class="sd">        Region over which the material is defined.</span>
</span><span id="update_material-1271"><a href="#update_material-1271"><span class="linenos">1271</span></a><span class="sd">    integral : `Integral` instance</span>
</span><span id="update_material-1272"><a href="#update_material-1272"><span class="linenos">1272</span></a><span class="sd">        Sfepy&#39;s Integral class instance (wrapper class around quadratures).</span>
</span><span id="update_material-1273"><a href="#update_material-1273"><span class="linenos">1273</span></a>
</span><span id="update_material-1274"><a href="#update_material-1274"><span class="linenos">1274</span></a><span class="sd">    Returns</span>
</span><span id="update_material-1275"><a href="#update_material-1275"><span class="linenos">1275</span></a><span class="sd">    -------</span>
</span><span id="update_material-1276"><a href="#update_material-1276"><span class="linenos">1276</span></a><span class="sd">    None.</span>
</span><span id="update_material-1277"><a href="#update_material-1277"><span class="linenos">1277</span></a>
</span><span id="update_material-1278"><a href="#update_material-1278"><span class="linenos">1278</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="update_material-1279"><a href="#update_material-1279"><span class="linenos">1279</span></a>    <span class="kn">from</span> <span class="nn">sfepy.solvers.ts</span> <span class="kn">import</span> <span class="n">TimeStepper</span>
</span><span id="update_material-1280"><a href="#update_material-1280"><span class="linenos">1280</span></a>    <span class="n">dummy_ts</span> <span class="o">=</span> <span class="n">TimeStepper</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="c1"># ficticious time-stepper</span>
</span><span id="update_material-1281"><a href="#update_material-1281"><span class="linenos">1281</span></a>    <span class="n">qps</span> <span class="o">=</span> <span class="n">get_physical_qps</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">integral</span><span class="p">)</span>
</span><span id="update_material-1282"><a href="#update_material-1282"><span class="linenos">1282</span></a>    <span class="n">coors</span> <span class="o">=</span> <span class="n">qps</span><span class="o">.</span><span class="n">values</span>
</span><span id="update_material-1283"><a href="#update_material-1283"><span class="linenos">1283</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">dummy_ts</span><span class="p">,</span> <span class="n">coors</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;qp&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">mat</span><span class="o">.</span><span class="n">extra_args</span><span class="p">)</span>
</span><span id="update_material-1284"><a href="#update_material-1284"><span class="linenos">1284</span></a>    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">region</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">integral</span><span class="o">.</span><span class="n">order</span><span class="p">)</span>
</span><span id="update_material-1285"><a href="#update_material-1285"><span class="linenos">1285</span></a>    <span class="n">mat</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">qps</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Utility function for updating a material's data at the region quadrature
points.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>mat</strong> (<code>Material</code> instance):
The material to be updated.</li>
<li><strong>region</strong> (<code>Region</code> instance):
Region over which the material is defined.</li>
<li><strong>integral</strong> (<code>Integral</code> instance):
Sfepy's Integral class instance (wrapper class around quadratures).</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None.</strong></li>
</ul>
</div>


                </section>
                <section id="update_material_all">
                            <input id="update_material_all-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_material_all</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">wf</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="update_material_all-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#update_material_all"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="update_material_all-1288"><a href="#update_material_all-1288"><span class="linenos">1288</span></a><span class="k">def</span> <span class="nf">update_material_all</span><span class="p">(</span><span class="n">wf</span><span class="p">):</span>
</span><span id="update_material_all-1289"><a href="#update_material_all-1289"><span class="linenos">1289</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="update_material_all-1290"><a href="#update_material_all-1290"><span class="linenos">1290</span></a><span class="sd">    Utility function for updating all materials&#39; data of a given weak form.</span>
</span><span id="update_material_all-1291"><a href="#update_material_all-1291"><span class="linenos">1291</span></a>
</span><span id="update_material_all-1292"><a href="#update_material_all-1292"><span class="linenos">1292</span></a><span class="sd">    Parameters</span>
</span><span id="update_material_all-1293"><a href="#update_material_all-1293"><span class="linenos">1293</span></a><span class="sd">    ----------</span>
</span><span id="update_material_all-1294"><a href="#update_material_all-1294"><span class="linenos">1294</span></a><span class="sd">    wf : `WeakForm` instance</span>
</span><span id="update_material_all-1295"><a href="#update_material_all-1295"><span class="linenos">1295</span></a><span class="sd">        Weak form whose materials&#39; data are updated.</span>
</span><span id="update_material_all-1296"><a href="#update_material_all-1296"><span class="linenos">1296</span></a>
</span><span id="update_material_all-1297"><a href="#update_material_all-1297"><span class="linenos">1297</span></a><span class="sd">    Returns</span>
</span><span id="update_material_all-1298"><a href="#update_material_all-1298"><span class="linenos">1298</span></a><span class="sd">    -------</span>
</span><span id="update_material_all-1299"><a href="#update_material_all-1299"><span class="linenos">1299</span></a><span class="sd">    None.</span>
</span><span id="update_material_all-1300"><a href="#update_material_all-1300"><span class="linenos">1300</span></a>
</span><span id="update_material_all-1301"><a href="#update_material_all-1301"><span class="linenos">1301</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="update_material_all-1302"><a href="#update_material_all-1302"><span class="linenos">1302</span></a>    <span class="k">for</span> <span class="n">mat</span><span class="p">,</span> <span class="n">term</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">eqn</span><span class="o">.</span><span class="n">collect_materials</span><span class="p">(),</span> <span class="n">wf</span><span class="o">.</span><span class="n">terms</span><span class="p">):</span>
</span><span id="update_material_all-1303"><a href="#update_material_all-1303"><span class="linenos">1303</span></a>        <span class="n">update_material</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">region</span><span class="p">,</span> <span class="n">term</span><span class="o">.</span><span class="n">integral</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Utility function for updating all materials' data of a given weak form.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>wf</strong> (<code>WeakForm</code> instance):
Weak form whose materials' data are updated.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None.</strong></li>
</ul>
</div>


                </section>
                <section id="reset_dirichlet">
                            <input id="reset_dirichlet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reset_dirichlet</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">data</span>, </span><span class="param"><span class="n">wf1</span>, </span><span class="param"><span class="n">wf2</span>, </span><span class="param"><span class="n">cogammas</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="reset_dirichlet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#reset_dirichlet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="reset_dirichlet-1306"><a href="#reset_dirichlet-1306"><span class="linenos">1306</span></a><span class="k">def</span> <span class="nf">reset_dirichlet</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">wf1</span><span class="p">,</span> <span class="n">wf2</span><span class="p">,</span> <span class="n">cogammas</span><span class="p">):</span>
</span><span id="reset_dirichlet-1307"><a href="#reset_dirichlet-1307"><span class="linenos">1307</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="reset_dirichlet-1308"><a href="#reset_dirichlet-1308"><span class="linenos">1308</span></a><span class="sd">    Utility function for setting new Dirichlet boundary condition on the outer</span>
</span><span id="reset_dirichlet-1309"><a href="#reset_dirichlet-1309"><span class="linenos">1309</span></a><span class="sd">    boundary of the interior domain. This function is only called when dealing</span>
</span><span id="reset_dirichlet-1310"><a href="#reset_dirichlet-1310"><span class="linenos">1310</span></a><span class="sd">    with unbounded problems with `conn` set to &#39;ping-pong&#39;.</span>
</span><span id="reset_dirichlet-1311"><a href="#reset_dirichlet-1311"><span class="linenos">1311</span></a>
</span><span id="reset_dirichlet-1312"><a href="#reset_dirichlet-1312"><span class="linenos">1312</span></a><span class="sd">    Parameters</span>
</span><span id="reset_dirichlet-1313"><a href="#reset_dirichlet-1313"><span class="linenos">1313</span></a><span class="sd">    ----------</span>
</span><span id="reset_dirichlet-1314"><a href="#reset_dirichlet-1314"><span class="linenos">1314</span></a><span class="sd">    data : ndarray</span>
</span><span id="reset_dirichlet-1315"><a href="#reset_dirichlet-1315"><span class="linenos">1315</span></a><span class="sd">        1D numpy array containing the solution field at the exterior domain</span>
</span><span id="reset_dirichlet-1316"><a href="#reset_dirichlet-1316"><span class="linenos">1316</span></a><span class="sd">        DOFs.</span>
</span><span id="reset_dirichlet-1317"><a href="#reset_dirichlet-1317"><span class="linenos">1317</span></a><span class="sd">    wf1 : `WeakForm` instance</span>
</span><span id="reset_dirichlet-1318"><a href="#reset_dirichlet-1318"><span class="linenos">1318</span></a><span class="sd">        Weak form associated with the interior domain.</span>
</span><span id="reset_dirichlet-1319"><a href="#reset_dirichlet-1319"><span class="linenos">1319</span></a><span class="sd">    wf2 : `WeakForm` instance</span>
</span><span id="reset_dirichlet-1320"><a href="#reset_dirichlet-1320"><span class="linenos">1320</span></a><span class="sd">        Weak form associated with the exterior domain.</span>
</span><span id="reset_dirichlet-1321"><a href="#reset_dirichlet-1321"><span class="linenos">1321</span></a><span class="sd">    cogammas : list</span>
</span><span id="reset_dirichlet-1322"><a href="#reset_dirichlet-1322"><span class="linenos">1322</span></a><span class="sd">        List of two `sfepy.discrete.common.region.Region` instances</span>
</span><span id="reset_dirichlet-1323"><a href="#reset_dirichlet-1323"><span class="linenos">1323</span></a><span class="sd">        corresponding to the interior and exterior domain common frontier.</span>
</span><span id="reset_dirichlet-1324"><a href="#reset_dirichlet-1324"><span class="linenos">1324</span></a>
</span><span id="reset_dirichlet-1325"><a href="#reset_dirichlet-1325"><span class="linenos">1325</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="reset_dirichlet-1326"><a href="#reset_dirichlet-1326"><span class="linenos">1326</span></a>
</span><span id="reset_dirichlet-1327"><a href="#reset_dirichlet-1327"><span class="linenos">1327</span></a>    <span class="k">def</span> <span class="nf">dbc</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">coor</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="reset_dirichlet-1328"><a href="#reset_dirichlet-1328"><span class="linenos">1328</span></a>        <span class="k">return</span> <span class="n">wf2</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">evaluate_at</span><span class="p">(</span><span class="n">coor</span><span class="p">,</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
</span><span id="reset_dirichlet-1329"><a href="#reset_dirichlet-1329"><span class="linenos">1329</span></a>
</span><span id="reset_dirichlet-1330"><a href="#reset_dirichlet-1330"><span class="linenos">1330</span></a>    <span class="n">d_func</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="s1">&#39;d_func&#39;</span><span class="p">,</span> <span class="n">dbc</span><span class="p">)</span>
</span><span id="reset_dirichlet-1331"><a href="#reset_dirichlet-1331"><span class="linenos">1331</span></a>    <span class="n">new_ebc</span> <span class="o">=</span> <span class="n">EssentialBC</span><span class="p">(</span><span class="s1">&#39;dbc_pp&#39;</span><span class="p">,</span> <span class="n">cogammas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="reset_dirichlet-1332"><a href="#reset_dirichlet-1332"><span class="linenos">1332</span></a>                          <span class="p">{</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.all&#39;</span> <span class="o">%</span><span class="n">wf1</span><span class="o">.</span><span class="n">unknown_name</span> <span class="p">:</span> <span class="n">d_func</span><span class="p">})</span>
</span><span id="reset_dirichlet-1333"><a href="#reset_dirichlet-1333"><span class="linenos">1333</span></a>
</span><span id="reset_dirichlet-1334"><a href="#reset_dirichlet-1334"><span class="linenos">1334</span></a>    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ebc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">):</span>
</span><span id="reset_dirichlet-1335"><a href="#reset_dirichlet-1335"><span class="linenos">1335</span></a>        <span class="k">if</span> <span class="n">ebc</span><span class="o">.</span><span class="n">region</span> <span class="o">==</span> <span class="n">cogammas</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="reset_dirichlet-1336"><a href="#reset_dirichlet-1336"><span class="linenos">1336</span></a>            <span class="n">wf1</span><span class="o">.</span><span class="n">ebcs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ebc</span>
</span><span id="reset_dirichlet-1337"><a href="#reset_dirichlet-1337"><span class="linenos">1337</span></a>            <span class="k">break</span>
</span></pre></div>


            <div class="docstring"><p>Utility function for setting new Dirichlet boundary condition on the outer
boundary of the interior domain. This function is only called when dealing
with unbounded problems with <code>conn</code> set to 'ping-pong'.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>data</strong> (ndarray):
1D numpy array containing the solution field at the exterior domain
DOFs.</li>
<li><strong>wf1</strong> (<code>WeakForm</code> instance):
Weak form associated with the interior domain.</li>
<li><strong>wf2</strong> (<code>WeakForm</code> instance):
Weak form associated with the exterior domain.</li>
<li><strong>cogammas</strong> (list):
List of two <code>sfepy.discrete.common.region.Region</code> instances
corresponding to the interior and exterior domain common frontier.</li>
</ul>
</div>


                </section>
                <section id="strong_residual">
                            <input id="strong_residual-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">strong_residual</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">solver</span>, </span><span class="param"><span class="n">sol_w</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="strong_residual-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#strong_residual"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="strong_residual-1340"><a href="#strong_residual-1340"><span class="linenos">1340</span></a><span class="k">def</span> <span class="nf">strong_residual</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">sol_w</span><span class="p">):</span>
</span><span id="strong_residual-1341"><a href="#strong_residual-1341"><span class="linenos">1341</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="strong_residual-1342"><a href="#strong_residual-1342"><span class="linenos">1342</span></a><span class="sd">    Compute the strong residual (for nonlinear problems only). Note that the</span>
</span><span id="strong_residual-1343"><a href="#strong_residual-1343"><span class="linenos">1343</span></a><span class="sd">    strong residual might be evaluated on both the interior and exterior</span>
</span><span id="strong_residual-1344"><a href="#strong_residual-1344"><span class="linenos">1344</span></a><span class="sd">    if two nonlinear WeakForms instances are provided at the creation of</span>
</span><span id="strong_residual-1345"><a href="#strong_residual-1345"><span class="linenos">1345</span></a><span class="sd">    `solver` (unbounded problems only).</span>
</span><span id="strong_residual-1346"><a href="#strong_residual-1346"><span class="linenos">1346</span></a>
</span><span id="strong_residual-1347"><a href="#strong_residual-1347"><span class="linenos">1347</span></a><span class="sd">    Parameters</span>
</span><span id="strong_residual-1348"><a href="#strong_residual-1348"><span class="linenos">1348</span></a><span class="sd">    ----------</span>
</span><span id="strong_residual-1349"><a href="#strong_residual-1349"><span class="linenos">1349</span></a><span class="sd">    solver : `Solver` instance</span>
</span><span id="strong_residual-1350"><a href="#strong_residual-1350"><span class="linenos">1350</span></a><span class="sd">        The solver instance.</span>
</span><span id="strong_residual-1351"><a href="#strong_residual-1351"><span class="linenos">1351</span></a><span class="sd">    sol_w : array</span>
</span><span id="strong_residual-1352"><a href="#strong_residual-1352"><span class="linenos">1352</span></a><span class="sd">        Current solution (vector).</span>
</span><span id="strong_residual-1353"><a href="#strong_residual-1353"><span class="linenos">1353</span></a>
</span><span id="strong_residual-1354"><a href="#strong_residual-1354"><span class="linenos">1354</span></a><span class="sd">    Returns</span>
</span><span id="strong_residual-1355"><a href="#strong_residual-1355"><span class="linenos">1355</span></a><span class="sd">    -------</span>
</span><span id="strong_residual-1356"><a href="#strong_residual-1356"><span class="linenos">1356</span></a><span class="sd">    res_vec : ndarray</span>
</span><span id="strong_residual-1357"><a href="#strong_residual-1357"><span class="linenos">1357</span></a><span class="sd">        Residual vector.</span>
</span><span id="strong_residual-1358"><a href="#strong_residual-1358"><span class="linenos">1358</span></a>
</span><span id="strong_residual-1359"><a href="#strong_residual-1359"><span class="linenos">1359</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="strong_residual-1360"><a href="#strong_residual-1360"><span class="linenos">1360</span></a>
</span><span id="strong_residual-1361"><a href="#strong_residual-1361"><span class="linenos">1361</span></a>    <span class="c1"># Fetch solution vector and matrix &amp; rhs associated with the residual</span>
</span><span id="strong_residual-1362"><a href="#strong_residual-1362"><span class="linenos">1362</span></a>    <span class="n">wf_res</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">wfs_dic</span><span class="p">[</span><span class="s1">&#39;wf_res&#39;</span><span class="p">]</span>
</span><span id="strong_residual-1363"><a href="#strong_residual-1363"><span class="linenos">1363</span></a>    <span class="n">cg</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">cogammas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;cogammas&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="strong_residual-1364"><a href="#strong_residual-1364"><span class="linenos">1364</span></a>    <span class="n">idx_bc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">get_ebc_dofs</span><span class="p">(</span><span class="n">wf_res</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">cg</span><span class="p">))</span>
</span><span id="strong_residual-1365"><a href="#strong_residual-1365"><span class="linenos">1365</span></a>    <span class="n">mtx_res</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_res&#39;</span><span class="p">]</span>
</span><span id="strong_residual-1366"><a href="#strong_residual-1366"><span class="linenos">1366</span></a>    <span class="n">rhs_res</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_res&#39;</span><span class="p">]</span>
</span><span id="strong_residual-1367"><a href="#strong_residual-1367"><span class="linenos">1367</span></a>    
</span><span id="strong_residual-1368"><a href="#strong_residual-1368"><span class="linenos">1368</span></a>    <span class="c1"># Set coeff associated with EBC to zero</span>
</span><span id="strong_residual-1369"><a href="#strong_residual-1369"><span class="linenos">1369</span></a>    <span class="c1"># mtx_res[idx_bc, :] = 0.0</span>
</span><span id="strong_residual-1370"><a href="#strong_residual-1370"><span class="linenos">1370</span></a>    <span class="c1"># mtx_res[:, idx_bc] = 0.0</span>
</span><span id="strong_residual-1371"><a href="#strong_residual-1371"><span class="linenos">1371</span></a>    <span class="c1"># rhs_res[idx_bc] = 0.0</span>
</span><span id="strong_residual-1372"><a href="#strong_residual-1372"><span class="linenos">1372</span></a>    
</span><span id="strong_residual-1373"><a href="#strong_residual-1373"><span class="linenos">1373</span></a>    <span class="c1"># Evaluate the residual vector</span>
</span><span id="strong_residual-1374"><a href="#strong_residual-1374"><span class="linenos">1374</span></a>    <span class="n">Ax</span> <span class="o">=</span> <span class="n">mtx_res</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sol_w</span><span class="p">)</span>
</span><span id="strong_residual-1375"><a href="#strong_residual-1375"><span class="linenos">1375</span></a>    <span class="n">res_vec</span> <span class="o">=</span> <span class="n">Ax</span> <span class="o">-</span> <span class="n">rhs_res</span>
</span><span id="strong_residual-1376"><a href="#strong_residual-1376"><span class="linenos">1376</span></a>    <span class="n">res_vec</span><span class="p">[</span><span class="n">idx_bc</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
</span><span id="strong_residual-1377"><a href="#strong_residual-1377"><span class="linenos">1377</span></a>    <span class="n">res_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">res_vec</span><span class="p">)</span>
</span><span id="strong_residual-1378"><a href="#strong_residual-1378"><span class="linenos">1378</span></a>    <span class="n">res_vec_parts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mtx&#39;</span> <span class="p">:</span> <span class="n">Ax</span><span class="p">,</span>
</span><span id="strong_residual-1379"><a href="#strong_residual-1379"><span class="linenos">1379</span></a>                     <span class="s1">&#39;rhs_cst&#39;</span> <span class="p">:</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_res&#39;</span><span class="p">],</span>
</span><span id="strong_residual-1380"><a href="#strong_residual-1380"><span class="linenos">1380</span></a>                     <span class="s1">&#39;rhs_mod&#39;</span> <span class="p">:</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_res&#39;</span><span class="p">]}</span>
</span><span id="strong_residual-1381"><a href="#strong_residual-1381"><span class="linenos">1381</span></a>
</span><span id="strong_residual-1382"><a href="#strong_residual-1382"><span class="linenos">1382</span></a>    <span class="k">return</span> <span class="n">res_vec</span><span class="p">,</span> <span class="n">res_vec_parts</span>
</span></pre></div>


            <div class="docstring"><p>Compute the strong residual (for nonlinear problems only). Note that the
strong residual might be evaluated on both the interior and exterior
if two nonlinear WeakForms instances are provided at the creation of
<code>solver</code> (unbounded problems only).</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>solver</strong> (<code><a href="#Solver">Solver</a></code> instance):
The solver instance.</li>
<li><strong>sol_w</strong> (array):
Current solution (vector).</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>res_vec</strong> (ndarray):
Residual vector.</li>
</ul>
</div>


                </section>
                <section id="vec_G">
                            <input id="vec_G-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">vec_G</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">solver</span>, </span><span class="param"><span class="n">sol_w</span>, </span><span class="param"><span class="n">delta</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="vec_G-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#vec_G"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="vec_G-1385"><a href="#vec_G-1385"><span class="linenos">1385</span></a><span class="k">def</span> <span class="nf">vec_G</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">sol_w</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
</span><span id="vec_G-1386"><a href="#vec_G-1386"><span class="linenos">1386</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Utility function for the line-search algorithm&quot;&quot;&quot;</span>
</span><span id="vec_G-1387"><a href="#vec_G-1387"><span class="linenos">1387</span></a>    <span class="n">wf1</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="vec_G-1388"><a href="#vec_G-1388"><span class="linenos">1388</span></a>    <span class="n">wf_G</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">wfs_dic</span><span class="p">[</span><span class="s1">&#39;wf_G&#39;</span><span class="p">]</span>
</span><span id="vec_G-1389"><a href="#vec_G-1389"><span class="linenos">1389</span></a>    <span class="n">sol_qps</span> <span class="o">=</span> <span class="n">evaluate_at_qps</span><span class="p">(</span><span class="n">wf1</span><span class="p">,</span> <span class="n">sol_w</span><span class="p">)</span>
</span><span id="vec_G-1390"><a href="#vec_G-1390"><span class="linenos">1390</span></a>    <span class="n">dphi_qps</span> <span class="o">=</span> <span class="n">evaluate_at_qps</span><span class="p">(</span><span class="n">wf1</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>
</span><span id="vec_G-1391"><a href="#vec_G-1391"><span class="linenos">1391</span></a>    <span class="n">set_mat_extra_arg</span><span class="p">(</span><span class="n">wf_G</span><span class="p">,</span> <span class="n">sol_qps</span><span class="p">,</span> <span class="n">dphi_qps</span><span class="p">,</span>
</span><span id="vec_G-1392"><a href="#vec_G-1392"><span class="linenos">1392</span></a>                      <span class="n">keys</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;phi&#39;</span><span class="p">,</span> <span class="s1">&#39;dphi&#39;</span><span class="p">),</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="vec_G-1393"><a href="#vec_G-1393"><span class="linenos">1393</span></a>    <span class="n">is_not_assembled</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mtx_cst_G&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="vec_G-1394"><a href="#vec_G-1394"><span class="linenos">1394</span></a>    <span class="k">if</span> <span class="n">is_not_assembled</span><span class="p">:</span>
</span><span id="vec_G-1395"><a href="#vec_G-1395"><span class="linenos">1395</span></a>        <span class="n">assemble_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_cst_G&#39;</span><span class="p">],</span> <span class="n">assemble_rhs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="vec_G-1396"><a href="#vec_G-1396"><span class="linenos">1396</span></a>    <span class="n">assemble_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="n">solver</span><span class="o">.</span><span class="n">pbs_dic</span><span class="p">[</span><span class="s1">&#39;pb_mod_G&#39;</span><span class="p">],</span> <span class="n">assemble_mtx</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="vec_G-1397"><a href="#vec_G-1397"><span class="linenos">1397</span></a>    <span class="n">mtx</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_G&#39;</span><span class="p">]</span>
</span><span id="vec_G-1398"><a href="#vec_G-1398"><span class="linenos">1398</span></a>    <span class="n">rhs</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_G&#39;</span><span class="p">]</span>
</span><span id="vec_G-1399"><a href="#vec_G-1399"><span class="linenos">1399</span></a>    <span class="n">vec</span> <span class="o">=</span> <span class="n">mtx</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span> <span class="o">-</span> <span class="n">rhs</span>
</span><span id="vec_G-1400"><a href="#vec_G-1400"><span class="linenos">1400</span></a>    <span class="n">cg</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">cogammas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="s1">&#39;cogammas&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="vec_G-1401"><a href="#vec_G-1401"><span class="linenos">1401</span></a>    <span class="n">idx_bc</span> <span class="o">=</span> <span class="n">get_ebc_dofs</span><span class="p">(</span><span class="n">wf_G</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">cg</span><span class="p">)</span>
</span><span id="vec_G-1402"><a href="#vec_G-1402"><span class="linenos">1402</span></a>    <span class="n">vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">idx_bc</span><span class="p">)</span>
</span><span id="vec_G-1403"><a href="#vec_G-1403"><span class="linenos">1403</span></a>    <span class="k">return</span> <span class="n">vec</span>
</span></pre></div>


            <div class="docstring"><p>Utility function for the line-search algorithm</p>
</div>


                </section>
                <section id="delete_ebc_dofs">
                            <input id="delete_ebc_dofs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_ebc_dofs</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">vec</span>, </span><span class="param"><span class="n">wf</span>, </span><span class="param"><span class="n">gamma</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="delete_ebc_dofs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#delete_ebc_dofs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="delete_ebc_dofs-1405"><a href="#delete_ebc_dofs-1405"><span class="linenos">1405</span></a><span class="k">def</span> <span class="nf">delete_ebc_dofs</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">wf</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="delete_ebc_dofs-1406"><a href="#delete_ebc_dofs-1406"><span class="linenos">1406</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="delete_ebc_dofs-1407"><a href="#delete_ebc_dofs-1407"><span class="linenos">1407</span></a><span class="sd">    Remove vector elements that correspond to DOFs subject to essential</span>
</span><span id="delete_ebc_dofs-1408"><a href="#delete_ebc_dofs-1408"><span class="linenos">1408</span></a><span class="sd">    boundary conditions or DOFs that are part of a certain facet region</span>
</span><span id="delete_ebc_dofs-1409"><a href="#delete_ebc_dofs-1409"><span class="linenos">1409</span></a><span class="sd">    specified by the keyword argument `gamma`.</span>
</span><span id="delete_ebc_dofs-1410"><a href="#delete_ebc_dofs-1410"><span class="linenos">1410</span></a>
</span><span id="delete_ebc_dofs-1411"><a href="#delete_ebc_dofs-1411"><span class="linenos">1411</span></a><span class="sd">    Parameters</span>
</span><span id="delete_ebc_dofs-1412"><a href="#delete_ebc_dofs-1412"><span class="linenos">1412</span></a><span class="sd">    ----------</span>
</span><span id="delete_ebc_dofs-1413"><a href="#delete_ebc_dofs-1413"><span class="linenos">1413</span></a><span class="sd">    vec : ndarray</span>
</span><span id="delete_ebc_dofs-1414"><a href="#delete_ebc_dofs-1414"><span class="linenos">1414</span></a><span class="sd">        1D numpy array defined over DOFs.</span>
</span><span id="delete_ebc_dofs-1415"><a href="#delete_ebc_dofs-1415"><span class="linenos">1415</span></a><span class="sd">    wf : `WeakForm` instance</span>
</span><span id="delete_ebc_dofs-1416"><a href="#delete_ebc_dofs-1416"><span class="linenos">1416</span></a><span class="sd">        Weak form instance containing the DOFs info as well as the facet(s)</span>
</span><span id="delete_ebc_dofs-1417"><a href="#delete_ebc_dofs-1417"><span class="linenos">1417</span></a><span class="sd">        subject to essential boundary conditions.</span>
</span><span id="delete_ebc_dofs-1418"><a href="#delete_ebc_dofs-1418"><span class="linenos">1418</span></a><span class="sd">    gamma : `Region` instance, optional</span>
</span><span id="delete_ebc_dofs-1419"><a href="#delete_ebc_dofs-1419"><span class="linenos">1419</span></a><span class="sd">        Extra boundary where `vec` elements should be deleted (a priori not</span>
</span><span id="delete_ebc_dofs-1420"><a href="#delete_ebc_dofs-1420"><span class="linenos">1420</span></a><span class="sd">        concerned by ebc). The default is None.</span>
</span><span id="delete_ebc_dofs-1421"><a href="#delete_ebc_dofs-1421"><span class="linenos">1421</span></a>
</span><span id="delete_ebc_dofs-1422"><a href="#delete_ebc_dofs-1422"><span class="linenos">1422</span></a><span class="sd">    Returns</span>
</span><span id="delete_ebc_dofs-1423"><a href="#delete_ebc_dofs-1423"><span class="linenos">1423</span></a><span class="sd">    -------</span>
</span><span id="delete_ebc_dofs-1424"><a href="#delete_ebc_dofs-1424"><span class="linenos">1424</span></a><span class="sd">    idx : ndarray</span>
</span><span id="delete_ebc_dofs-1425"><a href="#delete_ebc_dofs-1425"><span class="linenos">1425</span></a><span class="sd">        Indices of the DOFs deleted.</span>
</span><span id="delete_ebc_dofs-1426"><a href="#delete_ebc_dofs-1426"><span class="linenos">1426</span></a><span class="sd">    ndarray</span>
</span><span id="delete_ebc_dofs-1427"><a href="#delete_ebc_dofs-1427"><span class="linenos">1427</span></a><span class="sd">        The amputed version of `vec`.</span>
</span><span id="delete_ebc_dofs-1428"><a href="#delete_ebc_dofs-1428"><span class="linenos">1428</span></a>
</span><span id="delete_ebc_dofs-1429"><a href="#delete_ebc_dofs-1429"><span class="linenos">1429</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="delete_ebc_dofs-1430"><a href="#delete_ebc_dofs-1430"><span class="linenos">1430</span></a>    <span class="n">vertices_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="delete_ebc_dofs-1431"><a href="#delete_ebc_dofs-1431"><span class="linenos">1431</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">ebcs</span><span class="p">)):</span>
</span><span id="delete_ebc_dofs-1432"><a href="#delete_ebc_dofs-1432"><span class="linenos">1432</span></a>        <span class="n">vertices_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_dofs_in_region</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">ebcs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">region</span><span class="p">))</span>
</span><span id="delete_ebc_dofs-1433"><a href="#delete_ebc_dofs-1433"><span class="linenos">1433</span></a>    <span class="k">if</span> <span class="n">gamma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="delete_ebc_dofs-1434"><a href="#delete_ebc_dofs-1434"><span class="linenos">1434</span></a>        <span class="n">vertices_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_dofs_in_region</span><span class="p">(</span><span class="n">gamma</span><span class="p">))</span>
</span><span id="delete_ebc_dofs-1435"><a href="#delete_ebc_dofs-1435"><span class="linenos">1435</span></a>    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">vertices_list</span><span class="p">))</span>
</span><span id="delete_ebc_dofs-1436"><a href="#delete_ebc_dofs-1436"><span class="linenos">1436</span></a>    <span class="k">return</span> <span class="n">idx</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Remove vector elements that correspond to DOFs subject to essential
boundary conditions or DOFs that are part of a certain facet region
specified by the keyword argument <code>gamma</code>.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>vec</strong> (ndarray):
1D numpy array defined over DOFs.</li>
<li><strong>wf</strong> (<code>WeakForm</code> instance):
Weak form instance containing the DOFs info as well as the facet(s)
subject to essential boundary conditions.</li>
<li><strong>gamma</strong> (<code>Region</code> instance, optional):
Extra boundary where <code>vec</code> elements should be deleted (a priori not
concerned by ebc). The default is None.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>idx</strong> (ndarray):
Indices of the DOFs deleted.</li>
<li><strong>ndarray</strong>: The amputed version of <code>vec</code>.</li>
</ul>
</div>


                </section>
                <section id="get_ebc_dofs">
                            <input id="get_ebc_dofs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_ebc_dofs</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">wf</span>, </span><span class="param"><span class="n">gamma</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_ebc_dofs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_ebc_dofs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_ebc_dofs-1438"><a href="#get_ebc_dofs-1438"><span class="linenos">1438</span></a><span class="k">def</span> <span class="nf">get_ebc_dofs</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="get_ebc_dofs-1439"><a href="#get_ebc_dofs-1439"><span class="linenos">1439</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Same as `delete_ebc_dofs` but only returns the indices of the DOFs</span>
</span><span id="get_ebc_dofs-1440"><a href="#get_ebc_dofs-1440"><span class="linenos">1440</span></a><span class="sd">    associated with Dirichlet boundary conditions or belong to facet gamma.&quot;&quot;&quot;</span>
</span><span id="get_ebc_dofs-1441"><a href="#get_ebc_dofs-1441"><span class="linenos">1441</span></a>    <span class="n">vertices_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="get_ebc_dofs-1442"><a href="#get_ebc_dofs-1442"><span class="linenos">1442</span></a>    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">ebcs</span><span class="p">)):</span>
</span><span id="get_ebc_dofs-1443"><a href="#get_ebc_dofs-1443"><span class="linenos">1443</span></a>        <span class="n">vertices_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_dofs_in_region</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">ebcs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">region</span><span class="p">))</span>
</span><span id="get_ebc_dofs-1444"><a href="#get_ebc_dofs-1444"><span class="linenos">1444</span></a>    <span class="k">if</span> <span class="n">gamma</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="get_ebc_dofs-1445"><a href="#get_ebc_dofs-1445"><span class="linenos">1445</span></a>        <span class="n">vertices_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wf</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">get_dofs_in_region</span><span class="p">(</span><span class="n">gamma</span><span class="p">))</span>
</span><span id="get_ebc_dofs-1446"><a href="#get_ebc_dofs-1446"><span class="linenos">1446</span></a>    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">vertices_list</span><span class="p">))</span>
</span><span id="get_ebc_dofs-1447"><a href="#get_ebc_dofs-1447"><span class="linenos">1447</span></a>    <span class="k">return</span> <span class="n">idx</span>
</span></pre></div>


            <div class="docstring"><p>Same as <code><a href="#delete_ebc_dofs">delete_ebc_dofs</a></code> but only returns the indices of the DOFs
associated with Dirichlet boundary conditions or belong to facet gamma.</p>
</div>


                </section>
                <section id="assemble_mtxvec">
                            <input id="assemble_mtxvec-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">assemble_mtxvec</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">solver</span>, </span><span class="param"><span class="o">*</span><span class="n">pbs</span>, </span><span class="param"><span class="n">assemble_mtx</span><span class="o">=</span><span class="kc">True</span>, </span><span class="param"><span class="n">assemble_rhs</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="assemble_mtxvec-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#assemble_mtxvec"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="assemble_mtxvec-1449"><a href="#assemble_mtxvec-1449"><span class="linenos">1449</span></a><span class="k">def</span> <span class="nf">assemble_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">,</span> <span class="o">*</span><span class="n">pbs</span><span class="p">,</span> <span class="n">assemble_mtx</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">assemble_rhs</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="assemble_mtxvec-1450"><a href="#assemble_mtxvec-1450"><span class="linenos">1450</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="assemble_mtxvec-1451"><a href="#assemble_mtxvec-1451"><span class="linenos">1451</span></a><span class="sd">    Assemble the terms (matrices and vectors) of `Problem` instances (Cf sfepy</span>
</span><span id="assemble_mtxvec-1452"><a href="#assemble_mtxvec-1452"><span class="linenos">1452</span></a><span class="sd">    API) provided by the user. The assembled matrices and vectors are then</span>
</span><span id="assemble_mtxvec-1453"><a href="#assemble_mtxvec-1453"><span class="linenos">1453</span></a><span class="sd">    accessible through the solver&#39;s `mtxvec_dic` dictionary.</span>
</span><span id="assemble_mtxvec-1454"><a href="#assemble_mtxvec-1454"><span class="linenos">1454</span></a>
</span><span id="assemble_mtxvec-1455"><a href="#assemble_mtxvec-1455"><span class="linenos">1455</span></a><span class="sd">    Parameters</span>
</span><span id="assemble_mtxvec-1456"><a href="#assemble_mtxvec-1456"><span class="linenos">1456</span></a><span class="sd">    ----------</span>
</span><span id="assemble_mtxvec-1457"><a href="#assemble_mtxvec-1457"><span class="linenos">1457</span></a><span class="sd">    solver : `Solver` instance</span>
</span><span id="assemble_mtxvec-1458"><a href="#assemble_mtxvec-1458"><span class="linenos">1458</span></a><span class="sd">        The solver instance.</span>
</span><span id="assemble_mtxvec-1459"><a href="#assemble_mtxvec-1459"><span class="linenos">1459</span></a><span class="sd">    *pbs : list or tupple</span>
</span><span id="assemble_mtxvec-1460"><a href="#assemble_mtxvec-1460"><span class="linenos">1460</span></a><span class="sd">        List of `Problem` instances.</span>
</span><span id="assemble_mtxvec-1461"><a href="#assemble_mtxvec-1461"><span class="linenos">1461</span></a><span class="sd">    assemble_mtx : bool, optional</span>
</span><span id="assemble_mtxvec-1462"><a href="#assemble_mtxvec-1462"><span class="linenos">1462</span></a><span class="sd">        Whether matrices are assembled or not. The default is True.</span>
</span><span id="assemble_mtxvec-1463"><a href="#assemble_mtxvec-1463"><span class="linenos">1463</span></a><span class="sd">    assemble_rhs : bool, optional</span>
</span><span id="assemble_mtxvec-1464"><a href="#assemble_mtxvec-1464"><span class="linenos">1464</span></a><span class="sd">        Whether vectors are assembled or not. The default is True.</span>
</span><span id="assemble_mtxvec-1465"><a href="#assemble_mtxvec-1465"><span class="linenos">1465</span></a>
</span><span id="assemble_mtxvec-1466"><a href="#assemble_mtxvec-1466"><span class="linenos">1466</span></a><span class="sd">    Returns</span>
</span><span id="assemble_mtxvec-1467"><a href="#assemble_mtxvec-1467"><span class="linenos">1467</span></a><span class="sd">    -------</span>
</span><span id="assemble_mtxvec-1468"><a href="#assemble_mtxvec-1468"><span class="linenos">1468</span></a><span class="sd">    None.</span>
</span><span id="assemble_mtxvec-1469"><a href="#assemble_mtxvec-1469"><span class="linenos">1469</span></a>
</span><span id="assemble_mtxvec-1470"><a href="#assemble_mtxvec-1470"><span class="linenos">1470</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="assemble_mtxvec-1471"><a href="#assemble_mtxvec-1471"><span class="linenos">1471</span></a>
</span><span id="assemble_mtxvec-1472"><a href="#assemble_mtxvec-1472"><span class="linenos">1472</span></a>    <span class="n">saved_assemble_mtx</span> <span class="o">=</span> <span class="n">assemble_mtx</span>
</span><span id="assemble_mtxvec-1473"><a href="#assemble_mtxvec-1473"><span class="linenos">1473</span></a>    <span class="n">saved_assemble_rhs</span> <span class="o">=</span> <span class="n">assemble_rhs</span>
</span><span id="assemble_mtxvec-1474"><a href="#assemble_mtxvec-1474"><span class="linenos">1474</span></a>
</span><span id="assemble_mtxvec-1475"><a href="#assemble_mtxvec-1475"><span class="linenos">1475</span></a>    <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="n">pbs</span><span class="p">:</span>
</span><span id="assemble_mtxvec-1476"><a href="#assemble_mtxvec-1476"><span class="linenos">1476</span></a>
</span><span id="assemble_mtxvec-1477"><a href="#assemble_mtxvec-1477"><span class="linenos">1477</span></a>        <span class="k">if</span> <span class="n">pb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="assemble_mtxvec-1478"><a href="#assemble_mtxvec-1478"><span class="linenos">1478</span></a>            <span class="k">continue</span>
</span><span id="assemble_mtxvec-1479"><a href="#assemble_mtxvec-1479"><span class="linenos">1479</span></a>
</span><span id="assemble_mtxvec-1480"><a href="#assemble_mtxvec-1480"><span class="linenos">1480</span></a>        <span class="c1"># name handling</span>
</span><span id="assemble_mtxvec-1481"><a href="#assemble_mtxvec-1481"><span class="linenos">1481</span></a>        <span class="n">pb_name</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span>
</span><span id="assemble_mtxvec-1482"><a href="#assemble_mtxvec-1482"><span class="linenos">1482</span></a>        <span class="n">sname</span> <span class="o">=</span> <span class="n">pb_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
</span><span id="assemble_mtxvec-1483"><a href="#assemble_mtxvec-1483"><span class="linenos">1483</span></a>        <span class="n">sname</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="assemble_mtxvec-1484"><a href="#assemble_mtxvec-1484"><span class="linenos">1484</span></a>        <span class="n">mtx_key</span> <span class="o">=</span> <span class="s1">&#39;mtx_&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sname</span><span class="p">)</span>
</span><span id="assemble_mtxvec-1485"><a href="#assemble_mtxvec-1485"><span class="linenos">1485</span></a>        <span class="n">rhs_key</span> <span class="o">=</span> <span class="s1">&#39;rhs_&#39;</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sname</span><span class="p">)</span>
</span><span id="assemble_mtxvec-1486"><a href="#assemble_mtxvec-1486"><span class="linenos">1486</span></a>
</span><span id="assemble_mtxvec-1487"><a href="#assemble_mtxvec-1487"><span class="linenos">1487</span></a>        <span class="c1"># handling exceptions</span>
</span><span id="assemble_mtxvec-1488"><a href="#assemble_mtxvec-1488"><span class="linenos">1488</span></a>        <span class="k">if</span> <span class="p">((</span><span class="n">solver</span><span class="o">.</span><span class="n">islinear</span> <span class="ow">and</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;pb_mod_pp2&#39;</span><span class="p">)</span> <span class="ow">or</span> 
</span><span id="assemble_mtxvec-1489"><a href="#assemble_mtxvec-1489"><span class="linenos">1489</span></a>            <span class="p">(</span><span class="ow">not</span> <span class="n">solver</span><span class="o">.</span><span class="n">islinear</span> <span class="ow">and</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;pb_mod_res&#39;</span><span class="p">)):</span>
</span><span id="assemble_mtxvec-1490"><a href="#assemble_mtxvec-1490"><span class="linenos">1490</span></a>            <span class="n">assemble_mtx</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="assemble_mtxvec-1491"><a href="#assemble_mtxvec-1491"><span class="linenos">1491</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">solver</span><span class="o">.</span><span class="n">initialized</span> <span class="ow">and</span> <span class="n">pb</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;pb_mod_pp2&#39;</span><span class="p">:</span>
</span><span id="assemble_mtxvec-1492"><a href="#assemble_mtxvec-1492"><span class="linenos">1492</span></a>            <span class="n">assemble_rhs</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="assemble_mtxvec-1493"><a href="#assemble_mtxvec-1493"><span class="linenos">1493</span></a>        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">assemble_mtx</span> <span class="ow">or</span> <span class="n">assemble_rhs</span><span class="p">):</span>
</span><span id="assemble_mtxvec-1494"><a href="#assemble_mtxvec-1494"><span class="linenos">1494</span></a>            <span class="k">continue</span>
</span><span id="assemble_mtxvec-1495"><a href="#assemble_mtxvec-1495"><span class="linenos">1495</span></a>
</span><span id="assemble_mtxvec-1496"><a href="#assemble_mtxvec-1496"><span class="linenos">1496</span></a>        <span class="c1"># assembling matrix and rhs vector</span>
</span><span id="assemble_mtxvec-1497"><a href="#assemble_mtxvec-1497"><span class="linenos">1497</span></a>        <span class="n">tss</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">get_solver</span><span class="p">()</span>
</span><span id="assemble_mtxvec-1498"><a href="#assemble_mtxvec-1498"><span class="linenos">1498</span></a>        <span class="n">pb</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_unknown</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="assemble_mtxvec-1499"><a href="#assemble_mtxvec-1499"><span class="linenos">1499</span></a>        <span class="n">variables</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">get_initial_state</span><span class="p">(</span><span class="n">vec</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="assemble_mtxvec-1500"><a href="#assemble_mtxvec-1500"><span class="linenos">1500</span></a>        <span class="n">variables</span><span class="o">.</span><span class="n">adof_conns</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="assemble_mtxvec-1501"><a href="#assemble_mtxvec-1501"><span class="linenos">1501</span></a>        <span class="n">pb</span><span class="o">.</span><span class="n">time_update</span><span class="p">(</span><span class="n">tss</span><span class="o">.</span><span class="n">ts</span><span class="p">,</span> <span class="n">is_matrix</span><span class="o">=</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">mtx_a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">))</span>
</span><span id="assemble_mtxvec-1502"><a href="#assemble_mtxvec-1502"><span class="linenos">1502</span></a>        <span class="n">variables</span><span class="o">.</span><span class="n">apply_ebc</span><span class="p">(</span><span class="n">force_values</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="assemble_mtxvec-1503"><a href="#assemble_mtxvec-1503"><span class="linenos">1503</span></a>        <span class="n">pb</span><span class="o">.</span><span class="n">update_materials</span><span class="p">()</span>
</span><span id="assemble_mtxvec-1504"><a href="#assemble_mtxvec-1504"><span class="linenos">1504</span></a>        <span class="n">ev</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">get_evaluator</span><span class="p">()</span>
</span><span id="assemble_mtxvec-1505"><a href="#assemble_mtxvec-1505"><span class="linenos">1505</span></a>        <span class="k">if</span> <span class="n">assemble_mtx</span><span class="p">:</span>
</span><span id="assemble_mtxvec-1506"><a href="#assemble_mtxvec-1506"><span class="linenos">1506</span></a>            <span class="n">mtx</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">eval_tangent_matrix</span><span class="p">(</span><span class="n">variables</span><span class="p">(),</span> <span class="n">is_full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="assemble_mtxvec-1507"><a href="#assemble_mtxvec-1507"><span class="linenos">1507</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="p">[</span><span class="n">mtx_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtx</span>
</span><span id="assemble_mtxvec-1508"><a href="#assemble_mtxvec-1508"><span class="linenos">1508</span></a>        <span class="k">if</span> <span class="n">assemble_rhs</span><span class="p">:</span>
</span><span id="assemble_mtxvec-1509"><a href="#assemble_mtxvec-1509"><span class="linenos">1509</span></a>            <span class="n">rhs</span> <span class="o">=</span> <span class="o">-</span><span class="n">ev</span><span class="o">.</span><span class="n">eval_residual</span><span class="p">(</span><span class="n">variables</span><span class="p">(),</span> <span class="n">is_full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="assemble_mtxvec-1510"><a href="#assemble_mtxvec-1510"><span class="linenos">1510</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span><span class="p">[</span><span class="n">rhs_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">rhs</span>
</span><span id="assemble_mtxvec-1511"><a href="#assemble_mtxvec-1511"><span class="linenos">1511</span></a>            <span class="c1"># alternative way / syntax</span>
</span><span id="assemble_mtxvec-1512"><a href="#assemble_mtxvec-1512"><span class="linenos">1512</span></a>            <span class="c1"># rhs = pb.equations.create_reduced_vec()</span>
</span><span id="assemble_mtxvec-1513"><a href="#assemble_mtxvec-1513"><span class="linenos">1513</span></a>            <span class="c1"># rhs = pb.equations.evaluate(mode=&#39;weak&#39;, dw_mode=&#39;vector&#39;,</span>
</span><span id="assemble_mtxvec-1514"><a href="#assemble_mtxvec-1514"><span class="linenos">1514</span></a>            <span class="c1">#                             asm_obj=rhs)</span>
</span><span id="assemble_mtxvec-1515"><a href="#assemble_mtxvec-1515"><span class="linenos">1515</span></a>            <span class="c1"># solver.mtxvec_dic[rhs_key] = -rhs</span>
</span><span id="assemble_mtxvec-1516"><a href="#assemble_mtxvec-1516"><span class="linenos">1516</span></a>
</span><span id="assemble_mtxvec-1517"><a href="#assemble_mtxvec-1517"><span class="linenos">1517</span></a>        <span class="c1"># reset assembling boolean options</span>
</span><span id="assemble_mtxvec-1518"><a href="#assemble_mtxvec-1518"><span class="linenos">1518</span></a>        <span class="n">assemble_mtx</span> <span class="o">=</span> <span class="n">saved_assemble_mtx</span>
</span><span id="assemble_mtxvec-1519"><a href="#assemble_mtxvec-1519"><span class="linenos">1519</span></a>        <span class="n">assemble_rhs</span> <span class="o">=</span> <span class="n">saved_assemble_rhs</span>
</span></pre></div>


            <div class="docstring"><p>Assemble the terms (matrices and vectors) of <code>Problem</code> instances (Cf sfepy
API) provided by the user. The assembled matrices and vectors are then
accessible through the solver's <code>mtxvec_dic</code> dictionary.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>solver</strong> (<code><a href="#Solver">Solver</a></code> instance):
The solver instance.</li>
<li><strong>*pbs</strong> (list or tupple):
List of <code>Problem</code> instances.</li>
<li><strong>assemble_mtx</strong> (bool, optional):
Whether matrices are assembled or not. The default is True.</li>
<li><strong>assemble_rhs</strong> (bool, optional):
Whether vectors are assembled or not. The default is True.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>None.</strong></li>
</ul>
</div>


                </section>
                <section id="update_global_mtxvec">
                            <input id="update_global_mtxvec-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_global_mtxvec</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">solver</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="update_global_mtxvec-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#update_global_mtxvec"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="update_global_mtxvec-1522"><a href="#update_global_mtxvec-1522"><span class="linenos">1522</span></a><span class="k">def</span> <span class="nf">update_global_mtxvec</span><span class="p">(</span><span class="n">solver</span><span class="p">):</span>
</span><span id="update_global_mtxvec-1523"><a href="#update_global_mtxvec-1523"><span class="linenos">1523</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the global stiffness matrix &amp; rhs vector (those subsequently</span>
</span><span id="update_global_mtxvec-1524"><a href="#update_global_mtxvec-1524"><span class="linenos">1524</span></a><span class="sd">    passed to the linear solver) which are only sums of pre-computed matrices</span>
</span><span id="update_global_mtxvec-1525"><a href="#update_global_mtxvec-1525"><span class="linenos">1525</span></a><span class="sd">    &amp; vectors.&quot;&quot;&quot;</span>
</span><span id="update_global_mtxvec-1526"><a href="#update_global_mtxvec-1526"><span class="linenos">1526</span></a>    <span class="n">mtxvec_dic</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">mtxvec_dic</span>
</span><span id="update_global_mtxvec-1527"><a href="#update_global_mtxvec-1527"><span class="linenos">1527</span></a>    <span class="n">wf1</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">weakforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="update_global_mtxvec-1528"><a href="#update_global_mtxvec-1528"><span class="linenos">1528</span></a>    <span class="k">if</span> <span class="n">solver</span><span class="o">.</span><span class="n">nwf</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">nwf</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">conn</span><span class="o">==</span><span class="s1">&#39;connected&#39;</span><span class="p">):</span>
</span><span id="update_global_mtxvec-1529"><a href="#update_global_mtxvec-1529"><span class="linenos">1529</span></a>        <span class="k">if</span> <span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="update_global_mtxvec-1530"><a href="#update_global_mtxvec-1530"><span class="linenos">1530</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst&#39;</span><span class="p">]</span>
</span><span id="update_global_mtxvec-1531"><a href="#update_global_mtxvec-1531"><span class="linenos">1531</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst&#39;</span><span class="p">]</span>
</span><span id="update_global_mtxvec-1532"><a href="#update_global_mtxvec-1532"><span class="linenos">1532</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="update_global_mtxvec-1533"><a href="#update_global_mtxvec-1533"><span class="linenos">1533</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_mod&#39;</span><span class="p">]</span>
</span><span id="update_global_mtxvec-1534"><a href="#update_global_mtxvec-1534"><span class="linenos">1534</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod&#39;</span><span class="p">]</span>
</span><span id="update_global_mtxvec-1535"><a href="#update_global_mtxvec-1535"><span class="linenos">1535</span></a>    <span class="k">elif</span> <span class="n">solver</span><span class="o">.</span><span class="n">nwf</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">conn</span><span class="o">==</span><span class="s1">&#39;ping-pong&#39;</span><span class="p">:</span>
</span><span id="update_global_mtxvec-1536"><a href="#update_global_mtxvec-1536"><span class="linenos">1536</span></a>        <span class="k">if</span> <span class="n">wf1</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="update_global_mtxvec-1537"><a href="#update_global_mtxvec-1537"><span class="linenos">1537</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_pp1&#39;</span><span class="p">]</span>
</span><span id="update_global_mtxvec-1538"><a href="#update_global_mtxvec-1538"><span class="linenos">1538</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_pp1&#39;</span><span class="p">]</span>
</span><span id="update_global_mtxvec-1539"><a href="#update_global_mtxvec-1539"><span class="linenos">1539</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_pp2&#39;</span><span class="p">]</span>
</span><span id="update_global_mtxvec-1540"><a href="#update_global_mtxvec-1540"><span class="linenos">1540</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_pp2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_pp2&#39;</span><span class="p">]</span>
</span><span id="update_global_mtxvec-1541"><a href="#update_global_mtxvec-1541"><span class="linenos">1541</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="update_global_mtxvec-1542"><a href="#update_global_mtxvec-1542"><span class="linenos">1542</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_pp1&#39;</span><span class="p">]</span> \
</span><span id="update_global_mtxvec-1543"><a href="#update_global_mtxvec-1543"><span class="linenos">1543</span></a>                <span class="o">+</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_mod_pp1&#39;</span><span class="p">]</span>
</span><span id="update_global_mtxvec-1544"><a href="#update_global_mtxvec-1544"><span class="linenos">1544</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_pp1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_pp1&#39;</span><span class="p">]</span> \
</span><span id="update_global_mtxvec-1545"><a href="#update_global_mtxvec-1545"><span class="linenos">1545</span></a>                <span class="o">+</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_pp1&#39;</span><span class="p">]</span>
</span><span id="update_global_mtxvec-1546"><a href="#update_global_mtxvec-1546"><span class="linenos">1546</span></a>
</span><span id="update_global_mtxvec-1547"><a href="#update_global_mtxvec-1547"><span class="linenos">1547</span></a>    <span class="n">wf_res</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">wfs_dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_res&#39;</span><span class="p">)</span>
</span><span id="update_global_mtxvec-1548"><a href="#update_global_mtxvec-1548"><span class="linenos">1548</span></a>    <span class="k">if</span> <span class="n">wf_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="update_global_mtxvec-1549"><a href="#update_global_mtxvec-1549"><span class="linenos">1549</span></a>        <span class="k">if</span> <span class="n">wf_res</span><span class="o">.</span><span class="n">eqn_mod</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="update_global_mtxvec-1550"><a href="#update_global_mtxvec-1550"><span class="linenos">1550</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_res&#39;</span><span class="p">]</span>
</span><span id="update_global_mtxvec-1551"><a href="#update_global_mtxvec-1551"><span class="linenos">1551</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_res&#39;</span><span class="p">]</span>
</span><span id="update_global_mtxvec-1552"><a href="#update_global_mtxvec-1552"><span class="linenos">1552</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="update_global_mtxvec-1553"><a href="#update_global_mtxvec-1553"><span class="linenos">1553</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;mtx_cst_res&#39;</span><span class="p">]</span> <span class="c1">#+ mtxvec_dic[&#39;mtx_mod_res&#39;]</span>
</span><span id="update_global_mtxvec-1554"><a href="#update_global_mtxvec-1554"><span class="linenos">1554</span></a>            <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_res&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_cst_res&#39;</span><span class="p">]</span> \
</span><span id="update_global_mtxvec-1555"><a href="#update_global_mtxvec-1555"><span class="linenos">1555</span></a>                <span class="o">+</span> <span class="n">mtxvec_dic</span><span class="p">[</span><span class="s1">&#39;rhs_mod_res&#39;</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Update the global stiffness matrix &amp; rhs vector (those subsequently
passed to the linear solver) which are only sums of pre-computed matrices
&amp; vectors.</p>
</div>


                </section>
                <section id="reconstruct_full_sol">
                            <input id="reconstruct_full_sol-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reconstruct_full_sol</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">pb</span>, </span><span class="param"><span class="n">sol_reduced</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="reconstruct_full_sol-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#reconstruct_full_sol"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="reconstruct_full_sol-1558"><a href="#reconstruct_full_sol-1558"><span class="linenos">1558</span></a><span class="k">def</span> <span class="nf">reconstruct_full_sol</span><span class="p">(</span><span class="n">pb</span><span class="p">,</span> <span class="n">sol_reduced</span><span class="p">):</span>
</span><span id="reconstruct_full_sol-1559"><a href="#reconstruct_full_sol-1559"><span class="linenos">1559</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="reconstruct_full_sol-1560"><a href="#reconstruct_full_sol-1560"><span class="linenos">1560</span></a><span class="sd">    Reconstruct the full solution vector from the reduced solution vector</span>
</span><span id="reconstruct_full_sol-1561"><a href="#reconstruct_full_sol-1561"><span class="linenos">1561</span></a><span class="sd">    (defined only at active DOFs i.e. DOFs that are not constrained by</span>
</span><span id="reconstruct_full_sol-1562"><a href="#reconstruct_full_sol-1562"><span class="linenos">1562</span></a><span class="sd">    essential boundary conditions).</span>
</span><span id="reconstruct_full_sol-1563"><a href="#reconstruct_full_sol-1563"><span class="linenos">1563</span></a>
</span><span id="reconstruct_full_sol-1564"><a href="#reconstruct_full_sol-1564"><span class="linenos">1564</span></a><span class="sd">    Parameters</span>
</span><span id="reconstruct_full_sol-1565"><a href="#reconstruct_full_sol-1565"><span class="linenos">1565</span></a><span class="sd">    ----------</span>
</span><span id="reconstruct_full_sol-1566"><a href="#reconstruct_full_sol-1566"><span class="linenos">1566</span></a><span class="sd">    pb : `Problem` instance</span>
</span><span id="reconstruct_full_sol-1567"><a href="#reconstruct_full_sol-1567"><span class="linenos">1567</span></a><span class="sd">        Problem instance associated with the solution to reconstruct.</span>
</span><span id="reconstruct_full_sol-1568"><a href="#reconstruct_full_sol-1568"><span class="linenos">1568</span></a><span class="sd">    sol_reduced : ndarray</span>
</span><span id="reconstruct_full_sol-1569"><a href="#reconstruct_full_sol-1569"><span class="linenos">1569</span></a><span class="sd">        Reduced solution vector.</span>
</span><span id="reconstruct_full_sol-1570"><a href="#reconstruct_full_sol-1570"><span class="linenos">1570</span></a>
</span><span id="reconstruct_full_sol-1571"><a href="#reconstruct_full_sol-1571"><span class="linenos">1571</span></a><span class="sd">    Returns</span>
</span><span id="reconstruct_full_sol-1572"><a href="#reconstruct_full_sol-1572"><span class="linenos">1572</span></a><span class="sd">    -------</span>
</span><span id="reconstruct_full_sol-1573"><a href="#reconstruct_full_sol-1573"><span class="linenos">1573</span></a><span class="sd">    sol_full : ndarray</span>
</span><span id="reconstruct_full_sol-1574"><a href="#reconstruct_full_sol-1574"><span class="linenos">1574</span></a><span class="sd">        Solution vector defined on all DOFs.</span>
</span><span id="reconstruct_full_sol-1575"><a href="#reconstruct_full_sol-1575"><span class="linenos">1575</span></a>
</span><span id="reconstruct_full_sol-1576"><a href="#reconstruct_full_sol-1576"><span class="linenos">1576</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="reconstruct_full_sol-1577"><a href="#reconstruct_full_sol-1577"><span class="linenos">1577</span></a>    <span class="n">pb</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">sol_reduced</span><span class="p">,</span> <span class="n">reduced</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="reconstruct_full_sol-1578"><a href="#reconstruct_full_sol-1578"><span class="linenos">1578</span></a>    <span class="n">sol_full</span> <span class="o">=</span> <span class="n">pb</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">variables</span><span class="p">()</span>
</span><span id="reconstruct_full_sol-1579"><a href="#reconstruct_full_sol-1579"><span class="linenos">1579</span></a>    <span class="k">return</span> <span class="n">sol_full</span>
</span></pre></div>


            <div class="docstring"><p>Reconstruct the full solution vector from the reduced solution vector
(defined only at active DOFs i.e. DOFs that are not constrained by
essential boundary conditions).</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>pb</strong> (<code>Problem</code> instance):
Problem instance associated with the solution to reconstruct.</li>
<li><strong>sol_reduced</strong> (ndarray):
Reduced solution vector.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>sol_full</strong> (ndarray):
Solution vector defined on all DOFs.</li>
</ul>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>